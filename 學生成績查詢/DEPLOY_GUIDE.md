# 校園段考成績查詢系統 - 完整部署指南 (V9.0)

**版本**：V9.0 Campus Edition
**最後更新**：2026年1月20日
**適用人數**：最多 240 人（可擴展）
**學校/企業用戶**：請務必參考 [WORKSPACE_GUIDE.md](WORKSPACE_GUIDE.md)

---

## 📋 目錄

1. [系統特色](#系統特色)
2. [準備工作](#準備工作)
3. [步驟 1：建立 Google Sheet](#步驟-1建立-google-sheet)
4. [步驟 2：輸入程式碼](#步驟-2輸入程式碼)
5. [步驟 3：初次設定](#步驟-3初次設定)
6. [步驟 4：寄送查詢碼](#步驟-4寄送查詢碼)
7. [步驟 5：發布為網頁應用程式](#步驟-5發布為網頁應用程式)
8. [管理員功能](#管理員功能)
9. [安全機制說明](#安全機制說明)
10. [常見問題 FAQ](#常見問題-faq)
11. [疑難排解](#疑難排解)

---

## 系統特色

### 🛡️ 六層安全防護

| 防護層 | 機制 | 效果 |
|--------|------|------|
| 1️⃣ CAPTCHA | 數學題 + 干擾線 + 噪點 + 乘法 | 阻擋自動化腳本 |
| 2️⃣ 密碼強度 | 5 位數亂數 (100,000 組合) | 暴力破解需 115 天 |
| 3️⃣ 座號驗證 | 第 2 次失敗要求座號 | 防止惡意鎖定他人帳號 |
| 4️⃣ 漸進式延遲 | 10秒 → 1分鐘 → 5分鐘 → 鎖定 | 友善真實用戶，延緩攻擊 |
| 5️⃣ 全域熔斷 | 120次/分 → 全系統鎖 3 分鐘 | DDoS 攻擊自動防禦 |
| 6️⃣ 日誌警報 | `_SecurityLog` + Email 通知 | 即時監控 + 事後追查 |

### 🎨 UI/UX 特色

- ✅ 現代簡約設計風格
- ✅ 支援手機/平板/電腦
- ✅ 單頁成績趨勢比對（智慧辨識「第二次」vs「第一次」）
- ✅ 班排名 + 班平均統計

---

## 準備工作

### 必要條件

- ✅ Google 帳號
- ✅ 學生成績資料（Excel 或 CSV 格式）
- ✅ 學生 Email 清單（若要使用寄信功能）
- ✅ 學生座號資料（V6.2 新增，用於安全驗證）

### 建議環境

- Chrome / Edge / Safari 瀏覽器
- 穩定的網路連線

---

## 步驟 1：建立 Google Sheet

### 1.1 建立新的試算表

1. 前往 [Google 試算表](https://sheets.google.com)
2. 點選「空白」建立新試算表
3. 將試算表命名為「段考成績」（或您喜歡的名稱）

### 1.2 設定工作表名稱

**重要**：工作表名稱 = 班級名稱

- 將預設的「工作表1」改名為班級名稱，例如：`101`、`102`
- 如果有多個班級，點選左下角 `+` 新增工作表
- 每個班級一個獨立的工作表

### 1.3 欄位名稱 (⚠️ 重要)

**系統會嚴格檢查以下欄位名稱，請務必完全一致（包含繁體中文）：**

**A. 系統核心欄位 (必須存在)**
| 欄位名稱 | 用途 |
|---------|------|
| `學號` | 系統唯一識別碼 |
| `姓名` | 顯示在查詢結果上方 |
| `座號` | 安全防護驗證用 |
| `查詢碼` | 登入密碼 (系統自動產生) |
| `Email` | 寄送通知用 |

**B. 成績顯示欄位 (對應前端介面)**
若要讓系統正確顯示成績卡片，**欄位名稱必須完全符合下表**（順序不拘）：

| 試算表欄位名稱 | 系統顯示名稱 | 備註 |
|--------------|------------|------|
| `第一次段考` | 第一次段考 | 用於計算趨勢 |
| `第二次段考` | 第二次段考 | 會自動與第一次比較 (▲/▼) |
| `期末考` | 期末考 | 會自動與第二次比較 |
| `小考平均` | 小考平均 | |
| `缺交` | 缺交次數 | 僅顯示數字，不計算排名 |
| `平時` | 平時 | |
| `學期` | 學期總成績 | 大字體強調顯示 |

> [!CAUTION]
> **請勿自行改名**
> - 例如：請勿將「第一次段考」寫成「一模」或「First Exam」。
> - 若名稱不符，系統將**無法抓取**該項成績，卡片也不會顯示。
> - 若某項成績暫時沒有（例如學期初），保持欄位空白或不建立該欄位即可，系統會自動隱藏。

### 1.4 範例資料表結構

```
+-------+--------+------+--------+-------------------+----------+----------+
| 學號  | 姓名   | 座號 | 查詢碼 | Email             | 第一次段 | 第二次段 |
+-------+--------+------+--------+-------------------+----------+----------+
| 10101 | 王小明 |  1   |        | s10101@school.edu | 85       | 92       |
| 10102 | 李小華 |  2   |        | s10102@school.edu | 78       | 81       |
| 10103 | 陳大明 |  3   |        | s10103@school.edu | 90       | 88       |
+-------+--------+------+--------+-------------------+----------+----------+
```

> [!IMPORTANT]
> **座號欄位說明**
> - 座號用於防止惡意鎖定攻擊
> - 學生登入時如果連續輸錯 2 次密碼，系統會要求輸入座號
> - 座號正確才能繼續嘗試；座號錯誤會立即鎖定（判定為惡意攻擊）
> - 成功登入後，座號**不會**顯示在查詢頁面（隱私保護）

### 1.5 輸入學生資料

- 從第 2 列開始輸入學生資料
- **查詢碼欄位請保持空白**（系統會自動生成）
- 確保每位學生的「學號」都不重複

---

## 步驟 2：輸入程式碼

### 2.1 開啟 Apps Script 編輯器

1. 在 Google Sheet 上方選單，點選 **「擴充功能」** → **「Apps Script」**
2. 系統會開啟新分頁進入 Apps Script 編輯器

### 2.2 輸入後端程式碼

1. 左側會看到預設的 `程式碼.gs` 檔案
2. **清空所有預設內容**
3. 複製本專案資料夾中 `gas_project/Code.js` 的**完整內容**
4. 貼上到 `程式碼.gs`
5. 點選磁碟圖示 💾 **儲存**

> [!WARNING]
> **修改管理員 Email**
> 
> 找到程式碼第 19 行：
> ```javascript
> ADMIN_EMAIL: '在此輸入您的Email'
> ```
> 
> 改成您的實際 Email：
> ```javascript
> ADMIN_EMAIL: 'your.email@example.com'
> ```

**設定開放時間 (選填)**
若要限制查詢時間，請修改第 23-24 行：
```javascript
SYSTEM_OPEN_TIME: '2026-01-19 08:00',   // 開放時間
SYSTEM_CLOSE_TIME: '2026-01-25 17:00'   // 結束時間
```
*若不限制，請保持引號內為空白 `''`*。

### 2.3 輸入前端程式碼

1. 點選左上角 **「+」** 按鈕，選擇 **「HTML」**
2. 檔案名稱輸入：`Index`（注意大小寫）
3. 複製本專案資料夾中 `gas_project/Index.html` 的**完整內容**
4. 貼上到 `Index.html`
5. 點選 💾 **儲存**

### 2.4 重新整理 Google Sheet

1. 回到 Google Sheet 分頁
2. 按 `F5` 重新整理網頁
3. 上方選單應該會出現新的 **「管理選項」** 選單

---

## 步驟 3：初次設定

### 3.1 產生查詢碼

1. 點選 Google Sheet 上方的 **「管理選項」** → **「產生所有查詢碼 (5碼)」**
2. 第一次執行會要求授權：
   - 點選 **「審查權限」**
   - 選擇您的 Google 帳號
   - 點選 **「進階」**
   - 點選 **「前往 [您的專案名稱] (不安全)」**
   - 點選 **「允許」**
3. 執行成功後，所有分頁的「查詢碼」欄位會自動填入 5 位數亂數

**查詢碼範例**：`12345`、`67890`、`54321`

### 3.2 檢查結果

返回試算表，確認：
- ✅ 每位學生都有一個 5 位數查詢碼
- ✅ 查詢碼都不相同
- ✅ 沒有漏失的學生

---

## 步驟 4：寄送查詢碼

### 4.1 確保 Email 欄位已填寫

- 檢查試算表中的「Email」欄位
- 確保格式正確（包含 `@`）

### 4.2 執行寄送功能

1. 點選 **「管理選項」** → **「寄送查詢碼 (Email)」**
2. **[NEW] 系統會跳出視窗，請貼上您剛才部署複製的「網頁應用程式網址」**
3. 點選「確定」後，系統會自動掃描所有分頁，將查詢碼寄給學生
4. 執行完畢會顯示「已寄送 XX 封」

### 4.3 Email 內容範例

```
主旨：成績查詢碼

學號: 10101
查詢碼: 12345

查詢網址: https://script.google.com/...
```

---

## 步驟 5：發布為網頁應用程式

### 5.1 部署設定

1. 回到 Apps Script 編輯器
2. 點選右上角 **「部署」** → **「新增部署作業」**
3. 左側齒輪圖示，選擇 **「網頁應用程式」**

### 5.2 設定參數

| 設定項目 | 選擇值 | 說明 |
|---------|--------|------|
| **說明** | `成績查詢 V9.0` | 版本標記 |
| **執行身分** | **我 (您的 Email)** | **重要**：讓學生不需登入 Google |
| **存取權使用者** | **任何人 (Anyone)** | **關鍵設定**：必須選「任何人」，學生才能免登入訪問 |

> [!IMPORTANT]
> **關於「存取權使用者」設定**
> - **必須選擇「任何人 (Anyone)」**：這代表「匿名使用者」也能訪問。系統程式碼會自動開啟「匿名模式」，學生不需要登入 Google 帳號即可查詢。
> - **如果選「任何擁有 Google 帳號的人」**：學生必須登入 Google 才能看（不便民）。
> - **如果找不到「任何人」選項**：代表您的學校/組織網域禁止對外分享。請參考 [WORKSPACE_GUIDE.md](WORKSPACE_GUIDE.md) 或必須要求學生登入學校帳號。

### 5.3 完成部署

1. 點選 **「部署」**
2. 複製 **「網頁應用程式網址」**
3. 將此網址發送給學生

**網址範例**：
```
https://script.google.com/macros/s/AKfycbx.../exec
```

---

## 管理員功能

點選 Google Sheet 上方的 **「管理選項」** 可使用以下功能：

### 📊 查看安全日誌

- 查看所有登入記錄
- 包含：時間、學號、事件類型（成功/失敗/鎖定）
- 工作表名稱：`_SecurityLog`

### 🔓 解除特定學號鎖定

- 手動解除單一學生的帳號鎖定
- 輸入學號即可立即解鎖

### ⚠️ 緊急解除全部鎖定

- 用於遭受大規模惡意攻擊時
- **注意**：無法真正清除所有鎖定（Google Cache 限制）
- 鎖定記錄會在 10 分鐘後自動過期

### 📱 產生專案分享圖卡 (給老師)

- 自動生成一張包含 **QR Code** 的精美圖卡
- 包含：專案教學連結 QR Code、簡易推廣步驟
- **用途**：截圖分享給其他想使用本系統的老師

---

## 安全機制說明

### 🔐 混合防護機制（V6.2 核心）

#### 登入流程詳解

```
第 1 次輸錯密碼
└─> 提示：「學號或密碼錯誤」
    
第 2 次輸錯密碼
├─> 系統：「⚠️ 為了保護您的帳號安全，請輸入您的座號以繼續嘗試」
├─> 學生輸入座號
│   ├─> 座號正確 ✅
│   │   └─> 允許繼續（等待 10 秒）
│   │
│   └─> 座號錯誤 ❌
│       └─> 立即鎖定 10 分鐘
│       └─> 發送 Email 警報給管理員
│       └─> 記錄到 _SecurityLog
│
└─> 第 3 次輸錯（座號驗證通過後）
    └─> 等待 10 秒才能再試
    
第 4 次輸錯
└─> 等待 1 分鐘才能再試

第 5 次輸錯
└─> 等待 5 分鐘才能再試

第 6 次輸錯
└─> 鎖定 10 分鐘
```

#### 防護效果分析

| 攻擊類型 | 防護結果 | 說明 |
|---------|---------|------|
| **陌生攻擊者**<br>（不知道座號） | ✅ **完全阻擋** | 第 2 次失敗後座號驗證失敗，立即鎖定 |
| **同班同學惡作劇**<br>（知道座號） | ⚠️ **大幅延緩** | 需要 16 分鐘才能鎖定一個帳號 |
| **批量腳本攻擊** | ✅ **觸發全域熔斷** | 1 分鐘內 >120 次失敗，全系統鎖 3 分鐘 |

### 📧 管理員警報機制

**觸發條件**：
- 座號驗證失敗（明確的惡意行為）
- 帳號被鎖定（連續輸錯 6 次）
- 全域熔斷啟動（DDoS 攻擊）

**警報內容**：
```
主旨：[成績查詢安全警報] 帳號鎖定警報

學號 10101 因連續錯誤 6 次已被系統鎖定。

此為系統自動發送，請檢查 _SecurityLog。
```

---

## 常見問題 FAQ

### Q1：如何新增下一次段考成績？

**答**：系統是動態的，只需在 Google Sheet 中新增一欄即可。

**步驟**：
1. 在成績表最後一欄新增標題，例如「第三次段考」
2. 填入學生成績
3. **不需要重新部署**
4. 學生重新整理網頁後，就會自動看到新的成績欄位

---

### Q2：成績趨勢（▲/▼）是如何計算的？

**答**：系統會自動在**同一張工作表**中尋找前一次的成績。

**比對規則（自動）**：
- 欄位名稱含 `二`（如「第二次段考」）→ 自動找含 `一` 的欄位
- 欄位名稱含 `三` → 自動找含 `二` 的
- 欄位名稱含 `2`（如 `Exam 2`）→ 自動找含 `1` 的

**只要您的欄位命名符合這個邏輯，程式就會自動顯示 ▲ 或 ▼。**

**範例**：
```
第一次段考：85 分
第二次段考：92 分
➡️ 系統顯示：92 ▲ (+7)
```

---

### Q3：學生忘記查詢碼怎麼辦？

**方案 1：重新寄送 Email**
- 點選「管理選項」→「寄送查詢碼 (Email)」

**方案 2：直接告知**
- 在 Google Sheet 中查看該學生的查詢碼並告知

**方案 3：重新產生（不建議）**
- 如果需要重設，先刪除該學生的查詢碼欄位
- 執行「產生所有查詢碼」

---

### Q4：網頁頂端的 Google 警告標示是什麼？

**答**：顯示「這個應用程式是由 Google Apps Script 的使用者建立」。

這是 Google 的**強制安全機制**，只要是公開的 Apps Script 都會顯示，**無法移除**。

**建議**：若希望介面更美觀，可將產生後的網址嵌入到 **Google Sites (協作平台)** 中，看起來會更像正式的學校網頁。

---

### Q5：如何確保資料不外洩？

**檢查清單**：

✅ **Google Sheet 權限設定**
- 點選 Google Sheet 右上角「共用」
- 確認「一般存取權」設為 **「限制存取」**
- **絕對不要**開啟「知道連結的任何人都能檢視」

✅ **Apps Script 權限**
- 發布時選擇「執行身分：我」
- 學生只能透過網頁應用程式查詢，**看不到試算表本身**

✅ **座號隱私**
- 座號僅用於驗證，登入後**不會顯示**在查詢頁面

---

### Q6：系統可以支援多少人使用？

**答**：已針對 **240 人**（6 個班級）優化。

**容量上限**：
- Google Apps Script：有每日執行時間限制（約 6 小時）
- 理論上可支援數千人，但建議不超過 500 人
- 如需更大規模，建議改用 AppSheet 或自架伺服器

---

## 疑難排解

### ⚠️ 常見手機存取錯誤 (Mobile Access Error)

**情況**：手機開啟連結時顯示「很抱歉，目前無法開啟這個檔案 (Sorry, unable to open this file)」。

**原因**：
這是 Google Apps Script 的已知限制。當您的瀏覽器同時登入多個 Google 帳號（例如：個人帳號 + 學校帳號）時，Google 系統會發生衝突，導致無法開啟網頁應用程式。

**解決方法（三選一）**：
1. **✅ 推薦：使用「無痕模式」或「私密瀏覽」開啟連結**（最快解決）。
2. 使用另一個瀏覽器（例如原本用 Chrome，改用 Safari）。
3. 登出所有 Google 帳號，只登入一個帳號。

---

### ⚠️ 設定時找不到「存取權使用者：任何人」

**原因**：您的 Google 帳號屬於 **學校或企業 (Google Workspace)**，組織管理員關閉了對外分享權限。

**解決方法**：
請參閱專屬指南：[📘 Google Workspace 專用設定手冊](WORKSPACE_GUIDE.md)

### 問題 1：執行「產生所有查詢碼」後沒有反應

**可能原因**：
- 沒有授權或授權失敗

**解決方法**：
1. 重新執行「產生所有查詢碼」
2. 在授權畫面點選「進階」→「前往 [專案名稱] (不安全)」
3. 點選「允許」

---

### 問題 2：學生查詢時顯示「系統忙碌中」

**可能原因**：
- Google Sheet 欄位名稱有誤
- 缺少必要欄位（學號、查詢碼）

**解決方法**：
1. 檢查第一列標題是否包含「學號」和「查詢碼」
2. 檢查Apps Script 中是否有錯誤訊息（點選「執行」→「檢視記錄」）

---

### 問題 3：學生輸入正確密碼仍然顯示錯誤

**可能原因**：
- 查詢碼為數字，但試算表儲存為文字格式

**解決方法**：
1. 選取「查詢碼」整欄
2. 點選「格式」→「數值」→「純文字」
3. 重新產生查詢碼

---

### 問題 4：無法收到 Email 警報

**檢查項目**：
1. 確認 `Code.js` 第 19 行的 `ADMIN_EMAIL` 已正確設定
2. 檢查 Gmail 的「垃圾郵件」資料夾
3. 確認 Apps Script 有 Gmail 權限（初次執行會要求授權）

---

### 問題 5：全域熔斷誤判，正常學生也被鎖

**情況**：240 人在考試後 2 分鐘內同時登入

**調整方法**：
修改 `Code.js` 第 14-16 行：

```javascript
// 原設定（嚴格）
GLOBAL_FAIL_LIMIT: 120,      
GLOBAL_WINDOW: 60,           
GLOBAL_PANIC_DURATION: 180,  

// 寬鬆設定（適合大考期間）
GLOBAL_FAIL_LIMIT: 200,      // 提高到 200 次
GLOBAL_WINDOW: 60,           
GLOBAL_PANIC_DURATION: 120,  // 縮短到 2 分鐘
```

---

## 技術支援

### 查看日誌

**Apps Script 執行記錄**：
1. Apps Script 編輯器
2. 左側選單「執行作業」
3. 查看最近的執行狀態

**安全日誌**：
- Google Sheet → 切換到 `_SecurityLog` 工作表
- 查看所有登入嘗試記錄

### 聯絡資訊

- **專案作者**：MAXCHAN
- **版本**：V6.2 Security Edition
- **最後更新**：2026-01-17

---

## 版本歷程

| 版本 | 日期 | 更新內容 |
|------|------|---------|
| V9.0 | 2026-01-20 | 校園通用版發布 (移除學科/品牌特定內容)，優化權限說明 |
| V6.2 | 2026-01-17 | 混合防護機制（座號驗證 + 漸進式延遲） |
| V6.1 | 2026-01-17 | 座號二次驗證、管理員解鎖功能 |
| V6.0 | 2026-01-17 | 全域熔斷、安全日誌、Email 警報 |
| V5.8 | 2026-01-16 | 5 位數密碼、Hardened CAPTCHA |

---

**🎉 部署完成！祝您使用愉快！**
