// Init
let token = '';
let sessionId = ''; // ğŸ†• è¿½è¹¤ç¢¼
window.onload = function () {
loadCaptcha();
initSecurityInfo(); // ğŸ†• åˆå§‹åŒ–å®‰å…¨è³‡è¨Š
setupEnterKeySupport(); // ğŸ†• æ”¯æ´ Enter éµé€å‡º
};
const capBox = document.getElementById('cap-box');
capBox.onclick = loadCaptcha;

// ğŸ†• Enter éµé€å‡ºæ”¯æ´ï¼ˆæ•ˆèƒ½å„ªåŒ– - æå‡ UXï¼‰
function setupEnterKeySupport() {
const inputs = document.querySelectorAll('#inp-id, #inp-pwd, #inp-cap');
inputs.forEach(input => {
input.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
e.preventDefault();
doLogin();
}
});
});
}

// ğŸ†• åˆå§‹åŒ–å®‰å…¨è³‡è¨Š
function initSecurityInfo() {
// ç”Ÿæˆ Session IDï¼ˆçœŸå¯¦çš„è¿½è¹¤ç¢¼ï¼‰
const timestamp = new Date().toISOString().replace(/[-:]/g, '').slice(0, 15);
const random = Math.random().toString(36).substring(2, 8);
sessionId = `${timestamp}-${random}`;

// æ ¼å¼åŒ–æ™‚é–“
const now = new Date();
const timeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2,
'0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2,
'0')}:${String(now.getSeconds()).padStart(2, '0')}`;

// ğŸ†• æ›´æ–°é¡¯ç¤º (é¡¯ç¤ºçœŸå¯¦ Email èˆ‡ IP)
// âš ï¸ ä½¿ç”¨ window.SERVER_DATA é¿å… GAS æ¨¡æ¿èªæ³•éŒ¯èª¤
const userEmail = (window.SERVER_DATA && window.SERVER_DATA.userEmail) ? window.SERVER_DATA.userEmail : 'Anonymous';
document.getElementById('user-email').textContent = "Email: " + userEmail;

document.getElementById('session-id').textContent = sessionId;
document.getElementById('access-time').textContent = timeStr;

// ğŸ†• å–å¾—å®¢æˆ¶ç«¯ IPï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™ï¼‰
fetch('https://api.ipify.org?format=json')
.then(response => response.json())
.then(data => {
document.getElementById('user-ip').textContent = `IP: ${data.ip}`;
})
.catch(() => {
document.getElementById('user-ip').textContent = 'IP: ç„¡æ³•å–å¾—';
});
}

function loadCaptcha() {
capBox.innerHTML = '<span style="color:#999;font-size:12px;">...</span>';
google.script.run.withSuccessHandler(r => {
capBox.innerHTML = r.svg;
token = r.token;
}).getCaptcha();
}

function showToast(msg, type = 'normal') {
const t = document.getElementById('toast');
t.innerHTML = msg;
t.className = type === 'error' ? 'visible error' : 'visible';
setTimeout(() => t.classList.remove('visible'), 3000);
}

// ğŸ†• ç™»å‡ºå‡½æ•¸ - è¿”å›ç™»å…¥ç•«é¢ï¼ˆä¸é‡æ–°æ•´ç†ï¼‰
function doLogout() {
// éš±è—çµæœé 
document.getElementById('view-result').style.display = 'none';
// é¡¯ç¤ºç™»å…¥é 
document.getElementById('view-login').style.display = 'flex';

// æ¸…ç©ºè¼¸å…¥æ¬„ä½
document.getElementById('inp-id').value = '';
document.getElementById('inp-pwd').value = '';
document.getElementById('inp-cap').value = '';

// ç§»é™¤åº§è™Ÿè¼¸å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
const seatRow = document.getElementById('seat-row');
if (seatRow) seatRow.remove();

// æ¸…ç©ºçµæœå€åŸŸ
document.getElementById('list-container').innerHTML = '';
document.getElementById('announce-area').innerHTML = '';
document.getElementById('chart-section').style.display = 'none';
document.getElementById('risk-indicator').style.display = 'none';

// é‡æ–°è¼‰å…¥é©—è­‰ç¢¼
loadCaptcha();

// é‡æ–°ç”Ÿæˆ Session ID
initSecurityInfo();

showToast('å·²ç™»å‡ºï¼Œè«‹é‡æ–°ç™»å…¥');
}

// ğŸ†• V10 Smart Announcement: Mark as Read
function markAsRead(studentId, announcementId, btn) {
btn.disabled = true;
btn.innerText = 'è™•ç†ä¸­...';

google.script.run
.withSuccessHandler(res => {
if (res.success) {
// æ›´æ–° UI
const item = btn.closest('.announce-item');
item.classList.add('read');
// æ›¿æ›æŒ‰éˆ•ç‚ºå·²è®€å¾½ç« 
const badge = document.createElement('span');
badge.className = 'read-badge';
badge.innerText = 'å·²è®€';
btn.replaceWith(badge);
} else {
showToast('æ¨™è¨˜å¤±æ•—', 'error');
btn.disabled = false;
btn.innerText = 'âœ“ å·²è®€';
}
})
.withFailureHandler(err => {
showToast('æ¨™è¨˜å¤±æ•—: ' + err.message, 'error');
btn.disabled = false;
btn.innerText = 'âœ“ å·²è®€';
})
.markAnnouncementRead(studentId, announcementId);
}

function doLogin() {
const id = document.getElementById('inp-id').value;
const pwd = document.getElementById('inp-pwd').value;
const cap = document.getElementById('inp-cap').value;
const seat = document.getElementById('inp-seat')?.value || null; // ğŸ†• åº§è™Ÿ
if (!id || !pwd || !cap) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

document.getElementById('loader').style.display = 'flex';
google.script.run.withSuccessHandler(res => {
document.getElementById('loader').style.display = 'none';
if (!res.success) {
// ğŸ†• è™•ç†åº§è™Ÿé©—è­‰è¦æ±‚
if (res.requireSeatNumber) {
showSeatNumberInput();
}
// ğŸ†• è™•ç†æ¼¸é€²å¼å»¶é²
if (res.waitSeconds) {
showCountdown(res.waitSeconds);
disableLoginButton(res.waitSeconds);
}
showToast(res.message, 'error');
if (!res.locked && !res.waitSeconds) {
document.getElementById('inp-cap').value = '';
loadCaptcha();
}
} else {
renderResult(res.data, res.config, res.announcements);
}
}).login(id, pwd, token, cap, seat, sessionId); // ğŸ†• æ–°å¢ sessionId åƒæ•¸
}

// ğŸ†• å‹•æ…‹é¡¯ç¤ºåº§è™Ÿè¼¸å…¥æ¡†
function showSeatNumberInput() {
if (document.getElementById('inp-seat')) return; // å·²å­˜åœ¨

const seatRow = document.createElement('div');
seatRow.className = 'input-row';
seatRow.id = 'seat-row';
seatRow.style.animation = 'slideIn 0.3s ease';
seatRow.innerHTML = `
<label>ğŸ“ åº§è™Ÿ</label>
<input type="text" id="inp-seat" placeholder="è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ" />
`;

const pwdRow = document.querySelector('.input-row:has(#inp-pwd)');
pwdRow.after(seatRow);

// è‡ªå‹•èšç„¦åº§è™Ÿè¼¸å…¥æ¡†
setTimeout(() => document.getElementById('inp-seat').focus(), 100);
}

// ğŸ†• é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨
function showCountdown(seconds) {
const toast = document.getElementById('toast');
let remaining = seconds;

const updateCountdown = () => {
if (remaining > 0) {
const mins = Math.floor(remaining / 60);
const secs = remaining % 60;
const timeStr = mins > 0 ? `${mins} åˆ† ${secs} ç§’` : `${secs} ç§’`;
toast.innerHTML = `â³ è«‹ç¨å€™ ${timeStr} å†è©¦`;
toast.className = 'visible error';
remaining--;
setTimeout(updateCountdown, 1000);
} else {
toast.classList.remove('visible');
showToast('å¯ä»¥å†æ¬¡å˜—è©¦äº†ï¼');
}
};
updateCountdown();
}

// ğŸ†• ç¦½ç”¨ç™»å…¥æŒ‰éˆ• N ç§’
function disableLoginButton(seconds) {
const btn = document.querySelector('.btn-primary');
btn.disabled = true;
btn.style.opacity = '0.5';
btn.style.cursor = 'not-allowed';

setTimeout(() => {
btn.disabled = false;
btn.style.opacity = '1';
btn.style.cursor = 'pointer';
loadCaptcha(); // é‡æ–°è¼‰å…¥é©—è­‰ç¢¼
}, seconds * 1000);
}

function renderResult(data, config, announcements) {
document.getElementById('view-login').style.display = 'none';
document.getElementById('view-result').style.display = 'flex';

// ğŸ†• Store config in data object for easier access in loop
data.config = config;

// ğŸ†• Render Announcements (V10 Smart Announcement System)
const announceArea = document.getElementById('announce-area');
announceArea.innerHTML = '';

// ä½¿ç”¨å¾Œç«¯å‚³ä¾†çš„å€‹äººåŒ–å…¬å‘Š
const smartAnnouncements = data.announcements || [];

if (smartAnnouncements.length > 0) {
smartAnnouncements.forEach(a => {
const el = document.createElement('div');
el.className = `announce-item ${a.type}${a.isRead ? ' read' : ''}`;
el.dataset.id = a.id;

let icon = 'â„¹ï¸';
if (a.type === 'warning') icon = 'âš ï¸';
if (a.type === 'emergency') icon = 'ğŸš¨';

// æ§‹å»ºæŒ‰éˆ• HTML (é¿å…ä½¿ç”¨å·¢ç‹€æ¨¡æ¿å­—ä¸²)
let actionHtml = '';
// data['å­¸è™Ÿ'] æ˜¯å­—ä¸²ï¼Œéœ€è¦å°å¿ƒå¼•è™Ÿ
const stuId = data['å­¸è™Ÿ'];

if (!a.isRead) {
// ä½¿ç”¨ onclick å‘¼å«å…¨åŸŸå‡½æ•¸
actionHtml = `<button class="mark-read-btn" onclick="markAsRead('${stuId}', '${a.id}', this)">âœ“ å·²è®€</button>`;
} else {
actionHtml = '<span class="read-badge">å·²è®€</span>';
}

el.innerHTML = `
<div class="announce-icon">${icon}</div>
<div class="announce-content">
    <div class="announce-message">${a.message}</div>
    ${actionHtml}
</div>
`;
announceArea.appendChild(el);
});
}

document.getElementById('disp-name').innerText = data['å§“å'] || 'åŒå­¸';
document.getElementById('disp-id').innerText = data['å­¸è™Ÿ'];

// Debug Log
if (data._debug) {
console.group('Backend Debug Logic');
data._debug.forEach(l => console.log(l));
console.groupEnd();
}

const container = document.getElementById('list-container');
container.innerHTML = '';

const stats = data._stats || {};

// ğŸ†• å›ºå®šé¡¯ç¤ºé †åºï¼ˆç”±ä¸Šåˆ°ä¸‹ï¼‰
const displayOrder = [
'ç¬¬ä¸€æ¬¡æ®µè€ƒ',
'ç¬¬äºŒæ¬¡æ®µè€ƒ',
'æœŸæœ«è€ƒ',
'å°è€ƒå¹³å‡',
'ç¼ºäº¤',
'å¹³æ™‚',
'å­¸æœŸ'
];

// æ¸²æŸ“å‡½å¼
const renderGradeCard = (key) => {
// ğŸ†• V10.1: æª¢æŸ¥æ¬„ä½æ˜¯å¦å…è¨±é¡¯ç¤º
const visibleFields = data.visibleFields || [];
if (visibleFields.length > 0 && !visibleFields.includes(key)) return;

if (!data.hasOwnProperty(key)) return; // è‹¥æ¬„ä½ä¸å­˜åœ¨å‰‡è·³é

const val = data[key];
if (val === undefined || val === null) return; // è‹¥å€¼ç‚ºç©ºå‰‡è·³é

const s = stats[key] || {};

// Trend
let trendHtml = '';
if (s.diff !== undefined && s.diff !== null) {
const diff = parseFloat(s.diff);
if (diff > 0) trendHtml = `<div class="trend-pill up">â–² ${diff}</div>`;
else if (diff < 0) trendHtml=`<div class="trend-pill down">â–¼ ${Math.abs(diff)}</div>`;
    else trendHtml = `<div class="trend-pill flat">-</div>`;
    }

    // Stats (æ’åèˆ‡å¹³å‡)
    let footerHtml = '';
    // ğŸ†• ä½¿ç”¨å¾Œç«¯å‚³ä¾†çš„ Configï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
    const noStatsFields = (data.config && data.config.noStatsFields) || ['ç¼ºäº¤', 'å°è€ƒå¹³å‡', 'å¹³æ™‚', 'å­¸æœŸ'];
    if (s.avg && !noStatsFields.includes(key)) {
    footerHtml = `
    <div class="stats-footer">
        <div class="stat-item">ç­æ’å <span class="stat-val">${s.rank}</span></div>
        <div class="stat-item">ç­ç´šå¹³å‡ <span class="stat-val">${s.avg}</span></div>
    </div>
    `;
    }

    // ç‰¹æ®Šæ¬„ä½è™•ç†
    let cardClass = 'grade-card';
    let valueDisplay = val;
    let displayName = key; // ğŸ†• æ¬„ä½é¡¯ç¤ºåç¨±

    // ğŸ†• ä¿®æ”¹é¡¯ç¤ºåç¨±
    if (key === 'ç¼ºäº¤') displayName = 'ç¼ºäº¤æ¬¡æ•¸';
    if (key === 'å­¸æœŸ') displayName = 'å­¸æœŸç¸½æˆç¸¾';

    // å­¸æœŸæˆç¸¾ï¼šæ”¾å¤§å¼·èª¿
    if (key === 'å­¸æœŸ' && val !== '-') {
    cardClass += ' semester-highlight';
    }

    // ä½œæ¥­ç¼ºäº¤ï¼šé¡¯ç¤ºæ¬¡æ•¸ (ç§»é™¤è­¦ç¤ºè‰²)
    if (key === 'ç¼ºäº¤') {
    const count = parseInt(val);
    valueDisplay = `${val}<span class="homework-unit">æ¬¡</span>`;
    }

    const card = document.createElement('div');
    card.className = cardClass;
    card.innerHTML = `
    <div class="grade-header">
        <span class="subject-name">${displayName}</span>
        ${trendHtml}
    </div>
    <div class="grade-main-container">
        <span class="grade-val">${valueDisplay}</span>
    </div>
    ${footerHtml}
    `;
    container.appendChild(card);
    };

    // æŒ‰ç…§å›ºå®šé †åºæ¸²æŸ“
    displayOrder.forEach(key => renderGradeCard(key));

    // ğŸ†• æ¸²æŸ“é¢¨éšªæŒ‡ç¤ºå™¨ (V10.1)
    if (data.failRisk) {
    const riskEl = document.getElementById('risk-indicator');
    const estimated = data.failRisk.estimatedScore;
    const isAtRisk = data.failRisk.isAtRisk;

    // è¨ˆç®—åŠæ ¼æ©Ÿç‡ï¼š>=60åˆ†=100%ï¼Œ<60åˆ†å‰‡æŒ‰æ¯”ä¾‹è¨ˆç®— let probability; if (estimated>= 60) {
        probability = 100;
        } else {
        // ä½æ–¼60åˆ†ï¼ŒæŒ‰æ¯”ä¾‹è¨ˆç®—ï¼ˆ0-59åˆ† â†’ 0%-99%ï¼‰
        probability = Math.max(0, Math.round((estimated / 60) * 100));
        }

        riskEl.className = `risk-indicator ${isAtRisk ? 'danger' : 'safe'}`;
        riskEl.querySelector('.risk-probability').innerText = `${probability}%`;
        riskEl.style.display = 'flex';
        }

        // ğŸ†• æ¸²æŸ“åœ–è¡¨ (V9.2)
        if (data.chartData) {
        renderCharts(data.chartData);
        }
        }

        // ğŸ†• Chart.js åœ–è¡¨æ¸²æŸ“å‡½æ•¸ (V9.2 Grade Visualization Dashboard)
        let distributionChartInstance = null;
        let trendChartInstance = null;
        let globalChartData = null; // ğŸ†• å„²å­˜å…¨åŸŸè³‡æ–™ä»¥ä¾›åˆ‡æ›

        function renderCharts(chartData) {
        globalChartData = chartData; // å­˜å…¥å…¨åŸŸ
        const chartSection = document.getElementById('chart-section');

        if (!chartData || (!chartData.distributions && !chartData.trend)) {
        chartSection.style.display = 'none';
        return;
        }

        chartSection.style.display = 'block';

        // === 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®ä¸¦æ¸²æŸ“åˆ†ä½ˆåœ– ===
        const selector = document.getElementById('examSelector');
        selector.innerHTML = '';

        if (chartData.distributions && chartData.distributions.length > 0) {
        // å¡«å……é¸é …
        chartData.distributions.forEach((dist, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = dist.examName;
        selector.appendChild(opt);
        });

        // é¡¯ç¤ºä¸‹æ‹‰é¸å–®
        selector.style.display = 'block';

        // é è¨­é¸å–æœ€å¾Œä¸€å€‹ï¼ˆæœ€æ–°è€ƒè©¦ï¼‰
        selector.value = chartData.distributions.length - 1;

        // æ¸²æŸ“åˆ†ä½ˆåœ–
        updateDistributionChart();
        } else {
        // ç„¡åˆ†ä½ˆè³‡æ–™
        selector.style.display = 'none';
        // æ¸…ç©ºç•«å¸ƒæˆ–é¡¯ç¤ºç„¡è³‡æ–™
        if (distributionChartInstance) distributionChartInstance.destroy();
        }

        // === 2. æ¸²æŸ“å€‹äººæˆç¸¾è¶¨å‹¢åœ– ===
        renderTrendChart(chartData.trend);
        }

        // ğŸ†• æ›´æ–°åˆ†ä½ˆåœ– (On Change)
        function updateDistributionChart() {
        if (!globalChartData || !globalChartData.distributions) return;

        const selector = document.getElementById('examSelector');
        const index = parseInt(selector.value);
        const distData = globalChartData.distributions[index];

        if (!distData) return;

        const distCtx = document.getElementById('distributionChart').getContext('2d');

        // Starlux é…è‰²
        const colors = {
        earthGold: '#9B8A5E',
        earthGoldLight: 'rgba(155, 138, 94, 0.6)',
        highlight: '#FFB554',
        obsidian: '#45464D'
        };

        // éŠ·æ¯€èˆŠå¯¦ä¾‹
        if (distributionChartInstance) {
        distributionChartInstance.destroy();
        }

        // æ¨™è¨˜å­¸ç”Ÿæ‰€åœ¨å€é–“
        const backgroundColors = distData.labels.map((label, idx) => {
        return idx === distData.myRangeIndex
        ? colors.highlight
        : colors.earthGoldLight;
        });

        distributionChartInstance = new Chart(distCtx, {
        type: 'bar',
        data: {
        labels: distData.labels,
        datasets: [{
        label: 'äººæ•¸',
        data: distData.data,
        backgroundColor: backgroundColors,
        borderColor: colors.earthGold,
        borderWidth: 1,
        borderRadius: 6
        }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
        legend: { display: false },
        title: {
        display: true,
        text: 'å…¨ç­æˆç¸¾åˆ†ä½ˆ',
        font: { size: 14, weight: '600' },
        color: '#45464D',
        padding: { bottom: 16 }
        },
        tooltip: {
        callbacks: {
        afterLabel: function (context) {
        if (context.dataIndex === distData.myRangeIndex) {
        return 'â¬…ï¸ ä½ çš„æˆç¸¾å€é–“';
        }
        return '';
        }
        }
        }
        },
        scales: {
        y: {
        beginAtZero: true,
        title: {
        display: true,
        text: 'äººæ•¸',
        color: '#45464D',
        font: { weight: '500' }
        },
        ticks: {
        stepSize: 1,
        color: colors.obsidian
        },
        grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
        title: {
        display: true,
        text: 'åˆ†æ•¸å€é–“',
        color: '#45464D',
        font: { weight: '500' }
        },
        ticks: { color: colors.obsidian },
        grid: { display: false }
        }
        }
        }
        });
        }

        // ğŸ†• æ¸²æŸ“è¶¨å‹¢åœ– (åˆ†é›¢å‡ºä¾†ä»¥ä¿æŒç¨‹å¼ç¢¼æ•´æ½”)
        function renderTrendChart(trendData) {
        if (!trendData || trendData.labels.length === 0) return;

        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const colors = {
        earthGold: '#9B8A5E',
        earthGoldLight: 'rgba(155, 138, 94, 0.6)',
        roseGold: '#B4745A',
        roseGoldLight: 'rgba(180, 116, 90, 0.6)',
        obsidian: '#45464D'
        };

        // éŠ·æ¯€èˆŠå¯¦ä¾‹
        if (trendChartInstance) {
        trendChartInstance.destroy();
        }

        trendChartInstance = new Chart(trendCtx, {
        type: 'line',
        data: {
        labels: trendData.labels,
        datasets: [
        {
        label: 'æˆ‘çš„æˆç¸¾',
        data: trendData.myScores,
        borderColor: colors.earthGold,
        backgroundColor: colors.earthGoldLight,
        borderWidth: 3,
        pointRadius: 6,
        pointBackgroundColor: colors.earthGold,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        tension: 0.3,
        fill: false
        },
        {
        label: 'ç­ç´šå¹³å‡',
        data: trendData.classAvg,
        borderColor: colors.roseGoldLight,
        backgroundColor: 'transparent',
        borderWidth: 2,
        borderDash: [5, 5],
        pointRadius: 4,
        pointBackgroundColor: colors.roseGold,
        tension: 0.3,
        fill: false
        }
        ]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
        legend: {
        display: true,
        position: 'bottom',
        labels: {
        color: colors.obsidian,
        usePointStyle: true,
        padding: 12
        }
        }
        },
        scales: {
        y: {
        min: 0,
        max: 100,
        title: {
        display: true,
        text: 'åˆ†æ•¸',
        color: '#45464D',
        font: { weight: '500' }
        },
        ticks: {
        stepSize: 20,
        color: colors.obsidian
        },
        grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
        title: {
        display: true,
        text: 'è€ƒè©¦',
        color: '#45464D',
        font: { weight: '500' }
        },
        ticks: { color: colors.obsidian },
        grid: { display: false }
        }
        }
        }
        });
        }