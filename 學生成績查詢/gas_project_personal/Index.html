<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <title>ç‰©ç†ç§‘æ®µè€ƒæˆç¸¾æŸ¥è©¢</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <!-- ç³»çµ±é è¨­å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Rufina:wght@400;700&family=Montserrat:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* 
           Design System: Starlux Airlines x Apple UI 
           - Font: Apple System (San Francisco)
           - Colors: Starlux Official Palette
           - Components: iOS 15+ Rounded Cards, Large Headers
        */
        :root {
            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               æ˜Ÿå®‡èˆªç©ºå®˜æ–¹å“ç‰Œè¦ç¯„è‰² (STARLUX Brand Colors)
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

            /* å¤§åœ°é‡‘ (Earth Gold) - æ—©æ™¨ãƒ»å‰µæ–°æ€ç¶­ãƒ»ç†±å¿±æœå‹™ */
            --earth-gold: #9B8A5E;
            --earth-gold-light: #F9C78B;
            --earth-gold-bright: #FFB554;

            /* ç«ç‘°é‡‘ (Rose Gold) - é»ƒæ˜ãƒ»å°ˆæ¥­æœ¬ä½ãƒ»è±ªè¯é…å‚™ */
            --rose-gold: #B4745A;
            --rose-gold-deep: #794425;
            --rose-gold-light: #C9917A;

            /* æ›œçŸ³ç° (Obsidian Grey) - å¤œæ™šãƒ»è¬¹æ…ç´€å¾‹ãƒ»å®‰å…¨è‡³ä¸Š */
            --obsidian-grey: #45464D;
            --obsidian-deep: #0F2D3C;
            --obsidian-light: #4E463F;

            /* èƒŒæ™¯ */
            --cream-bg: #F3F1E5;
            --cream-dark: #E8E6DA;

            /* èªæ„è‰²å½© (Apple Style) */
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-dark: #1D1D1F;
            --success: #32D74B;
            --error: #FF453A;
            --warning: #FFD60A;
            --info: #0A84FF;

            /* åœ“è§’ç³»çµ± */
            --radius-s: 8px;
            --radius-m: 16px;
            --radius-l: 24px;
            --radius-pill: 50px;

            /* é–“è·ç³»çµ± */
            --space-xs: 4px;
            --space-s: 8px;
            --space-m: 16px;
            --space-l: 24px;
            --space-xl: 32px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            /* AJA å…§æ–‡å­—é«”ï¼šMontserrat */
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }

        html {
            height: 100%;
        }

        body {
            margin: 0;
            /* AJA å¥¶æ²¹ç™½èƒŒæ™¯ */
            background-color: var(--cream-bg);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 24px;
        }

        /* Safe Centering Container */
        .login-content {
            width: 100%;
            margin: auto 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            padding-bottom: 40px;
        }

        /* æ¨™é¡Œå­—é«”ï¼šRufina è¥¯ç·šé«” + å¤§åœ°é‡‘ */
        h1 {
            font-family: 'Rufina', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 0 0 8px 0;
            color: var(--earth-gold);
            /* å¤§åœ°é‡‘ - å‰µæ–°æ€ç¶­ */
            text-align: center;
        }

        h2 {
            font-family: 'Rufina', Georgia, serif;
            font-size: 34px;
            font-weight: 700;
            margin: 0;
            color: var(--text-dark);
        }

        .subtitle {
            font-size: 12px;
            color: var(--rose-gold);
            /* ç«ç‘°é‡‘ - å°ˆæ¥­æœ¬ä½ */
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 36px;
            opacity: 0.9;
        }

        /* è¼¸å…¥å€å¡Š - æ›œçŸ³ç°å¡ç‰‡ */
        .input-group {
            background: var(--obsidian-grey);
            /* æ›œçŸ³ç° - è¬¹æ…ç´€å¾‹ */
            border-radius: var(--radius-l);
            padding: 0;
            margin-bottom: 24px;
            border: 1px solid rgba(155, 138, 94, 0.2);
            /* å¤§åœ°é‡‘é‚Šæ¡† */
            overflow: hidden;
            color: var(--text-primary);
            box-shadow: 0 8px 32px rgba(69, 70, 77, 0.4);
        }

        .input-row {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 0.5px solid var(--separator);
            min-height: 56px;
        }

        .input-row:last-child {
            border-bottom: none;
        }

        .input-label {
            width: 70px;
            font-size: 16px;
            color: #FFFFFF;
            /* ğŸ†• Force White */
            font-weight: 500;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: #FFFFFF;
            /* ğŸ†• Force White */
            font-size: 17px;
            /* Prevent zoom on iOS */
            outline: none;
            padding: 0;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
            /* ğŸ†• Opacity White */
        }

        /* Captcha */
        .captcha-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        #cap-box {
            min-height: 50px;
            height: auto;
            background: #fff;
            border-radius: 6px;
            overflow: visible;
            cursor: pointer;
            min-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }

        #cap-box svg {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Button Primary with Rose Gold Gradient */
        .btn-primary {
            background: linear-gradient(135deg, var(--rose-gold-deep) 0%, var(--rose-gold) 50%, var(--rose-gold-deep) 100%);
            border-radius: var(--radius-pill);
            color: #FFFFFF;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 18px 32px;
            box-shadow: 0 8px 24px rgba(180, 116, 90, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(180, 116, 90, 0.55);
        }

        .btn-secondary {
            background: transparent;
            color: var(--rose-gold);
            /* ç«ç‘°é‡‘ */
            border: 1.5px solid var(--rose-gold);
            padding: 14px 24px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            font-weight: 500;
            margin-top: 24px;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--rose-gold);
            color: #FFFFFF;
        }

        /* Result View */
        .student-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .student-id {
            font-size: 17px;
            color: #86868b;
            margin-top: 4px;
            font-family: monospace;
            letter-spacing: 1px;
        }

        /* æˆç¸¾å¡ç‰‡ - æ›œçŸ³ç°æ·±è‰²å¡ç‰‡ */
        .grade-card {
            background: var(--obsidian-grey);
            /* æ›œçŸ³ç° */
            border-radius: var(--radius-m);
            padding: 20px 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(155, 138, 94, 0.15);
            /* å¤§åœ°é‡‘é‚Šæ¡† */
            color: var(--text-primary);
            box-shadow: 0 8px 24px rgba(69, 70, 77, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .grade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(69, 70, 77, 0.45);
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .subject-name {
            font-size: 17px;
            font-weight: 600;
            color: #FFFFFF;
            /* ğŸ†• Force White */
        }

        .grade-main-container {
            display: flex;
            align-items: baseline;
            justify-content: flex-end;
            gap: 8px;
        }

        .grade-val {
            font-size: 28px;
            font-weight: 700;
            color: #FFFFFF;
            /* ğŸ†• Force White */
            font-variant-numeric: tabular-nums;
        }

        /* Trend Badges */
        .trend-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
        }

        .trend-pill.up {
            background: rgba(255, 69, 58, 0.15);
            color: var(--error);
        }

        .trend-pill.down {
            background: rgba(50, 215, 75, 0.15);
            color: var(--success);
        }

        .trend-pill.flat {
            background: rgba(142, 142, 147, 0.15);
            color: var(--text-secondary);
        }

        /* Stats Footer in Card */
        .stats-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 16px;
        }

        .stat-item {
            font-size: 14px;
            /* Was 12px */
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-val {
            color: var(--earth-gold);
            /* å¤§åœ°é‡‘ */
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
        }


        .grade-card.semester-highlight .grade-val {
            font-size: 72px;
            color: var(--earth-gold);
            font-weight: 900;
        }



        .homework-unit {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
            margin-left: 8px;
        }

        /* Loading */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--rose-gold);
            /* ç«ç‘°é‡‘ */
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        #toast {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(50, 50, 50, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* ğŸ†• Announcement Banner */
        .announce-container {
            width: 100%;
            margin-bottom: 24px;
        }

        .announce-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius-m);
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            align-items: start;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            animation: slideInDown 0.5s ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ğŸ†• Starlux-Apple Skill Compliant Announcement Colors */
        .announce-item.info {
            background: rgba(10, 132, 255, 0.1);
            /* --info */
            color: #0A84FF;
            border-left: 4px solid var(--info);
        }

        .announce-item.warning {
            background: rgba(255, 214, 10, 0.1);
            /* --warning */
            color: var(--rose-gold);
            /* ç«ç‘°é‡‘å¢åŠ æ˜Ÿå®‡æ„Ÿ */
            border-left: 4px solid var(--warning);
        }

        .announce-item.emergency {
            background: rgba(255, 69, 58, 0.1);
            /* --error */
            color: var(--error);
            border-left: 4px solid var(--error);
        }

        .announce-icon {
            font-size: 18px;
            flex-shrink: 0;
            margin-top: 2px;
        }
    </style>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
    </div>
    <div id="toast"><span>Alert</span></div>

    <!-- Login View -->
    <div id="view-login" class="app-container">
        <div class="login-content">
            <h1>æˆç¸¾æŸ¥è©¢</h1>
            <div class="subtitle">PHYSICS DEPARTMENT</div>

            <div class="input-group">
                <div class="input-row">
                    <span class="input-label">å­¸è™Ÿ</span>
                    <input type="number" id="inp-id" placeholder="Student ID" inputmode="numeric">
                </div>
                <div class="input-row">
                    <span class="input-label">æŸ¥è©¢ç¢¼</span>
                    <input type="password" id="inp-pwd" placeholder="Code" inputmode="numeric">
                </div>
            </div>

            <div class="input-group">
                <div class="captcha-row">
                    <input type="text" id="inp-cap" placeholder="é©—è­‰ç¢¼ Answer"
                        style="width: 100px; text-align: left; padding-left: 16px;">
                    <div id="cap-box">Loading...</div>
                </div>
            </div>

            <button class="btn-primary" onclick="doLogin()">ç™»å…¥æŸ¥è©¢ Login</button>

            <!-- å®‰å…¨è­¦å‘Šå€å¡Š -->
            <div
                style="margin-top: 24px; padding: 24px; background: var(--obsidian-grey); border: 1px solid rgba(155, 138, 94, 0.25); border-radius: var(--radius-m); box-shadow: 0 8px 24px rgba(69, 70, 77, 0.3);">
                <div
                    style="font-size: 14px; font-weight: 700; color: var(--earth-gold); margin-bottom: 14px; letter-spacing: 1px; text-transform: uppercase;">
                    âš ï¸ Security Notice
                </div>
                <div
                    style="font-size: 13px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; border-left: 3px solid var(--rose-gold); padding-left: 14px;">
                    æœ¬ç³»çµ±å·²å•Ÿç”¨å®Œæ•´å®‰å…¨æ—¥èªŒã€‚æ‰€æœ‰æ“ä½œå‡è¢«è¨˜éŒ„ï¼Œæƒ¡æ„é–å®šä»–äººå¸³è™Ÿå°‡è¢«è¿½æŸ¥ä¸¦ä¾æ³•è™•ç†ã€‚
                </div>
                <div
                    style="font-size: 11px; color: rgba(255,255,255,0.5); font-family: 'SF Mono', 'Monaco', 'Courier', monospace; background: rgba(0,0,0,0.3); padding: 14px; border-radius: var(--radius-s); line-height: 2.0; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: rgba(255,255,255,0.4);">ğŸ‘¤ User:</span>
                        <span id="user-identity" style="color: var(--earth-gold); font-weight: 600;">é©—è­‰ä¸­...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: rgba(255,255,255,0.4);">ğŸ“ SID:</span>
                        <span id="session-id" style="color: var(--earth-gold-light); font-weight: 500;">è¼‰å…¥ä¸­...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: rgba(255,255,255,0.4);">â° TIME:</span>
                        <span id="access-time" style="color: var(--earth-gold-light); font-weight: 500;">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            </div>

            <p style="text-align:center; color:var(--text-secondary); font-size:12px; margin-top:16px;">
                Designed by MAXCHAN V9.0 (Physics Edition)
            </p>
        </div>
    </div>

    <!-- Result View -->
    <div id="view-result" class="app-container" style="display:none;">
        <div class="student-header">
            <h2 id="disp-name">--</h2>
            <div class="student-id" id="disp-id">--</div>
        </div>

        <!-- ğŸ†• Announcements Area -->
        <div id="announce-area" class="announce-container"></div>

        <div id="list-container">
            <!-- Cards go here -->
        </div>

        <button class="btn-secondary" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
    </div>

    <script>
        // Init
        let token = '';
        let sessionId = '';  // ğŸ†• è¿½è¹¤ç¢¼
        window.onload = function () {
            loadCaptcha();
            initSecurityInfo();  // ğŸ†• åˆå§‹åŒ–å®‰å…¨è³‡è¨Š
        };
        const capBox = document.getElementById('cap-box');
        capBox.onclick = loadCaptcha;

        // ğŸ†• åˆå§‹åŒ–å®‰å…¨è³‡è¨Š
        function initSecurityInfo() {
            // ç”Ÿæˆ Session IDï¼ˆçœŸå¯¦çš„è¿½è¹¤ç¢¼ï¼‰
            const timestamp = new Date().toISOString().replace(/[-:]/g, '').slice(0, 15);
            const random = Math.random().toString(36).substring(2, 8);
            sessionId = `${timestamp}-${random}`;

            // æ ¼å¼åŒ–æ™‚é–“
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            // ğŸ†• æ›´æ–°é¡¯ç¤º (é¡¯ç¤ºçœŸå¯¦ Email)
            // userEmail è®Šæ•¸ç”±å¾Œç«¯ doGet å‚³å…¥ (é€é Scriptlet)
            document.getElementById('user-identity').textContent = "<?= userEmail ?>";
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('access-time').textContent = timeStr;
        }

        function loadCaptcha() {
            capBox.innerHTML = '<span style="color:#999;font-size:12px;">...</span>';
            google.script.run.withSuccessHandler(r => {
                capBox.innerHTML = r.svg;
                token = r.token;
            }).getCaptcha();
        }

        function showToast(msg, type = 'normal') {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = type === 'error' ? 'visible error' : 'visible';
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

        function doLogin() {
            const id = document.getElementById('inp-id').value;
            const pwd = document.getElementById('inp-pwd').value;
            const cap = document.getElementById('inp-cap').value;
            const seat = document.getElementById('inp-seat')?.value || null;  // ğŸ†• åº§è™Ÿ
            if (!id || !pwd || !cap) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            document.getElementById('loader').style.display = 'flex';
            google.script.run.withSuccessHandler(res => {
                document.getElementById('loader').style.display = 'none';
                if (!res.success) {
                    // ğŸ†• è™•ç†åº§è™Ÿé©—è­‰è¦æ±‚
                    if (res.requireSeatNumber) {
                        showSeatNumberInput();
                    }
                    // ğŸ†• è™•ç†æ¼¸é€²å¼å»¶é²
                    if (res.waitSeconds) {
                        showCountdown(res.waitSeconds);
                        disableLoginButton(res.waitSeconds);
                    }
                    showToast(res.message, 'error');
                    if (!res.locked && !res.waitSeconds) {
                        document.getElementById('inp-cap').value = '';
                        loadCaptcha();
                    }
                } else {
                    renderResult(res.data, res.config, res.announcements);
                }
            }).login(id, pwd, token, cap, seat, sessionId);  // ğŸ†• æ–°å¢ sessionId åƒæ•¸
        }

        // ğŸ†• å‹•æ…‹é¡¯ç¤ºåº§è™Ÿè¼¸å…¥æ¡†
        function showSeatNumberInput() {
            if (document.getElementById('inp-seat')) return;  // å·²å­˜åœ¨

            const seatRow = document.createElement('div');
            seatRow.className = 'input-row';
            seatRow.id = 'seat-row';
            seatRow.style.animation = 'slideIn 0.3s ease';
            seatRow.innerHTML = `
                <label>ğŸ“ åº§è™Ÿ</label>
                <input type="text" id="inp-seat" placeholder="è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ" />
            `;

            const pwdRow = document.querySelector('.input-row:has(#inp-pwd)');
            pwdRow.after(seatRow);

            // è‡ªå‹•èšç„¦åº§è™Ÿè¼¸å…¥æ¡†
            setTimeout(() => document.getElementById('inp-seat').focus(), 100);
        }

        // ğŸ†• é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨
        function showCountdown(seconds) {
            const toast = document.getElementById('toast');
            let remaining = seconds;

            const updateCountdown = () => {
                if (remaining > 0) {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    const timeStr = mins > 0 ? `${mins} åˆ† ${secs} ç§’` : `${secs} ç§’`;
                    toast.innerHTML = `â³ è«‹ç¨å€™ ${timeStr} å†è©¦`;
                    toast.className = 'visible error';
                    remaining--;
                    setTimeout(updateCountdown, 1000);
                } else {
                    toast.classList.remove('visible');
                    showToast('å¯ä»¥å†æ¬¡å˜—è©¦äº†ï¼');
                }
            };
            updateCountdown();
        }

        // ğŸ†• ç¦½ç”¨ç™»å…¥æŒ‰éˆ• N ç§’
        function disableLoginButton(seconds) {
            const btn = document.querySelector('.btn-primary');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';

            setTimeout(() => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                loadCaptcha();  // é‡æ–°è¼‰å…¥é©—è­‰ç¢¼
            }, seconds * 1000);
        }

        function renderResult(data, config, announcements) {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-result').style.display = 'flex';

            // ğŸ†• Store config in data object for easier access in loop
            data.config = config;

            // ğŸ†• Render Announcements
            const announceArea = document.getElementById('announce-area');
            announceArea.innerHTML = '';
            if (announcements && announcements.length > 0) {
                announcements.forEach(a => {
                    const el = document.createElement('div');
                    el.className = `announce-item ${a.type}`;
                    let icon = 'â„¹ï¸';
                    if (a.type === 'warning') icon = 'âš ï¸';
                    if (a.type === 'emergency') icon = 'ğŸš¨';

                    el.innerHTML = `
                        <div class="announce-icon">${icon}</div>
                        <div>${a.message}</div>
                    `;
                    announceArea.appendChild(el);
                });
            }

            document.getElementById('disp-name').innerText = data['å§“å'] || 'åŒå­¸';
            document.getElementById('disp-id').innerText = data['å­¸è™Ÿ'];

            // Debug Log (Hidden from UI, visible in Console as requested previously)
            if (data._debug) {
                console.group('Backend Debug Logic');
                data._debug.forEach(l => console.log(l));
                console.groupEnd();
            }

            const container = document.getElementById('list-container');
            container.innerHTML = '';

            const stats = data._stats || {};

            // ğŸ†• å›ºå®šé¡¯ç¤ºé †åºï¼ˆç”±ä¸Šåˆ°ä¸‹ï¼‰
            const displayOrder = [
                'ç¬¬ä¸€æ¬¡æ®µè€ƒ',
                'ç¬¬äºŒæ¬¡æ®µè€ƒ',
                'æœŸæœ«è€ƒ',
                'å°è€ƒå¹³å‡',
                'ç¼ºäº¤',
                'å¹³æ™‚',
                'å­¸æœŸ'
            ];

            // æ¸²æŸ“å‡½å¼
            const renderGradeCard = (key) => {
                if (!data.hasOwnProperty(key)) return; // è‹¥æ¬„ä½ä¸å­˜åœ¨å‰‡è·³é

                const val = data[key];
                if (val === undefined || val === null) return; // è‹¥å€¼ç‚ºç©ºå‰‡è·³é

                const s = stats[key] || {};

                // Trend
                let trendHtml = '';
                if (s.diff !== undefined && s.diff !== null) {
                    const diff = parseFloat(s.diff);
                    if (diff > 0) trendHtml = `<div class="trend-pill up">â–² ${diff}</div>`;
                    else if (diff < 0) trendHtml = `<div class="trend-pill down">â–¼ ${Math.abs(diff)}</div>`;
                    else trendHtml = `<div class="trend-pill flat">-</div>`;
                }

                // Stats (æ’åèˆ‡å¹³å‡)
                let footerHtml = '';
                // ğŸ†• ä½¿ç”¨å¾Œç«¯å‚³ä¾†çš„ Configï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
                const noStatsFields = (data.config && data.config.noStatsFields) || ['ç¼ºäº¤', 'å°è€ƒå¹³å‡', 'å¹³æ™‚', 'å­¸æœŸ'];
                if (s.avg && !noStatsFields.includes(key)) {
                    footerHtml = `
                        <div class="stats-footer">
                            <div class="stat-item">ç­æ’å <span class="stat-val">${s.rank}</span></div>
                            <div class="stat-item">ç­ç´šå¹³å‡ <span class="stat-val">${s.avg}</span></div>
                        </div>
                    `;
                }

                // ç‰¹æ®Šæ¬„ä½è™•ç†
                let cardClass = 'grade-card';
                let valueDisplay = val;
                let displayName = key; // ğŸ†• æ¬„ä½é¡¯ç¤ºåç¨±

                // ğŸ†• ä¿®æ”¹é¡¯ç¤ºåç¨±
                if (key === 'ç¼ºäº¤') displayName = 'ç¼ºäº¤æ¬¡æ•¸';
                if (key === 'å­¸æœŸ') displayName = 'å­¸æœŸç¸½æˆç¸¾';

                // å­¸æœŸæˆç¸¾ï¼šæ”¾å¤§å¼·èª¿
                if (key === 'å­¸æœŸ' && val !== '-') {
                    cardClass += ' semester-highlight';
                }

                // ä½œæ¥­ç¼ºäº¤ï¼šé¡¯ç¤ºæ¬¡æ•¸ (ç§»é™¤è­¦ç¤ºè‰²)
                if (key === 'ç¼ºäº¤') {
                    const count = parseInt(val);
                    valueDisplay = `${val}<span class="homework-unit">æ¬¡</span>`;
                }

                const card = document.createElement('div');
                card.className = cardClass;
                card.innerHTML = `
                    <div class="grade-header">
                        <span class="subject-name">${displayName}</span>
                        ${trendHtml}
                    </div>
                    <div class="grade-main-container">
                        <span class="grade-val">${valueDisplay}</span>
                    </div>
                    ${footerHtml}
                `;
                container.appendChild(card);
            };

            // æŒ‰ç…§å›ºå®šé †åºæ¸²æŸ“
            displayOrder.forEach(key => renderGradeCard(key));
        }
    </script>
</body>

</html>