<!DOCTYPE html>
<html lang="zh-TW" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教學進度 V9</title>

    <!-- PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#9B8A5E">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">

    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&family=Rufina:wght@400;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        premium: {
                            gold: '#9B8A5E', // Earth Gold
                            goldDark: '#7B6D45',
                            rose: '#B4745A', // Rose Gold
                            obsidian: '#45464D', // Obsidian Grey
                            obsidianLight: '#505159',
                            warmBeige: '#F5F5F0',
                        }
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <style>
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4,
        .font-display {
            font-family: 'Rufina', 'Montserrat', serif;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-pop {
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .micro-interaction:active {
            transform: scale(0.95);
        }

        .stagger-enter {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
            }

            header,
            .fixed.bottom-0,
            button,
            .no-print,
            select,
            .animate-pop>h2 {
                display: none !important;
            }

            .page-break {
                page-break-before: always;
            }

            /* Hide forms and settings */
            .lg\:col-span-12 .flex.gap-4 {
                display: none !important;
            }

            /* Hide Dashboard Scroller */
            .lg\:col-span-5 {
                display: none !important;
            }

            .lg\:col-span-7 {
                width: 100% !important;
                display: block !important;
            }

            /* Print friendly list */
            .bg-white,
            .dark\:bg-starlux-obsidianLight {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
                background: white !important;
                color: black !important;
            }

            .font-black,
            .font-bold {
                color: black !important;
            }

            .text-gray-400,
            .text-gray-500 {
                color: #666 !important;
            }

            /* Signature area */
            .print-footer {
                display: block !important;
                margin-top: 50px;
                border-top: 2px solid black;
                padding-top: 20px;
                text-align: right;
            }
        }

        .print-footer {
            display: none;
        }
    </style>
</head>

<body
    class="bg-[#F5F5F0] dark:bg-[#45464D] text-[#1C1C1E] dark:text-gray-100 transition-colors duration-300 pb-24 md:pb-0">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Robust Icon Component ---
        // --- Robust Icon Component (Safe for React) ---
        // --- Robust Icon Component (Safe for React) ---
        const LucideIcon = React.memo(({ name, size = 24, className }) => {
            const [svgContent, setSvgContent] = useState('');

            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name] && window.lucide.createElement) {
                    try {
                        // createElement returns a DOM Node (SVGElement)
                        const element = window.lucide.createElement(window.lucide.icons[name]);

                        // Apply props manually to the generated element
                        element.setAttribute('width', size);
                        element.setAttribute('height', size);
                        if (className) element.setAttribute('class', className);
                        element.setAttribute('stroke-width', '2.5');

                        setSvgContent(element.outerHTML);
                    } catch (e) {
                        console.error("Icon render error:", e);
                    }
                }
            }, [name, size, className]);

            // Render SVG inside the span
            return <span className="flex items-center justify-center shrink-0" style={{ width: size, height: size }} dangerouslySetInnerHTML={{ __html: svgContent }} />;
        }, (prevProps, nextProps) =>
            prevProps.name === nextProps.name &&
            prevProps.size === nextProps.size &&
            prevProps.className === nextProps.className
        );

        // V9 Optimization #3: React.memo for components
        const AppleCard = React.memo(({ children, className = "" }) => (
            <div className={`bg-white dark:bg-premium-obsidianLight rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.04)] dark:shadow-none p-6 sm:p-8 border border-transparent dark:border-white/10 ${className}`}>
                {children}
            </div>
        ));

        const AppleButton = React.memo(({ onClick, iconName, label, variant = 'primary', className = "", disabled = false, size = "md", type = "button" }) => {
            const sizeClasses = size === 'sm' ? 'px-4 py-2 text-base' : 'px-6 py-4 text-lg';
            const vars = {
                primary: "bg-[#9B8A5E] text-white hover:bg-[#7B6D45] dark:bg-[#B4745A] dark:text-white dark:hover:bg-[#C88569] shadow-yellow-900/10",
                secondary: "bg-gray-100 text-gray-900 hover:bg-gray-200 dark:bg-white/10 dark:text-white dark:hover:bg-white/20",
                ghost: "bg-transparent text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10",
                header: "bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm shadow-none"
            };
            return (
                <button onClick={onClick} type={type} disabled={disabled} className={`flex items-center justify-center gap-2.5 font-bold tracking-wide transition-all rounded-full active:scale-95 disabled:opacity-50 ${sizeClasses} ${vars[variant]} ${className}`}>
                    {iconName && <LucideIcon name={iconName} size={size === 'sm' ? 20 : 24} />}
                    {label && <span>{label}</span>}
                </button>
            );
        });

        const AppleBadge = ({ label, value, urgent, total }) => {
            // Simple visual stat: circular progress or just a bar
            const percentage = total > 0 ? Math.min(100, Math.round((value / total) * 100)) : 0;
            return (
                <div className={`relative overflow-hidden flex flex-col items-center justify-center px-4 py-3 rounded-2xl flex-1 min-w-[80px] transition-colors ${urgent ? 'bg-[#9B8A5E] dark:bg-[#B4745A] text-white' : 'bg-gray-50 dark:bg-white/5 text-gray-600 dark:text-gray-300'}`}>
                    {/* Visual Progress Bar Background */}
                    {!urgent && <div className="absolute bottom-0 left-0 h-1.5 bg-[#9B8A5E]/20 dark:bg-[#B4745A]/30 transition-all" style={{ width: `${percentage}%` }}></div>}

                    <span className={`text-xs font-bold uppercase tracking-widest ${urgent ? 'opacity-90' : 'opacity-50'}`}>{label}</span>
                    <span className="text-2xl font-black mt-1 leading-none relative z-10">{value}</span>
                    <span className="text-[10px] opacity-60 font-bold mt-1">堂</span>
                </div>
            );
        };

        function ClassTrackerV8() {
            const DEFAULT_YEARS = ['113-1', '113-2', '114-1', '114-2'];
            const DEFAULT_CURRENT_YEAR = '114-1';
            const INITIAL_HOLIDAYS = ['2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-28', '2025-04-03', '2025-04-04', '2025-05-30', '2025-10-10', '2026-01-01'];
            const GOV_API_URL = "https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/2025.json";

            const formatDate = (d) => {
                const z = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
                return z.toISOString().split('T')[0];
            };
            const getDayBefore = (s) => { if (!s) return null; const d = new Date(s); d.setDate(d.getDate() - 1); return formatDate(d); };
            const weekDays = ['一', '二', '三', '四', '五', '六', '日'];

            const [academicYears, setAcademicYears] = useState(DEFAULT_YEARS);
            const [currentYear, setCurrentYear] = useState(DEFAULT_CURRENT_YEAR);
            const [records, setRecords] = useState([]);
            const [classes, setClasses] = useState([]);
            const [exams, setExams] = useState({}); // V8.6: { "113-1": { ... }, "113-2": { ... } }
            const [holidays, setHolidays] = useState(INITIAL_HOLIDAYS);

            const [viewMode, setViewMode] = useState('list');
            const [darkMode, setDarkMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [settingTab, setSettingTab] = useState('class');
            const [filter, setFilter] = useState('');

            const [form, setForm] = useState({ className: '', subject: '', date: formatDate(new Date()), progress: '', homework: '', quiz: false, tags: [], note: '' });
            const [tags, setTags] = useState(['複習', '實驗', '影片', '學習單', '分組', '口試']);
            const [expandedClasses, setExpandedClasses] = useState({});
            const [calendarDate, setCalendarDate] = useState(new Date());
            const [restoreText, setRestoreText] = useState('');

            // V8.6 New State: Undo Delete
            const [deletedRecord, setDeletedRecord] = useState(null);
            const undoTimeoutRef = useRef(null);

            // V8.6 New State: Edit Record
            const [editingRecord, setEditingRecord] = useState(null);

            // V8.6 New State: Cloud Sync (Restored from V8.4)
            const [cloudSettings, setCloudSettings] = useState({ gasUrl: '' });

            // V8.6 D&D Sorting Refs
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);



            useEffect(() => {
                const load = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) || def; } catch { return def; } };
                // V9 Migration: keys v9_, try loading v8_6_ if v9_ is empty
                const loadMigrate = (k9, k86, def) => {
                    const v9 = load(k9, null);
                    if (v9 !== null) return v9;
                    return load(k86, def);
                };

                setAcademicYears(loadMigrate('v9_years', 'v8_6_years', DEFAULT_YEARS));
                setCurrentYear(localStorage.getItem('v9_current_year') || localStorage.getItem('v8_6_current_year') || DEFAULT_CURRENT_YEAR);
                setRecords(loadMigrate('v9_records', 'v8_6_records', []));
                setClasses(loadMigrate('v9_classes', 'v8_6_classes', []));

                // V9 Exam Migration
                const loadedExams = loadMigrate('v9_exams', 'v8_6_exams', {});
                setExams(loadedExams);
                setHolidays(loadMigrate('v9_holidays', 'v8_6_holidays', INITIAL_HOLIDAYS));
                setTags(loadMigrate('v9_tags', 'v8_6_tags', ['複習', '實驗', '影片', '學習單', '分組', '口試']));

                if (localStorage.getItem('v9_theme') === 'dark' || (!('v9_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
                if (window.lucide) window.lucide.createIcons();
            }, []);

            // V9 Optimization #1: Consolidated localStorage writes
            const persistentData = useMemo(() => ({
                records, classes, exams, holidays,
                years: academicYears, tags, currentYear, cloudSettings
            }), [records, classes, exams, holidays, academicYears, tags, currentYear, cloudSettings]);

            useEffect(() => {
                Object.entries(persistentData).forEach(([key, value]) => {
                    const storageKey = key === 'years' ? 'v9_years' :
                        key === 'currentYear' ? 'v9_current_year' :
                            key === 'cloudSettings' ? 'v9_cloud_settings' : `v9_${key}`;
                    localStorage.setItem(storageKey, typeof value === 'string' ? value : JSON.stringify(value));
                });
            }, [persistentData]);

            useEffect(() => {
                if (darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('v9_theme', 'dark'); }
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('v9_theme', 'light'); }
                if (window.lucide) window.lucide.createIcons();
            }, [darkMode]);

            // Sync: Upload a single record
            const uploadRecordToCloud = async (record) => {
                if (!cloudSettings.gasUrl) return;
                try {
                    await fetch(cloudSettings.gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'add_record', record })
                    });
                    console.log('Record uploaded to cloud');
                } catch (e) {
                    console.error('Upload failed', e);
                }
            };

            // Sync: Download all records
            const syncFromCloud = async () => {
                if (!cloudSettings.gasUrl) { alert('請先設定 Google Apps Script URL'); return; }
                try {
                    const res = await fetch(cloudSettings.gasUrl);
                    const cloudRecords = await res.json();

                    const localIds = new Set(records.map(r => r.id));
                    const newRecords = cloudRecords.filter(r => !localIds.has(r.id));

                    if (newRecords.length > 0) {
                        const sanitizedRecords = newRecords.map(r => ({
                            ...r,
                            date: r.date && r.date.includes('T') ? r.date.split('T')[0] : r.date,
                            tags: typeof r.tags === 'string' ? r.tags.split(',').filter(Boolean) : (Array.isArray(r.tags) ? r.tags : [])
                        }));

                        setRecords(prev => [...sanitizedRecords, ...prev].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));

                        // Auto-create missing classes
                        const newClasses = [];
                        const existingClassMap = new Set(classes.map(c => c.name + '_' + c.year));

                        sanitizedRecords.forEach(r => {
                            const key = r.className + '_' + r.year;
                            if (!existingClassMap.has(key)) {
                                newClasses.push({ name: r.className, year: r.year, days: [] });
                                existingClassMap.add(key);
                            }
                        });

                        if (newClasses.length > 0) {
                            setClasses(prev => [...prev, ...newClasses]);
                            alert(`已同步 ${newRecords.length} 筆新資料，並自動建立了 ${newClasses.length} 個新班級！`);
                        } else {
                            alert(`已同步 ${newRecords.length} 筆新資料！`);
                        }
                    } else {
                        alert('目前沒有新資料。');
                    }
                } catch (e) {
                    console.error('Sync failed', e);
                    alert('同步失敗，請檢查網址或權限');
                }
            };



            const currentExams = useMemo(() => exams[currentYear] || { exam1: { start: '', end: '' }, exam2: { start: '', end: '' }, exam3: { start: '', end: '' } }, [exams, currentYear]);

            const currentYearClasses = useMemo(() => classes.filter(c => c.year === currentYear), [classes, currentYear]);
            const currentYearRecords = useMemo(() => records.filter(r => r.year === currentYear), [records, currentYear]);

            const isClassDoneToday = (className) => {
                const today = formatDate(new Date());
                return currentYearRecords.some(r => r.className === className && r.date === today);
            };

            // V9 Optimization #2: Improved calculateSessions algorithm (O(1) complexity)
            const calculateSessions = (sStr, eStr, days) => {
                if (!sStr || !eStr || !days?.length) return 0;

                const start = new Date(sStr);
                const end = new Date(eStr);
                if (start > end) return 0;

                const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const startDay = start.getDay();

                // Calculate weekday occurrences
                let count = days.reduce((acc, day) => {
                    const offset = (day - startDay + 7) % 7;
                    const fullWeeks = Math.floor((totalDays - offset - 1) / 7) + (offset < totalDays ? 1 : 0);
                    return acc + (fullWeeks < 0 ? 0 : fullWeeks);
                }, 0);

                // Subtract holidays that fall on class days
                const holidayCount = holidays.filter(h => {
                    const hDate = new Date(h);
                    return hDate >= start && hDate <= end && days.includes(hDate.getDay());
                }).length;

                return Math.max(0, count - holidayCount);
            };

            const currentClassStats = useMemo(() => {
                if (!form.className) return null;
                const target = currentYearClasses.find(c => c.name === form.className);
                if (!target?.days?.length) return null;

                let startDate = new Date();
                if (isClassDoneToday(form.className)) {
                    startDate.setDate(startDate.getDate() + 1);
                }
                const startStr = formatDate(startDate);

                const getEnd = (ex) => ex.start ? getDayBefore(ex.start) : null;
                // V8.6: Calculate totals for visual stats
                // Note: accurate total sessions calculation is complex as it depends on PAST sessions too.
                // For "remaining", we just show remaining. To show progress, we might need (past / (past + remaining)).
                // Simplified: Just use remaining. The badge visualization will be "remaining intensity" or just decoration?
                // Visual Stats: Let's assume a 'full' semester is ~20 weeks * N classes. 
                // Let's just make the bar full if > 0. Or maybe randomize/estimate? 
                // Better: (Remaining Sessions) vs (Approx Total Sessions in Exam Period).
                // Let's implement strict calc: Sessions between Start of Semester (or Previous Exam) and Next Exam.
                // Too complex for single file quickly. Let's make it decoration: 
                // Badge bg bar width = (100 - (remaining / 20 * 100))% ?? No, let's keep it simple.
                // Idea: Compare Remaining to "Total Possible in Period".
                // For now, pass remaining as value.

                // V8.6: Calculate totals for visual stats (Estimate: 6 weeks per exam period)
                const weekly = target.days.length;
                return {
                    exam1: currentExams.exam1.start ? calculateSessions(startStr, getEnd(currentExams.exam1), target.days) : 0,
                    exam1Total: weekly * 6,
                    exam2: currentExams.exam2.start ? calculateSessions(startStr, getEnd(currentExams.exam2), target.days) : 0,
                    exam2Total: weekly * 6,
                    exam3: currentExams.exam3.start ? calculateSessions(startStr, getEnd(currentExams.exam3), target.days) : 0,
                    exam3Total: weekly * 8
                };
            }, [form.className, currentYearClasses, exams, holidays, currentYearRecords]);

            const todayClasses = useMemo(() => {
                const day = new Date().getDay();
                if (holidays.includes(formatDate(new Date()))) return [];
                const doneClasses = currentYearRecords.filter(r => r.date === formatDate(new Date())).map(r => r.className);
                return currentYearClasses
                    .filter(c => c.days && c.days.includes(day))
                    .map(c => ({ ...c, isDone: doneClasses.includes(c.name) }));
            }, [currentYearClasses, currentYearRecords, holidays]);

            const handleExport = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM
                csvContent += "日期,班級,科目,進度,作業,標籤\n";
                const sortedRecords = [...currentYearRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedRecords.forEach(r => {
                    const cleanTags = [r.quiz ? '小考' : '', ...(r.tags || [])].filter(Boolean).join(';');
                    const row = [
                        r.date,
                        r.className,
                        r.subject,
                        `"${r.progress.replace(/"/g, '""')}"`, // Escape quotes
                        `"${(r.homework || '').replace(/"/g, '""')}"`,
                        cleanTags
                    ];
                    csvContent += row.join(",") + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `教學進度報表_${currentYear}_${formatDate(new Date())}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleExportToClipboard = () => {
                // V8.6 Feature
                const sortedRecords = [...currentYearRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                const text = sortedRecords.map(r =>
                    `${r.date} | ${r.className} | ${r.subject}\n進度: ${r.progress}\n${r.homework ? '作業: ' + r.homework : ''}\n`
                ).join('\n-------------------\n');

                navigator.clipboard.writeText(text).then(() => alert('已複製到剪貼簿！'), () => alert('複製失敗'));
            };

            const getRemainingForClass = (clsName) => {
                const target = classes.find(c => c.name === clsName);
                if (!target?.days?.length) return null;

                let startDate = new Date();
                if (isClassDoneToday(clsName)) {
                    startDate.setDate(startDate.getDate() + 1);
                }
                const startStr = formatDate(startDate);

                let nextExam = null;
                if (currentExams.exam1.start && startStr < currentExams.exam1.start) nextExam = currentExams.exam1;
                else if (currentExams.exam2.start && startStr < currentExams.exam2.start) nextExam = currentExams.exam2;
                else if (currentExams.exam3.start && startStr < currentExams.exam3.start) nextExam = currentExams.exam3;
                if (nextExam) return calculateSessions(startStr, getDayBefore(nextExam.start), target.days);
                return null;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.className || !form.subject || !form.progress) return;
                const newRecord = { id: Date.now(), ...form, year: currentYear, timestamp: new Date().toISOString() };
                setRecords([newRecord, ...records]);
                // Trigger Cloud Upload
                uploadRecordToCloud(newRecord);

                setForm({ ...form, progress: '', homework: '', quiz: false, tags: [], note: '' });
                setExpandedClasses(p => ({ ...p, [form.className]: true }));
            };

            // V8.6: Delete with Undo
            // V8.6: Delete with Undo
            const handleDeleteRecord = (id) => {
                const record = records.find(r => r.id === id);
                if (!record) return;

                // Check if this is the last record for this class/year
                const remaining = records.filter(r => r.className === record.className && r.year === record.year && r.id !== id);
                let classToDelete = null;

                if (remaining.length === 0) {
                    classToDelete = classes.find(c => c.name === record.className && c.year === record.year);
                    if (classToDelete) {
                        setClasses(prev => prev.filter(c => c !== classToDelete));
                    }
                }

                // Remove immediately from UI
                setRecords(prev => prev.filter(r => r.id !== id));

                // set pending delete (attach class info if we deleted it)
                setDeletedRecord({ ...record, _restoredClass: classToDelete });

                // Clear existing timeout
                if (undoTimeoutRef.current) clearTimeout(undoTimeoutRef.current);

                // Set new timeout to clear "deletedRecord" (effectively committing the delete)
                undoTimeoutRef.current = setTimeout(() => {
                    setDeletedRecord(null);
                    undoTimeoutRef.current = null;
                }, 5000);
            };

            const handleUndoDelete = () => {
                if (deletedRecord) {
                    // Restore class if it was auto-deleted
                    if (deletedRecord._restoredClass) {
                        setClasses(prev => {
                            const cls = deletedRecord._restoredClass;
                            if (prev.some(c => c.name === cls.name && c.year === cls.year)) return prev;
                            return [...prev, cls];
                        });
                    }

                    // Restore record (remove internal flag)
                    const { _restoredClass, ...originalRecord } = deletedRecord;
                    setRecords(prev => [...prev, originalRecord].sort((a, b) => b.id - a.id));

                    setDeletedRecord(null);
                    if (undoTimeoutRef.current) clearTimeout(undoTimeoutRef.current);
                }
            };

            // V8.6: Update Record Logic
            const handleUpdateRecord = (e) => {
                e.preventDefault();
                if (!editingRecord) return;
                setRecords(prev => prev.map(r => r.id === editingRecord.id ? editingRecord : r));
                setEditingRecord(null);
            };

            const handleRestore = (e) => {
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if (confirm(`確定還原？`)) {
                            if (d.records) setRecords(d.records);
                            if (d.classes) setClasses(d.classes);
                            if (d.exams) setExams(d.exams);
                            if (d.holidays) setHolidays(d.holidays);
                            alert('還原成功！');
                            setShowSettings(false);
                        }
                    } catch { alert('檔案錯誤'); }
                };
                if (e.target.files[0]) r.readAsText(e.target.files[0]);
                e.target.value = '';
            };

            const handleTextRestore = () => {
                try {
                    const d = JSON.parse(restoreText);
                    if (confirm(`確定還原？`)) {
                        if (d.records) setRecords(d.records);
                        if (d.classes) setClasses(d.classes);
                        if (d.exams) setExams(d.exams);
                        if (d.holidays) setHolidays(d.holidays);
                        alert('還原成功！');
                        setShowSettings(false);
                        setRestoreText('');
                    }
                } catch { alert('格式錯誤，請確認貼上的是正確的 JSON 內容'); }
            };

            // V8.6 D&D Sort Function
            const handleSort = () => {
                // duplicate items
                let _classes = [...classes];

                // Get indices in the FULL list (we need to be careful here)
                // Actually, easier to sort the logical list and reconstruct.

                const currentList = _classes.filter(c => c.year === currentYear);
                const otherList = _classes.filter(c => c.year !== currentYear);

                // remove and save the dragged item content
                const draggedItemContent = currentList.splice(dragItem.current, 1)[0];

                // switch the position
                currentList.splice(dragOverItem.current, 0, draggedItemContent);

                // reset the position ref
                dragItem.current = null;
                dragOverItem.current = null;

                // update the actual state
                setClasses([...otherList, ...currentList]); // Note: this effectively moves current year classes to the end of persistence array, which is fine.
            };

            const getCalendarDays = () => {
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                const startPad = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                for (let i = 0; i < startPad; i++) days.push({ date: null });

                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dateStr = formatDate(new Date(year, month, i));
                    const dayOfWeek = new Date(year, month, i).getDay();
                    const dayRecords = currentYearRecords.filter(r => r.date === dateStr);
                    const isHoliday = holidays.includes(dateStr);
                    const ghostClasses = [];

                    if (!isHoliday) {
                        currentYearClasses.forEach(cls => {
                            if (cls.days && cls.days.includes(dayOfWeek) && !dayRecords.find(r => r.className === cls.name)) {
                                ghostClasses.push(cls);
                            }
                        });
                    }
                    days.push({ date: dateStr, dayNum: i, records: dayRecords, isHoliday, ghostClasses });
                }
                return days;
            };

            const toggleTag = (tag) => {
                const newTags = form.tags.includes(tag)
                    ? form.tags.filter(t => t !== tag)
                    : [...form.tags, tag];
                setForm({ ...form, tags: newTags });
            };

            return (
                <div className="min-h-screen pb-20">
                    <header className="sticky top-0 z-40 bg-[#9B8A5E] dark:bg-black/80 dark:backdrop-blur-md shadow-md border-b border-white/10">
                        <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="bg-white text-[#9B8A5E] p-2.5 rounded-2xl shadow-lg"><LucideIcon name="BookOpen" size={28} /></div>
                                <div><h1 className="text-2xl sm:text-3xl font-black text-white leading-none">教學日誌</h1><span className="text-xs font-bold text-white/80 uppercase">V9</span></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="hidden md:flex items-center bg-white/10 rounded-full px-4 py-2">
                                    <select value={currentYear} onChange={e => setCurrentYear(e.target.value)} className="bg-transparent text-white font-bold text-lg outline-none cursor-pointer [&>option]:text-black">{academicYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                                </div>
                                <AppleButton onClick={() => setDarkMode(!darkMode)} iconName={darkMode ? "Sun" : "Moon"} variant="header" size="sm" className="!px-3" />
                                <div className="hidden md:block w-px h-8 bg-white/20"></div>
                                <div className="hidden md:flex gap-2">
                                    <AppleButton onClick={() => setViewMode('list')} iconName="List" label="列表" variant={viewMode === 'list' ? 'header' : 'ghost'} className={viewMode === 'list' ? 'bg-white/20 text-white' : 'text-white/60 hover:bg-white/10 hover:text-white'} size="sm" />
                                    <AppleButton onClick={() => setViewMode('calendar')} iconName="Calendar" label="月曆" variant={viewMode === 'calendar' ? 'header' : 'ghost'} className={viewMode === 'calendar' ? 'bg-white/20 text-white' : 'text-white/60 hover:bg-white/10 hover:text-white'} size="sm" />
                                </div>
                                <AppleButton onClick={() => setShowSettings(true)} iconName="Settings" variant="header" size="sm" className="hidden md:flex" />
                            </div>
                        </div>
                    </header>

                    {/* Mobile Bottom Navigation */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-white/80 dark:bg-[#45464D]/90 backdrop-blur-lg border-t border-gray-200 dark:border-white/10 pb-safe">
                        <div className="grid grid-cols-4 h-16">
                            <button onClick={() => setViewMode('list')} className={`flex flex-col items-center justify-center gap-1 transition-colors ${viewMode === 'list' && !showSettings ? 'text-[#9B8A5E] dark:text-[#B4745A]' : 'text-gray-400'}`}>
                                <LucideIcon name="LayoutList" size={24} />
                                <span className="text-[10px] font-bold">列表</span>
                            </button>
                            <button onClick={() => setViewMode('calendar')} className={`flex flex-col items-center justify-center gap-1 transition-colors ${viewMode === 'calendar' && !showSettings ? 'text-[#9B8A5E] dark:text-[#B4745A]' : 'text-gray-400'}`}>
                                <LucideIcon name="Calendar" size={24} />
                                <span className="text-[10px] font-bold">月曆</span>
                            </button>
                            <div className="relative -top-6 flex justify-center">
                                <button onClick={() => { setShowSettings(false); setViewMode('list'); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="w-14 h-14 bg-[#9B8A5E] dark:bg-[#B4745A] rounded-full shadow-lg shadow-red-900/20 text-white flex items-center justify-center micro-interaction">
                                    <LucideIcon name="Plus" size={28} />
                                </button>
                            </div>
                            <button onClick={() => setShowSettings(true)} className={`flex flex-col items-center justify-center gap-1 transition-colors ${showSettings ? 'text-[#9B8A5E] dark:text-[#B4745A]' : 'text-gray-400'}`}>
                                <LucideIcon name="Settings" size={24} />
                                <span className="text-[10px] font-bold">設定</span>
                            </button>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 sm:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start mt-2">
                        {/* Today Dashboard */}
                        <div className="lg:col-span-12 mb-4 animate-pop">
                            <h2 className="text-xl font-black text-gray-900 dark:text-white mb-4 flex items-center gap-2"><LucideIcon name="Sparkles" className="text-[#9B8A5E] dark:text-[#B4745A]" /> 今日課表</h2>
                            {todayClasses.length > 0 ? (
                                <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x">
                                    {todayClasses.map(c => (
                                        <div key={c.name} onClick={() => setForm(f => ({ ...f, className: c.name }))} className={`snap-start shrink-0 w-40 p-4 rounded-2xl border cursor-pointer transition-all micro-interaction ${form.className === c.name ? 'bg-[#9B8A5E] border-[#9B8A5E] dark:bg-[#B4745A] dark:border-[#B4745A] shadow-xl text-white' : c.isDone ? 'bg-gray-100 border-transparent dark:bg-white/5 text-gray-400' : 'bg-white border-gray-100 dark:border-white/10 dark:bg-starlux-obsidianLight text-gray-900 dark:text-white'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-xs font-black px-2 py-1 rounded-md ${form.className === c.name ? 'bg-white/20 text-white' : 'bg-gray-200 dark:bg-white/10 text-gray-500'}`}>{weekDays[new Date().getDay() - 1]}</span>
                                                {c.isDone && <LucideIcon name="Check" size={16} className={`${form.className === c.name ? 'text-white' : 'text-gray-400'}`} />}
                                            </div>
                                            <div className="text-xl font-black">{c.name}</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="bg-white/50 dark:bg-white/5 rounded-2xl p-6 text-center text-gray-400 font-bold border border-dashed border-gray-300 dark:border-white/10">
                                    ☕️ 今天沒有課，好好休息吧！
                                </div>
                            )}
                        </div>

                        <div className={`lg:col-span-5 space-y-6 lg:sticky lg:top-28 ${viewMode === 'calendar' ? 'hidden lg:block' : ''}`}>
                            <AppleCard className="border-t-8 border-[#9B8A5E] dark:border-[#B4745A]">
                                <h2 className="text-3xl font-black text-gray-900 dark:text-white mb-6 flex items-center gap-3"><LucideIcon name="Plus" size={32} className="text-[#9B8A5E] dark:text-[#B4745A]" /> 新增進度</h2>
                                <form onSubmit={handleSubmit} className="space-y-6">
                                    <div className="relative">
                                        <select name="className" value={form.className} onChange={e => setForm({ ...form, className: e.target.value })} required className="w-full bg-gray-100 dark:bg-black/20 text-gray-900 dark:text-white font-bold text-2xl p-4 rounded-2xl outline-none focus:ring-4 focus:ring-[#9B8A5E]/20 appearance-none">
                                            <option value="" disabled>選擇班級...</option>
                                            {currentYearClasses.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                        </select>
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><LucideIcon name="ChevronDown" /></div>
                                    </div>

                                    {currentClassStats && (currentExams.exam1.start || currentExams.exam2.start || currentExams.exam3.start) ? (
                                        <div className="bg-gray-50 dark:bg-white/5 rounded-2xl p-2 border border-gray-100 dark:border-white/5 flex gap-2">
                                            <AppleBadge label="一段前" value={currentClassStats.exam1} total={currentClassStats.exam1Total} urgent={currentClassStats.exam1 > 0 && currentClassStats.exam1 < 5} />
                                            <AppleBadge label="二段前" value={currentClassStats.exam2} total={currentClassStats.exam2Total} />
                                            <AppleBadge label="期末前" value={currentClassStats.exam3} total={currentClassStats.exam3Total} />
                                        </div>
                                    ) : (
                                        <div onClick={() => { setShowSettings(true); setSettingTab('exam') }} className="bg-red-50 dark:bg-red-900/20 p-4 rounded-2xl text-center text-red-600 dark:text-red-400 font-bold text-sm cursor-pointer border border-dashed border-red-200">
                                            ⚠ 尚未設定段考日期，點此設定以開啟倒數功能
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="text" placeholder="科目" value={form.subject} onChange={e => setForm({ ...form, subject: e.target.value })} required className="bg-gray-100 dark:bg-black/20 p-4 rounded-2xl font-bold text-lg text-gray-900 dark:text-white outline-none focus:ring-4 focus:ring-[#9B8A5E]/20" />
                                        <input type="date" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })} required className="bg-gray-100 dark:bg-black/20 p-4 rounded-2xl font-bold text-lg text-gray-900 dark:text-white outline-none focus:ring-4 focus:ring-[#9B8A5E]/20" />
                                    </div>

                                    {/* V8.6 Smart Input: Suggest progress from other classes */}
                                    {(() => {
                                        if (!form.subject) return null;
                                        // Find records of DIFFERENT classes but SAME subject in current year
                                        const suggestions = currentYearRecords
                                            .filter(r => r.subject === form.subject && r.className !== form.className)
                                            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

                                        if (suggestions.length > 0) {
                                            const latest = suggestions[0];
                                            return (
                                                <div onClick={() => setForm(f => ({ ...f, progress: latest.progress, homework: latest.homework }))} className="cursor-pointer bg-blue-50 dark:bg-blue-900/20 p-3 rounded-2xl border border-blue-200 dark:border-white/10 flex items-center gap-3 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
                                                    <div className="bg-blue-500 text-white rounded-full p-1"><LucideIcon name="Sparkles" size={16} /></div>
                                                    <div className="flex-1 overflow-hidden">
                                                        <div className="text-xs font-bold text-blue-600 dark:text-blue-300">帶入 {latest.className} ({latest.date}) 進度</div>
                                                        <div className="text-sm font-black text-gray-800 dark:text-white truncate">{latest.progress}</div>
                                                    </div>
                                                </div>
                                            );
                                        }
                                    })()}

                                    <textarea value={form.progress} onChange={e => setForm({ ...form, progress: e.target.value })} required rows={3} className="w-full bg-gray-100 dark:bg-black/20 p-4 rounded-2xl font-bold text-lg text-gray-900 dark:text-white outline-none focus:ring-4 focus:ring-[#9B8A5E]/20 resize-none" placeholder="輸入章節進度..." />
                                    <div className="flex gap-2 flex-wrap mb-4">
                                        <span className="text-xs font-bold text-gray-400 flex items-center mb-1 w-full">標籤</span>
                                        {tags.map(t => (
                                            <button type="button" key={t} onClick={() => toggleTag(t)} className={`px-3 py-1.5 rounded-xl text-xs font-bold transition-all micro-interaction ${form.tags.includes(t) ? 'bg-[#9B8A5E] text-white dark:bg-[#B4745A]' : 'bg-gray-100 text-gray-400 dark:bg-white/10'}`}>
                                                #{t}
                                            </button>
                                        ))}
                                        <button type="button" onClick={() => { const t = prompt('輸入新標籤'); if (t && !tags.includes(t)) setTags([...tags, t]) }} className="px-3 py-1.5 rounded-xl text-xs font-bold bg-gray-200 text-gray-500 dark:bg-white/10 hover:bg-gray-300">+</button>
                                    </div>

                                    <div className="flex items-center justify-between pt-2">
                                        <label className="flex items-center gap-3 cursor-pointer group micro-interaction">
                                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all ${form.quiz ? 'bg-[#9B8A5E] dark:bg-[#B4745A]' : 'bg-gray-200 dark:bg-white/10'}`}>{form.quiz && <LucideIcon name="CheckSquare" size={18} className="text-white" />}</div>
                                            <input type="checkbox" checked={form.quiz} onChange={e => setForm({ ...form, quiz: e.target.checked })} className="hidden" />
                                            <span className="font-bold text-gray-600 dark:text-gray-400">下次小考</span>
                                        </label>
                                        <AppleButton type="submit" iconName="Save" label="儲存" className="px-8 py-3 text-lg shadow-xl shadow-red-900/10" />
                                    </div>
                                </form>
                            </AppleCard>
                        </div>

                        <div className="lg:col-span-7 space-y-6">
                            {viewMode === 'list' && (
                                <div className="space-y-6 animate-pop">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-3xl font-black text-gray-900 dark:text-white">歷史紀錄</h2>
                                        <div className="bg-white dark:bg-[#505159] p-2 rounded-2xl flex items-center shadow-sm w-48 border border-transparent dark:border-white/10">
                                            <div className="pl-3 text-gray-400"><LucideIcon name="Filter" size={20} /></div>
                                            <input type="text" placeholder="搜尋..." value={filter} onChange={e => setFilter(e.target.value)} className="bg-transparent p-2 outline-none font-bold text-base w-full placeholder-gray-300 text-gray-800 dark:text-white" />
                                        </div>
                                    </div>

                                    {currentYearClasses.map((cls, idx) => {
                                        const items = currentYearRecords.filter(r => r.className === cls.name && (r.progress.includes(filter) || r.date.includes(filter) || (r.tags && r.tags.some(t => t.includes(filter)))));
                                        if (!items.length && filter) return null;
                                        const isOpen = expandedClasses[cls.name] !== false;
                                        const remain = getRemainingForClass(cls.name);
                                        return (
                                            <div
                                                key={cls.name}
                                                className="bg-white dark:bg-starlux-obsidianLight rounded-[2rem] shadow-sm overflow-hidden border border-transparent dark:border-white/10 mb-6 break-inside-avoid"
                                                draggable
                                                onDragStart={(e) => {
                                                    dragItem.current = idx;
                                                    e.target.classList.add('opacity-50');
                                                }}
                                                onDragEnter={(e) => {
                                                    dragOverItem.current = idx;
                                                }}
                                                onDragEnd={(e) => {
                                                    e.target.classList.remove('opacity-50');
                                                    handleSort();
                                                }}
                                                onDragOver={(e) => e.preventDefault()}
                                                style={{ animationDelay: `${idx * 0.05}s` }}
                                            >
                                                <div onClick={() => setExpandedClasses(p => ({ ...p, [cls.name]: !p[cls.name] }))} className="p-6 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-colors micro-interaction select-none">
                                                    <div className="flex items-center gap-4">
                                                        <div className="cursor-grab active:cursor-grabbing text-gray-300 hover:text-gray-500 p-1" onMouseDown={e => e.stopPropagation()}>
                                                            <LucideIcon name="GripVertical" size={20} />
                                                        </div>
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-transform ${isOpen ? 'bg-[#9B8A5E] dark:bg-[#B4745A] text-white rotate-90' : 'bg-gray-100 dark:bg-white/10 text-gray-400'}`}><LucideIcon name="ChevronRight" size={18} /></div>
                                                        <div><h3 className="text-2xl font-black text-gray-900 dark:text-white">{cls.name}</h3><p className="text-sm font-bold text-gray-400">{items.length} 筆紀錄</p></div>
                                                    </div>
                                                    {remain !== null && (
                                                        <div className="bg-[#9B8A5E] dark:bg-[#B4745A] text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2">
                                                            <span className="text-xs font-bold opacity-80 uppercase">剩</span><span className="text-xl font-black leading-none">{remain}</span>
                                                        </div>
                                                    )}
                                                </div>
                                                {isOpen && (
                                                    <div className="bg-gray-50/50 dark:bg-black/20 border-t border-gray-100 dark:border-white/5">
                                                        {items.map((r, i) => (
                                                            <div key={r.id} className={`p-6 flex gap-6 group relative ${i !== items.length - 1 ? 'border-b border-gray-200/50 dark:border-white/5' : ''}`}>
                                                                <div className="w-24 text-right">
                                                                    <div className="font-mono text-xl font-black text-gray-900 dark:text-white opacity-80">{r.date.slice(5)}</div>
                                                                    <div className="text-xs font-bold text-gray-400 mt-1">{r.subject}</div>
                                                                </div>
                                                                <div className="flex-1">
                                                                    <p className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">{r.progress}</p>
                                                                    <div className="flex gap-2 flex-wrap">
                                                                        {r.homework && <span className="px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-xs font-bold">作業: {r.homework}</span>}
                                                                        {r.quiz && <span className="px-3 py-1 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg text-xs font-bold">小考</span>}
                                                                        {r.tags && r.tags.map(t => <span key={t} className="px-3 py-1 bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400 rounded-lg text-xs font-bold">#{t}</span>)}
                                                                    </div>
                                                                </div>
                                                                <div className="absolute right-4 top-4 opacity-0 group-hover:opacity-100 flex gap-2 transition-opacity">
                                                                    <button onClick={(e) => { e.stopPropagation(); setEditingRecord(r); }} className="text-gray-300 hover:text-blue-500"><LucideIcon name="Pencil" size={20} /></button>
                                                                    <button onClick={(e) => { e.stopPropagation(); handleDeleteRecord(r.id); }} className="text-gray-300 hover:text-red-500"><LucideIcon name="Trash2" size={20} /></button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )
                                    })}

                                    {/* V8.6 Print Footer */}
                                    <div className="print-footer">
                                        <h3 className="text-xl font-black mb-12">教師簽名：____________________</h3>
                                        <p className="text-sm text-gray-400">Printed by ClassTracker V8.6</p>
                                    </div>
                                </div>
                            )
                            }

                            {viewMode === 'calendar' && (
                                <div className="bg-white dark:bg-[#45464D] rounded-[2rem] p-4 shadow-sm border border-gray-100 dark:border-white/10 overflow-hidden animate-pop">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-black dark:text-white ml-2">行事曆</h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth() - 1)))} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-xl dark:text-white"><LucideIcon name="ChevronLeft" /></button>
                                            <span className="font-black text-xl py-2 dark:text-white">{calendarDate.getFullYear()}/{calendarDate.getMonth() + 1}</span>
                                            <button onClick={() => setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth() + 1)))} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-xl dark:text-white"><LucideIcon name="ChevronRight" /></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-7 mb-4 text-center">
                                        {weekDays.map(d => <div key={d} className="text-gray-400 text-sm font-bold py-2">{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 sm:gap-2">
                                        {getCalendarDays().map((day, i) => (
                                            <div key={i} className={`min-h-[80px] sm:min-h-[120px] rounded-xl p-1.5 sm:p-2 border transition-colors relative flex flex-col gap-1 ${!day.date ? 'border-transparent' : day.isHoliday ? 'bg-red-50 dark:bg-red-900/10 border-red-100 dark:border-red-900/30' : 'bg-gray-50 dark:bg-[#505159] border-gray-100 dark:border-white/5 hover:border-gray-300 dark:hover:border-white/20'}`}>
                                                {day.date && (
                                                    <>
                                                        <div className={`text-right text-sm font-black mb-1 ${day.date === formatDate(new Date()) ? 'text-[#9B8A5E] dark:text-[#B4745A]' : 'text-gray-400'}`}>{day.dayNum}</div>
                                                        {day.records.map(r => (
                                                            <div key={r.id} onClick={() => alert(`${r.className}: ${r.progress}`)} className="cursor-pointer bg-white dark:bg-[#3A3A3C] p-1 sm:px-2 rounded-lg shadow-sm border-l-4 border-[#9B8A5E] dark:border-[#B4745A] text-[10px] sm:text-xs truncate font-bold dark:text-gray-200">{r.className}</div>
                                                        ))}
                                                        {day.ghostClasses.map((c, idx) => (
                                                            // V8.6: Quick Add onClick
                                                            <div key={idx} onClick={() => {
                                                                setForm(f => ({ ...f, className: c.name, date: day.date }));
                                                                alert(`已選擇: ${c.name} (${day.date})\n請填寫進度後儲存。`);
                                                                setViewMode('list');
                                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                                            }} className="cursor-pointer bg-gray-200/50 dark:bg-white/5 p-1 sm:px-2 rounded-lg text-[10px] sm:text-xs truncate font-bold text-gray-400 dark:text-gray-500 border border-dashed border-gray-300 dark:border-white/10 hover:bg-[#9B8A5E]/10 hover:border-[#9B8A5E] hover:text-[#9B8A5E] transition-all">{c.name}?</div>
                                                        ))}
                                                        {day.isHoliday && <div className="text-[10px] text-red-400 font-bold text-center mt-auto">放假</div>}
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-4 text-sm font-bold text-gray-500 justify-center mt-4">
                                        <span className="flex items-center gap-2"><div className="w-3 h-3 bg-[#9B8A5E] dark:bg-[#B4745A] rounded-full"></div> 已上課</span>
                                        <span className="flex items-center gap-2"><div className="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full border border-dashed border-gray-400"></div> 預定 (Ghost)</span>
                                    </div>
                                </div>
                            )
                            }
                        </div >
                    </main >

                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-pop">
                            <div className="bg-white dark:bg-[#45464D] w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl space-y-6 max-h-[90vh] overflow-y-auto no-scrollbar flex flex-col">
                                <div className="flex justify-between items-center"><h3 className="text-3xl font-black text-gray-900 dark:text-white">設定</h3><button onClick={() => setShowSettings(false)} className="bg-gray-100 dark:bg-white/10 p-2 rounded-full"><LucideIcon name="X" className="dark:text-white" /></button></div>
                                <div className="flex bg-gray-100 dark:bg-black/40 p-1.1 rounded-2xl">
                                    {['class', 'exam', 'system'].map(t => (
                                        <button key={t} onClick={() => setSettingTab(t)} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${settingTab === t ? 'bg-white dark:bg-[#505159] text-black dark:text-white shadow-sm' : 'text-gray-400'}`}>{t === 'class' ? '排課' : t === 'exam' ? '段考' : t === 'system' ? '系統' : t}</button>
                                    ))}
                                </div>

                                <div className="flex-1 space-y-6 overflow-y-auto">
                                    {settingTab === 'class' && (
                                        <div className="space-y-6">
                                            <div>
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">新增班級</h4>
                                                <div className="flex gap-2 mb-3">
                                                    <input id="newClass" placeholder="班級名稱" className="flex-1 bg-gray-50 dark:bg-black/20 p-4 rounded-2xl font-bold dark:text-white outline-none" />
                                                    <AppleButton onClick={() => {
                                                        const n = document.getElementById('newClass').value;
                                                        const days = Array.from(document.querySelectorAll('.day-sel:checked')).map(x => parseInt(x.value));
                                                        if (!n) return alert('請輸入班級名稱');
                                                        if (days.length === 0) return alert('請選擇每週上課日（星期幾），否則月曆無法顯示！');
                                                        setClasses([...classes, { name: n, days, year: currentYear }]); document.getElementById('newClass').value = '';
                                                    }} iconName="Plus" />
                                                </div>
                                                <div className="flex justify-between bg-gray-50 dark:bg-black/20 p-4 rounded-2xl">
                                                    {[1, 2, 3, 4, 5].map(d => (
                                                        <label key={d} className="flex flex-col items-center cursor-pointer">
                                                            <input type="checkbox" value={d} className="day-sel hidden peer" />
                                                            <div className="w-10 h-10 rounded-full bg-white dark:bg-white/10 peer-checked:bg-[#9B8A5E] dark:peer-checked:bg-[#B4745A] peer-checked:text-white flex items-center justify-center font-bold text-gray-400 transition-colors">{weekDays[d - 1]}</div>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                {currentYearClasses.map(c => (
                                                    <div key={c.name} className="flex justify-between p-4 bg-gray-50 dark:bg-black/20 rounded-2xl items-center">
                                                        <div>
                                                            <span className="font-bold dark:text-white text-lg block">{c.name}</span>
                                                            <div className="flex gap-1 mt-1">
                                                                {c.days && c.days.length > 0 ?
                                                                    c.days.sort().map(d => <span key={d} className="text-xs bg-white dark:bg-white/10 px-2 py-0.5 rounded text-gray-500 dark:text-gray-300 font-bold">{weekDays[d - 1]}</span>)
                                                                    : <span className="text-xs text-red-500 font-bold">⚠ 未設定星期 (月曆無法顯示)</span>
                                                                }
                                                            </div>
                                                        </div>
                                                        <button onClick={() => setClasses(classes.filter(x => x !== c))} className="text-gray-400 hover:text-red-500"><LucideIcon name="Trash2" size={20} /></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {settingTab === 'exam' && (
                                        <div className="space-y-6">
                                            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl text-blue-700 dark:text-blue-300 text-sm font-bold leading-relaxed border border-blue-100 dark:border-blue-900/30">設定段考日期後，系統將自動計算倒數堂數。</div>
                                            {['exam1', 'exam2', 'exam3'].map((ex, i) => (
                                                <div key={ex} className="bg-gray-50 dark:bg-black/20 p-4 rounded-2xl">
                                                    <label className="text-xs font-black text-gray-400 uppercase tracking-widest block mb-2">{['第一次段考', '第二次段考', '期末考'][i]}</label>
                                                    <div className="flex gap-2 items-center">
                                                        <input type="date" value={currentExams[ex].start} onChange={e => { const newExams = { ...currentExams, [ex]: { ...currentExams[ex], start: e.target.value } }; setExams(prev => ({ ...prev, [currentYear]: newExams })); }} className="flex-1 bg-white dark:bg-[#505159] p-3 rounded-xl font-bold dark:text-white outline-none" />
                                                        <LucideIcon name="ChevronRight" size={20} className="text-gray-300" />
                                                        <input type="date" value={currentExams[ex].end} onChange={e => { const newExams = { ...currentExams, [ex]: { ...currentExams[ex], end: e.target.value } }; setExams(prev => ({ ...prev, [currentYear]: newExams })); }} className="flex-1 bg-white dark:bg-[#505159] p-3 rounded-xl font-bold dark:text-white outline-none" />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {settingTab === 'system' && (
                                        <div className="space-y-6">
                                            <div className="space-y-4">
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest">行政院行事曆同步 (自動)</h4>
                                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl mb-2 text-xs font-bold text-blue-600 dark:text-blue-300">
                                                    系統將自動抓取「今年 ({new Date().getFullYear()})」與「去年 ({new Date().getFullYear() - 1})」的假日資料。
                                                </div>
                                                <AppleButton onClick={async () => {
                                                    const curYear = new Date().getFullYear();
                                                    const prevYear = curYear - 1;
                                                    const years = [curYear, prevYear];
                                                    let count = 0;
                                                    let errors = [];

                                                    try {
                                                        const results = await Promise.all(years.map(async (y) => {
                                                            try {
                                                                const res = await fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${y}.json`);
                                                                if (!res.ok) throw new Error(`${y} 資料未發布`);
                                                                const d = await res.json();
                                                                return d.filter(x => x.isHoliday).map(x => x.date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                                                            } catch (e) {
                                                                errors.push(e.message);
                                                                return [];
                                                            }
                                                        }));

                                                        const newHolidays = results.flat();
                                                        if (newHolidays.length > 0) {
                                                            setHolidays(prev => [...new Set([...prev, ...newHolidays])].sort());
                                                            alert(`已成功匯入 ${years.join(' & ')} 年共 ${newHolidays.length} 筆假日資料！\n${errors.length > 0 ? `(注意：${errors.join(', ')})` : ''}`);
                                                        } else {
                                                            alert(`未找到新資料。\n錯誤：${errors.join(', ')}`);
                                                        }
                                                    } catch (e) { alert(`同步發生未預期錯誤：${e.message}`); }
                                                }} label="一鍵自動同步行事曆" iconName="Calendar" variant="secondary" className="w-full" />
                                            </div>
                                            <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-white/10">
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest">匯出</h4>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <AppleButton onClick={handleExport} label="CSV 報表" iconName="FileSpreadsheet" variant="secondary" className="w-full" size="sm" />
                                                    <AppleButton onClick={handleExportToClipboard} label="複製文字" iconName="Copy" variant="secondary" className="w-full" size="sm" />
                                                </div>
                                            </div>

                                            {/* V8.6: Dynamic Years */}
                                            <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-white/10">
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest">學年管理</h4>
                                                <div className="flex gap-2">
                                                    <input id="newYearInput" placeholder="輸入學年 (e.g. 115-1)" className="flex-1 bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white outline-none" />
                                                    <AppleButton onClick={() => {
                                                        const val = document.getElementById('newYearInput').value;
                                                        if (val && !academicYears.includes(val)) {
                                                            setAcademicYears([...academicYears, val].sort());
                                                            document.getElementById('newYearInput').value = '';
                                                        } else { alert('輸入無效或已存在'); }
                                                    }} iconName="Plus" size="sm" />
                                                </div>
                                            </div>
                                            <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-white/10">
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest">備份與還原</h4>
                                                <AppleButton onClick={() => {
                                                    const a = document.createElement('a');
                                                    a.href = URL.createObjectURL(new Blob([JSON.stringify({ version: "8.5", records, classes, exams, holidays, academicYears })], { type: 'application/json' }));
                                                    a.download = `Backup_${formatDate(new Date())}.json`; a.click();
                                                }} label="下載備份檔" iconName="Download" variant="secondary" className="w-full" />
                                                <div className="relative">
                                                    <label className="flex items-center justify-center gap-2.5 font-bold tracking-wide transition-all rounded-full active:scale-95 px-6 py-4 text-lg bg-transparent text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-white/10 w-full cursor-pointer">
                                                        <LucideIcon name="HardDrive" size={24} />
                                                        <span>讀取備份檔 (還原)</span>
                                                        <input type="file" onChange={handleRestore} className="hidden" accept=".json" onClick={(e) => e.target.value = null} />
                                                    </label>
                                                </div>
                                                <div className="relative pt-4 border-t border-gray-100 dark:border-white/10">
                                                    <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">或：貼上備份內容還原</h4>
                                                    <textarea value={restoreText} onChange={e => setRestoreText(e.target.value)} placeholder="請將 .json 檔案內容複製並貼上到這裡..." className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-2xl text-xs font-mono h-24 mb-2 outline-none dark:text-gray-300" />
                                                    <AppleButton onClick={handleTextRestore} label="確認還原" iconName="Check" variant="ghost" className="w-full text-blue-600 dark:text-blue-400" disabled={!restoreText} />
                                                </div>

                                                <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-white/10">
                                                    <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest">雲端同步設定 (Google Sheet / LINE)</h4>
                                                    <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl text-xs text-blue-600 dark:text-blue-300 font-bold leading-relaxed">
                                                        連結 Google Apps Script (GAS) 可與 Google Sheet 和 LINE Bot 雙向同步。
                                                    </div>
                                                    <div className="space-y-2">
                                                        <input
                                                            type="text"
                                                            placeholder="Google Apps Script URL"
                                                            value={cloudSettings.gasUrl}
                                                            onChange={e => setCloudSettings({ ...cloudSettings, gasUrl: e.target.value })}
                                                            className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white outline-none text-sm"
                                                        />
                                                        <div className="flex gap-2">
                                                            <AppleButton
                                                                onClick={syncFromCloud}
                                                                label="立即同步雲端資料"
                                                                iconName="RefreshCw"
                                                                variant="primary"
                                                                size="sm"
                                                                className="flex-1"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    {/* V8.6 Undo Toast */}
                    {
                        deletedRecord && (
                            <div className="fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 animate-pop" style={{ zIndex: 9999 }}>
                                <div className="bg-[#45464D] dark:bg-white text-white dark:text-black px-6 py-4 rounded-full shadow-2xl flex items-center gap-4">
                                    <span className="font-bold">已刪除 1 筆紀錄</span>
                                    <button onClick={handleUndoDelete} className="text-[#B4745A] dark:text-[#B4745A] font-black uppercase tracking-wide hover:opacity-80">復原 (Undo)</button>
                                </div>
                            </div>
                        )
                    }

                    {/* V8.6 Edit Modal */}
                    {
                        editingRecord && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setEditingRecord(null)}></div>
                                <div className="bg-white dark:bg-[#45464D] rounded-3xl p-6 w-full max-w-lg shadow-2xl relative animate-pop">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-black dark:text-white">編輯紀錄</h2>
                                        <button onClick={() => setEditingRecord(null)} className="p-2 bg-gray-100 dark:bg-white/10 rounded-full dark:text-white hover:bg-gray-200"><LucideIcon name="X" size={20} /></button>
                                    </div>
                                    <form onSubmit={handleUpdateRecord} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs font-bold text-gray-400 block mb-1">日期</label>
                                                <input type="date" value={editingRecord.date} onChange={e => setEditingRecord({ ...editingRecord, date: e.target.value })} className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white" required />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400 block mb-1">班級</label>
                                                <div className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold text-gray-500 dark:text-gray-400">{editingRecord.className}</div>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">科目</label>
                                            <input type="text" value={editingRecord.subject} onChange={e => setEditingRecord({ ...editingRecord, subject: e.target.value })} className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white" required />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">進度內容</label>
                                            <textarea value={editingRecord.progress} onChange={e => setEditingRecord({ ...editingRecord, progress: e.target.value })} rows={3} className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white resize-none" required />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">作業</label>
                                            <input type="text" value={editingRecord.homework || ''} onChange={e => setEditingRecord({ ...editingRecord, homework: e.target.value })} className="w-full bg-gray-50 dark:bg-black/20 p-3 rounded-xl font-bold dark:text-white" placeholder="無" />
                                        </div>
                                        <div className="flex items-center gap-4 py-2 border-t border-gray-100 dark:border-white/10 mt-2">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" checked={editingRecord.quiz || false} onChange={e => setEditingRecord({ ...editingRecord, quiz: e.target.checked })} className="w-5 h-5 accent-[#9B8A5E]" />
                                                <span className="font-bold text-gray-600 dark:text-gray-300">本節有小考</span>
                                            </label>
                                        </div>
                                        <AppleButton type="submit" label="儲存變更" iconName="Save" className="w-full mt-4" />
                                    </form>
                                </div>
                            </div>
                        )
                    }

                    {/* Footer */}
                    <footer className="w-full text-center py-8 mt-8 pb-32 md:pb-8">
                        <p className="text-[10px] font-bold tracking-[0.3em] uppercase text-gray-400 dark:text-gray-600">
                            Designed by <span className="text-[#9B8A5E]">MAXCHAN</span>
                        </p>
                    </footer>
                </div >
            );
        }

        // Error Boundary to catch runtime errors
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-100 dark:bg-[#000000] flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-[#45464D] p-8 rounded-3xl shadow-xl max-w-lg w-full">
                                <h1 className="text-2xl font-black text-red-600 mb-4">發生錯誤</h1>
                                <p className="text-gray-600 dark:text-gray-300 font-bold mb-4">程式遇到預期外的錯誤，請截圖此畫面回報。</p>
                                <div className="bg-gray-100 dark:bg-black/30 p-4 rounded-xl overflow-auto text-xs font-mono text-red-500 mb-6 max-h-48">
                                    {this.state.error && this.state.error.toString()}
                                </div>
                                <button onClick={() => window.location.reload()} className="w-full bg-[#9B8A5E] text-white font-bold py-3 rounded-xl">重新整理頁面</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><ClassTrackerV8 /></ErrorBoundary>);
    </script>
</body>

</html>