<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>島民行政中心 V8.3 乾淨版</title>

    <!-- ==========================================
         0. 全域錯誤捕捉 (Global Error Handling)
         ========================================== -->
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            console.error("Global Error Caught:", message, error);
        };
    </script>

    <!-- ==========================================
         1. 核心樣式庫 (Core CSS Libraries)
         ========================================== -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap"
        rel="stylesheet">

    <!-- ==========================================
         2. React 核心 (React Core)
         ========================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone (for JSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- ==========================================
         3. 外部功能庫 (External Libraries)
         ========================================== -->
    <!-- Heavy libraries removed for Lazy Loading in V8.3 Clean Version -->

    <!-- ==========================================
         4. 自定義樣式 (Custom CSS)
         ========================================== -->
    <style>
        /* --- Fix: 修復「服務總覽」標籤在夜間模式看不見的問題 --- */
        /* Tailwind 的 /60 會產生特殊符號，CSS 中需要用 \ 轉義 */
        [data-theme="dark"] .bg-white\/60 {
            background-color: var(--sidebar-bg) !important;
            /* 改為深灰背景 */
            border-color: var(--border-color) !important;
            /* 深色邊框 */
            color: var(--text-main) !important;
            /* 白色文字 */
        }

        /* 隱藏 Chrome, Safari, Edge, Opera 的數字輸入箭頭 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 隱藏 Firefox 的數字輸入箭頭 */
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* --- 核心變數定義 --- */
        /* --- 核心變數定義 (日夜間) --- */
        :root {
            /* 日間模式：保持原樣 */
            --app-bg: #F9F5E3;
            --card-bg: #FFFFFF;
            --card-bg-hover: #F8F9F0;
            --sidebar-bg: #F8F9F0;
            --text-main: #574E44;
            --text-sub: #9CA38F;
            --border-color: #E0E4CC;
            --highlight: #7FD1B9;
            --shadow-color: rgba(0, 0, 0, 0.05);
            /* Tile Colors for 2048 */
            --nook-2048-grid: #BBADA0;
            --nook-2048-empty: #CDC1B4;
            --tile-2: #EEE4DA;
            --tile-4: #EDE0C8;
            --tile-8: #F2B179;
            --tile-16: #F59563;
            --tile-32: #F67C5F;
            --tile-64: #F65E3B;
            --tile-128: #EDCF72;
            --tile-256: #EDCC61;
            --tile-512: #EDC850;
            --tile-1024: #EDC53F;
            --tile-2048: #EDC22E;
            --ac-green: #7FD1B9;
            --ac-yellow: #F2D879;
            --ac-text: #574E44;
        }

        /* --- Apple 風格夜間模式 (High Contrast 版) --- */
        [data-theme="dark"] {
            /* 背景與層次 */
            --app-bg: #000000;
            /* 改為純黑，讓對比更強 (類似 iPhone OLED 模式) */
            --card-bg: #1C1C1E;
            /* 深灰卡片 */
            --card-bg-hover: #2C2C2E;
            --sidebar-bg: #2C2C2E;
            /* 側邊欄 */

            /* ★ 關鍵修改：文字亮度大幅提升 ★ */
            --text-main: #FFFFFF;
            /* 主標題改為純白，最清晰 */
            --text-sub: #D1D1D6;
            /* 次標題改為亮銀灰 (原本太暗了) */

            --border-color: #38383A;
            --highlight: #64D2FF;
            /* iOS 藍 */
            --shadow-color: rgba(0, 0, 0, 0.8);
        }

        /* --- 全域過渡 --- */
        body {
            background-color: var(--app-bg) !important;
            color: var(--text-main) !important;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- ★ 強制覆蓋規則 (Fix: 解決標題看不見的問題) ★ --- */

        /* 1. 卡片與背景變色 */
        [data-theme="dark"] .bg-white {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* [Fix] 修復「數字轉大寫」結果區在夜間模式的背景色 */
        [data-theme="dark"] .bg-\[\#FFF8DC\] {
            background-color: var(--sidebar-bg) !important;
            /* 改為深灰 */
            border-color: var(--border-color) !important;
            /* 改為深色邊框 */
        }

        /* [Fix] 修復結果區的邊框顏色 (原本是亮黃色) */
        [data-theme="dark"] .border-\[\#F4E798\] {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .bg-\[\#F8F9F0\],
        [data-theme="dark"] .bg-\[\#F9F5E3\],
        [data-theme="dark"] .bg-\[\#F0F5F1\],
        [data-theme="dark"] .bg-\[\#FFF9C4\],
        [data-theme="dark"] .bg-\[\#EFEBE9\] {
            background-color: var(--sidebar-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* 2. ★ 針對標題的強力修正 (直接鎖定標籤) ★ */
        /* 不管原本是什麼顏色，夜間模式下 h1~h6 全部強制變白 */
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #FFFFFF !important;
        }

        /* 3. 處理原本深褐色的文字 (轉為純白) */
        [data-theme="dark"] .text-\[\#574E44\],
        [data-theme="dark"] .text-\[\#797365\],
        [data-theme="dark"] .text-\[\#5D4037\],
        [data-theme="dark"] .text-\[\#7A5C3E\] {
            color: var(--text-main) !important;
        }

        /* 4. 處理原本灰綠色的文字 (轉為亮銀灰) */
        [data-theme="dark"] .text-\[\#9CA38F\] {
            color: var(--text-sub) !important;
        }

        /* 5. 輸入框優化 */
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: #2C2C2E !important;
            color: #FFF !important;
            border-color: #48484A !important;
        }

        /* 6. 圖表反色 (維持不變) */
        [data-theme="dark"] .chart-container,
        [data-theme="dark"] canvas {
            filter: invert(1) hue-rotate(180deg);
        }

        [data-theme="dark"] img,
        [data-theme="dark"] .no-invert {
            filter: none !important;
        }

        /* 隱藏捲軸 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 14px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--ac-green);
            border-radius: 20px;
            border: 4px solid white;
        }

        /* --- 動畫 --- */
        @keyframes balloon-float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }

            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        .animate-pop {
            animation: pop 0.15s ease-out forwards;
        }

        @keyframes pop {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.8;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .animate-drop {
            animation: drop 0.8s cubic-bezier(0.6, 0.04, 0.98, 0.335) forwards;
        }

        @keyframes drop {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(80vh) rotate(180deg);
                opacity: 0;
            }
        }

        /* --- 震動特效 --- */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both infinite;
        }

        /* 木桌紋理 */
        .wood-pattern-light {
            background-color: #DEB887;
            background-image: repeating-linear-gradient(45deg, #DEB887 0, #DEB887 10px, #D2B48C 10px, #D2B48C 12px);
            border-color: #8B4513;
        }

        /* --- 座位大師樣式 --- */
        .nook-phone-header {
            background-color: #F0F3EC;
            border-bottom: 4px solid #FFFFFF;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .nook-btn {
            border-radius: 15px;
            font-weight: 700;
            transition: all 0.1s;
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .nook-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.15);
        }

        .nook-input {
            background: #FFFFFF;
            border: 2px solid #EBE4D5;
            border-radius: 12px;
            padding: 6px 10px;
            color: var(--ac-text);
            font-weight: bold;
            transition: border-color 0.2s;
        }

        .nook-input:focus {
            border-color: var(--ac-green);
            outline: none;
        }

        /* 座位卡片 */
        .seat-item {
            border-radius: 12px;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-weight: bold;
            overflow: hidden;
            padding: 4px;
        }

        .seat-note-input {
            width: 90%;
            background: rgba(255, 255, 255, 0.4);
            border: none;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.6);
            color: inherit;
            text-align: center;
            font-size: 0.75em;
            margin-top: 4px;
            padding: 1px 0;
            outline: none;
            border-radius: 4px;
        }

        .seat-note-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .screen-mode .seat-item {
            background-color: #88C9A1;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            color: white;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
            font-size: clamp(12px, 1.2vw, 18px);
        }

        .screen-mode .seat-item.empty {
            background-color: #E0E0E0;
            border: 2px dashed #CCC;
            color: #AAA;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            text-shadow: none;
        }

        .screen-mode .seat-item.empty .seat-note-input {
            display: none;
        }

        .screen-mode .seat-item.blocked {
            background-color: #8D6E63;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0, 0, 0, 0.1) 5px, rgba(0, 0, 0, 0.1) 10px);
            border: none;
            box-shadow: 0 4px 0 #5D4037;
        }

        .screen-mode .seat-item.blocked .seat-note-input {
            display: none;
        }

        .screen-mode .seat-item.selected {
            background-color: var(--ac-yellow);
            border: 3px solid #FFF;
            transform: scale(1.05) rotate(-2deg);
            z-index: 20;
            color: #7A5C3E;
            text-shadow: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .screen-mode .seat-item.selected .seat-note-input {
            border-bottom: 1px dashed #7A5C3E;
            background: rgba(255, 255, 255, 0.5);
            color: #7A5C3E;
        }

        .screen-mode .seat-item.selected .seat-note-input::placeholder {
            color: rgba(122, 92, 62, 0.5);
        }

        .seat-swap-anim {
            animation: seat-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes seat-pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .teacher-view-transform {
            transform: rotate(180deg);
        }

        .teacher-view-transform .seat-item {
            transform: rotate(-180deg);
        }

        /* 響應式網格容器 */
        .seat-grid-wrapper {
            display: grid;
            gap: 10px;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-content: center;
        }

        /* --- 2048 遊戲專用樣式 --- */
        .game-2048-container {
            background: var(--nook-2048-grid);
            border-radius: 20px;
            padding: 10px;
            width: 320px;
            height: 320px;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1), 0 8px 0 #C4BEAF;
            border: 4px solid #FFF;
            position: relative;
            touch-action: none;
            margin: 0 auto;
        }

        .game-2048-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            height: 100%;
        }

        .game-2048-cell {
            background: var(--nook-2048-empty);
            border-radius: 8px;
            width: 100%;
            height: 100%;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05);
        }

        .game-2048-tile {
            position: absolute;
            width: 65px;
            height: 65px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 24px;
            transition: transform 0.1s ease-in-out, top 0.1s ease-in-out, left 0.1s ease-in-out;
            z-index: 10;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        }

        .game-2048-tile-new {
            animation: pop 0.2s ease-in;
        }

        .game-2048-tile-merged {
            animation: pop 0.2s ease-in;
            z-index: 20;
        }

        /* Tile Specifics */
        .tile-2 {
            background: var(--tile-2);
        }

        .tile-4 {
            background: var(--tile-4);
        }

        .tile-8 {
            background: var(--tile-8);
        }

        .tile-16 {
            background: var(--tile-16);
        }

        .tile-32 {
            background: var(--tile-32);
        }

        .tile-64 {
            background: var(--tile-64);
        }

        .tile-128 {
            background: var(--tile-128);
            box-shadow: 0 0 10px var(--tile-128);
        }

        .tile-256 {
            background: var(--tile-256);
        }

        .tile-512 {
            background: var(--tile-512);
        }

        .tile-1024 {
            background: var(--tile-1024);
        }

        .tile-2048 {
            background: var(--tile-2048);
            box-shadow: 0 0 15px gold;
            border: 2px solid gold;
        }

        /* 房產面板 */
        .house-panel {
            background: #FFF;
            border-radius: 20px;
            border: 4px solid #FFF;
            box-shadow: 0 8px 0 #E0DBC5;
            width: 320px;
            height: 320px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: space-between;
        }

        .house-display-box {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #F9F5E3 50%, transparent 60%);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
        }

        .house-emoji-large {
            font-size: 50px;
            line-height: 1;
            filter: drop-shadow(0 5px 0px rgba(0, 0, 0, 0.1));
        }

        /* --- 列印 --- */
        /* ... 上面是 .house-emoji-large 的樣式 ... */

        /* --- 強力列印樣式 (V2 自動填滿版) --- */
        @media print {

            /* 設定 A4 橫向，邊距設為 0，由內部 padding 控制 */
            @page {
                size: A4 landscape;
                margin: 0;
            }

            body,
            html {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                background: white !important;
            }

            body * {
                visibility: hidden;
            }

            #print-root,
            #print-root * {
                visibility: visible;
            }

            #print-root {
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: white;
                z-index: 9999;
            }

            /* 通用頁面容器 */
            .print-page {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                box-sizing: border-box;
                padding: 5mm 10mm;
                /* 稍微縮小邊距以爭取空間 */
                display: none;
                background: white;
            }

            /* 學生視角：垂直排列 */
            #page-student {
                flex-direction: column;
                align-items: center;
            }

            /* 導師視角：左右排列 */
            #page-teacher {
                flex-direction: row;
                gap: 10px;
            }

            /* 顯示控制 */
            body.print-mode-all .print-page {
                display: flex !important;
                page-break-after: always;
            }

            body.print-mode-student #page-student {
                display: flex !important;
            }

            body.print-mode-teacher #page-teacher {
                display: flex !important;
            }

            .print-page:last-child {
                page-break-after: avoid;
            }

            /* 標題與黑板講台調整 */
            h1 {
                font-size: 18pt !important;
                margin: 0 0 10px 0 !important;
                text-align: center;
                width: 100%;
            }

            .blackboard-print {
                background: #333 !important;
                color: white !important;
                border: 2px solid black !important;
                width: 50% !important;
                height: 40px !important;
                margin: 0 auto 10px auto !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
                font-size: 14pt !important;
            }

            .podium-print {
                border: 2px solid black !important;
                width: 100px !important;
                height: 30px !important;
                margin: 0 auto 10px auto !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
                font-size: 10pt !important;
            }

            /* ★關鍵修改：網格自動填滿剩餘高度★ */
            .seat-grid-wrapper {
                width: 100% !important;
                flex: 1 !important;
                /* 佔用所有剩餘空間 */
                min-height: 0 !important;
                /* 允許被壓縮 */
                display: grid !important;
                gap: 4px !important;
                /* 稍微縮小間距 */
                align-content: stretch !important;
                justify-content: stretch !important;
            }

            /* 導師視角右側容器修正 */
            #page-teacher .flex-1.flex.flex-col {
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
            }

            #page-teacher .teacher-view-container {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                min-height: 0 !important;
            }

            /* 座位卡片樣式 */
            .seat-item {
                border: 2px solid #000 !important;
                border-radius: 6px !important;
                color: #000 !important;
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: white !important;
                overflow: hidden;
                page-break-inside: avoid;
            }

            /* 字體縮小以防撐開格子 */
            .seat-item>div:first-child {
                font-size: 14pt !important;
                font-weight: 900 !important;
                line-height: 1.1;
            }

            .seat-note-input {
                font-size: 9pt !important;
                color: #555 !important;
                margin-top: 1px !important;
            }

            /* 狀態樣式 */
            .seat-item.blocked {
                background: #ddd !important;
                border: 2px dashed #999 !important;
            }

            .seat-item.empty {
                border: 1px dashed #ccc !important;
                color: transparent !important;
            }

            /* 點名表 */
            .roster-print {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                border: 1px solid #000;
                padding: 5px;
                font-size: 9pt;
            }
        }

        /* --- 島嶼氛圍特效 (鳥、落葉、下雪) --- */
        /* 1. 鳥的飛行路徑 */
        @keyframes fly-across {

            /* 修正邏輯：從右側起點 (0) 往左飛 (-120vw 視窗寬度) */
            0% {
                transform: translateX(0) translateY(0) scaleX(1);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateX(-120vw) translateY(-20px) scaleX(1);
                opacity: 0;
            }
        }

        /* 鳥翅膀搧動 */
        @keyframes wing-flap {

            0%,
            100% {
                d: path("M2 14 Q10 2 18 14 L10 18 Z");
            }

            50% {
                d: path("M2 14 Q10 24 18 14 L10 10 Z");
            }
        }

        /* 2. 飄落與搖曳 */
        @keyframes fall-down {
            0% {
                transform: translateY(-10vh) translateX(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) translateX(20px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes sway-left-right {

            0%,
            100% {
                margin-left: -15px;
            }

            50% {
                margin-left: 15px;
            }
        }

        /* 容器設定：讓動畫不會擋住滑鼠點擊 */
        .atmosphere-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            overflow: hidden;
        }

        .ac-bird {
            position: absolute;
            right: -50px;
            filter: drop-shadow(0 4px 2px rgba(0, 0, 0, 0.1));
        }

        .particle {
            position: absolute;
            top: -20px;
        }
    </style>

    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Zen Maru Gothic', 'Noto Sans TC', 'sans-serif'] },
                    screens: { 'xs': '375px' },
                    colors: {
                        'ac-green': '#7FD1B9',
                        'ac-yellow': '#F2D879',
                        'ac-brown': '#7A5C3E',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-[#F0F5F1] text-[#574E44] selection:bg-[#F2D879] selection:text-[#7A5C3E]">
    <div id="root" class="h-full w-full"></div>

    <!-- ==========================================
         5. PWA 與 系統初始化 (PWA & System Init)
         ========================================== -->
    <script>
        // 1. 動態注入 Manifest (讓瀏覽器認為這是個 App)
        const pwaManifest = {
            "name": "島民行政中心",
            "short_name": "島民行政",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#F9F5E3",
            "theme_color": "#7FD1B9",
            "orientation": "landscape",
            "icons": [
                {
                    "src": "https://dodo.ac/np/images/thumb/e/ef/Map_NH_Icon.png/150px-Map_NH_Icon.png",
                    "sizes": "192x192",
                    "type": "image/png"
                }
            ]
        };

        const stringManifest = JSON.stringify(pwaManifest);
        const blob = new Blob([stringManifest], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        // 2. 註冊 Service Worker (負責離線功能)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker 註冊成功，範圍:', reg.scope))
                    .catch(err => console.log('Service Worker 註冊失敗:', err));
            });
        }
    </script>

    <!-- ==========================================
         6. React 應用程式邏輯 (Main Application)
         ========================================== -->
    <script type="text/babel">
        // 檢查 React 是否載入
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red; text-align: center;">系統錯誤：核心元件載入失敗。</div>';
            throw new Error("React not loaded");
        }

        const { useState, useRef, useEffect, Component, useMemo } = React;

        /**
         * 全域錯誤邊界 (Error Boundary)
         * 攔截子組件的渲染錯誤，顯示友善的錯誤畫面
         */
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("UI Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center h-full flex flex-col items-center justify-center"><h2 className="text-xl font-bold text-[#797365]">發生錯誤</h2><button onClick={() => window.location.reload()} className="mt-4 bg-[#7FD1B9] text-white px-4 py-2 rounded-full">重新整理</button></div>;
                return this.props.children;
            }
        }

        /**
         * 基礎圖示組件 (Base Icon Component)
         */
        const Icon = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        // --- 圖示定義庫 (Icon Library) ---
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></Icon>;
        const ScanText = (props) => <Icon {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2" /><path d="M17 3h2a2 2 0 0 1 2 2v2" /><path d="M21 17v2a2 2 0 0 1-2 2h-2" /><path d="M7 21H5a2 2 0 0 1-2-2v-2" /><path d="M7 9h10" /><path d="M9 13h6" /></Icon>;
        const Scissors = (props) => <Icon {...props}><circle cx="6" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><line x1="20" x2="8.12" y1="4" y2="15.88" /><line x1="14.47" x2="20" y1="14.48" y2="20" /><line x1="8.12" x2="12" y1="8.12" y2="12" /></Icon>;
        const Layers = (props) => <Icon {...props}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></Icon>;
        const ImageIcon = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></Icon>;
        const Loader2 = (props) => <Icon {...props} className={`animate-spin ${props.className || ''}`}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const Stamp = (props) => <Icon {...props}><path d="M5 22h14" /><path d="M19.27 13.73A2.5 2.5 0 0 0 17.5 13h-11A2.5 2.5 0 0 0 4.73 13.73L2.5 16a2.5 2.5 0 0 0 0 3.54C2.7 19.74 3.03 20 4.5 20h15c1.47 0 1.8-.26 2-4.46a2.5 2.5 0 0 0 0-3.54l-2.23-2.27z" /><path d="M12 2v11" /></Icon>;
        const Type = (props) => <Icon {...props}><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" x2="15" y1="20" y2="20" /><line x1="12" x2="12" y1="4" y2="20" /></Icon>;
        const Shield = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /></Icon>;
        const Leaf = (props) => <Icon {...props}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-11 10z" /><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" /></Icon>;
        const FileInput = (props) => <Icon {...props}><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4" /><polyline points="14 2 14 8 20 8" /><path d="M2 15h10" /><path d="m9 18 3-3-3-3" /></Icon>;
        const FileOutput = (props) => <Icon {...props}><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4" /><polyline points="14 2 14 8 20 8" /><path d="M2 15h10" /><path d="m5 12-3 3 3 3" /></Icon>;
        const RotateCw = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>;
        const Hash = (props) => <Icon {...props}><line x1="4" x2="20" y1="9" y2="9" /><line x1="4" x2="20" y1="15" y2="15" /><line x1="10" x2="8" y1="3" y2="21" /><line x1="16" x2="14" y1="3" y2="21" /></Icon>;
        const Lock = (props) => <Icon {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>;
        const Unlock = (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></Icon>;
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></Icon>;
        const MessageCircle = (props) => <Icon {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z" /></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 3v4" /><path d="M3 5h4" /><path d="M3 9h4" /></Icon>;
        const FileCog = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><circle cx="12" cy="13" r="2" /><path d="M12 11V9" /><path d="M12 17v-2" /><path d="M9 13H7" /><path d="M17 13h-2" /></Icon>;
        const Gift = (props) => <Icon {...props}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5" /></Icon>;
        const Tent = (props) => <Icon {...props}><path d="M3.5 21 14 3" /><path d="M20.5 21 10 3" /><path d="M15.5 21 12 15l-3.5 6" /><path d="M2 21h20" /></Icon>;
        const Gem = (props) => <Icon {...props}><path d="M6 3h12l4 6-10 13L2 9Z" /><path d="M11 3 8 9l4 13 4-13-3-6" /></Icon>;
        const Tree = (props) => <Icon {...props}><path d="M12 19v-6" /><path d="M12 2a9 9 0 0 0-9 9c0 1.5.3 2.9.9 4.2L3 22h18l-.9-6.8c.6-1.3.9-2.7.9-4.2a9 9 0 0 0-9-9Z" /></Icon>;


        const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></Icon>;
        const CalendarDays = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></Icon>;
        const Dice5 = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M16 8h.01" /><path d="M8 8h.01" /><path d="M8 16h.01" /><path d="M16 16h.01" /><path d="M12 12h.01" /></Icon>;
        const Timer = (props) => <Icon {...props}><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></Icon>;
        const AlarmClock = (props) => <Icon {...props}><circle cx="12" cy="13" r="8" /><path d="M12 9v4l2 2" /><path d="M5 3 2 6" /><path d="m22 6-3-3" /><path d="M6.38 18.7 4 21" /><path d="M17.64 18.67 20 21" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const ClipboardList = (props) => <Icon {...props}><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></Icon>;
        const StickyNote = (props) => <Icon {...props}><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z" /><path d="M15 3v6h6" /></Icon>;
        const School = (props) => <Icon {...props}><path d="m4 6 8-4 8 4" /><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2" /><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4" /><path d="M18 5v17" /><path d="M6 5v17" /><circle cx="12" cy="9" r="2" /></Icon>;
        const BarChart = (props) => <Icon {...props}><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></Icon>;
        const Eye = (props) => <Icon {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const EyeOff = (props) => <Icon {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></Icon>;
        const Copy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12" /></Icon>;
        const Key = (props) => <Icon {...props}><circle cx="7.5" cy="15.5" r="5.5" /><path d="m21 2-9.6 9.6" /><path d="m15.5 7.5 3 3L22 7l-3-3" /></Icon>;
        const Smile = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M8 14s1.5 2 4 2 4-2 4-2" /><line x1="9" x2="9.01" y1="9" y2="9" /><line x1="15" x2="15.01" y1="9" y2="9" /></Icon>;
        const Laugh = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M18 13a6 6 0 0 1-6 5 6 6 0 0 1-6-5h12Z" /><line x1="9" x2="9.01" y1="9" y2="9" /><line x1="15" x2="15.01" y1="9" y2="9" /></Icon>;
        const Meh = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="8" x2="16" y1="15" y2="15" /><line x1="9" x2="9.01" y1="9" y2="9" /><line x1="15" x2="15.01" y1="9" y2="9" /></Icon>;
        const Grid = (props) => <Icon {...props}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></Icon>;
        const Bush = (props) => <Icon {...props}><path d="M4 15s1-7 8-7 8 7 8 7-3 7-8 7-8-7-8-7Z" /><path d="M8 14s.5-3 4-3 4 3 4 3" /></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
        const FolderOpen = (props) => <Icon {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v2" /></Icon>;
        const Printer = (props) => <Icon {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></Icon>;
        const Plane = (props) => <Icon {...props}><path d="M2 12h20" /><path d="M13 2 9 22" /><path d="M15 9h-2l-3-7H6l4 7H6l-2 3h16l-2-3Z" /></Icon>;
        const LinkIcon = (props) => <Icon {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></Icon>;
        const Wifi = (props) => <Icon {...props}><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></Icon>;
        const PieChart = (props) => <Icon {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>;
        const Medal = (props) => <Icon {...props}><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3" /></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></Icon>;
        const Shuffle = (props) => <Icon {...props}><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6c.8-1.1 2-1.7 3.3-1.7H26" /><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.6c.8 1.1 2 1.7 3.3 1.7H26" /></Icon>;

        const SkipForward = (props) => <Icon {...props}><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" y1="5" x2="19" y2="19" /></Icon>;
        const MapPin = (props) => <Icon {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></Icon>;
        const Volume2 = (props) => <Icon {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></Icon>;
        const Monitor = (props) => <Icon {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></Icon>;
        const Star = (props) => <Icon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></Icon>;
        const GitBranch = (props) => <Icon {...props}><line x1="6" y1="3" x2="6" y2="15" /><circle cx="18" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><path d="M18 9a9 9 0 0 1-9 9" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const Minus = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const ShieldCheck = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><path d="m9 12 2 2 4-4" /></Icon>;
        // 101 Tower (Modified for slimmer real-world aspect ratio)
        const Taipei101 = (props) => (
            <svg viewBox="0 0 200 500" fill="none" stroke="currentColor" strokeWidth="0" {...props}>
                <path d="M70 480 L52 480 L61 410 L139 410 L148 480 L130 480" fill="#8FA998" />
                <path d="M58 405 L142 405 L151 325 L49 325 Z" fill="#8FA998" />
                <path d="M52 320 L148 320 L154 240 L46 240 Z" fill="#8FA998" />
                <path d="M49 235 L151 235 L157 155 L43 155 Z" fill="#8FA998" />
                <path d="M46 150 L154 150 L160 70 L40 70 Z" fill="#8FA998" />
                <rect x="91" y="20" width="18" height="50" fill="#8FA998" />
                <rect x="98" y="0" width="4" height="20" fill="#8FA998" />
                <circle cx="100" cy="110" r="9" fill="#B4C6BC" />
                <circle cx="100" cy="195" r="9" fill="#B4C6BC" />
                <circle cx="100" cy="280" r="9" fill="#B4C6BC" />
                <circle cx="100" cy="365" r="9" fill="#B4C6BC" />
            </svg>
        );

        /**
         * 基礎設施 Hook (Infrastructure Hooks)
         */
        /* =========================================
           SECTION: UTILITIES - LAZY LOADER (Material Reduction)
           ========================================= */
        const SCRIPTS_CONFIG = {
            pdf: { src: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js', global: 'pdfjsLib' },
            pdfWorker: { src: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js', global: null },
            tesseract: { src: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js', global: 'Tesseract' },
            qrcode: { src: 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js', global: 'QRCode' },
            html2canvas: { src: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', global: 'html2canvas' },
            pdflib: { src: 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js', global: 'PDFLib' },
            jszip: { src: 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js', global: 'JSZip' },
            xlsx: { src: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', global: 'XLSX' },
            chart: { src: 'https://cdn.jsdelivr.net/npm/chart.js', global: 'Chart' },
            matter: { src: 'https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js', global: 'Matter' }
        };

        const useLazyScript = (scripts = []) => {
            const [loaded, setLoaded] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!scripts || scripts.length === 0) {
                    setLoaded(true);
                    return;
                }

                const loadScript = (key) => new Promise((resolve, reject) => {
                    const config = SCRIPTS_CONFIG[key];
                    if (!config) return resolve();
                    if (config.global && window[config.global]) return resolve();
                    if (key === 'pdfWorker') return resolve();

                    if (document.querySelector(`script[src="${config.src}"]`)) {
                        const check = setInterval(() => {
                            if (config.global && window[config.global]) { clearInterval(check); resolve(); }
                        }, 100);
                        setTimeout(() => { clearInterval(check); resolve(); }, 10000);
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = config.src;
                    script.async = true;
                    script.onload = () => {
                        if (key === 'pdf' && window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = SCRIPTS_CONFIG.pdfWorker.src;
                        resolve();
                    };
                    script.onerror = () => reject(new Error(`Failed to load ${key}`));
                    document.head.appendChild(script);
                });

                Promise.all(scripts.map(loadScript)).then(() => setLoaded(true)).catch(err => setError(err));
            }, [JSON.stringify(scripts)]);

            return { loaded, error };
        };

        const ToolWrapper = ({ component: Component, scripts }) => {
            const { loaded, error } = useLazyScript(scripts);

            if (error) return <div className="p-8 text-center text-red-500 font-bold">⚠️ 資源載入失敗，請檢查網路。</div>;
            if (!loaded) return (
                <div className="flex flex-col items-center justify-center p-12 h-64 text-[#9CA38F]">
                    <Loader2 className="w-10 h-10 animate-spin mb-4 text-[#7FD1B9]" />
                    <p className="animate-pulse font-bold">正在準備工具與資源...</p>
                </div>
            );

            return <ErrorBoundary><Component ready={true} /></ErrorBoundary>;
        };

        const useExternalScripts = () => ({ loaded: true, error: null });

        // 音效工具
        const playAlarm = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const playNote = (freq, time, duration, type = 'sine') => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, time);
                    gain.gain.setValueAtTime(0, time);
                    gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(time);
                    osc.stop(time + duration);
                };
                const now = ctx.currentTime;
                playNote(523.25, now, 0.4);       // C5
                playNote(659.25, now + 0.15, 0.4); // E5
                playNote(783.99, now + 0.30, 0.4); // G5
                playNote(987.77, now + 0.45, 0.4); // B5
                playNote(1046.50, now + 0.60, 0.8, 'triangle'); // C6
            } catch (e) {
                console.error("Audio play failed", e);
            }
        };

        /**
         * 核心工具函式庫 (Core Utilities)
         */
        const Utils = {
            formatBytes: (bytes, decimals = 2) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024; const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            },
            readFileAsArrayBuffer: (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsArrayBuffer(file); }),
            readImageAsDataURL: (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }),
            loadImage: (src) => new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = src; }),

            // [V7.9.9 Fix] 修正版：數字轉中文大寫
            numberToChinese: (num) => {
                if (!/^(0|[1-9]\d*)(\.\d+)?$/.test(num)) return "";
                const unit = "仟佰拾億仟佰拾萬仟佰拾元角分";
                let str = "";
                num += "00";
                const pointIdx = num.indexOf('.');
                if (pointIdx >= 0) num = num.substring(0, pointIdx) + num.substr(pointIdx + 1, 2);
                const currentUnit = unit.substr(unit.length - num.length);
                for (let i = 0; i < num.length; i++) str += '零壹貳參肆伍陸柒捌玖'.charAt(num.charAt(i)) + currentUnit.charAt(i);
                return str.replace(/零(仟|佰|拾|角)/g, "零").replace(/(零)+/g, "零").replace(/零(萬|億|元)/g, "$1").replace(/(億)萬|壹(拾)/g, "$1$2").replace(/^元零?|零分/g, "").replace(/元$/g, "元整");
            },
        };

        // ==========================================
        // 7. UI 基礎元件層 (UI Foundation Layer)
        // ==========================================

        /**
         * 葉子背景圖案組件
         * 顯示一個半透明的葉子背景圖案，增加視覺層次感
         */
        const LeafPattern = () => (
            <div className="fixed inset-0 pointer-events-none opacity-[0.05] z-0 leaf-pattern"
                style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0c16.569 0 30 13.431 30 30 0 16.569-13.431 30-30 30C13.431 60 0 46.569 0 30 0 13.431 13.431 0 30 0zm0 5c-13.807 0-25 11.193-25 25 0 13.807 11.193 25 25 25 13.807 0 25-11.193 25-25 0-13.807-11.193-25-25-25z' fill='%237FD1B9' fill-opacity='1' fill-rule='evenodd'/%3E%3C/svg%3E")`, backgroundSize: '60px 60px' }}
            />
        );

        /**
         * 通用卡片組件
         * 提供統一的圓角、陰影、背景模糊效果，作為內容容器
         * @param {React.ReactNode} children - 卡片內容
         * @param {string} className - 自定義樣式類名
         */
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white/95 backdrop-blur-md rounded-[30px] md:rounded-[40px] shadow-[0_4px_20px_rgb(0,0,0,0.04)] border-[6px] border-white relative z-10 ${className}`}>
                {children}
            </div>
        );

        /**
         * 通用按鈕組件
         * 支援多種變體樣式 (primary, secondary, danger, etc.)
         * @param {function} onClick - 點擊事件處理函數
         * @param {boolean} disabled - 是否禁用
         * @param {string} variant - 按鈕樣式變體
         * @param {string} className - 自定義樣式類名
         * @param {React.Component} icon -按鈕圖示組件
         */
        const Button = ({ onClick, disabled, variant = 'primary', className = "", children, icon: Icon }) => {
            const variants = {
                primary: "bg-[#7FD1B9] text-white hover:bg-[#68C0A6]",
                secondary: "bg-[#F2D879] text-[#7A5C3E] hover:bg-[#E6C964]",
                blue: "bg-[#7ACBD5] text-white hover:bg-[#68b8c2]",
                danger: "bg-[#FF9A8B] text-white hover:bg-[#ee897a]",
                purple: "bg-[#C4A9E8] text-white hover:bg-[#b092da]",
                outline: "bg-white border-[3px] border-[#E0E4CC] text-[#9CA38F] hover:bg-[#F2F4E6]",
                teal: "bg-[#26A69A] text-white hover:bg-[#00897B]",
                pink: "bg-[#FF91B3] text-white hover:bg-[#FF75A0]"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`inline-flex items-center justify-center px-4 py-3 md:px-6 md:py-4 rounded-full font-bold transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_4px_0_0_rgba(0,0,0,0.15)] active:shadow-none translate-y-0 active:translate-y-1 text-sm md:text-base ${variants[variant]} ${className}`}>
                    {Icon && <Icon className={`w-4 h-4 md:w-5 md:h-5 ${children ? 'mr-2' : ''} stroke-[3]`} />}
                    {children}
                </button>
            );
        };

        /**
         * 檔案項目組件
         * 顯示已上傳檔案的資訊 (名稱、大小、類型圖示) 及刪除按鈕
         * @param {File} file - 檔案物件
         * @param {function} onRemove - 刪除檔案的回調函數
         */
        const FileItem = ({ file, onRemove }) => (
            <div className="flex items-center justify-between p-3 md:p-4 bg-[#F8F9F0] rounded-[16px] md:rounded-[20px] border-[3px] border-white group transition-all">
                <div className="flex items-center space-x-3 md:space-x-4 overflow-hidden">
                    <div className="p-2 md:p-3 bg-white rounded-xl md:rounded-2xl text-[#88C9A1] shadow-sm shrink-0">
                        {file.type.includes('pdf') ? <FileText className="w-5 h-5 md:w-6 md:h-6 stroke-[2.5]" /> : <ImageIcon className="w-5 h-5 md:w-6 md:h-6 stroke-[2.5]" />}
                    </div>
                    <div className="min-w-0">
                        <p className="text-sm md:text-base font-bold text-[#797365] truncate">{file.name}</p>
                        <p className="text-xs text-[#9CA38F] font-bold">{Utils.formatBytes(file.size)}</p>
                    </div>
                </div>
                <button onClick={onRemove} className="p-1.5 md:p-2 text-[#FF9A8B] hover:bg-white rounded-full transition-colors shrink-0">
                    <X className="w-5 h-5 md:w-6 md:h-6 stroke-[3]" />
                </button>
            </div>
        );

        /**
         * 拖放區域組件
         * 處理檔案拖放和點擊上傳
         * @param {function} onDrop - 檔案拖放或選擇後的回調
         * @param {string} accept - 接受的檔案類型
         * @param {boolean} multiple - 是否允許多選
         * @param {string} label - 提示文字
         */
        const DropZone = ({ onDrop, accept, multiple = false, label }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const inputRef = useRef(null);

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                if (e.dataTransfer.files.length > 0) onDrop(Array.from(e.dataTransfer.files));
            };

            const handleChange = (e) => {
                if (e.target.files.length > 0) onDrop(Array.from(e.target.files));
                e.target.value = null;
            };

            return (
                <div
                    onClick={() => inputRef.current?.click()}
                    onDragOver={(e) => { e.preventDefault(); setIsDragOver(true); }}
                    onDragLeave={() => setIsDragOver(false)}
                    onDrop={handleDrop}
                    className={`relative border-[3px] md:border-[5px] border-dashed rounded-[24px] md:rounded-[40px] p-6 md:p-10 text-center cursor-pointer transition-all duration-300 flex flex-col items-center justify-center gap-2 md:gap-4 ${isDragOver ? 'border-[#88C9A1] bg-[#F2F4E6] scale-[1.02]' : 'border-[#E0E4CC] bg-[#FEFEFD] hover:border-[#88C9A1] hover:bg-[#F9FAF4]'}`}
                >
                    <input ref={inputRef} type="file" className="hidden" accept={accept} multiple={multiple} onChange={handleChange} />
                    <div className={`p-4 md:p-5 rounded-full shadow-sm transition-colors ${isDragOver ? 'bg-[#88C9A1] text-white' : 'bg-[#F2F4E6] text-[#88C9A1]'}`}>
                        <Upload className="w-8 h-8 md:w-10 md:h-10 stroke-[2.5]" />
                    </div>
                    <div>
                        <p className="text-base md:text-lg font-bold text-[#797365]">點擊或拖曳文件</p>
                        <p className="text-xs md:text-sm text-[#9CA38F] mt-1 font-bold">{label}</p>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 8. Class Management Tools (班級經營工具)
        // ==========================================

        /**
         * 島民靈感板 (Mind Map Tool) V3.2 - 智慧防撞版
         * 提供一個無限畫布，支援 Markdown 語法輸入並自動轉換為心智圖
         * 包含節點自動排版、縮放漫遊、以及圖片匯出功能
         */
        /**
         * 上台報告亂數排序工具
         * 提供名單亂數排序功能，支援 Excel 匯出與複製
         */
        const RandomPresentationTool = () => {
            const [students, setStudents] = useState('');
            const [sortedList, setSortedList] = useState([]);
            const [isShuffling, setIsShuffling] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);

            // Load saved students
            useEffect(() => {
                const saved = localStorage.getItem('presentation_students');
                if (saved) setStudents(saved);
            }, []);

            // Save students
            useEffect(() => {
                localStorage.setItem('presentation_students', students);
            }, [students]);

            const handleShuffle = () => {
                const list = students.split('\n').filter(s => s.trim() !== '');
                if (list.length === 0) return;

                setIsShuffling(true);
                setShowConfetti(false);
                setSortedList([]);

                // Shuffle animation
                let count = 0;
                const maxCount = 10;
                const interval = setInterval(() => {
                    // Fisher-Yates shuffle
                    const currentList = [...list];
                    for (let i = currentList.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [currentList[i], currentList[j]] = [currentList[j], currentList[i]];
                    }
                    setSortedList(currentList);
                    count++;
                    if (count >= maxCount) {
                        clearInterval(interval);
                        setIsShuffling(false);
                        setShowConfetti(true);
                        playAlarm(); // Use system alarm sound
                    }
                }, 100);
            };

            const handleCopy = () => {
                const text = sortedList.map((s, i) => `${i + 1}. ${s}`).join('\n');
                navigator.clipboard.writeText(text).then(() => alert('已複製到剪貼簿！'));
            };

            const handleExport = () => {
                if (!window.XLSX) return alert('Excel 組件尚未載入，請稍後再試');
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([['序號', '姓名'], ...sortedList.map((s, i) => [i + 1, s])]);
                XLSX.utils.book_append_sheet(wb, ws, "報告順序");
                XLSX.writeFile(wb, "上台報告順序.xlsx");
            };

            const handleReset = () => {
                if (confirm('確定要清空名單嗎？')) {
                    setStudents('');
                    setSortedList([]);
                    localStorage.removeItem('presentation_students');
                }
            };

            return (
                <div className="h-full flex flex-col gap-6 relative overflow-hidden p-2">
                    {showConfetti && <div className="absolute inset-0 pointer-events-none z-50 flex justify-center items-start pt-20"><div className="text-6xl animate-bounce">🎉</div></div>}

                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-[#797365] flex items-center gap-2">
                                <Shuffle className="w-8 h-8 text-[#7FD1B9]" />
                                上台順序抽籤
                            </h2>
                            <p className="text-sm text-[#9CA38F] font-bold">輸入名單，一鍵隨機排序</p>
                        </div>
                        <div className="flex gap-2">
                            <Button onClick={handleReset} variant="outline" icon={RotateCcw}>清空</Button>
                            <Button onClick={handleShuffle} variant="primary" icon={Shuffle} disabled={isShuffling || !students.trim()}>
                                {isShuffling ? '洗牌中...' : '開始抽籤'}
                            </Button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 min-h-0">
                        <div className="flex flex-col gap-2 h-full">
                            <label className="text-sm font-bold text-[#797365] pl-1">學生名單 (每行一位)</label>
                            <textarea
                                value={students}
                                onChange={(e) => setStudents(e.target.value)}
                                className="flex-1 w-full p-4 rounded-2xl border-[3px] border-[#E0E4CC] focus:border-[#7FD1B9] outline-none resize-none bg-[#FEFEFD] text-lg leading-relaxed shadow-inner custom-scrollbar"
                                placeholder="請輸入姓名..."
                            />
                            <div className="text-right text-xs text-[#9CA38F] font-bold">
                                共 {students.split('\n').filter(s => s.trim()).length} 人
                            </div>
                        </div>

                        <div className="flex flex-col gap-2 h-full">
                            <div className="flex justify-between items-end pl-1">
                                <label className="text-sm font-bold text-[#797365]">抽籤結果</label>
                                {sortedList.length > 0 && (
                                    <div className="flex gap-2">
                                        <button onClick={handleCopy} className="text-xs font-bold text-[#7FD1B9] hover:text-[#68C0A6] flex items-center gap-1"><Copy size={14} /> 複製</button>
                                        <button onClick={handleExport} className="text-xs font-bold text-[#7FD1B9] hover:text-[#68C0A6] flex items-center gap-1"><Download size={14} /> Excel</button>
                                    </div>
                                )}
                            </div>
                            <div className={`flex-1 rounded-2xl border-[3px] overflow-y-auto custom-scrollbar relative transition-colors duration-300 ${sortedList.length > 0 ? 'bg-white border-[#88C9A1]' : 'bg-[#F8F9F0] border-[#E0E4CC] dashed-border'}`}>
                                {isShuffling ? (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-[#88C9A1]">
                                        <Loader2 className="w-12 h-12 animate-spin mb-2" />
                                        <p className="font-bold text-lg animate-pulse">命運安排中...</p>
                                    </div>
                                ) : sortedList.length > 0 ? (
                                    <div className="p-4 space-y-2">
                                        {sortedList.map((s, i) => (
                                            <div key={i} className="flex items-center gap-3 p-3 bg-white rounded-xl shadow-sm border border-[#E0E4CC] animate-in slide-in-from-bottom-2 fade-in" style={{ animationDelay: `${i * 0.05}s` }}>
                                                <div className="w-8 h-8 rounded-full bg-[#7FD1B9] text-white flex items-center justify-center font-black text-lg shadow-sm shrink-0">
                                                    {i + 1}
                                                </div>
                                                <div className="text-xl font-bold text-[#574E44]">{s}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-[#D7CCC8] opacity-60 pointer-events-none">
                                        <Users className="w-16 h-16 mb-4" />
                                        <p className="font-bold text-lg">等待抽籤...</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MindMapTool = () => {

            const [text, setText] = useState("# 我的計畫\n## 第一步\n### 收集資料\n### 分析數據\n## 第二步\n### 撰寫報告\n### 製作簡報\n## 備案計畫\n### 尋求支援\n### 申請預算");

            const [view, setView] = useState({ x: 0, y: 0, scale: 1 });
            const [isDragging, setIsDragging] = useState(false);
            const [lastPos, setLastPos] = useState({ x: 0, y: 0 });

            const canvasRef = useRef(null);
            const containerRef = useRef(null);

            // 解析 Markdown 文字為樹狀結構
            const parseText = (input) => {
                const lines = input.split('\n').filter(l => l.trim() !== '');
                const root = { name: "Root", children: [], level: 0 };
                const stack = [root];
                lines.forEach(line => {
                    const match = line.match(/^(#+)\s+(.*)/);
                    if (match) {
                        const level = match[1].length;
                        const node = { name: match[2], children: [], level };
                        while (stack.length > 1 && stack[stack.length - 1].level >= level) stack.pop();
                        stack[stack.length - 1].children.push(node);
                        stack.push(node);
                    }
                });
                return root.children[0] || { name: "請輸入內容", children: [], level: 1 };
            };

            // 繪製圓角矩形輔助函數
            const drawRoundRect = (ctx, x, y, w, h, r) => {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.arcTo(x + w, y, x + w, y + h, r);
                ctx.arcTo(x + w, y + h, x, y + h, r);
                ctx.arcTo(x, y + h, x, y, r);
                ctx.arcTo(x, y, x + w, y, r);
                ctx.closePath();
            };

            // ★ 高清修復版 drawMap ★
            // 負責繪製整個心智圖，包含 DPR 校正以確保在視網膜螢幕上清晰
            const drawMap = () => {
                const canvas = canvasRef.current;
                const container = containerRef.current;
                if (!canvas || !container) return;

                const ctx = canvas.getContext('2d');
                const rootData = parseText(text);

                // --- 步驟一：DPR 解析度校正 (解決模糊問題) ---
                const dpr = window.devicePixelRatio || 1;

                // 1. 設定畫布的「物理像素」為螢幕的真實解析度 (例如放大 2 倍)
                canvas.width = container.clientWidth * dpr;
                canvas.height = container.clientHeight * dpr;

                // 2. 強制設定 CSS 樣式寬高為「邏輯大小」，確保版面不跑掉
                canvas.style.width = `${container.clientWidth}px`;
                canvas.style.height = `${container.clientHeight}px`;

                // 3. 調整繪圖筆刷的縮放比例，讓所有繪製動作自動放大
                ctx.setTransform(1, 0, 0, 1, 0, 0); // 重置矩陣
                ctx.scale(dpr, dpr);

                // 4. 清除畫布 (使用邏輯尺寸)
                ctx.clearRect(0, 0, container.clientWidth, container.clientHeight);

                // 計算節點高度 (邏輯不變)
                const measureNode = (node) => {
                    if (!node.children || node.children.length === 0) {
                        node.treeHeight = 50;
                        return;
                    }
                    let totalHeight = 0;
                    node.children.forEach(child => {
                        measureNode(child);
                        totalHeight += child.treeHeight;
                    });
                    node.treeHeight = totalHeight;
                };
                measureNode(rootData);

                // --- 步驟二：開始繪製 ---
                ctx.save();
                // ★ 注意：這裡改用 container.clientWidth (邏輯寬度) 來找中心點
                ctx.translate(container.clientWidth / 2 + view.x, container.clientHeight / 2 + view.y);
                ctx.scale(view.scale, view.scale);
                ctx.translate(-200, 0); // 初始偏移

                const drawNode = (node, x, y, level) => {
                    // 計算文字寬度
                    ctx.font = level === 1 ? 'bold 24px sans-serif' : 'bold 16px sans-serif';
                    const textMetrics = ctx.measureText(node.name);
                    const nodeW = textMetrics.width + 30; // padding
                    const nodeH = level === 1 ? 50 : 36;

                    // 畫節點背景
                    ctx.fillStyle = level === 1 ? '#5D4037' : (node.children.length > 0 ? '#FFF8E1' : '#FFFFFF');
                    ctx.shadowBlur = 4;
                    ctx.shadowColor = "rgba(0,0,0,0.1)";
                    drawRoundRect(ctx, x, y - nodeH / 2, nodeW, nodeH, 10);
                    ctx.fill();

                    // 畫邊框
                    ctx.shadowBlur = 0;
                    ctx.strokeStyle = level === 1 ? '#3E2723' : '#D7CCC8';
                    ctx.lineWidth = level === 1 ? 3 : 2;
                    ctx.stroke();

                    // 畫文字
                    ctx.fillStyle = level === 1 ? '#FFF' : '#5D4037';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(node.name, x + 15, y);

                    // 畫子節點連線
                    if (node.children && node.children.length > 0) {
                        let currentY = y - node.treeHeight / 2;

                        node.children.forEach(child => {
                            const childY = currentY + child.treeHeight / 2;
                            const childX = x + nodeW + 60;

                            ctx.beginPath();
                            ctx.moveTo(x + nodeW, y);
                            ctx.bezierCurveTo(x + nodeW + 30, y, x + nodeW + 30, childY, childX, childY);
                            ctx.strokeStyle = '#8D6E63';
                            ctx.lineWidth = Math.max(1, 3 - (level * 0.5));
                            ctx.stroke();

                            drawNode(child, childX, childY, level + 1);
                            currentY += child.treeHeight;
                        });
                    }
                };

                drawNode(rootData, 0, 0, 1);
                ctx.restore();
            };

            // 監聽文字或視圖變化以重繪
            useEffect(() => {
                const timer = setTimeout(drawMap, 100);
                window.addEventListener('resize', drawMap);
                return () => { clearTimeout(timer); window.removeEventListener('resize', drawMap); };
            }, [text, view]);

            // --- 互動事件處理 (拖曳、縮放) ---
            const handleMouseDown = (e) => { setIsDragging(true); setLastPos({ x: e.clientX, y: e.clientY }); };
            const handleMouseMove = (e) => {
                if (!isDragging) return;
                setView(v => ({ ...v, x: v.x + (e.clientX - lastPos.x), y: v.y + (e.clientY - lastPos.y) }));
                setLastPos({ x: e.clientX, y: e.clientY });
            };
            const handleMouseUp = () => setIsDragging(false);
            const handleWheel = (e) => {
                const scaleAmount = -e.deltaY * 0.001;
                setView(v => ({ ...v, scale: Math.min(Math.max(0.1, v.scale + scaleAmount), 5) }));
            };

            // 視圖控制按鈕功能
            const zoomIn = () => setView(v => ({ ...v, scale: Math.min(v.scale * 1.2, 5) }));
            const zoomOut = () => setView(v => ({ ...v, scale: Math.max(v.scale / 1.2, 0.1) }));
            const resetView = () => setView({ x: 0, y: 0, scale: 1 });

            // 匯出為圖片
            const downloadImage = () => {
                if (!canvasRef.current) return;
                const link = document.createElement('a');
                link.download = '心智圖.png';
                link.href = canvasRef.current.toDataURL();
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-[600px] gap-6 w-full">
                    {/* 左側輸入區 */}
                    <div className="w-full lg:w-[35%] flex flex-col h-full bg-[#EFEBE9] p-4 rounded-[24px] border-[3px] border-[#D7CCC8] shadow-sm shrink-0 min-w-0">
                        <div className="flex justify-between items-center mb-3">
                            <label className="text-sm font-bold text-[#5D4037] flex items-center gap-2">
                                <GitBranch size={18} /> 靈感輸入
                            </label>
                            <button onClick={downloadImage} className="text-xs bg-white px-3 py-1.5 rounded-lg border border-[#D7CCC8] hover:bg-[#F2F4E6] font-bold text-[#797365]">📸 存圖</button>
                        </div>
                        <textarea
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            className="flex-1 w-full p-4 rounded-xl border-2 border-[#D7CCC8] text-sm font-mono focus:ring-4 focus:ring-[#8D6E63]/20 outline-none custom-scrollbar resize-none bg-white leading-relaxed"
                            placeholder="# 主題\n## 分支 A\n## 分支 B"
                        />
                        <div className="mt-3 text-[10px] text-[#9CA38F] font-bold text-center">支援 Markdown • 自動防撞排版</div>
                    </div>

                    {/* 右側無限畫布區 */}
                    <div ref={containerRef} className="flex-1 h-full bg-[#FAFAFA] rounded-[24px] border-[4px] border-[#E0E4CC] relative overflow-hidden shadow-inner cursor-move group min-w-0">
                        <div className="absolute inset-0 pointer-events-none opacity-10" style={{ backgroundImage: 'radial-gradient(#8D6E63 1.5px, transparent 1.5px)', backgroundSize: '24px 24px' }}></div>
                        <canvas
                            ref={canvasRef}
                            className="absolute inset-0 block w-full h-full"
                            onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onWheel={handleWheel}
                        />
                        <div className="absolute bottom-6 right-6 flex flex-col gap-3">
                            <button onClick={zoomIn} className="bg-white text-[#5D4037] p-3 rounded-full shadow-lg border-2 border-[#E0E4CC] hover:bg-[#F2F4E6] active:scale-95 transition-all"><Plus size={20} /></button>
                            <button onClick={zoomOut} className="bg-white text-[#5D4037] p-3 rounded-full shadow-lg border-2 border-[#E0E4CC] hover:bg-[#F2F4E6] active:scale-95 transition-all"><Minus size={20} /></button>
                            <button onClick={resetView} className="bg-[#8D6E63] text-white p-3 rounded-full shadow-lg border-2 border-[#5D4037] hover:bg-[#6D4C41] active:scale-95 transition-all"><RefreshCw size={20} /></button>
                        </div>
                        <div className="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-black text-[#9CA38F] pointer-events-none select-none border-2 border-[#E0E4CC] shadow-sm">{Math.round(view.scale * 100)}%</div>
                    </div>
                </div>
            );
        };

        /**
         * 世界咖啡館 (World Cafe) V2.2 - 內建規則說明版
         * 用於分組交流活動，提供計時器、換桌提示音效、以及動態桌位指示
         * 包含自動輪調邏輯：每輪結束後計算每個人的下一桌位置
         */
        const WorldCafeTool = () => {
            const [numGroups, setNumGroups] = useState(6);
            const [studentsPerGroup, setStudentsPerGroup] = useState(4);
            const [round, setRound] = useState(0);
            const [timeLeft, setTimeLeft] = useState(300);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [initialTime, setInitialTime] = useState(300);
            const audioContextRef = useRef(null);

            const groupColors = [
                { name: '蘋果紅', bg: '#FF9A8B', text: '#B71C1C', border: '#E57373' },
                { name: '梨子綠', bg: '#C8E6C9', text: '#1B5E20', border: '#81C784' },
                { name: '天空藍', bg: '#B3E5FC', text: '#01579B', border: '#4FC3F7' },
                { name: '蜜桃粉', bg: '#F8BBD0', text: '#880E4F', border: '#F06292' },
                { name: '橘子橙', bg: '#FFE0B2', text: '#E65100', border: '#FFB74D' },
                { name: '葡萄紫', bg: '#E1BEE7', text: '#4A148C', border: '#BA68C8' },
                { name: '檸檬黃', bg: '#FFF9C4', text: '#F57F17', border: '#FFF176' },
                { name: '椰子褐', bg: '#D7CCC8', text: '#5D4037', border: '#A1887F' },
                { name: '薄荷綠', bg: '#B2DFDB', text: '#004D40', border: '#80CBC4' },
                { name: '岩石灰', bg: '#F5F5F5', text: '#212121', border: '#E0E0E0' },
                { name: '綠松石', bg: '#80DEEA', text: '#006064', border: '#4DD0E1' },
                { name: '靛青藍', bg: '#9FA8DA', text: '#1A237E', border: '#7986CB' },
                { name: '珊瑚紅', bg: '#FFAB91', text: '#BF360C', border: '#FF8A65' },
                { name: '橄欖綠', bg: '#E6EE9C', text: '#827717', border: '#DCE775' },
                { name: '咖啡褐', bg: '#BCAAA4', text: '#3E2723', border: '#A1887F' },
            ];

            const getGroupVisitorsAtTable = (tableIndex, currentRound, totalGroups) => {
                let visitorGroupIndex = (tableIndex - currentRound) % totalGroups;
                if (visitorGroupIndex < 0) visitorGroupIndex += totalGroups;
                return visitorGroupIndex;
            };

            const nextRound = () => setRound((prev) => (prev + 1) % numGroups);
            const reset = () => { setRound(0); setIsTimerRunning(false); stopAlertSound(); setTimeLeft(initialTime); };

            const playAlertSound = () => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!audioContextRef.current) audioContextRef.current = new AudioContext();
                    const ctx = audioContextRef.current;
                    if (ctx.state === 'suspended') ctx.resume();

                    const now = ctx.currentTime;

                    // 頻率對照表
                    const notes = {
                        'G4': 392.00, 'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'C6': 1046.50
                    };

                    // 完整 14 秒旋律 (重複兩遍)
                    const melody = [
                        // === 第一遍 (0~7秒) ===
                        { n: 'E5', t: 0.0, d: 0.6 },
                        { n: 'C5', t: 0.6, d: 0.6 },
                        { n: 'D5', t: 1.2, d: 0.6 },
                        { n: 'G4', t: 1.8, d: 1.2 },
                        // 間隔
                        { n: 'G4', t: 3.5, d: 0.6 },
                        { n: 'D5', t: 4.1, d: 0.6 },
                        { n: 'E5', t: 4.7, d: 0.6 },
                        { n: 'C5', t: 5.3, d: 1.5 },

                        // === 第二遍 (7~14秒) ===
                        { n: 'E5', t: 7.0, d: 0.6 }, // 從第 7 秒開始重複
                        { n: 'C5', t: 7.6, d: 0.6 },
                        { n: 'D5', t: 8.2, d: 0.6 },
                        { n: 'G4', t: 8.8, d: 1.2 },
                        // 間隔
                        { n: 'G4', t: 10.5, d: 0.6 },
                        { n: 'D5', t: 11.1, d: 0.6 },
                        { n: 'E5', t: 11.7, d: 0.6 },
                        { n: 'C5', t: 12.3, d: 1.5 }, // 結束在約 13.8 秒
                    ];

                    melody.forEach(note => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();

                        osc.type = 'sine'; // 柔和的正弦波
                        osc.frequency.setValueAtTime(notes[note.n], now + note.t);

                        // 音量包絡線
                        gain.gain.setValueAtTime(0, now + note.t);
                        gain.gain.linearRampToValueAtTime(0.3, now + note.t + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + note.t + note.d);

                        osc.connect(gain);
                        gain.connect(ctx.destination);

                        osc.start(now + note.t);
                        osc.stop(now + note.t + note.d + 0.1);
                    });

                } catch (e) { console.error("Audio failed", e); }
            };
            const stopAlertSound = () => {
                if (audioContextRef.current) {
                    audioContextRef.current.close().catch(() => { }).then(() => { audioContextRef.current = null; });
                }
            };

            useEffect(() => {
                let interval;
                if (isTimerRunning && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) { playAlertSound(); setIsTimerRunning(false); return 0; }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTimerRunning]);

            const formatTime = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
            const adjustTime = (v) => { const n = Math.max(10, initialTime + v); setInitialTime(n); setTimeLeft(n); };

            return (
                <div className="flex flex-col h-full gap-4 relative overflow-hidden">
                    {/* 上方控制板 */}
                    <div className="w-full nook-phone-header p-3 flex flex-col gap-3 shrink-0 rounded-[20px] border-2 border-white shadow-md z-20 bg-[#F0F3EC]">
                        <div className="flex flex-wrap justify-between items-center gap-2">
                            <div className="flex items-center gap-2">
                                <div className="bg-[#8D6E63] p-1.5 rounded-xl text-[#FFF8E1] shadow-sm border-2 border-[#5D4037]"><Users size={20} /></div>
                                <div>
                                    <h2 className="text-lg font-bold text-[#5D4037] leading-none">森林咖啡廳</h2>
                                    <span className="text-[10px] text-[#8D6E63] font-bold">World Café (美蓮師監修)</span>
                                </div>
                            </div>

                            {/* ★ 特大號計時器面板 (整合時間與所有按鈕) ★ */}
                            <div className="flex flex-wrap items-center gap-3 bg-white p-3 pr-4 rounded-[25px] border-[3px] border-[#E0E4CC] shadow-sm ml-auto">

                                {/* 1. 時間顯示 (超大字體 text-6xl = 約 60px) */}
                                <div className={`px-4 py-2 rounded-2xl font-mono font-black text-6xl min-w-[240px] text-center tracking-widest bg-[#FAFAFA] border-2 border-[#F2F4E6] ${timeLeft <= 30 && timeLeft > 0 ? 'text-red-500' : 'text-[#5D4037]'}`}>
                                    {formatTime(timeLeft)}
                                </div>

                                {/* 2. 時間調整按鈕群 (垂直排列) */}
                                <div className="flex flex-col gap-1.5">
                                    <div className="flex gap-1">
                                        <button onClick={() => adjustTime(60)} className="px-3 py-1.5 bg-[#F2F4E6] border border-[#E0E4CC] rounded-lg text-[#5D4037] font-bold text-xs hover:bg-[#E0E4CC] active:scale-95 transition-colors">+1分</button>
                                        <button onClick={() => adjustTime(-60)} className="px-3 py-1.5 bg-[#F2F4E6] border border-[#E0E4CC] rounded-lg text-[#5D4037] font-bold text-xs hover:bg-[#E0E4CC] active:scale-95 transition-colors">-1分</button>
                                    </div>
                                    <div className="flex gap-1">
                                        <button onClick={() => adjustTime(10)} className="px-3 py-1.5 bg-[#F2F4E6] border border-[#E0E4CC] rounded-lg text-[#5D4037] font-bold text-xs hover:bg-[#E0E4CC] active:scale-95 transition-colors">+10秒</button>
                                        <button onClick={() => adjustTime(-10)} className="px-3 py-1.5 bg-[#F2F4E6] border border-[#E0E4CC] rounded-lg text-[#5D4037] font-bold text-xs hover:bg-[#E0E4CC] active:scale-95 transition-colors">-10秒</button>
                                    </div>
                                </div>

                                {/* 3. 播放與重置 (加大按鈕) */}
                                <div className="flex gap-2 pl-3 border-l-2 border-[#F2F4E6]">
                                    <button onClick={() => setIsTimerRunning(!isTimerRunning)} className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all shadow-md active:scale-95 hover:scale-105 ${isTimerRunning ? 'bg-[#FFAB91] text-white hover:bg-[#FF8A65]' : 'bg-[#88C9A1] text-white hover:bg-[#68B085]'}`}>
                                        {isTimerRunning ? <Pause size={28} /> : <Play size={28} />}
                                    </button>
                                    <button onClick={reset} className="w-14 h-14 rounded-2xl bg-[#E0E4CC] text-[#797365] flex items-center justify-center hover:bg-[#D7CCC8] shadow-md active:scale-95 hover:scale-105 border-2 border-white">
                                        <RotateCcw size={28} />
                                    </button>
                                </div>
                            </div>

                        </div>


                        {/* ★ 新增：可收折的活動規則說明 ★ */}
                        <details className="group bg-white/60 rounded-xl border border-[#D7CCC8] open:bg-white open:shadow-sm transition-all duration-300">
                            <summary className="cursor-pointer p-2 text-xs font-bold text-[#8D6E63] flex items-center gap-2 select-none hover:text-[#5D4037] transition-colors">
                                <Info size={14} />
                                <span>活動規則說明 (點擊展開)</span>
                                <span className="ml-auto transform group-open:rotate-180 transition-transform text-[#D7CCC8]">▼</span>
                            </summary>
                            <div className="p-3 pt-0 text-xs text-[#5D4037] space-y-2 border-t border-dashed border-[#D7CCC8] mt-1">
                                <div className="mt-2 flex items-start gap-2">
                                    <span className="bg-[#8D6E63] text-white px-1.5 py-0.5 rounded text-[10px] h-fit shrink-0 whitespace-nowrap mt-0.5">桌長 Host</span>
                                    <span className="leading-tight">留守原桌，擔任「發表者」。負責向新來的訪客解說本組的觀點與成果。</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <span className="bg-white border border-[#8D6E63] text-[#8D6E63] px-1.5 py-0.5 rounded text-[10px] h-fit shrink-0 whitespace-nowrap mt-0.5">組員 Travelers</span>
                                    <span className="leading-tight">帶著「旅行護照」移動到下一桌，擔任「訪客」。負責傾聽他組發表並給予回饋。</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <span className="bg-[#F2D879] text-[#797365] px-1.5 py-0.5 rounded text-[10px] h-fit shrink-0 whitespace-nowrap mt-0.5">流程 Flow</span>
                                    <span className="leading-tight">計時開始 ➔ 進行交流 ➔ 時間到 (嗶嗶聲) ➔ 依照下方箭頭指示移動換桌。</span>
                                </div>
                            </div>
                        </details>

                        <div className="flex flex-wrap gap-2 items-center text-xs">
                            <div className="flex gap-2 items-center bg-white p-2 rounded-xl border border-[#E0E4CC] shadow-sm flex-1 min-w-[150px]">
                                <span className="font-bold text-[#5D4037] whitespace-nowrap">桌數: {numGroups}</span>
                                <input type="range" min="3" max="15" value={numGroups} onChange={e => { setNumGroups(Number(e.target.value)); setRound(0); }} className="flex-1 h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#8D6E63]" />
                            </div>
                            <div className="flex gap-2 items-center bg-white p-2 rounded-xl border border-[#E0E4CC] shadow-sm flex-1 min-w-[150px]">
                                <span className="font-bold text-[#5D4037] whitespace-nowrap">人數: {studentsPerGroup}</span>
                                <input type="range" min="2" max="8" value={studentsPerGroup} onChange={e => setStudentsPerGroup(Number(e.target.value))} className="flex-1 h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#8D6E63]" />
                            </div>

                        </div>

                        <div className="flex justify-between items-center bg-[#D7CCC8] p-2 rounded-xl border-2 border-[#A1887F] text-[#3E2723]">
                            <div className="flex items-center gap-2">
                                <span className="bg-[#3E2723] text-[#FFF8E1] text-[10px] font-black px-2 py-0.5 rounded-full">STATUS</span>
                                <span className="text-lg font-black">{round === 0 ? "準備中" : `第 ${round} 輪交流`}</span>
                            </div>
                            <button onClick={nextRound} className="flex items-center gap-1 bg-[#5D4037] text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm hover:bg-[#4E342E] active:translate-y-0.5 border border-[#3E2723]">
                                下一輪 <SkipForward size={12} />
                            </button>
                        </div>
                    </div>

                    {/* 下方顯示區 */}
                    <div className="flex-1 overflow-y-auto p-4 bg-[#C5E1A5] rounded-[20px] shadow-inner custom-scrollbar relative">
                        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#558B2F 2px, transparent 2px)', backgroundSize: '20px 20px' }}></div>

                        <div className="grid gap-8 content-start pb-10 relative z-10" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(170px, 1fr))' }}>
                            {Array.from({ length: numGroups }).map((_, tableIndex) => {
                                const groupColor = groupColors[tableIndex % groupColors.length];
                                const visitorGroupIndex = getGroupVisitorsAtTable(tableIndex, round, numGroups);
                                const visitorColor = groupColors[visitorGroupIndex % groupColors.length];

                                return (
                                    <div key={tableIndex} className="flex flex-col items-center">

                                        {/* 樹樁圓桌 */}
                                        <div className="relative w-40 h-40 rounded-full flex flex-col items-center justify-center shadow-lg transform transition-transform hover:scale-105"
                                            style={{
                                                backgroundColor: '#DEB887',
                                                backgroundImage: 'repeating-radial-gradient(#E6CEAA 0, #E6CEAA 10px, #D4B483 11px, #D4B483 12px)',
                                                border: '6px solid #8B4513'
                                            }}>

                                            <div className="absolute -top-4 bg-[#FFF8E1] px-3 py-1 rounded-md border-2 border-[#8B4513] shadow-sm text-base font-black text-[#5D4037] transform rotate-[-3deg] z-20 whitespace-nowrap">
                                                Table {tableIndex + 1}
                                            </div>

                                            <div className="flex flex-col items-center z-10 mb-1">
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center border-2 border-white shadow-sm mb-0.5"
                                                    style={{ backgroundColor: groupColor.bg }}>
                                                    <MapPin size={18} color={groupColor.text} strokeWidth={2.5} />
                                                </div>
                                                <span className="text-[9px] font-bold text-[#5D4037] bg-white/80 px-1.5 rounded-full backdrop-blur-sm">發表</span>
                                            </div>

                                            <div className="flex justify-center gap-1 flex-wrap px-2 z-10">
                                                {Array.from({ length: Math.min(3, Math.max(0, studentsPerGroup - 1)) }).map((_, i) => (
                                                    <div key={i} className="w-7 h-7 rounded-full bg-white border border-[#8B4513] flex items-center justify-center shadow-sm" title={`來自第 ${visitorGroupIndex + 1} 桌`}>
                                                        <User size={14} color={visitorColor.text} fill={visitorColor.bg} />
                                                    </div>
                                                ))}
                                                {(studentsPerGroup - 1) > 3 && (
                                                    <div className="w-7 h-7 rounded-full bg-[#EFEBE9] border border-[#8B4513] flex items-center justify-center text-[9px] font-bold text-[#5D4037]">
                                                        +{studentsPerGroup - 4}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="mt-3 bg-[#8D6E63] text-white text-sm font-bold py-1.5 px-3 rounded-lg border-2 border-[#5D4037] shadow-sm flex items-center gap-1.5 transform rotate-1">
                                            <span>來自 G{visitorGroupIndex + 1}</span>
                                            <ArrowRight size={16} strokeWidth={3} />
                                            <span>往 T{(tableIndex + 1) % numGroups + 1}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * 傅達的實驗繪圖板 (Lab Plotter Tool) V4.2 - 自動標題+圓鈕優化版
         * 專為自然科學實驗設計的數據分析與繪圖工具
         * 支援線性回歸、二次多項式、冪次、指數函數擬合
         * 提供 Excel 匯入、資料貼上、與互動式 Canvas 繪圖功能
         */
        const LabPlotterTool = () => {
            // 預設數據：二次函數範例
            const defaultRows = Array(20).fill(null).map((_, i) =>
                i < 5 ? { x: (i + 1).toString(), y: (4.9 * (i + 1) * (i + 1)).toFixed(1) } : { x: "", y: "" }
            );

            const [dataRows, setDataRows] = useState(defaultRows);
            const [xLabel, setXLabel] = useState("時間 t (s)");
            const [yLabel, setYLabel] = useState("位移 S (m)");
            const [fitType, setFitType] = useState("poly2"); // 預設擬合類型
            const [showEq, setShowEq] = useState(true);
            const [stats, setStats] = useState(null);
            const [renderTrigger, setRenderTrigger] = useState(0); // 強制重繪觸發器
            const canvasRef = useRef(null);

            // --- 資料處理核心功能 ---

            // 處理貼上事件：支援從 Excel/Google Sheets 直接貼上數據
            const handlePaste = (e) => {
                e.preventDefault();
                const pastedText = e.clipboardData.getData('text');
                const lines = pastedText.trim().split('\n');
                const newRows = [...dataRows];

                lines.forEach((line, i) => {
                    if (i < newRows.length) {
                        // 支援多種分隔符: Tab, 逗號, 空格
                        const parts = line.split(/[\t,\s]+/);
                        newRows[i].x = parts[0] || "";
                        newRows[i].y = parts[1] || "";
                    }
                });

                setDataRows(newRows);
            };

            // Excel 檔案匯入功能 (使用 SheetJS)
            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        if (!window.XLSX) {
                            alert("Excel 元件尚未載入,請稍後再試");
                            return;
                        }

                        const wb = window.XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = window.XLSX.utils.sheet_to_json(ws, { header: 1 });

                        const newRows = Array(20).fill(null).map(() => ({ x: "", y: "" }));
                        data.forEach((row, i) => {
                            if (i < newRows.length && row.length >= 2) {
                                newRows[i].x = String(row[0] || "");
                                newRows[i].y = String(row[1] || "");
                            }
                        });

                        setDataRows(newRows);
                    } catch (e) {
                        console.error(e);
                        alert("讀取 Excel 失敗,請確認檔案格式");
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = null;
            };

            const handleCellChange = (index, field, value) => {
                const newRows = [...dataRows];
                newRows[index][field] = value;
                setDataRows(newRows);
            };

            const clearAll = () => {
                setDataRows(Array(20).fill(null).map(() => ({ x: "", y: "" })));
                setStats(null);
                setRenderTrigger(prev => prev + 1);
            };

            // --- 數學擬合運算核心 (Regression Analysis) ---

            // 線性回歸 y = mx + c
            const solveLinear = (data) => {
                const n = data.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                data.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumXX += p.x * p.x; });
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                return {
                    eqStr: `y = ${slope.toFixed(4)}x + ${intercept.toFixed(4)}`,
                    predict: (x) => slope * x + intercept,
                    params: { m: slope, c: intercept }
                };
            };

            // 二次多項式回歸 y = ax² + bx + c
            const solvePoly2 = (data) => {
                let sX = 0, sX2 = 0, sX3 = 0, sX4 = 0, sY = 0, sXY = 0, sX2Y = 0; const n = data.length;
                data.forEach(p => { const x = p.x, y = p.y, x2 = x * x; sX += x; sX2 += x2; sX3 += x2 * x; sX4 += x2 * x2; sY += y; sXY += x * y; sX2Y += x2 * y; });
                const det = n * (sX2 * sX4 - sX3 * sX3) - sX * (sX * sX4 - sX3 * sX2) + sX2 * (sX * sX3 - sX2 * sX2);
                if (Math.abs(det) < 1e-9) return null;
                const detA = sY * (sX2 * sX4 - sX3 * sX3) - sX * (sXY * sX4 - sX3 * sX2Y) + sX2 * (sXY * sX3 - sX2 * sX2Y);
                const detB = n * (sXY * sX4 - sX3 * sX2Y) - sY * (sX * sX4 - sX3 * sX2) + sX2 * (sX * sX2Y - sXY * sX2);
                const detC = n * (sX2 * sX2Y - sXY * sX3) - sX * (sX * sX2Y - sXY * sX2) + sY * (sX * sX3 - sX2 * sX2);
                const c = detA / det, b = detB / det, a = detC / det;
                return {
                    eqStr: `y = ${a.toFixed(4)}x² + ${b.toFixed(4)}x + ${c.toFixed(4)}`,
                    predict: (x) => a * x * x + b * x + c,
                    params: { a, b, c }
                };
            };

            // 冪次函數回歸 y = ax^b (轉為線性: ln(y) = ln(a) + b*ln(x))
            const solvePower = (data) => {
                const logData = data.filter(p => p.x > 0 && p.y > 0).map(p => ({ x: Math.log(p.x), y: Math.log(p.y) }));
                if (logData.length < 2) return null;
                const linear = solveLinear(logData);
                const b = linear.params.m; const a = Math.exp(linear.params.c);
                return {
                    eqStr: `y = ${a.toFixed(4)} * x^${b.toFixed(4)}`,
                    predict: (x) => a * Math.pow(x, b),
                    params: { a, b }
                };
            };

            // 指數函數回歸 y = ae^(bx) (轉為線性: ln(y) = ln(a) + bx)
            const solveExp = (data) => {
                const logData = data.filter(p => p.y > 0).map(p => ({ x: p.x, y: Math.log(p.y) }));
                if (logData.length < 2) return null;
                const linear = solveLinear(logData);
                const b = linear.params.m; const a = Math.exp(linear.params.c);
                return {
                    eqStr: `y = ${a.toFixed(4)} * e^(${b.toFixed(4)}x)`,
                    predict: (x) => a * Math.exp(b * x),
                    params: { a, b }
                };
            };

            // 執行數據分析的主控函數
            const analyzeData = (customRows = null, customFitType = null) => {
                const rowsToUse = customRows || dataRows;
                const typeToUse = customFitType || fitType;
                const validPoints = [];
                rowsToUse.forEach(row => {
                    const x = parseFloat(row.x), y = parseFloat(row.y);
                    if (!isNaN(x) && !isNaN(y)) validPoints.push({ x, y });
                });

                if (validPoints.length < 2) {
                    if (!customRows) alert("請至少輸入兩組有效數據");
                    setStats(null);
                    setRenderTrigger(prev => prev + 1);
                    return;
                }

                let result = null;
                try {
                    if (typeToUse === 'linear') result = solveLinear(validPoints);
                    else if (typeToUse === 'poly2') result = solvePoly2(validPoints);
                    else if (typeToUse === 'power') result = solvePower(validPoints);
                    else if (typeToUse === 'exp') result = solveExp(validPoints);
                } catch (e) { }

                if (!result && !customRows) { alert("無法擬合"); return; }

                // 計算 R-Squared
                const meanY = validPoints.reduce((s, p) => s + p.y, 0) / validPoints.length;
                const ssTot = validPoints.reduce((s, p) => s + Math.pow(p.y - meanY, 2), 0);
                const ssRes = validPoints.reduce((s, p) => s + Math.pow(p.y - result.predict(p.x), 2), 0);
                const rSquared = ssTot === 0 ? 1 : (1 - (ssRes / ssTot));

                setStats({ ...result, rSquared, points: validPoints, type: typeToUse });
                setRenderTrigger(prev => prev + 1);
            };

            // ★★★ 手繪 Canvas 核心 (自動標題 + 增加上方留白) ★★★
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                ctx.clearRect(0, 0, rect.width, rect.height);

                if (!stats || !stats.points || stats.points.length === 0) {
                    ctx.fillStyle = "#CCC"; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "center";
                    ctx.fillText("請輸入數據並點擊右側分析...", rect.width / 2, rect.height / 2);
                    return;
                }

                const padding = { top: 80, right: 30, bottom: 50, left: 60 };
                const plotW = rect.width - padding.left - padding.right;
                const plotH = rect.height - padding.top - padding.bottom;

                const xs = stats.points.map(p => p.x);
                const ys = stats.points.map(p => p.y);
                let minX = Math.min(...xs), maxX = Math.max(...xs);
                let minY = Math.min(...ys), maxY = Math.max(...ys);
                const rangeX = maxX - minX || 1;
                const rangeY = maxY - minY || 1;

                // 稍微擴大顯示範圍
                minX -= rangeX * 0.1; maxX += rangeX * 0.1;
                minY -= rangeY * 0.1; maxY += rangeY * 0.1;

                const mapX = (val) => padding.left + ((val - minX) / (maxX - minX)) * plotW;
                const mapY = (val) => padding.top + plotH - ((val - minY) / (maxY - minY)) * plotH;

                // 繪製格線與刻度
                ctx.strokeStyle = "#EEEEEE"; ctx.lineWidth = 1;
                ctx.fillStyle = "#795548"; ctx.font = "10px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "top";
                for (let i = 0; i <= 5; i++) {
                    const val = minX + ((maxX - minX) * i / 5); const cx = mapX(val);
                    ctx.beginPath(); ctx.moveTo(cx, padding.top); ctx.lineTo(cx, padding.top + plotH); ctx.stroke();
                    ctx.fillText(val.toFixed(1), cx, padding.top + plotH + 5);
                }
                ctx.textAlign = "right"; ctx.textBaseline = "middle";
                for (let i = 0; i <= 5; i++) {
                    const val = minY + ((maxY - minY) * i / 5); const cy = mapY(val);
                    ctx.beginPath(); ctx.moveTo(padding.left, cy); ctx.lineTo(padding.left + plotW, cy); ctx.stroke();
                    ctx.fillText(val.toFixed(1), padding.left - 5, cy);
                }

                // 標題與軸標籤
                ctx.fillStyle = "#5D4037"; ctx.font = "bold 14px sans-serif"; ctx.textAlign = "center";
                ctx.fillText(xLabel, padding.left + plotW / 2, padding.top + plotH + 35);
                ctx.save(); ctx.translate(20, padding.top + plotH / 2); ctx.rotate(-Math.PI / 2);
                ctx.fillText(yLabel, 0, 0); ctx.restore();

                // 繪製圖表邊框
                ctx.strokeStyle = "#5D4037"; ctx.lineWidth = 2; ctx.strokeRect(padding.left, padding.top, plotW, plotH);

                // 繪製擬合曲線
                ctx.beginPath(); ctx.strokeStyle = "#FF7043"; ctx.lineWidth = 3;
                for (let i = 0; i <= 100; i++) {
                    const xVal = minX + (maxX - minX) * (i / 100); const yVal = stats.predict(xVal);
                    if (yVal >= minY && yVal <= maxY) {
                        const cx = mapX(xVal); const cy = mapY(yVal);
                        if (i === 0) ctx.moveTo(cx, cy); else ctx.lineTo(cx, cy);
                    }
                }
                ctx.stroke();

                // 繪製數據點
                stats.points.forEach(p => {
                    const cx = mapX(p.x); const cy = mapY(p.y);
                    ctx.beginPath(); ctx.fillStyle = "#8D6E63"; ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.stroke();
                });

                // 繪製上方大標題
                ctx.textAlign = "center";
                ctx.fillStyle = "#3E2723"; ctx.font = "bold 20px sans-serif";
                ctx.fillText(`${yLabel} vs ${xLabel}`, rect.width / 2, 30);

                // 繪製方程式
                if (showEq) {
                    ctx.fillStyle = "#E64A19"; ctx.font = "bold 14px sans-serif";
                    ctx.fillText(`${stats.eqStr} (R²=${stats.rSquared.toFixed(4)})`, rect.width / 2, 55);
                }

            }, [renderTrigger, stats, xLabel, yLabel, showEq]);

            // 載入預設範例
            const loadExample = (type) => {
                const newRows = Array(20).fill(null).map(() => ({ x: "", y: "" }));
                let newX = "X", newY = "Y";
                if (type === 'linear') { newX = "伸長量 x (cm)"; newY = "外力 F (gw)"; setFitType('linear');[{ x: "2.0", y: "10" }, { x: "4.1", y: "20" }, { x: "5.9", y: "30" }, { x: "8.2", y: "40" }, { x: "10.0", y: "50" }].forEach((d, i) => newRows[i] = d); }
                else if (type === 'poly2') { newX = "時間 t (s)"; newY = "位移 S (m)"; setFitType('poly2');[{ x: "0", y: "0" }, { x: "1", y: "4.9" }, { x: "2", y: "19.5" }, { x: "3", y: "44.2" }, { x: "4", y: "78.3" }].forEach((d, i) => newRows[i] = d); }
                else if (type === 'exp') { newX = "時間 t (s)"; newY = "電壓 V (V)"; setFitType('exp');[{ x: "0", y: "10.0" }, { x: "1", y: "6.1" }, { x: "2", y: "3.7" }, { x: "3", y: "2.2" }, { x: "4", y: "1.4" }].forEach((d, i) => newRows[i] = d); }
                setXLabel(newX); setYLabel(newY); setDataRows(newRows);
                setTimeout(() => analyzeData(newRows, type), 50);
            };

            // 初始加載自動分析
            useEffect(() => { setTimeout(() => analyzeData(defaultRows, "poly2"), 100); }, []);

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 w-full max-w-full">
                    <div className="flex flex-col lg:flex-row gap-6 lg:h-[600px] w-full">
                        {/* ☆☆☆ 修改後的左側:Excel風格表格 ☆☆☆ */}
                        <div className="w-full lg:w-[35%] flex flex-col h-[500px] lg:h-full bg-[#EFEBE9] p-4 rounded-[24px] border-[3px] border-[#D7CCC8] shrink-0 min-w-0">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-sm font-bold text-[#5D4037] flex items-center gap-2">
                                    <Activity size={18} /> 實驗數據表
                                </label>
                                <div className="flex gap-2">
                                    {/* ☆ Excel匯入按鈕 ☆ */}
                                    <label className="text-xs bg-white border border-[#D7CCC8] px-3 py-1.5 rounded hover:bg-[#D7CCC8] cursor-pointer font-bold flex items-center gap-1">
                                        <Upload size={12} /> Excel
                                        <input type="file" accept=".xlsx,.xls" onChange={handleExcelUpload} className="hidden" />
                                    </label>
                                    <button onClick={clearAll} className="text-xs bg-white border border-[#D7CCC8] px-2 py-1 rounded hover:bg-red-50 text-red-500">🗑️</button>
                                </div>
                            </div>

                            {/* 軸名稱輸入 */}
                            <div className="flex gap-2 mb-2 shrink-0">
                                <input value={xLabel} onChange={e => setXLabel(e.target.value)} className="w-1/2 p-1.5 rounded border border-[#D7CCC8] text-xs font-bold text-center text-[#5D4037] min-w-0" placeholder="X軸名稱" />
                                <input value={yLabel} onChange={e => setYLabel(e.target.value)} className="w-1/2 p-1.5 rounded border border-[#D7CCC8] text-xs font-bold text-center text-[#5D4037] min-w-0" placeholder="Y軸名稱" />
                            </div>

                            {/* ☆☆☆ Excel風格表格 (支援 Ctrl+V 貼上) ☆☆☆ */}
                            <div
                                className="flex-1 border-2 border-[#D7CCC8] rounded-lg overflow-hidden flex flex-col bg-white min-h-0"
                                onPaste={handlePaste}
                            >
                                {/* 表頭 */}
                                <div className="flex bg-[#D7CCC8] text-[#5D4037] text-xs font-black py-1.5 px-2 shrink-0">
                                    <div className="w-10 text-center opacity-50">#</div>
                                    <div className="flex-1 text-center border-l border-[#5D4037]/20">X (自變項)</div>
                                    <div className="flex-1 text-center border-l border-[#5D4037]/20">Y (應變項)</div>
                                </div>

                                {/* 數據行 */}
                                <div className="overflow-y-auto flex-1 custom-scrollbar">
                                    {dataRows.map((row, i) => (
                                        <div key={i} className="flex border-b border-[#EEE] last:border-none text-sm h-8 hover:bg-[#FFF8E1]">
                                            <div className="w-10 flex items-center justify-center bg-[#F5F5F5] text-[#999] text-xs font-bold select-none border-r border-[#EEE] shrink-0">{i + 1}</div>
                                            <div className="flex-1 border-r border-[#EEE] min-w-0">
                                                <input
                                                    type="number"
                                                    value={row.x}
                                                    onChange={e => handleCellChange(i, 'x', e.target.value)}
                                                    className="w-full h-full px-2 text-center text-[#5D4037] font-bold focus:bg-[#E3F2FD] focus:outline-none transition-colors"
                                                />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <input
                                                    type="number"
                                                    value={row.y}
                                                    onChange={e => handleCellChange(i, 'y', e.target.value)}
                                                    className="w-full h-full px-2 text-center text-[#5D4037] font-bold focus:bg-[#E3F2FD] focus:outline-none transition-colors"
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* 快速範例按鈕 */}
                            <div className="flex gap-2 mt-2 pt-2 border-t border-[#D7CCC8]/50 shrink-0 overflow-x-auto pb-1">
                                <button onClick={() => loadExample('linear')} className="flex-1 text-[10px] bg-[#EFEBE9] py-1.5 px-2 rounded text-[#8D6E63] font-bold hover:bg-[#D7CCC8] border border-[#D7CCC8] whitespace-nowrap">虎克 (線)</button>
                                <button onClick={() => loadExample('poly2')} className="flex-1 text-[10px] bg-[#EFEBE9] py-1.5 px-2 rounded text-[#8D6E63] font-bold hover:bg-[#D7CCC8] border border-[#D7CCC8] whitespace-nowrap">自由落體 (拋)</button>
                                <button onClick={() => loadExample('exp')} className="flex-1 text-[10px] bg-[#EFEBE9] py-1.5 px-2 rounded text-[#8D6E63] font-bold hover:bg-[#D7CCC8] border border-[#D7CCC8] whitespace-nowrap">電容 (指)</button>
                            </div>

                            {/* ☆ 使用說明 ☆ */}
                            <div className="mt-2 text-[9px] text-[#9CA38F] font-bold text-center bg-[#FFF9C4] py-1 px-2 rounded border border-[#FBC02D]">
                                💡 提示:可從Excel複製後直接按 Ctrl+V 貼入表格
                            </div>
                        </div>

                        {/* 右側:圖表與分析 (保持不變) */}
                        <div className="w-full lg:w-[65%] flex flex-col h-[500px] lg:h-full gap-4 min-w-0">
                            <div className="flex flex-wrap items-center gap-3 bg-white p-3 rounded-2xl border-2 border-[#E0E0E0] shadow-sm shrink-0">
                                <div className="flex items-center gap-2 shrink-0">
                                    <span className="text-xs font-bold text-[#9CA38F] whitespace-nowrap">擬合模型:</span>
                                    <select value={fitType} onChange={e => setFitType(e.target.value)} className="p-2 rounded-lg border-2 border-[#E0E0E0] text-sm font-bold text-[#574E44] outline-none focus:border-[#8D6E63] min-w-[120px]">
                                        <option value="linear">線性回歸 (Linear)</option>
                                        <option value="poly2">二次多項式 (Quadratic)</option>
                                        <option value="power">冪次函數 (Power)</option>
                                        <option value="exp">指數函數 (Exp)</option>
                                    </select>
                                </div>
                                <label className="flex items-center gap-2 cursor-pointer select-none whitespace-nowrap shrink-0">
                                    <input type="checkbox" checked={showEq} onChange={e => setShowEq(e.target.checked)} className="w-4 h-4 text-[#8D6E63] rounded focus:ring-[#8D6E63]" />
                                    <span className="text-sm font-bold text-[#574E44]">顯示方程式</span>
                                </label>
                                <div className="flex-1"></div>
                                <button onClick={() => analyzeData()} className="w-12 h-12 bg-[#8D6E63] hover:bg-[#6D4C41] rounded-full flex items-center justify-center text-white shadow-md hover:scale-110 active:scale-95 transition-all shrink-0 border-4 border-[#EFEBE9]" title="開始分析">
                                    <Play size={20} fill="currentColor" className="ml-1" />
                                </button>
                            </div>

                            <div className="bg-white p-2 md:p-4 rounded-[24px] border-[3px] border-[#E0E0E0] flex-1 relative shadow-sm min-h-0 overflow-hidden w-full flex flex-col">
                                <div className="flex-1 relative w-full h-full min-h-0">
                                    <div className="absolute inset-0">
                                        <canvas ref={canvasRef} style={{ width: '100%', height: '100%' }}></canvas>
                                    </div>
                                </div>
                                {stats && (
                                    <div className="mt-2 shrink-0 bg-[#FFF8E1] border-2 border-[#FFE082] rounded-xl p-3 grid grid-cols-3 gap-2 text-center shadow-inner">
                                        <div><div className="text-[10px] text-[#FF8F00] font-bold uppercase tracking-wider">{stats.type === 'linear' ? '斜率 Slope (m)' : '係數 a'}</div><div className="text-lg font-black text-[#5D4037]">{stats.params.m ? stats.params.m.toFixed(4) : stats.params.a?.toFixed(4)}</div></div>
                                        <div className="border-l border-[#FFE082]"><div className="text-[10px] text-[#FF8F00] font-bold uppercase tracking-wider">{stats.type === 'linear' ? '截距 Intercept (c)' : '係數 b'}</div><div className="text-lg font-black text-[#5D4037]">{stats.params.c ? stats.params.c.toFixed(4) : stats.params.b?.toFixed(4)}</div></div>
                                        <div className="border-l border-[#FFE082]"><div className="text-[10px] text-[#FF8F00] font-bold uppercase tracking-wider">相關係數 R²</div><div className="text-lg font-black text-[#E64A19]">{stats.rSquared.toFixed(4)}</div></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * 狸克印刷廠 (獎狀產生器) - V3.6 極簡姓名版
         * 模仿《集合啦！動物森友會》風格的獎狀產生器
         * 支援 HTML2Canvas + jsPDF 匯出 A4 PDF
         * 提供多種主題 (無人島、博物館、星空) 切換
         */
        const CertificateTool = () => {
            const [name, setName] = useState("陳小明");
            const [award, setAward] = useState("物理小天才");
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [sender, setSender] = useState("詹老師");
            const [theme, setTheme] = useState("nook");
            const [isExporting, setIsExporting] = useState(false);
            const [scale, setScale] = useState(1);

            const containerRef = useRef(null);
            const certRef = useRef(null);

            // A4 邏輯尺寸 (Landscape)
            const A4_WIDTH = 842;
            const A4_HEIGHT = 595;

            // 自動計算縮放比例
            useEffect(() => {
                const handleResize = () => {
                    if (containerRef.current) {
                        const parentWidth = containerRef.current.offsetWidth;
                        // 保留約 5% 邊距，避免貼邊
                        const newScale = Math.min(1, (parentWidth / A4_WIDTH) * 0.95);
                        setScale(newScale);
                    }
                };
                window.addEventListener('resize', handleResize);
                setTimeout(handleResize, 100);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const themes = {
                nook: { bg: "#F9F5E3", border: "#7FD1B9", accent: "#F2D879", text: "#574E44", icon: "🍃", title: "榮譽獎狀" },
                blathers: { bg: "#EFEBE9", border: "#8D6E63", accent: "#5D4037", text: "#3E2723", icon: "🦉", title: "學術鑑定書" },
                celeste: { bg: "#1a1a2e", border: "#F4E798", accent: "#16213e", text: "#FFF", icon: "✨", title: "星空觀測獎" }
            };
            const currentTheme = themes[theme];

            const handleExport = async () => {
                if (!certRef.current || !window.html2canvas || !window.PDFLib) return;
                setIsExporting(true);
                try {
                    const canvas = await window.html2canvas(certRef.current, {
                        scale: 4,
                        useCORS: true,
                        backgroundColor: currentTheme.bg,
                        onclone: (clonedDoc) => {
                            const el = clonedDoc.getElementById('cert-inner-body');
                            if (el) {
                                // 匯出時移除縮放與邊距，還原為標準 A4
                                el.style.transform = 'none';
                                el.style.margin = '0';
                            }
                        }
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const pdfDoc = await window.PDFLib.PDFDocument.create();
                    const page = pdfDoc.addPage([841.89, 595.28]);
                    const pngImage = await pdfDoc.embedPng(imgData);

                    page.drawImage(pngImage, {
                        x: 0, y: 0, width: 841.89, height: 595.28,
                    });

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `獎狀_${name}.pdf`;
                    a.click();
                } catch (e) {
                    console.error(e);
                    alert("匯出失敗，請重試");
                } finally {
                    setIsExporting(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* 設定區 */}
                    <div className="bg-[#F8F9F0] p-4 rounded-[24px] border-[3px] border-white grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-3">
                            <div><label className="text-xs font-bold text-[#9CA38F]">獲獎人</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 rounded-xl border-none font-bold text-[#797365]" /></div>
                            <div><label className="text-xs font-bold text-[#9CA38F]">獎項名稱</label><input type="text" value={award} onChange={e => setAward(e.target.value)} className="w-full p-2 rounded-xl border-none font-bold text-[#797365]" /></div>
                        </div>
                        <div className="space-y-3">
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs font-bold text-[#9CA38F]">頒獎日期</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-2 rounded-xl border-none font-bold text-[#797365]" /></div>
                                <div className="flex-1"><label className="text-xs font-bold text-[#9CA38F]">頒發人</label><input type="text" value={sender} onChange={e => setSender(e.target.value)} className="w-full p-2 rounded-xl border-none font-bold text-[#797365]" /></div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-[#9CA38F] block mb-1">風格主題</label>
                                <div className="flex gap-2">
                                    <button onClick={() => setTheme('nook')} className={`flex-1 py-1 rounded-lg font-bold text-xs border-2 ${theme === 'nook' ? 'border-[#7FD1B9] bg-[#7FD1B9] text-white' : 'border-[#E0E4CC] bg-white text-[#9CA38F]'}`}>🍃 無人島</button>
                                    <button onClick={() => setTheme('blathers')} className={`flex-1 py-1 rounded-lg font-bold text-xs border-2 ${theme === 'blathers' ? 'border-[#8D6E63] bg-[#8D6E63] text-white' : 'border-[#E0E4CC] bg-white text-[#9CA38F]'}`}>🦉 博物館</button>
                                    <button onClick={() => setTheme('celeste')} className={`flex-1 py-1 rounded-lg font-bold text-xs border-2 ${theme === 'celeste' ? 'border-[#16213e] bg-[#1a1a2e] text-[#F4E798]' : 'border-[#E0E4CC] bg-white text-[#9CA38F]'}`}>✨ 星空</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-end">
                        <Button onClick={handleExport} disabled={isExporting} variant="primary" icon={isExporting ? Loader2 : Download}>
                            {isExporting ? "製作中..." : "下載 A4 PDF 獎狀"}
                        </Button>
                    </div>

                    {/* 預覽容器 */}
                    <div ref={containerRef} className="w-full flex justify-center overflow-hidden pb-4">
                        <div style={{
                            width: A4_WIDTH,
                            height: A4_HEIGHT,
                            transform: `scale(${scale})`,
                            transformOrigin: 'top center',
                            marginBottom: `-${A4_HEIGHT * (1 - scale)}px`
                        }}>

                            {/* 獎狀本體 */}
                            <div id="cert-inner-body" ref={certRef} className="shadow-xl relative flex flex-col items-center justify-center text-center transition-colors duration-500 border-[20px] p-8 box-border"
                                style={{
                                    width: '842px',
                                    height: '595px',
                                    backgroundColor: currentTheme.bg,
                                    borderColor: currentTheme.border,
                                    color: currentTheme.text,
                                    fontFamily: "'Noto Serif TC', 'PMingLiU', 'MingLiU', serif",
                                }}>

                                {/* 裝飾圖示 */}
                                <div className="absolute top-3 left-3 text-4xl opacity-50">{currentTheme.icon}</div>
                                <div className="absolute top-3 right-3 text-4xl opacity-50">{currentTheme.icon}</div>
                                <div className="absolute bottom-3 left-3 text-4xl opacity-50">{currentTheme.icon}</div>
                                <div className="absolute bottom-3 right-3 text-4xl opacity-50">{currentTheme.icon}</div>

                                {/* 內容容器 */}
                                <div className="border-4 border-double w-full h-full flex flex-col justify-between p-6" style={{ borderColor: currentTheme.accent }}>

                                    {/* 1. 頭部 */}
                                    <div className="w-full flex-none">
                                        <div className="text-2xl font-bold tracking-[0.5em] opacity-80 uppercase mb-2">{currentTheme.title}</div>
                                        <h1 className="text-6xl font-bold whitespace-nowrap leading-tight" style={{ color: currentTheme.border }}>{award}</h1>
                                        <div className="text-xl font-bold opacity-80 mt-2">茲證明</div>
                                    </div>

                                    {/* 2. 姓名區塊：簡化版 (無底線) */}
                                    <div className="w-full flex-grow flex flex-col items-center justify-center min-h-0">
                                        <div className="w-full flex justify-center items-center">
                                            {/* 使用 tracking-widest 增加氣勢，移除所有底線元素 */}
                                            <div className="text-6xl font-bold tracking-widest leading-normal px-8 py-2 whitespace-nowrap">
                                                {name}
                                            </div>
                                        </div>

                                        <p className="text-xl font-bold opacity-80 leading-relaxed mt-6">
                                            在近期的學習與活動中表現優異，<br />
                                            特頒此狀，以資鼓勵。
                                        </p>
                                    </div>

                                    {/* 3. 底部簽名 */}
                                    <div className="w-full flex-none flex justify-between items-end px-8 pb-2">
                                        <div className="text-left">
                                            <div className="text-sm font-bold opacity-60 mb-1">DATE</div>
                                            <div className="text-2xl font-bold whitespace-nowrap">{date}</div>
                                        </div>

                                        <div className="relative">
                                            <div className="absolute -top-10 -left-8 w-28 h-28 border-[5px] rounded-full flex items-center justify-center opacity-40 rotate-[-15deg]" style={{ borderColor: 'red', color: 'red' }}>
                                                <span className="text-base font-bold border-2 border-red-500 rounded p-0.5">OFFICIAL</span>
                                            </div>
                                            <div className="text-center relative z-10 pl-6">
                                                <div className="text-4xl font-bold mb-1 font-serif whitespace-nowrap">{sender}</div>
                                                <div className="w-40 h-0.5 bg-current opacity-40 mb-1 mx-auto"></div>
                                                <div className="text-sm font-bold opacity-60">SIGNATURE</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * 座位大師 (Seating Chart Tool) V3.0
         * 教室座位表排版工具，支援學生視角與導師視角
         * 具備隨機、依序、S型、梅花座等多種排列演算法
         * 支援鎖定特定座位、設定障礙物、匯入名單(文字/Excel)
         * 可匯出 PDF 座位表
         */
        const SeatingChartTool = () => {
            const [namesStr, setNamesStr] = useState("");
            const [rows, setRows] = useState(6);
            const [cols, setCols] = useState(7);
            const [seats, setSeats] = useState(Array.from({ length: 42 }, () => ({ text: "", note: "", type: "empty", locked: false })));
            const [title, setTitle] = useState("");
            const [ignoreStr, setIgnoreStr] = useState("");
            const [mode, setMode] = useState("swap"); // swap, block, lock
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [currentView, setCurrentView] = useState("student");
            const [isExporting, setIsExporting] = useState(false);
            const containerRef = useRef(null);
            const [gridStyle, setGridStyle] = useState({});

            // 解析名單
            const parseNames = () => {
                if (!namesStr) return [];
                const allNames = namesStr.split(/[\n,]+/).map(s => s.trim()).filter(s => s && !ignoreStr.includes(s));
                const lockedNames = seats.filter(s => s.locked && s.text).map(s => s.text);
                return allNames.filter(n => !lockedNames.includes(n));
            };

            // RWD 網格計算
            useEffect(() => {
                const updateGridSize = () => {
                    if (!containerRef.current) return;
                    const { width, height } = containerRef.current.getBoundingClientRect();
                    const availableWidth = width - 48;
                    const availableHeight = height - 140;
                    const gap = 8;
                    const cellH = (availableHeight - ((rows - 1) * gap)) / rows;
                    const cellW = (availableWidth - ((cols - 1) * gap)) / cols;
                    const size = Math.max(40, Math.min(cellH, cellW, 120));

                    setGridStyle({
                        gridTemplateColumns: `repeat(${cols}, ${size}px)`,
                        gridTemplateRows: `repeat(${rows}, ${size}px)`
                    });
                };
                setSeats(prev => {
                    const newSize = rows * cols;
                    if (prev.length === newSize) return prev;
                    const newSeats = Array.from({ length: newSize }, () => ({ text: "", note: "", type: "empty", locked: false }));
                    for (let i = 0; i < Math.min(prev.length, newSize); i++) newSeats[i] = prev[i];
                    return newSeats;
                });

                const resizeObserver = new ResizeObserver(() => window.requestAnimationFrame(updateGridSize));
                if (containerRef.current) resizeObserver.observe(containerRef.current);
                updateGridSize();
                return () => resizeObserver.disconnect();
            }, [rows, cols]);

            // --- 核心演算法區 ---
            const fillGridWithList = (sortedList, useSnakeOrder = false) => {
                let currentListIdx = 0;
                const newSeats = [...seats];
                let availableIndices = [];
                for (let i = 0; i < newSeats.length; i++) {
                    if (!newSeats[i].locked && newSeats[i].type !== 'blocked') {
                        availableIndices.push(i);
                    }
                }
                if (useSnakeOrder) {
                    availableIndices.sort((a, b) => {
                        const rA = Math.floor(a / cols);
                        const cA = a % cols;
                        const rB = Math.floor(b / cols);
                        const cB = b % cols;
                        if (rA !== rB) return rA - rB;
                        return (rA % 2 === 0) ? (cA - cB) : (cB - cA);
                    });
                }
                availableIndices.forEach(idx => {
                    newSeats[idx] = { ...newSeats[idx], text: "", note: newSeats[idx].note, type: "empty" };
                });
                availableIndices.forEach(idx => {
                    if (currentListIdx < sortedList.length) {
                        newSeats[idx] = { ...newSeats[idx], text: sortedList[currentListIdx++], type: "occupied" };
                    }
                });
                setSeats(newSeats);
            };

            const handleRandomize = () => {
                let list = parseNames();
                for (let i = list.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [list[i], list[j]] = [list[j], list[i]];
                }
                fillGridWithList(list, false);
            };

            const handleSequential = () => { fillGridWithList(parseNames(), false); };
            const handleSnake = () => { fillGridWithList(parseNames(), true); };
            const handleInterleave = () => {
                const list = parseNames();
                if (list.length === 0) return;
                const mid = Math.ceil(list.length / 2);
                const firstHalf = list.slice(0, mid);
                const secondHalf = list.slice(mid);
                const interleavedList = [];
                for (let i = 0; i < mid; i++) {
                    if (i < firstHalf.length) interleavedList.push(firstHalf[i]);
                    if (i < secondHalf.length) interleavedList.push(secondHalf[i]);
                }
                fillGridWithList(interleavedList, false);
            };

            // --- 互動邏輯區 ---
            const handleSeatClick = (idx) => {
                const newSeats = [...seats];
                const seat = newSeats[idx];
                if (mode === 'assign') {
                    const newName = window.prompt("請輸入座位姓名 (輸入空值可清除):", seat.text);
                    if (newName !== null) {
                        newSeats[idx] = {
                            ...seat,
                            text: newName,
                            type: newName.trim() ? 'occupied' : 'empty',
                            locked: !!newName.trim()
                        };
                        setSeats(newSeats);
                    }
                } else if (mode === 'block') {
                    const isBlocked = seat.type === 'blocked';
                    newSeats[idx] = { ...seat, text: "", type: isBlocked ? 'empty' : 'blocked', locked: false };
                    setSeats(newSeats);
                } else if (mode === 'lock') {
                    if (seat.type !== 'blocked') {
                        newSeats[idx] = { ...seat, locked: !seat.locked };
                        setSeats(newSeats);
                    }
                } else {
                    if (seat.type === 'blocked') return;
                    if (selectedIdx === null) {
                        setSelectedIdx(idx);
                    } else {
                        const seatA = newSeats[selectedIdx];
                        const seatB = newSeats[idx];
                        const tempA = { ...seatA };
                        const tempB = { ...seatB };
                        newSeats[selectedIdx] = { ...tempB };
                        newSeats[idx] = { ...tempA };
                        setSeats(newSeats);
                        setSelectedIdx(null);
                    }
                }
            };

            const handleNoteChange = (idx, value) => {
                const newSeats = [...seats];
                newSeats[idx] = { ...newSeats[idx], note: value };
                setSeats(newSeats);
            };

            // 檔案處理
            const saveState = () => {
                const data = { title, namesStr, ignoreStr, seats, rows, cols };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = "seating_data.json"; a.click();
            };

            const loadState = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        setTitle(data.title || ""); setNamesStr(data.namesStr || ""); setIgnoreStr(data.ignoreStr || "");
                        setSeats((data.seats || []).map(s => ({ ...s, locked: s.locked || false })));
                        if (data.rows) setRows(data.rows); if (data.cols) setCols(data.cols);
                    } catch (err) { alert("讀取失敗"); }
                };
                reader.readText(file); e.target.value = null;
            };

            // ★ 補回遺失的 Excel 匯入功能 ★
            const handleFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        if (!window.XLSX) { alert("Excel 元件尚未載入，請稍後再試"); return; }
                        const wb = window.XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = window.XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const names = [];
                        data.forEach(row => { if (row[0]) names.push(row[0]); });
                        setNamesStr(names.join('\n'));
                    } catch (e) { console.error(e); alert("讀取 Excel 失敗"); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };

            const handleExportPDF = async (viewType) => {
                if (!window.html2canvas || !window.PDFLib) { alert("元件載入中"); return; }
                setIsExporting(true);
                const elementId = viewType === 'student' ? 'pdf-export-student' : 'pdf-export-teacher';
                const element = document.getElementById(elementId);
                try {
                    const canvas = await window.html2canvas(element, { scale: 2, backgroundColor: "#ffffff", logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const pdfDoc = await window.PDFLib.PDFDocument.create();
                    const page = pdfDoc.addPage([841.89, 595.28]);
                    const pngImage = await pdfDoc.embedPng(imgData);
                    page.drawImage(pngImage, { x: 0, y: 0, width: 841.89, height: 595.28 });
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `${title || '座位表'}.pdf`; a.click();
                } catch (e) { console.error(e); alert("匯出失敗"); } finally { setIsExporting(false); }
            };

            // --- 排序與列表邏輯 ---
            const getSortedNames = () => {
                const allNames = parseNames().concat(seats.filter(s => s.locked && s.text).map(s => s.text))
                    .map(n => n.trim()).filter((v, i, a) => v && a.indexOf(v) === i);

                // 檢查是否包含座號 (數字開頭)
                const hasNumber = allNames.some(n => /^\d+/.test(n));

                if (hasNumber) {
                    return allNames.sort((a, b) => {
                        const numA = parseInt((a.match(/^\d+/) || ['999'])[0]);
                        const numB = parseInt((b.match(/^\d+/) || ['999'])[0]);
                        return numA - numB;
                    });
                } else {
                    return allNames.sort((a, b) => a.localeCompare(b, 'zh-TW'));
                }
            };

            return (
                <div className="flex flex-col h-full gap-4 relative overflow-hidden">
                    <div style={{ position: 'fixed', top: '-10000px', left: '-10000px', pointerEvents: 'none' }}>
                        <div id="pdf-export-student" style={{ width: '1123px', height: '794px', padding: '40px', backgroundColor: 'white', display: 'flex', flexDirection: 'column' }}>
                            <h1 style={{ fontSize: '32px', fontWeight: 'bold', textAlign: 'center', marginBottom: '20px', color: '#000' }}>{title || '座位表'} (學生視角)</h1>
                            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '20px' }}><div style={{ background: '#333', color: 'white', border: '3px solid black', width: '60%', height: '60px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px', fontWeight: 'bold' }}>黑 板</div></div>
                            <div style={{ flex: 1, display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gridTemplateRows: `repeat(${rows}, 1fr)`, gap: '8px' }}>
                                {seats.map((seat, i) => (
                                    <div key={i} style={{ border: seat.type === 'empty' ? '1px dashed #ccc' : '2px solid #000', borderRadius: '8px', backgroundColor: seat.type === 'blocked' ? '#ddd' : 'white', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', overflow: 'hidden' }}>
                                        {seat.type !== 'empty' && seat.type !== 'blocked' && (<><div style={{ fontSize: '24px', fontWeight: '900', color: '#000' }}>{seat.text}</div>{seat.note && <div style={{ fontSize: '12px', color: '#555' }}>{seat.note}</div>}</>)}
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div id="pdf-export-teacher" style={{ width: '1123px', height: '794px', padding: '40px', backgroundColor: 'white', display: 'flex', gap: '20px' }}>
                            <div style={{ width: '250px', borderRight: '2px solid #000', paddingRight: '15px' }}>
                                <h3 style={{ fontSize: '20px', fontWeight: 'bold', borderBottom: '2px solid #000', marginBottom: '10px' }}>點名表</h3>
                                <div style={{ columnCount: 2, columnGap: '10px', height: '680px' }}>
                                    {getSortedNames().map((n, i) => (
                                        <div key={i} style={{ breakInside: 'avoid', width: '100%', fontSize: '12px', marginBottom: '4px', lineHeight: '1.4' }}>{n}</div>
                                    ))}
                                </div>
                            </div>
                            <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                                <h1 style={{ fontSize: '32px', fontWeight: 'bold', textAlign: 'center', marginBottom: '20px', color: '#000' }}>{title || '座位表'} (導師視角)</h1>
                                <div style={{ flex: 1, display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gridTemplateRows: `repeat(${rows}, 1fr)`, gap: '8px', transform: 'rotate(180deg)' }}>
                                    {seats.map((seat, i) => (
                                        <div key={i} style={{ border: seat.type === 'empty' ? '1px dashed #ccc' : '2px solid #000', borderRadius: '8px', backgroundColor: seat.type === 'blocked' ? '#ddd' : 'white', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', transform: 'rotate(-180deg)' }}>
                                            {seat.type !== 'empty' && seat.type !== 'blocked' && (<><div style={{ fontSize: '24px', fontWeight: '900', color: '#000' }}>{seat.text}</div>{seat.note && <div style={{ fontSize: '12px', color: '#555' }}>{seat.note}</div>}</>)}
                                        </div>
                                    ))}
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'center', marginTop: '20px' }}><div style={{ border: '3px solid black', width: '150px', height: '40px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px', fontWeight: 'bold' }}>講 台</div></div>
                            </div>
                        </div>
                    </div>

                    <div className="w-full nook-phone-header p-3 flex flex-col gap-2 no-print shrink-0 rounded-[20px] border-2 border-white shadow-md z-20 control-panel-top">
                        <div className="flex flex-wrap justify-between items-center gap-2">
                            <div className="flex items-center gap-2">
                                <div className="bg-[#F2D879] p-1.5 rounded-xl text-[#7A5C3E] shadow-sm"><Users size={20} /></div>
                                <h2 className="text-lg font-bold text-[#7A5C3E]">座位大師 <span className="text-[10px] bg-[#7FD1B9] text-white px-2 py-0.5 rounded-full ml-1">美蓮師監修 V2</span></h2>
                            </div>
                            <div className="flex gap-2">
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} className="nook-input text-xs py-1 px-2 w-32 md:w-40" placeholder="座位表標題" />
                                <div className="flex gap-1">
                                    <button onClick={() => handleExportPDF('student')} disabled={isExporting} className="nook-btn bg-[#574E44] text-white px-3 py-1 text-xs shadow-md">{isExporting ? <Loader2 size={14} className="animate-spin" /> : <Download size={14} />} 學生</button>
                                    <button onClick={() => handleExportPDF('teacher')} disabled={isExporting} className="nook-btn bg-[#8D6E63] text-white px-3 py-1 text-xs shadow-md">{isExporting ? <Loader2 size={14} className="animate-spin" /> : <Download size={14} />} 導師</button>
                                </div>
                                <button onClick={() => setCurrentView(currentView === 'student' ? 'teacher' : 'student')} className={`nook-btn px-3 py-1 text-xs border-2 ${currentView === 'student' ? 'bg-[#F2D879] text-[#7A5C3E] border-[#F2D879]' : 'bg-[#7FD1B9] text-white border-[#7FD1B9]'}`}>
                                    {currentView === 'student' ? '學生視角' : '導師視角'}
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-wrap gap-2 items-center text-xs">
                            <div className="flex gap-1 items-center bg-white p-1 rounded-lg border">
                                <span className="font-bold text-[#574E44] px-1">格局:</span>
                                <input type="number" min="1" max="10" value={rows} onChange={e => setRows(Math.max(1, Number(e.target.value)))} className="w-8 text-center border rounded text-[#574E44]" />
                                <span className="text-[#574E44] font-bold">x</span>
                                <input type="number" min="1" max="10" value={cols} onChange={e => setCols(Math.max(1, Number(e.target.value)))} className="w-8 text-center border rounded text-[#574E44]" />
                            </div>

                            <div className="flex gap-1 items-center bg-white p-1 rounded-lg border">
                                <span className="font-bold text-[#574E44] px-1">模式:</span>
                                <button onClick={() => setMode('swap')} className={`px-2 py-1 rounded-md transition flex items-center gap-1 ${mode === 'swap' ? 'bg-[#7ACBD5] text-white shadow-sm' : 'text-gray-400 hover:bg-gray-100'}`}><RotateCw size={12} /> 交換</button>
                                <button onClick={() => setMode('assign')} className={`px-2 py-1 rounded-md transition flex items-center gap-1 ${mode === 'assign' ? 'bg-[#88C9A1] text-white shadow-sm' : 'text-gray-400 hover:bg-gray-100'}`}><Type size={12} /> 指定</button>
                                <button onClick={() => setMode('lock')} className={`px-2 py-1 rounded-md transition flex items-center gap-1 ${mode === 'lock' ? 'bg-[#F2D879] text-[#7A5C3E] shadow-sm' : 'text-gray-400 hover:bg-gray-100'}`}><Lock size={12} /> 鎖定</button>
                                <button onClick={() => setMode('block')} className={`px-2 py-1 rounded-md transition flex items-center gap-1 ${mode === 'block' ? 'bg-[#FF9A8B] text-white shadow-sm' : 'text-gray-400 hover:bg-gray-100'}`}><Grid size={12} /> 障礙</button>
                            </div>

                            <div className="flex gap-1 items-center bg-white p-1 rounded-lg border">
                                <button onClick={handleRandomize} className="nook-btn bg-[#88C9A1] text-white py-1 px-2" title="隨機洗牌">🎲 隨機</button>
                                <button onClick={handleSequential} className="nook-btn bg-white border border-[#E0E4CC] text-[#797365] py-1 px-2" title="依輸入順序排列">🔢 依序</button>
                                <button onClick={handleSnake} className="nook-btn bg-white border border-[#E0E4CC] text-[#797365] py-1 px-2" title="成績 S 型排列 (需先將名單按成績排序)">🐍 S型</button>
                                <button onClick={handleInterleave} className="nook-btn bg-white border border-[#E0E4CC] text-[#E91E63] py-1 px-2" title="男女梅花座 (請將男生與女生名單分別貼在一起)">🌸 梅花</button>
                            </div>

                            <div className="flex gap-1 ml-auto">
                                <button onClick={saveState} className="nook-btn bg-[#8D6E63] text-white py-1 px-2" title="儲存"><Save size={12} /></button>
                                <label className="nook-btn bg-[#A1887F] text-white py-1 px-2 cursor-pointer" title="讀取"><FolderOpen size={12} /><input type="file" accept=".json" onChange={loadState} className="hidden" /></label>
                                <label className="nook-btn bg-[#7FD1B9] text-white py-1 px-2 cursor-pointer" title="匯入 Excel"><Upload size={12} /><input type="file" accept=".xlsx" onChange={handleFileUpload} className="hidden" /></label>
                            </div>
                        </div>

                        <details className="text-xs text-[#9CA38F]">
                            <summary className="cursor-pointer hover:text-[#797365] font-bold transition-colors p-1">編輯名單 & 操作說明 (點擊展開)</summary>

                            {/* 新增的操作說明區塊 - 平常隱藏，展開可見 */}
                            <div className="mt-2 mb-2 p-3 bg-[#FFF9C4] rounded-xl border-2 border-[#FBC02D] text-[#797365] leading-relaxed">
                                <p className="font-bold border-b border-[#FBC02D]/30 pb-1 mb-1">💡 特殊排列前置作業：</p>
                                <ul className="list-disc pl-4 space-y-1">
                                    <li><strong>🐍 成績 S 型：</strong>請先將名單按<strong>「成績高低」</strong>排序後貼上。</li>
                                    <li><strong>🌸 男女梅花：</strong>請將名單整理為<strong>「全男接全女」</strong>(或反之) 貼上。</li>
                                    <li><strong>🔒 鎖定座位：</strong>切換至鎖定模式，點擊座位出現鎖頭，該生即不參與洗牌。</li>
                                </ul>
                            </div>

                            <textarea value={namesStr} onChange={e => setNamesStr(e.target.value)} className="nook-input w-full h-32 text-xs resize-none font-mono" placeholder="在此貼上名單 (每行一個姓名)...&#10;系統會自動扣除已鎖定在座位上的學生" />
                        </details>
                    </div>

                    <div className="flex-1 bg-[#574E44] p-2 md:p-4 overflow-hidden rounded-[20px] md:rounded-[30px] print-hide screen-mode flex flex-col shadow-inner relative z-10" ref={containerRef}>
                        <div className={`paper-preview bg-white w-full h-full p-4 relative transition-transform duration-500 flex flex-col rounded-[15px] items-center justify-center ${currentView === 'teacher' ? 'teacher-view-transform' : ''}`}>

                            <div className={`flex flex-col items-center mb-2 w-full transition-all duration-300 shrink-0 ${currentView === 'teacher' ? 'rotate-180' : ''}`}>
                                <div className="blackboard w-1/2 h-10 md:h-14 mb-1 flex items-center justify-center text-white font-bold tracking-widest text-base md:text-xl font-mono rounded-lg shadow-md bg-[#2F4F4F] border-4 border-[#8B4513]">黑 板</div>
                                <div className="podium w-20 h-5 md:w-24 md:h-6 flex items-center justify-center font-bold text-[10px] md:text-xs rounded shadow-sm bg-[#DEB887] border border-[#8B4513]">講台</div>
                            </div>

                            <div className="flex-1 w-full flex items-center justify-center overflow-hidden">
                                <div className="grid gap-2 seat-grid-wrapper content-center justify-center" style={{ ...gridStyle }}>
                                    {seats.map((seat, i) => (
                                        <div
                                            key={i}
                                            onClick={() => handleSeatClick(i)}
                                            className={`
                                                seat-item cursor-pointer select-none relative group
                                                ${seat.type}
                                                ${selectedIdx === i ? 'selected' : ''}
                                                ${seat.type === 'occupied' ? 'seat-swap-anim' : ''}
                                                ${seat.locked ? 'border-[#F2D879] bg-[#FFF8E1]' : ''}
                                            `}
                                        >
                                            {seat.locked && (
                                                <div className="absolute top-1 right-1 text-[#F2D879] z-10">
                                                    <Lock size={12} />
                                                </div>
                                            )}

                                            <span className="truncate w-full text-center px-0.5 z-0 font-black">
                                                {seat.type === 'blocked' ? '' : (seat.text || (i + 1))}
                                            </span>

                                            {seat.type !== 'blocked' && seat.type !== 'empty' && (
                                                <input
                                                    className="seat-note-input"
                                                    value={seat.note || ''}
                                                    onChange={(e) => handleNoteChange(i, e.target.value)}
                                                    onClick={(e) => e.stopPropagation()}
                                                    placeholder="備註"
                                                />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * 班級成績分析工具 (Grade Analysis Tool)
         * 支援多班級管理、成績輸入 (文字/Excel)
         * 自動計算平均、標準差、及格率、分數區間分佈
         * 產生視覺化長條圖 (Chart.js)
         * 匯出全校分析報告 (PDF)
        
         * 班級成績分析工具 V2.0 (Grade Analysis Tool - Advanced Edition)
         * 新增指標：變異係數(CV)、偏態(Skewness)、峰度(Kurtosis)、四分位距(IQR)
         * 用途：深度診斷班級學力結構與試卷鑑別度
         /**
         * 班級成績分析工具 V2.1 (Grade Analysis Tool - Hybrid Edition)
         * 修正：完整保留並優化原本的「各班區間人數直方圖」，同時整合深度分析指標。
         * 修復：解決 BarChart3 未定義導致無法開啟的問題。
         */
        /**
         * 班級成績分析工具 V2.1 (Grade Analysis Tool - Hybrid Edition)
         * 修正：完整保留並優化原本的「各班區間人數直方圖」，同時整合深度分析指標。
         * 修復：解決 BarChart3 未定義導致無法開啟的問題。
         */
        const GradeAnalysisTool = () => {
            const [classes, setClasses] = useState([]);
            const [newClassName, setNewClassName] = useState("");
            const [inputData, setInputData] = useState("");
            const [isExporting, setIsExporting] = useState(false);
            const [showAdvanced, setShowAdvanced] = useState(true);
            const chartRefs = useRef({});
            const classRefs = useRef({});

            // 核心算法：高階統計指標 (五標 / PR / T分數)
            const getAdvancedStats = (scores) => {
                const vals = scores.map(s => s.score).sort((a, b) => a - b);
                const n = vals.length;
                if (n === 0) return null;

                const sum = vals.reduce((a, b) => a + b, 0);
                const mean = sum / n;

                const squareDiffs = vals.map(v => Math.pow(v - mean, 2));
                const variance = squareDiffs.reduce((a, b) => a + b, 0) / n;
                const stdDev = Math.sqrt(variance);

                const cv = mean === 0 ? 0 : (stdDev / mean);

                const q1 = vals[Math.floor((n - 1) * 0.25)];
                const median = vals[Math.floor((n - 1) * 0.5)];
                const q3 = vals[Math.floor((n - 1) * 0.75)];
                const iqr = q3 - q1;

                let m3 = 0;
                let m4 = 0;
                vals.forEach(v => {
                    m3 += Math.pow(v - mean, 3);
                    m4 += Math.pow(v - mean, 4);
                });
                m3 /= n;
                m4 /= n;

                const skewness = stdDev === 0 ? 0 : m3 / Math.pow(stdDev, 3);
                const kurtosis = stdDev === 0 ? 0 : (m4 / Math.pow(stdDev, 4)) - 3;

                const eliteCount = vals.filter(v => v >= 85).length;
                const riskCount = vals.filter(v => v < 40).length;

                // 五標計算 (台灣標準: 頂88 / 前75 / 均50 / 後25 / 底12)
                // 簡易算法：排序後取對應百分位數位置
                const getPercentile = (p) => vals[Math.ceil(n * (p / 100)) - 1] || vals[0];

                const topStd = getPercentile(88);    // 頂標
                const frontStd = getPercentile(75);  // 前標
                const avgStd = getPercentile(50);    // 均標
                const backStd = getPercentile(25);   // 後標
                const bottomStd = getPercentile(12); // 底標

                return {
                    count: n,
                    mean: mean.toFixed(1),
                    stdDev: stdDev.toFixed(1),
                    max: vals[n - 1],
                    min: vals[0],
                    passed: vals.filter(v => v >= 60).length,
                    passRate: Math.round((vals.filter(v => v >= 60).length / n) * 100),
                    cv: cv.toFixed(3),
                    q1, median, q3, iqr,
                    skewness: skewness.toFixed(2),
                    kurtosis: kurtosis.toFixed(2),
                    eliteRate: Math.round((eliteCount / n) * 100),
                    riskRate: Math.round((riskCount / n) * 100),
                    fiveStandards: { top: topStd, front: frontStd, avg: avgStd, back: backStd, bottom: bottomStd }
                };
            };

            // 學生個別數據計算
            const getStudentMetrics = (scores, stats) => {
                if (!stats || !scores) return [];
                const mean = parseFloat(stats.mean);
                const stdDev = parseFloat(stats.stdDev);
                const n = scores.length;

                // 排序以計算排名 (分數高 -> 低)
                const sorted = [...scores].sort((a, b) => b.score - a.score);

                return sorted.map((s, index) => {
                    // 排名 (處理同分)
                    let rank = index + 1;
                    if (index > 0 && s.score === sorted[index - 1].score) {
                        rank = sorted.findIndex(p => p.score === s.score) + 1;
                    }

                    // T分數 (T = 50 + 10Z)
                    const zScore = stdDev === 0 ? 0 : (s.score - mean) / stdDev;
                    const tScore = 50 + 10 * zScore;

                    // PR值 (簡易公式: 100 - (100R - 50)/N)
                    const pr = Math.floor(100 - (100 * rank - 50) / n);

                    return {
                        ...s,
                        rank,
                        tScore: tScore.toFixed(1),
                        pr: pr < 0 ? 0 : pr
                    };
                });
            };

            // 圖表渲染邏輯 (這是您最在意的部分，完整保留並優化)
            useEffect(() => {
                classes.forEach((cls) => {
                    const ctx = document.getElementById(`chart-${cls.id}`);
                    // 確保 canvas 存在且 Chart.js 已載入
                    if (ctx && window.Chart) {
                        // 如果該 canvas 已經有圖表實例，先銷毀舊的
                        if (chartRefs.current[cls.id]) {
                            chartRefs.current[cls.id].destroy();
                        }

                        // 計算各分數區間人數
                        const buckets = Array(11).fill(0);
                        const labels = ["0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80-89", "90-99", "100"];
                        cls.scores.forEach(s => {
                            if (s.score === 100) buckets[10]++;
                            else {
                                const idx = Math.floor(s.score / 10);
                                if (idx >= 0 && idx < 10) buckets[idx]++;
                            }
                        });

                        const stats = getAdvancedStats(cls.scores);

                        // 建立新圖表
                        chartRefs.current[cls.id] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: '人數',
                                    data: buckets,
                                    backgroundColor: (context) => {
                                        // 及格與不及格使用不同顏色，視覺更直觀
                                        const labelIndex = context.dataIndex;
                                        return labelIndex >= 6 ? '#88C9A1' : '#FFAB91';
                                    },
                                    borderColor: (context) => {
                                        const labelIndex = context.dataIndex;
                                        return labelIndex >= 6 ? '#E0F2F1' : '#FFEBEE';
                                    },
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    barPercentage: 0.7,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: { padding: { top: 30, bottom: 10 } },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(93, 64, 55, 0.9)',
                                        titleFont: { size: 14, family: "'Varela Round', sans-serif" },
                                        bodyFont: { size: 14, family: "'Varela Round', sans-serif" },
                                        padding: 10,
                                        cornerRadius: 8,
                                        displayColors: false,
                                        callbacks: {
                                            title: (items) => `分數區間: ${items[0].label} 分`,
                                            label: (item) => `${item.raw} 人`
                                        }
                                    },
                                    // 自定義平均線插件參數
                                    averageLine: { average: stats.mean }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { stepSize: 1, font: { weight: 'bold' }, color: '#9CA38F' },
                                        grid: { color: '#F2F4E6', drawBorder: false },
                                        title: { display: true, text: '人數 (人)', color: '#9CA38F', font: { weight: 'bold', size: 12 } }
                                    },
                                    x: {
                                        grid: { display: false },
                                        ticks: { font: { weight: 'bold' }, color: '#9CA38F' },
                                        title: { display: true, text: '分數區間 (分)', color: '#9CA38F', font: { weight: 'bold', size: 12 } }
                                    }
                                }
                            },
                            plugins: [{
                                id: 'averageLine',
                                afterDatasetsDraw(chart, args, options) {
                                    const { ctx, chartArea: { top, bottom, width }, scales: { x } } = chart;
                                    const avg = parseFloat(options.average);
                                    if (isNaN(avg)) return;

                                    let xPos;
                                    if (avg >= 100) xPos = x.getPixelForValue(10);
                                    else {
                                        const index = Math.floor(avg / 10);
                                        const remainder = avg % 10;
                                        const startPixel = x.getPixelForValue(index);
                                        const endPixel = x.getPixelForValue(index + 1) || x.getPixelForValue(index) + (width / 11);
                                        xPos = startPixel + (endPixel - startPixel) * (remainder / 10);
                                    }

                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.moveTo(xPos, top);
                                    ctx.lineTo(xPos, bottom);
                                    ctx.lineWidth = 3;
                                    ctx.strokeStyle = '#FF7043';
                                    ctx.setLineDash([6, 4]);
                                    ctx.stroke();

                                    // 平均分標籤
                                    ctx.fillStyle = '#FF7043';
                                    ctx.font = 'bold 12px "Varela Round", sans-serif';
                                    ctx.textAlign = 'center';
                                    ctx.fillText(`Avg ${avg}`, xPos, top - 8);
                                    ctx.restore();
                                }
                            }]
                        });
                    }
                });
                return () => { Object.values(chartRefs.current).forEach(c => c.destroy()); chartRefs.current = {}; };
            }, [classes]); // 當 classes 變動時重繪

            const handleAddClass = () => {
                if (!newClassName.trim()) { alert("請輸入班級名稱"); return; }
                const lines = inputData.split('\n').filter(l => l.trim());
                const scores = [];
                lines.forEach(line => {
                    const match = line.match(/(\d+)/);
                    if (match) {
                        const score = parseInt(match[0]);
                        if (score >= 0 && score <= 100) { const name = line.replace(match[0], '').trim() || `學生${scores.length + 1}`; scores.push({ name, score }); }
                    }
                });
                if (scores.length === 0) { alert("無法解析成績數據"); return; }
                setClasses([...classes, { id: Date.now() + Math.random(), name: newClassName, scores }]); setNewClassName(""); setInputData("");
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result; const wb = XLSX.read(bstr, { type: 'binary' });
                        const newClasses = [];
                        wb.SheetNames.forEach(wsname => {
                            const ws = wb.Sheets[wsname];
                            const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                            const scores = [];
                            data.forEach(row => {
                                const scoreIdx = row.findIndex(cell => typeof cell === 'number');
                                if (scoreIdx !== -1) {
                                    const score = row[scoreIdx];
                                    const name = row[scoreIdx - 1] || `學生${scores.length + 1}`;
                                    if (score >= 0 && score <= 100) scores.push({ name, score });
                                }
                            });
                            if (scores.length > 0) newClasses.push({ id: Date.now() + Math.random(), name: wsname, scores });
                        });
                        if (newClasses.length > 0) setClasses(prev => [...prev, ...newClasses]);
                    } catch (e) { console.error(e); alert("讀取 Excel 失敗"); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };

            const handleExportPDF = async () => {
                if (classes.length === 0 || !window.PDFLib || !window.html2canvas) return;
                setIsExporting(true);

                // [Fix] 暫時關閉動畫以確保截圖時圖表是靜態的
                const originalAnimation = Chart.defaults.animation;
                Chart.defaults.animation = false;

                const pdfPageWidth = 595.28;
                const pdfPageHeight = 841.89;
                const margin = 15;
                const contentWidth = pdfPageWidth - 2 * margin;
                const contentHeight = pdfPageHeight - 2 * margin;

                try {
                    await new Promise(r => setTimeout(r, 500));
                    const pdfDoc = await window.PDFLib.PDFDocument.create();

                    for (const cls of classes) {
                        const element = classRefs.current[cls.id];
                        if (!element) continue;

                        const stats = getAdvancedStats(cls.scores);
                        const studentMetrics = getStudentMetrics(cls.scores, stats);

                        // [Fix] 強制將 Canvas 替換為圖片
                        const originalCanvas = document.getElementById(`chart-${cls.id}`);
                        let chartImgData = null;
                        if (originalCanvas) {
                            chartImgData = originalCanvas.toDataURL('image/png');
                        }

                        // ========== 第 1 頁：統計摘要 + 圖表 (填滿頁面) ==========
                        const summaryCanvas = await window.html2canvas(element, {
                            scale: 2,
                            backgroundColor: "#ffffff",
                            useCORS: true,
                            logging: false,
                            width: 1280,
                            windowWidth: 1280,
                            onclone: (clonedDoc) => {
                                // 移除動畫
                                clonedDoc.querySelectorAll('*').forEach(node => {
                                    if (node.classList) {
                                        node.classList.remove('animate-in', 'fade-in', 'zoom-in-95', 'slide-in-from-bottom-4', 'duration-500', 'transition-all');
                                    }
                                });

                                // [關鍵] 隱藏學生排行表，只保留統計與圖表
                                const detailsElements = clonedDoc.querySelectorAll('details');
                                detailsElements.forEach(d => d.style.display = 'none');

                                // 優化卡片樣式
                                const card = clonedDoc.querySelector('[data-pdf-card="true"]');
                                if (card) {
                                    card.style.padding = '15px';
                                    card.style.border = 'none';
                                    card.style.boxShadow = 'none';
                                }

                                // 替換 canvas 為靜態圖片
                                if (chartImgData) {
                                    const clonedCanvas = clonedDoc.getElementById(`chart-${cls.id}`);
                                    if (clonedCanvas) {
                                        const img = clonedDoc.createElement('img');
                                        img.src = chartImgData;
                                        img.style.width = '100%';
                                        img.style.height = '100%';
                                        img.style.objectFit = 'contain';
                                        clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                                    }
                                }
                            }
                        });

                        // 輸出第 1 頁（統計摘要）- 填滿頁面但不超過
                        const summaryImgData = summaryCanvas.toDataURL('image/png');
                        const summaryImg = await pdfDoc.embedPng(summaryImgData);

                        // [修改] 優先使用寬度填滿，但確保高度不超過頁面
                        const scaleByWidth = contentWidth / summaryImg.width;
                        const scaledHeightByWidth = summaryImg.height * scaleByWidth;
                        let summaryScale;
                        if (scaledHeightByWidth <= contentHeight) {
                            // 寬度填滿後高度仍在範圍內，使用寬度縮放
                            summaryScale = scaleByWidth;
                        } else {
                            // 高度超過頁面，改用高度縮放
                            summaryScale = contentHeight / summaryImg.height;
                        }
                        const summaryScaledWidth = summaryImg.width * summaryScale;
                        const summaryScaledHeight = summaryImg.height * summaryScale;

                        const summaryPage = pdfDoc.addPage([pdfPageWidth, pdfPageHeight]);
                        summaryPage.drawImage(summaryImg, {
                            x: margin + (contentWidth - summaryScaledWidth) / 2,
                            y: pdfPageHeight - margin - summaryScaledHeight,
                            width: summaryScaledWidth,
                            height: summaryScaledHeight
                        });

                        // ========== 第 2 頁：所有學生排行表 (縮放填滿一頁) ==========
                        if (studentMetrics.length > 0) {
                            // 建立完整學生表格 HTML
                            const tableHtml = `
                                <div style="font-family: 'Noto Sans TC', sans-serif; padding: 15px; background: white;">
                                    <h2 style="color: #574E44; font-size: 20px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        📊 ${cls.name} - 詳細成績排行
                                        <span style="font-size: 12px; color: #9CA38F; font-weight: normal;">
                                            (共 ${studentMetrics.length} 人)
                                        </span>
                                    </h2>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                        <thead>
                                            <tr style="background: #F8F9F0; color: #797365;">
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">名次</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC; text-align: left;">姓名</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">分數</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">PR值</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">T分數</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">Z分數</th>
                                                <th style="padding: 6px 4px; border: 1px solid #E0E4CC;">落點</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentMetrics.map(stu => {
                                const zScore = ((stu.score - stats.mean) / stats.stdDev).toFixed(2);
                                const isPass = stu.score >= 60;
                                const rankBg = stu.rank <= 3 ? '#F2D879' : '#F0F0F0';
                                let levelLabel = '底標', levelColor = '#C62828', levelBg = '#FFEBEE';
                                if (stu.score >= stats.fiveStandards?.top) { levelLabel = '頂標'; levelColor = '#2E7D32'; levelBg = '#E8F5E9'; }
                                else if (stu.score >= stats.fiveStandards?.front) { levelLabel = '前標'; levelColor = '#558B2F'; levelBg = '#F1F8E9'; }
                                else if (stu.score >= stats.fiveStandards?.avg) { levelLabel = '均標'; levelColor = '#F9A825'; levelBg = '#FFFDE7'; }
                                else if (stu.score >= stats.fiveStandards?.back) { levelLabel = '後標'; levelColor = '#FF8F00'; levelBg = '#FFF3E0'; }
                                return `
                                                    <tr style="background: white;">
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center;">
                                                            <span style="display: inline-block; width: 20px; height: 20px; line-height: 20px; border-radius: 50%; background: ${rankBg}; font-weight: bold; font-size: 10px;">${stu.rank}</span>
                                                        </td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; font-weight: bold; color: #5D4037;">${stu.name}</td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center; font-weight: bold; color: ${isPass ? '#2E7D32' : '#C62828'};">${stu.score}</td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center;">${stu.pr}</td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center; font-family: monospace;">${stu.tScore}</td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center; font-family: monospace; color: #9CA38F;">${zScore}</td>
                                                        <td style="padding: 4px; border: 1px solid #E0E4CC; text-align: center;">
                                                            <span style="background: ${levelBg}; color: ${levelColor}; padding: 2px 4px; border-radius: 3px; font-size: 9px; font-weight: bold;">${levelLabel}</span>
                                                        </td>
                                                    </tr>
                                                `;
                            }).join('')}
                                        </tbody>
                                    </table>
                                    <div style="text-align: center; margin-top: 10px; color: #9CA38F; font-size: 10px;">
                                        分析報告生成時間: ${new Date().toLocaleString('zh-TW')}
                                    </div>
                                </div>
                            `;

                            // 建立臨時 DOM 並截圖
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = tableHtml;
                            tempDiv.style.position = 'absolute';
                            tempDiv.style.left = '-9999px';
                            tempDiv.style.width = '800px';
                            document.body.appendChild(tempDiv);

                            const tableCanvas = await window.html2canvas(tempDiv, {
                                scale: 2,
                                backgroundColor: "#ffffff",
                                logging: false
                            });

                            document.body.removeChild(tempDiv);

                            const tableImgData = tableCanvas.toDataURL('image/png');
                            const tableImg = await pdfDoc.embedPng(tableImgData);

                            // [修改] 縮放以填滿一頁（取寬度和高度中較小的縮放比例）
                            const tScaleX = contentWidth / tableImg.width;
                            const tScaleY = contentHeight / tableImg.height;
                            const tScale = Math.min(tScaleX, tScaleY);
                            const tScaledWidth = tableImg.width * tScale;
                            const tScaledHeight = tableImg.height * tScale;

                            const tablePage = pdfDoc.addPage([pdfPageWidth, pdfPageHeight]);
                            tablePage.drawImage(tableImg, {
                                x: margin + (contentWidth - tScaledWidth) / 2,
                                y: pdfPageHeight - margin - tScaledHeight,
                                width: tScaledWidth,
                                height: tScaledHeight
                            });
                        }
                    }

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `成績分析報告_${new Date().toISOString().slice(0, 10)}.pdf`;
                    a.click();
                } catch (err) {
                    console.error(err);
                    alert("PDF 匯出失敗");
                } finally {
                    setIsExporting(false);
                    // [Fix] 恢復動畫設定
                    Chart.defaults.animation = originalAnimation;
                }
            };

            const getStatusColor = (val, type) => {
                if (type === 'cv') return val > 0.3 ? 'text-red-500' : (val > 0.15 ? 'text-yellow-600' : 'text-green-600');
                if (type === 'risk') return val > 20 ? 'text-red-500' : (val > 10 ? 'text-yellow-600' : 'text-green-600');
                return 'text-[#5D4037]';
            };

            return (
                <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-[#F8F9F0] p-6 rounded-[30px] border-[4px] border-white shadow-sm">
                        <h3 className="text-lg font-bold text-[#797365] mb-4 flex items-center gap-2"><Upload size={20} /> 新增班級成績</h3>
                        <div className="space-y-4">
                            <input type="text" value={newClassName} onChange={e => setNewClassName(e.target.value)} className="w-full p-3 rounded-xl border-none font-bold text-[#797365]" placeholder="班級名稱 (例如: 三年二班)" />
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <textarea value={inputData} onChange={e => setInputData(e.target.value)} className="w-full h-32 p-3 rounded-xl border-none font-bold text-[#797365] resize-none" placeholder="直接貼上成績 (格式: 王小明 90 或 僅 90)" />
                                <div className="flex flex-col justify-center gap-3">
                                    <div className="flex gap-2 w-full">
                                        <Button onClick={handleAddClass} variant="primary" className="flex-1" icon={null}>確認新增</Button>
                                        <Button onClick={handleAddClass} className="flex-1 bg-[#8D6E63] text-white hover:bg-[#6D4C41] shadow-sm font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors" icon={null}>
                                            <Activity size={16} /> 分析
                                        </Button>
                                    </div>
                                    <div className="relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="bg-white border-2 border-dashed border-[#E0E4CC] text-[#9CA38F] font-bold py-3 rounded-xl text-center hover:bg-[#F2F4E6] transition-colors">或上傳 Excel 檔案</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {classes.length > 0 && (
                        <div className="flex justify-between items-center">
                            <label className="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-full border border-[#E0E4CC] shadow-sm">
                                <input type="checkbox" checked={showAdvanced} onChange={e => setShowAdvanced(e.target.checked)} className="accent-[#88C9A1]" />
                                <span className="text-sm font-bold text-[#797365]">顯示深度指標</span>
                            </label>
                            <Button onClick={handleExportPDF} disabled={isExporting} variant="secondary" className="shadow-lg" icon={isExporting ? Loader2 : Download}>
                                {isExporting ? "報告生成中..." : "匯出全校分析報告 (PDF)"}
                            </Button>
                        </div>
                    )}

                    {/* School-wide Score Distribution Table (Transposed) */}
                    {classes.length > 0 && (
                        <div className="bg-white rounded-[24px] border-[3px] border-[#E0E4CC] shadow-sm overflow-hidden animate-in fade-in slide-in-from-bottom-2">
                            <div className="bg-[#F8F9F0] p-4 border-b-2 border-[#E0E4CC] flex items-center justify-between">
                                <h4 className="font-black text-[#5D4037] flex items-center gap-2">
                                    <Grid size={18} /> 全校成績區間分佈總表
                                </h4>
                                <span className="text-xs font-bold text-[#9CA38F]">總覽所有班級</span>
                            </div>
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-sm text-center whitespace-nowrap">
                                    <thead>
                                        <tr className="bg-[#FFF8E1] text-[#795548]">
                                            <th className="p-3 font-black sticky left-0 bg-[#FFF8E1] border-r border-[#E0E0E0] min-w-[100px] z-10">項目 / 班級</th>
                                            {classes.map(cls => (
                                                <th key={cls.id} className="p-3 font-bold border-r border-[#F0F0F0] min-w-[80px] text-[#5D4037]">{cls.name}</th>
                                            ))}
                                            <th className="p-3 font-black bg-[#E0F2F1] text-[#00695C]">總計</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-[#F0F0F0]">
                                        {/* 1. Score Intervals: 100 down to 0-9 */}
                                        {Array.from({ length: 11 }).reverse().map((_, i) => {
                                            const idx = 10 - i;
                                            const label = idx === 10 ? "100" : `${idx * 10}-${idx * 10 + 9}`;
                                            const isFail = idx < 6;

                                            // Calculate total for this interval row
                                            let rowTotal = 0;

                                            return (
                                                <tr key={idx} className="hover:bg-[#F9FAF4] transition-colors">
                                                    <td className={`p-3 font-bold sticky left-0 border-r border-[#E0E0E0] z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] ${isFail ? 'bg-[#FFEBEE] text-[#C62828]' : (idx === 10 ? 'bg-[#E8F5E9] text-[#2E7D32]' : 'bg-white text-[#5D4037]')}`}>
                                                        {label}
                                                    </td>
                                                    {classes.map(cls => {
                                                        let count = 0;
                                                        cls.scores.forEach(s => {
                                                            if (idx === 10 && s.score === 100) count++;
                                                            else if (idx !== 10 && Math.floor(s.score / 10) === idx && s.score < 100) count++;
                                                        });
                                                        rowTotal += count;
                                                        return (
                                                            <td key={cls.id} className={`p-3 font-bold border-r border-[#F0F0F0] ${isFail ? 'text-[#C62828] bg-[#FFEBEE]/30' : (idx === 10 ? 'text-[#2E7D32] bg-[#E8F5E9]/30' : 'text-[#5D4037]')}`}>
                                                                {count || '-'}
                                                            </td>
                                                        );
                                                    })}
                                                    <td className={`p-3 font-black ${isFail ? 'text-[#C62828] bg-[#FFEBEE]/50' : 'text-[#00695C] bg-[#E0F2F1]/50'}`}>
                                                        {rowTotal}
                                                    </td>
                                                </tr>
                                            );
                                        })}

                                        {/* 2. Statistics Rows */}
                                        {/* Mean */}
                                        <tr className="bg-[#E0F2F1] border-t-2 border-[#80CBC4]">
                                            <td className="p-3 font-black text-[#00695C] sticky left-0 bg-[#E0F2F1] border-r border-[#80CBC4] z-10">平均 (Mean)</td>
                                            {classes.map(cls => {
                                                const stats = getAdvancedStats(cls.scores);
                                                return <td key={cls.id} className="p-3 font-black text-[#00695C] border-r border-[#80CBC4]">{stats ? stats.mean : '-'}</td>;
                                            })}
                                            <td className="p-3 font-black text-[#00695C]">
                                                {(() => {
                                                    const allScores = classes.flatMap(c => c.scores);
                                                    const totalStats = getAdvancedStats(allScores);
                                                    return totalStats ? totalStats.mean : '-';
                                                })()}
                                            </td>
                                        </tr>
                                        {/* StdDev */}
                                        <tr className="bg-[#E0F2F1]">
                                            <td className="p-3 font-black text-[#00695C] sticky left-0 bg-[#E0F2F1] border-r border-[#80CBC4] z-10">標準差 (SD)</td>
                                            {classes.map(cls => {
                                                const stats = getAdvancedStats(cls.scores);
                                                return <td key={cls.id} className="p-3 font-bold text-[#00695C] border-r border-[#80CBC4]">{stats ? stats.stdDev : '-'}</td>;
                                            })}
                                            <td className="p-3 font-bold text-[#00695C]">
                                                {(() => {
                                                    const allScores = classes.flatMap(c => c.scores);
                                                    const totalStats = getAdvancedStats(allScores);
                                                    return totalStats ? totalStats.stdDev : '-';
                                                })()}
                                            </td>
                                        </tr>
                                        {/* Fail Count */}
                                        <tr className="bg-[#FFEBEE] border-t-2 border-[#ffcdd2]">
                                            <td className="p-3 font-black text-[#C62828] sticky left-0 bg-[#FFEBEE] border-r border-[#ffcdd2] z-10">不及格人數</td>
                                            {classes.map(cls => {
                                                const stats = getAdvancedStats(cls.scores);
                                                return <td key={cls.id} className="p-3 font-black text-[#C62828] border-r border-[#ffcdd2]">{stats ? (stats.count - stats.passed) : '-'}</td>;
                                            })}
                                            <td className="p-3 font-black text-[#C62828]">
                                                {(() => {
                                                    const allScores = classes.flatMap(c => c.scores);
                                                    const totalStats = getAdvancedStats(allScores);
                                                    return totalStats ? (totalStats.count - totalStats.passed) : '-';
                                                })()}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    <div className="space-y-6">
                        {classes.map(cls => {
                            const stats = getAdvancedStats(cls.scores);
                            return (
                                <div key={cls.id} ref={el => classRefs.current[cls.id] = el} data-pdf-card="true" className="bg-white p-6 md:p-10 rounded-[30px] border-[4px] border-[#E0E4CC] shadow-sm page-break-item">
                                    <div className="flex justify-between items-center mb-6 pb-4 border-b-2 border-[#F2F4E6]">
                                        <h3 className="text-2xl font-extrabold text-[#797365] flex items-center gap-2">
                                            <School size={28} className="text-[#88C9A1]" />
                                            {cls.name}
                                        </h3>
                                        <button onClick={() => setClasses(classes.filter(c => c.id !== cls.id))} className="text-[#FF9A8B] hover:bg-[#FFF5F5] p-2 rounded-full no-print"><X size={24} /></button>
                                    </div>

                                    {/* 1. 基礎數據 (Mean, SD, Max, Pass) */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-[#E0F2F1] p-4 rounded-2xl text-center">
                                            <div className="text-xs font-bold text-[#00695C] opacity-70 uppercase mb-1">平均分 Mean</div>
                                            <div className="text-3xl font-black text-[#00695C]">{stats.mean}</div>
                                        </div>
                                        <div className="bg-[#FFEBEE] p-4 rounded-2xl text-center">
                                            <div className="text-xs font-bold text-[#C62828] opacity-70 uppercase mb-1">標準差 StdDev</div>
                                            <div className="text-3xl font-black text-[#C62828]">{stats.stdDev}</div>
                                        </div>
                                        <div className="bg-[#FFF3E0] p-4 rounded-2xl text-center">
                                            <div className="text-xs font-bold text-[#E65100] opacity-70 uppercase mb-1">最高分 Max</div>
                                            <div className="text-3xl font-black text-[#E65100]">{stats.max}</div>
                                        </div>
                                        <div className="bg-[#E8F5E9] p-4 rounded-2xl text-center">
                                            <div className="text-xs font-bold text-[#2E7D32] opacity-70 uppercase mb-1">及格率 Pass</div>
                                            <div className="text-3xl font-black text-[#2E7D32]">{stats.passRate}<span className="text-sm">%</span></div>
                                        </div>
                                    </div>

                                    {/* 2. 高階分析指標 (可選顯示) */}
                                    {showAdvanced && (
                                        <div className="mb-8 bg-[#FAFAFA] border-2 border-[#F0F0F0] rounded-2xl p-5 animate-in zoom-in-95">
                                            <h4 className="text-sm font-black text-[#5D4037] mb-4 flex items-center gap-2">
                                                <Activity size={16} /> 深度結構分析 (Diagnostic Metrics)
                                            </h4>

                                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                                {/* 0. 五標分析 (新增) */}
                                                <div className="bg-white p-4 rounded-xl border border-[#EEE] shadow-sm col-span-2 lg:col-span-4">
                                                    <div className="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                                                        <span className="text-xs font-bold text-[#9CA38F] flex items-center gap-1"><BarChart size={14} /> 五標分析 (Five Standards)</span>
                                                        <span className="text-[10px] text-[#9CA38F] bg-gray-100 px-2 py-0.5 rounded-full">依據台灣升學測驗標準</span>
                                                    </div>
                                                    <div className="grid grid-cols-5 gap-2 text-center">
                                                        {[
                                                            { label: '頂標 (88%)', val: stats.fiveStandards?.top, color: 'text-[#2E7D32] bg-[#E8F5E9]' },
                                                            { label: '前標 (75%)', val: stats.fiveStandards?.front, color: 'text-[#558B2F] bg-[#F1F8E9]' },
                                                            { label: '均標 (50%)', val: stats.fiveStandards?.avg, color: 'text-[#F9A825] bg-[#FFFDE7]' },
                                                            { label: '後標 (25%)', val: stats.fiveStandards?.back, color: 'text-[#FF8F00] bg-[#FFF3E0]' },
                                                            { label: '底標 (12%)', val: stats.fiveStandards?.bottom, color: 'text-[#C62828] bg-[#FFEBEE]' },
                                                        ].map((item, idx) => (
                                                            <div key={idx} className={`rounded-lg p-2 ${item.color.split(' ')[1]}`}>
                                                                <div className={`text-[10px] font-bold opacity-70 mb-1 ${item.color.split(' ')[0]}`}>{item.label}</div>
                                                                <div className={`text-xl font-black ${item.color.split(' ')[0]}`}>{item.val}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 1. 變異係數 CV */}
                                                <div className="bg-white p-3 rounded-xl border border-[#EEE] shadow-sm">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="text-[10px] font-bold text-[#9CA38F]">變異係數 (CV)</span>
                                                        <span className={`text-[10px] px-1.5 rounded font-bold ${parseFloat(stats.cv) > 0.3 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                                            {parseFloat(stats.cv) > 0.3 ? '極度M型化' : (parseFloat(stats.cv) < 0.15 ? '高度均質' : '分佈正常')}
                                                        </span>
                                                    </div>
                                                    <div className={`text-2xl font-black ${getStatusColor(parseFloat(stats.cv), 'cv')}`}>{stats.cv}</div>
                                                    <div className="text-[10px] text-[#9CA38F] mt-1">超過 0.3 代表差距極大</div>
                                                </div>

                                                {/* 2. 峰度與偏態 */}
                                                <div className="bg-white p-3 rounded-xl border border-[#EEE] shadow-sm">
                                                    <span className="text-[10px] font-bold text-[#9CA38F] block mb-2">試卷鑑別度 (Skew/Kurt)</span>
                                                    <div className="flex gap-2 text-xs font-bold text-[#5D4037]">
                                                        <div>偏態: {stats.skewness}</div>
                                                        <div>峰度: {stats.kurtosis}</div>
                                                    </div>
                                                    <div className="text-[10px] text-[#9CA38F] mt-2">
                                                        {parseFloat(stats.skewness) < -0.5 ? '⚠️ 題目過於簡單 (左偏)' : (parseFloat(stats.skewness) > 0.5 ? '⚠️ 題目過難 (右偏)' : '✅ 難度適中')}
                                                    </div>
                                                </div>

                                                {/* 3. 盒鬚圖數據 IQR */}
                                                <div className="bg-white p-3 rounded-xl border border-[#EEE] shadow-sm">
                                                    <span className="text-[10px] font-bold text-[#9CA38F] block mb-1">核心群體 (IQR)</span>
                                                    <div className="flex items-end gap-1">
                                                        <span className="text-xl font-black text-[#5D4037]">{stats.iqr}</span>
                                                        <span className="text-[10px] text-[#9CA38F] mb-1">分</span>
                                                    </div>
                                                    <div className="w-full bg-gray-100 h-2 rounded-full mt-2 overflow-hidden flex">
                                                        <div style={{ width: '25%' }} className="bg-transparent border-r border-gray-300"></div>
                                                        <div style={{ width: '50%' }} className="bg-[#88C9A1]"></div>
                                                    </div>
                                                    <div className="flex justify-between text-[9px] text-[#9CA38F] mt-1">
                                                        <span>Q1: {stats.q1}</span>
                                                        <span>Med: {stats.median}</span>
                                                        <span>Q3: {stats.q3}</span>
                                                    </div>
                                                </div>

                                                {/* 4. 結構風險 */}
                                                <div className="bg-white p-3 rounded-xl border border-[#EEE] shadow-sm">
                                                    <span className="text-[10px] font-bold text-[#9CA38F] block mb-2">結構佔比</span>
                                                    <div className="space-y-1">
                                                        <div className="flex justify-between text-xs font-bold">
                                                            <span className="text-[#2E7D32]">優秀率 (&gt;85)</span>
                                                            <span>{stats.eliteRate}%</span>
                                                        </div>
                                                        <div className="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                                            <div className="bg-[#2E7D32] h-full" style={{ width: `${stats.eliteRate}%` }}></div>
                                                        </div>
                                                        <div className="flex justify-between text-xs font-bold mt-1">
                                                            <span className="text-[#C62828]">待補強率 (&lt;40)</span>
                                                            <span className={getStatusColor(stats.riskRate, 'risk')}>{stats.riskRate}%</span>
                                                        </div>
                                                        <div className="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                                            <div className="bg-[#C62828] h-full" style={{ width: `${stats.riskRate}%` }}></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 詳細成績單 (Student Rank List) */}
                                            <div className="mt-6 border-t border-gray-100 pt-4">
                                                <details className="group">
                                                    <summary className="flex items-center gap-2 cursor-pointer text-sm font-bold text-[#797365] hover:text-[#574E44] transition-colors select-none">
                                                        <div className="bg-[#F2F4E6] p-1.5 rounded group-open:rotate-90 transition-transform"><ArrowRight size={14} /></div>
                                                        查看詳細成績排行 (Student Rankings)
                                                    </summary>

                                                    <div className="mt-4 overflow-x-auto rounded-xl border-2 border-[#E0E4CC]">
                                                        <table className="w-full text-sm text-center whitespace-nowrap">
                                                            <thead>
                                                                <tr className="bg-[#F8F9F0] text-[#797365]">
                                                                    <th className="p-3">名次</th>
                                                                    <th className="p-3 text-left">姓名</th>
                                                                    <th className="p-3">分數</th>
                                                                    <th className="p-3">PR值</th>
                                                                    <th className="p-3">T分數 (標準化)</th>
                                                                    <th className="p-3">Z分數</th>
                                                                    <th className="p-3">落點分析</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-[#E0E4CC]">
                                                                {getStudentMetrics(cls.scores, stats).map((stu, i) => (
                                                                    <tr key={i} className="bg-white hover:bg-[#FFFDE7]">
                                                                        <td className="p-2 font-black text-[#574E44]">
                                                                            <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full ${stu.rank <= 3 ? 'bg-[#F2D879] text-[#795548]' : 'bg-[#F0F0F0] text-[#9CA38F]'}`}>
                                                                                {stu.rank}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-2 font-bold text-left text-[#5D4037]">{stu.name}</td>
                                                                        <td className={`p-2 font-black ${stu.score < 60 ? 'text-[#C62828]' : 'text-[#2E7D32]'}`}>{stu.score}</td>
                                                                        <td className="p-2 font-bold text-[#797365]">{stu.pr}</td>
                                                                        <td className="p-2 font-mono text-[#797365]">{stu.tScore}</td>
                                                                        <td className="p-2 font-mono text-[#9CA38F] text-xs">{((stu.score - stats.mean) / stats.stdDev).toFixed(2)}</td>
                                                                        <td className="p-2 text-xs font-bold">
                                                                            {stu.score >= stats.fiveStandards?.top ? <span className="text-green-600 bg-green-50 px-2 py-0.5 rounded">頂標群</span> :
                                                                                stu.score >= stats.fiveStandards?.front ? <span className="text-lime-600 bg-lime-50 px-2 py-0.5 rounded">前標群</span> :
                                                                                    stu.score >= stats.fiveStandards?.avg ? <span className="text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded">均標群</span> :
                                                                                        stu.score >= stats.fiveStandards?.back ? <span className="text-orange-600 bg-orange-50 px-2 py-0.5 rounded">後標群</span> :
                                                                                            <span className="text-red-600 bg-red-50 px-2 py-0.5 rounded">底標群</span>}
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    )}

                                    {/* 3. 分數分佈直方圖 (這裡是您要找回的重點) */}
                                    <div className="w-full">
                                        <div className="flex justify-between items-end mb-2 px-2">
                                            <h4 className="text-sm font-black text-[#5D4037] flex items-center gap-2">
                                                <BarChart size={16} /> 分數區間分佈 (Score Distribution)
                                            </h4>
                                            <span className="text-[10px] font-bold text-[#9CA38F]">人數(人) vs 分數段</span>
                                        </div>
                                        <div data-pdf-chart-container="true" className="bg-[#FAFAFA] p-4 rounded-2xl border-2 border-[#F2F4E6] h-[350px] relative">
                                            {/* Canvas 容器，確保其高度被鎖定 */}
                                            <canvas id={`chart-${cls.id}`}></canvas>
                                        </div>
                                    </div>

                                    <div className="mt-6 text-center text-xs text-[#9CA38F] font-bold border-t border-[#F2F4E6] pt-4">
                                        分析報告生成時間: {new Date().toLocaleString('zh-TW')}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        /**
         * 隨機分組小幫手 (Group Maker Tool)
         * 支援輸入名單 (或 Excel)
         * 自動隨機分組
         * 可匯出分組表 JPG/PDF
         */
        const GroupMakerTool = () => {
            const [namesStr, setNamesStr] = useState("");
            const [groupSize, setGroupSize] = useState(4);
            const [groups, setGroups] = useState([]);
            const [isExporting, setIsExporting] = useState(false);
            const chartRef = useRef(null);

            const handleGenerate = () => {
                const names = namesStr.split(/[\n,]+/).map(n => n.trim()).filter(n => n);
                // Shuffle
                for (let i = names.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [names[i], names[j]] = [names[j], names[i]];
                }

                const newGroups = [];
                for (let i = 0; i < names.length; i += groupSize) {
                    newGroups.push(names.slice(i, i + groupSize));
                }
                setGroups(newGroups);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result; const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const names = [];
                        data.forEach(row => { if (row[0]) names.push(row[0]); });
                        setNamesStr(names.join('\n'));
                    } catch (e) { console.error(e); alert("讀取 Excel 失敗"); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };

            const handleExportPDF = async () => {
                if (!chartRef.current || !window.html2canvas || !window.PDFLib) return;
                setIsExporting(true);
                try {
                    const canvas = await window.html2canvas(chartRef.current, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdfDoc = await window.PDFLib.PDFDocument.create();
                    const pngImage = await pdfDoc.embedPng(imgData);
                    const pngDims = pngImage.scale(1);
                    const page = pdfDoc.addPage([pngDims.width + 100, pngDims.height + 100]);
                    page.drawImage(pngImage, { x: 50, y: 50, width: pngDims.width, height: pngDims.height, });
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `grouping_chart_${Date.now()}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) { console.error(err); alert("匯出 PDF 失敗"); } finally { setIsExporting(false); }
            };

            // 匯出 Excel 功能
            const handleExportExcel = () => {
                if (groups.length === 0 || !window.XLSX) {
                    alert("請先生成分組");
                    return;
                }
                // 建立工作表資料
                const wsData = [['組別', '成員']];
                groups.forEach((group, idx) => {
                    group.forEach((name, i) => {
                        wsData.push([i === 0 ? `第 ${idx + 1} 組` : '', name]);
                    });
                });
                const ws = window.XLSX.utils.aoa_to_sheet(wsData);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, '分組結果');
                window.XLSX.writeFile(wb, `分組結果_${new Date().toISOString().slice(0, 10)}.xlsx`);
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-[#F8F9F0] p-4 rounded-[24px] border-[3px] border-white">
                            <label className="text-sm font-bold text-[#797365] mb-2 block">名單 (每行一個)</label>
                            <textarea value={namesStr} onChange={(e) => setNamesStr(e.target.value)} className="w-full h-32 p-3 rounded-xl border-none text-[#797365] font-bold bg-white focus:ring-4 focus:ring-[#88C9A1]/30 resize-none" placeholder="例如：&#10;小明&#10;小華&#10;小美" />
                            <div className="mt-2 relative">
                                <input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                <div className="bg-white border-2 border-dashed border-[#E0E4CC] text-[#9CA38F] font-bold py-2 rounded-xl text-center hover:bg-[#F2F4E6] transition-colors text-sm">或匯入 Excel (讀取第一欄)</div>
                            </div>
                        </div>
                        <div className="bg-[#F8F9F0] p-4 rounded-[24px] border-[3px] border-white flex flex-col justify-center gap-4">
                            <div>
                                <label className="text-sm font-bold text-[#797365] mb-2 block">每組人數</label>
                                <input type="number" value={groupSize} onChange={e => setGroupSize(Number(e.target.value))} className="w-full p-3 rounded-xl border-none bg-white text-[#797365] font-bold" />
                            </div>
                            <div className="bg-[#FFF9C4] p-3 rounded-xl border-2 border-[#FBC02D] text-xs font-bold text-[#797365] opacity-80">
                                小提示：若人數無法整除，最後一組人數會較少。
                            </div>
                        </div>
                    </div>

                    <Button onClick={handleGenerate} variant="primary" className="w-full text-lg" icon={Grid}>生成隨機分組</Button>

                    {groups.length > 0 && (
                        <div className="bg-white p-4 rounded-[24px] border-[4px] border-[#E0E4CC] overflow-auto">
                            <div className="flex justify-end items-center gap-2 mb-4">
                                <Button onClick={handleExportExcel} variant="secondary" className="px-4 py-2 text-sm" icon={Download}>匯出 Excel</Button>
                                <Button onClick={handleExportPDF} disabled={isExporting} variant="secondary" className="px-4 py-2 text-sm" icon={Download}>{isExporting ? "匯出中..." : "匯出分組表 PDF"}</Button>
                            </div>
                            <div ref={chartRef} className="bg-white p-8 min-w-[600px] grid grid-cols-2 md:grid-cols-3 gap-8">
                                {groups.map((group, idx) => (
                                    <div key={idx} className="flex flex-col items-center">
                                        <div className="mb-2 text-[#8B4513] font-bold tracking-widest text-sm uppercase">Table {idx + 1}</div>
                                        <div className="w-full aspect-square wood-pattern-light rounded-[20px] shadow-lg border-[4px] border-[#8B4513] relative flex items-center justify-center p-4">
                                            <div className="text-center">
                                                {group.map((name, i) => (
                                                    <div key={i} className="text-[#8B4513] font-bold text-lg leading-relaxed drop-shadow-md">{name}</div>
                                                ))}
                                            </div>
                                            {/* Table details */}
                                            <div className="absolute top-2 right-2 w-2 h-2 bg-[#8B4513] rounded-full opacity-30"></div>
                                            <div className="absolute top-2 left-2 w-2 h-2 bg-[#8B4513] rounded-full opacity-30"></div>
                                            <div className="absolute bottom-2 right-2 w-2 h-2 bg-[#8B4513] rounded-full opacity-30"></div>
                                            <div className="absolute bottom-2 left-2 w-2 h-2 bg-[#8B4513] rounded-full opacity-30"></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * PDF 合併工具 (PDF Merger)
         * 使用 pdf-lib 進行純前端合併
         * 支援拖曳排序、多檔上傳
         */
        const PDFMerger = ({ ready }) => {
            const [files, setFiles] = useState([]);
            const [processing, setProcessing] = useState(false);

            const handleMerge = async () => {
                if (files.length < 2 || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const mergedPdf = await window.PDFLib.PDFDocument.create();

                    for (const file of files) {
                        const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                        const pdf = await window.PDFLib.PDFDocument.load(fileBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }

                    const pdfBytes = await mergedPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `merged_${Date.now()}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert('合併失敗');
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-4 md:space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <DropZone
                        accept=".pdf"
                        multiple={true}
                        onDrop={(fs) => setFiles(prev => [...prev, ...fs.filter(f => f.type === 'application/pdf')])}
                        label="支援多個 PDF 檔案"
                    />

                    {files.length > 0 && (
                        <div className="space-y-3 bg-white p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-[#F2F4E6]">
                            <div className="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                                {files.map((file, idx) => (
                                    <FileItem
                                        key={idx}
                                        file={file}
                                        onRemove={() => setFiles(files.filter((_, i) => i !== idx))}
                                    />
                                ))}
                            </div>
                        </div>
                    )}

                    <Button
                        onClick={handleMerge}
                        disabled={files.length < 2 || processing}
                        variant="primary"
                        className="w-full text-base md:text-lg"
                        icon={processing ? Loader2 : Layers}
                    >
                        {processing ? '處理中...' : '開始合併 PDF'}
                    </Button>
                </div>
            );
        };

        /**
         * PDF 分割工具 (PDF Splitter)
         * 將多頁 PDF 分割為單頁並打包成 ZIP 下載
         * 使用 JSZip 打包
         */
        const PDFSplitter = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);

            const handleSplit = async () => {
                if (!file || !window.PDFLib || !window.JSZip) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdfDoc = await window.PDFLib.PDFDocument.load(fileBuffer);
                    const pageCount = pdfDoc.getPageCount();
                    const zip = new window.JSZip();

                    for (let i = 0; i < pageCount; i++) {
                        const newPdf = await window.PDFLib.PDFDocument.create();
                        const [copiedPage] = await newPdf.copyPages(pdfDoc, [i]);
                        newPdf.addPage(copiedPage);
                        const pdfBytes = await newPdf.save();
                        zip.file(`${file.name.replace('.pdf', '')}_p${(i + 1).toString().padStart(3, '0')}.pdf`, pdfBytes);
                    }

                    const zipContent = await zip.generateAsync({ type: "blob" });
                    const url = URL.createObjectURL(zipContent);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `split_${Date.now()}.zip`;
                    a.click();
                } catch (err) {
                    console.error(err);
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <Button
                                onClick={handleSplit}
                                disabled={processing}
                                variant="blue"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : Scissors}
                            >
                                {processing ? '處理中...' : '分割並下載 ZIP'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * PDF 頁面移除工具 (PDF Page Remover)
         * 輸入頁碼 (如 1, 3-5) 移除特定頁面
         * 重新生成新的 PDF
         */
        const PDFPageRemover = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [pagesToRemove, setPagesToRemove] = useState('');
            const [processing, setProcessing] = useState(false);

            const handleRemove = async () => {
                if (!file || !pagesToRemove || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdfDoc = await window.PDFLib.PDFDocument.load(fileBuffer);
                    const newPdf = await window.PDFLib.PDFDocument.create();
                    const totalPages = pdfDoc.getPageCount();
                    const removeIndices = new Set();

                    pagesToRemove.split(',').forEach(part => {
                        const range = part.trim().split('-').map(Number);
                        if (range.length === 1 && !isNaN(range[0])) {
                            removeIndices.add(range[0] - 1);
                        } else if (range.length === 2) {
                            for (let i = range[0]; i <= range[1]; i++) {
                                removeIndices.add(i - 1);
                            }
                        }
                    });

                    const keepIndices = [];
                    for (let i = 0; i < totalPages; i++) {
                        if (!removeIndices.has(i)) {
                            keepIndices.push(i);
                        }
                    }

                    if (keepIndices.length === 0) throw new Error("不能移除所有頁面");

                    const copiedPages = await newPdf.copyPages(pdfDoc, keepIndices);
                    copiedPages.forEach(page => newPdf.addPage(page));

                    const pdfBytes = await newPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `removed_pages_${Date.now()}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert('操作失敗: ' + err.message);
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[20px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                                <label className="text-sm md:text-base font-bold text-[#797365] flex items-center gap-2">
                                    <Trash2 className="w-4 h-4" />
                                    要移除的頁碼 (例如: 1, 3-5)
                                </label>
                                <input
                                    type="text"
                                    value={pagesToRemove}
                                    onChange={(e) => setPagesToRemove(e.target.value)}
                                    className="w-full p-3 md:p-4 rounded-xl md:rounded-2xl border-none mt-2 md:mt-3 text-[#797365] bg-white focus:ring-4 focus:ring-[#88C9A1]/30 font-bold"
                                    placeholder="輸入頁碼..."
                                />
                            </div>

                            <Button
                                onClick={handleRemove}
                                disabled={processing}
                                variant="danger"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : Trash2}
                            >
                                {processing ? '處理中...' : '移除指定頁面'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * PDF 旋轉工具 (PDF Rotator)
         * 將整份 PDF 頁面旋轉 90 度
         */
        const PDFRotator = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);

            const handleRotate = async () => {
                if (!file || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdfDoc = await window.PDFLib.PDFDocument.load(fileBuffer);
                    const pages = pdfDoc.getPages();

                    pages.forEach(page => {
                        const rotation = page.getRotation();
                        page.setRotation(window.PDFLib.degrees(rotation.angle + 90));
                    });

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rotated_${Date.now()}.pdf`;
                    a.click();
                } catch (e) {
                    console.error(e);
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <Button
                                onClick={handleRotate}
                                disabled={processing}
                                variant="primary"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : RotateCw}
                            >
                                {processing ? '處理中...' : '全部向右旋轉 90°'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * 圖片轉 PDF 工具 (Image to PDF)
         * 支援多張圖片合併為一份 PDF
         * 支援 PNG, JPG
         */
        const ImageToPDF = ({ ready }) => {
            const [files, setFiles] = useState([]);
            const [processing, setProcessing] = useState(false);

            const handleConvert = async () => {
                if (files.length === 0 || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const pdfDoc = await window.PDFLib.PDFDocument.create();

                    for (const file of files) {
                        const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                        let image;

                        if (file.type === 'image/png') {
                            image = await pdfDoc.embedPng(fileBuffer);
                        } else if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                            image = await pdfDoc.embedJpg(fileBuffer);
                        } else {
                            continue;
                        }

                        const page = pdfDoc.addPage([image.width, image.height]);
                        page.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: image.width,
                            height: image.height
                        });
                    }

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `images_to_pdf_${Date.now()}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert("轉換失敗");
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <DropZone
                        accept="image/png, image/jpeg, image/jpg"
                        multiple={true}
                        onDrop={(fs) => setFiles(prev => [...prev, ...fs.filter(f => ['image/png', 'image/jpeg', 'image/jpg'].includes(f.type))])}
                        label="支援 JPG / PNG"
                    />

                    {files.length > 0 && (
                        <div className="space-y-3 bg-white p-6 rounded-[30px] border-[4px] border-[#F2F4E6]">
                            <div className="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                                {files.map((file, idx) => (
                                    <FileItem
                                        key={`img-${idx}`}
                                        file={file}
                                        onRemove={() => setFiles(files.filter((_, i) => i !== idx))}
                                    />
                                ))}
                            </div>
                        </div>
                    )}

                    <Button
                        onClick={handleConvert}
                        disabled={files.length === 0 || processing}
                        variant="primary"
                        className="w-full text-base md:text-lg"
                        icon={processing ? Loader2 : FileText}
                    >
                        {processing ? '轉換中...' : '轉換為 PDF'}
                    </Button>
                </div>
            );
        };

        /**
         * PDF 轉圖片工具 (PDF to Image)
         * 將 PDF 每一頁轉換為 JPG 圖片
         * 打包為 ZIP 下載
         */
        const PDFToImage = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);

            const handleConvert = async () => {
                if (!file || !window.pdfjsLib || !window.JSZip) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdf = await window.pdfjsLib.getDocument(fileBuffer).promise;
                    const zip = new window.JSZip();
                    const totalPages = pdf.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;

                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                        zip.file(`${file.name.replace('.pdf', '')}_p${i.toString().padStart(3, '0')}.jpg`, blob);
                    }

                    const zipContent = await zip.generateAsync({ type: "blob" });
                    const url = URL.createObjectURL(zipContent);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${file.name.replace('.pdf', '')}_images.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert("轉換失敗: 加密或格式錯誤");
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <Button
                                onClick={handleConvert}
                                disabled={processing}
                                variant="danger"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : ImageIcon}
                            >
                                {processing ? '渲染中...' : '轉換為 JPG (ZIP)'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * 圖片浮水印工具 (Watermark Tool)
         * 為圖片添加重覆的文字浮水印
         * 支援自定義文字
         */
        const WatermarkTool = () => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [text, setText] = useState("僅供行政使用");
            const [processing, setProcessing] = useState(false);

            useEffect(() => {
                if (file) {
                    Utils.readImageAsDataURL(file).then(setPreview);
                } else {
                    setPreview(null);
                }
            }, [file]);

            const handleProcess = async () => {
                if (!file || !preview) return;
                setProcessing(true);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = await Utils.loadImage(preview);

                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const fontSize = Math.max(20, Math.floor(img.width / 20));
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = 'rgba(200, 200, 200, 0.5)';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(-45 * Math.PI / 180);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);

                const stepX = fontSize * text.length * 1.5;
                const stepY = fontSize * 4;

                for (let x = -canvas.width; x < canvas.width * 2; x += stepX) {
                    for (let y = -canvas.height; y < canvas.height * 2; y += stepY) {
                        ctx.fillText(text, x, y);
                    }
                }

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `watermarked_${file.name}`;
                    a.click();
                    setProcessing(false);
                });
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept="image/*"
                            multiple={false}
                            onDrop={(fs) => fs[0].type.startsWith('image/') && setFile(fs[0])}
                            label="JPG, PNG (圖片浮水印)"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                                <label className="text-sm md:text-base font-bold text-[#797365] mb-2 block">
                                    浮水印文字
                                </label>
                                <input
                                    type="text"
                                    value={text}
                                    onChange={(e) => setText(e.target.value)}
                                    className="w-full p-3 md:p-4 rounded-xl md:rounded-2xl border-none text-[#797365] font-bold focus:ring-4 focus:ring-[#88C9A1]/30"
                                    placeholder="浮水印文字"
                                />
                            </div>

                            <Button
                                onClick={handleProcess}
                                disabled={processing}
                                variant="secondary"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : Stamp}
                            >
                                {processing ? '處理中...' : '下載'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * PDF 頁碼添加工具 (PDF Page Number)
         * 自動在 PDF 每一頁底部加入頁碼
         */
        const PDFPageNumber = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);

            const handleAdd = async () => {
                if (!file || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdfDoc = await window.PDFLib.PDFDocument.load(fileBuffer);
                    const pages = pdfDoc.getPages();
                    const { rgb } = window.PDFLib;

                    pages.forEach((page, idx) => {
                        const { width } = page.getSize();
                        page.drawText(`${idx + 1}`, {
                            x: width / 2,
                            y: 20,
                            size: 12,
                            color: rgb(0, 0, 0),
                        });
                    });

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pagenum_${Date.now()}.pdf`;
                    a.click();
                } catch (e) {
                    console.error(e);
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <Button
                                onClick={handleAdd}
                                disabled={processing}
                                variant="secondary"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : Hash}
                            >
                                {processing ? '處理中...' : '添加頁碼 (底部置中)'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * PDF 加密工具 (PDF Encrypt)
         * 設定開啟密碼保護 PDF
         */
        const PDFEncrypt = ({ ready }) => {
            const [file, setFile] = useState(null);
            const [password, setPassword] = useState('');
            const [processing, setProcessing] = useState(false);

            const handleEncrypt = async () => {
                if (!file || !password || !window.PDFLib) return;
                setProcessing(true);

                try {
                    const fileBuffer = await Utils.readFileAsArrayBuffer(file);
                    const pdfDoc = await window.PDFLib.PDFDocument.load(fileBuffer);
                    const pdfBytes = await pdfDoc.save({
                        userPassword: password,
                        ownerPassword: password
                    });

                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `encrypted_${Date.now()}.pdf`;
                    a.click();
                } catch (e) {
                    console.error(e);
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept=".pdf"
                            multiple={false}
                            onDrop={(fs) => fs[0].type === 'application/pdf' && setFile(fs[0])}
                            label="單一 PDF"
                        />
                    ) : (
                        <div className="space-y-4">
                            <FileItem
                                file={file}
                                onRemove={() => setFile(null)}
                            />

                            <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                                <label className="text-sm md:text-base font-bold text-[#797365] mb-2 flex items-center gap-2">
                                    <Lock className="w-4 h-4" />
                                    設定開啟密碼
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 md:p-4 rounded-xl md:rounded-2xl border-none mt-2 text-[#797365] bg-white focus:ring-4 focus:ring-[#88C9A1]/30 font-bold"
                                    placeholder="輸入密碼..."
                                />
                            </div>

                            <Button
                                onClick={handleEncrypt}
                                disabled={processing || !password}
                                variant="danger"
                                className="w-full text-base md:text-lg"
                                icon={processing ? Loader2 : Lock}
                            >
                                {processing ? '處理中...' : '加密 PDF'}
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        const NumToChiTool = ({ ready }) => {
            const [val, setVal] = useState('');
            const [res, setRes] = useState('');

            return (
                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-sm md:text-base font-bold text-[#797365] block">
                                輸入數字金額
                            </label>
                            <div className="text-[#F4E798] flex items-center gap-1 bg-[#797365]/10 px-2 py-1 rounded-lg">
                                <Gem size={16} />
                                <span className="text-xs font-bold text-[#797365]">Bells</span>
                            </div>
                        </div>
                        <input
                            type="number"
                            value={val}
                            onChange={e => setVal(e.target.value)}
                            className="w-full p-3 md:p-4 rounded-xl md:rounded-2xl border-none bg-white text-[#797365] font-bold focus:ring-4 focus:ring-[#88C9A1]/30"
                            placeholder="例如: 12345"
                        />
                    </div>

                    <Button
                        onClick={() => setRes(Utils.numberToChinese(val))}
                        variant="secondary"
                        className="w-full text-base md:text-lg"
                    >
                        轉換為中文大寫
                    </Button>

                    {res && (
                        <div className="bg-[#FFF8DC] p-6 md:p-8 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-[#F4E798] text-center relative overflow-hidden group hover:scale-[1.02] transition-transform">
                            <div className="absolute top-0 left-0 w-full h-3 bg-[#F4E798]/30"></div>
                            <p className="text-xs md:text-sm font-bold text-[#9CA38F] mb-2 uppercase tracking-wider">
                                Result
                            </p>
                            <p className="text-2xl md:text-3xl font-extrabold text-[#797365] select-all tracking-wide break-all">
                                {res}
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // --- 圖片壓縮機組件 (新功能) ---
        const ImageCompressorTool = () => {
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [compressedUrl, setCompressedUrl] = useState(null);
            const [quality, setQuality] = useState(0.7); // 預設品質 70%
            const [originalSize, setOriginalSize] = useState(0);
            const [compressedSize, setCompressedSize] = useState(0);
            const [isProcessing, setIsProcessing] = useState(false);

            // 處理檔案上傳
            const handleFileDrop = (files) => {
                const selectedFile = files[0];
                if (selectedFile && selectedFile.type.match('image.*')) {
                    setFile(selectedFile);
                    setOriginalSize(selectedFile.size);
                    const url = URL.createObjectURL(selectedFile);
                    setPreviewUrl(url);
                    // 載入新圖片時，自動執行一次壓縮
                    compressImage(selectedFile, 0.7);
                    setQuality(0.7);
                } else {
                    alert("請上傳圖片檔案 (JPG, PNG)");
                }
            };

            // 核心壓縮邏輯 (使用 Canvas)
            const compressImage = (imageFile, q) => {
                setIsProcessing(true);
                const img = new Image();
                img.src = URL.createObjectURL(imageFile);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    // 輸出壓縮後的 DataURL
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const newUrl = URL.createObjectURL(blob);
                            setCompressedUrl(newUrl);
                            setCompressedSize(blob.size);
                            setIsProcessing(false);
                        }
                    }, 'image/jpeg', q);
                };
            };

            // 滑桿變動時觸發
            const handleQualityChange = (e) => {
                const newQ = parseFloat(e.target.value);
                setQuality(newQ);
                if (file) compressImage(file, newQ);
            };

            // 下載檔案
            const handleDownload = () => {
                if (!compressedUrl) return;
                const a = document.createElement('a');
                a.href = compressedUrl;
                a.download = `compressed_${file.name.split('.')[0]}.jpg`;
                a.click();
            };

            // 清除重置
            const handleReset = () => {
                setFile(null);
                setPreviewUrl(null);
                setCompressedUrl(null);
                setOriginalSize(0);
                setCompressedSize(0);
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {!file ? (
                        <DropZone
                            accept="image/*"
                            multiple={false}
                            onDrop={handleFileDrop}
                            label="支援 JPG / PNG / WEBP"
                        />
                    ) : (
                        <div className="space-y-4">
                            {/* 檔案資訊卡 */}
                            <div className="flex items-center justify-between p-3 md:p-4 bg-[#F8F9F0] rounded-[20px] border-[3px] border-white">
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-[#E0E4CC]">
                                        <img src={previewUrl} className="w-full h-full object-cover rounded-lg" alt="preview" />
                                    </div>
                                    <div className="min-w-0">
                                        <p className="text-sm md:text-base font-bold text-[#797365] truncate max-w-[150px] md:max-w-xs">{file.name}</p>
                                        <div className="flex gap-2 text-xs font-bold">
                                            <span className="text-[#FF9A8B] line-through">{Utils.formatBytes(originalSize)}</span>
                                            <span className="text-[#88C9A1]">➜ {Utils.formatBytes(compressedSize)}</span>
                                            <span className="bg-[#88C9A1] text-white px-1.5 rounded text-[10px]">省下 {Math.round((1 - compressedSize / originalSize) * 100)}%</span>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleReset} className="p-2 text-[#FF9A8B] hover:bg-white rounded-full transition-colors"><X size={20} /></button>
                            </div>

                            {/* 控制面板 */}
                            <div className="bg-[#FFF9C4] p-4 md:p-6 rounded-[24px] border-[4px] border-[#FBC02D] relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10"><Settings size={80} /></div>
                                <label className="text-sm md:text-base font-bold text-[#F9A825] mb-2 flex justify-between">
                                    <span>壓縮強度 (品質: {Math.round(quality * 100)}%)</span>
                                    <span>{quality < 0.5 ? '檔案極小' : quality > 0.8 ? '畫質優先' : '平衡模式'}</span>
                                </label>
                                <input
                                    type="range"
                                    min="0.1"
                                    max="1.0"
                                    step="0.05"
                                    value={quality}
                                    onChange={handleQualityChange}
                                    className="w-full h-3 bg-[#FBC02D] rounded-lg appearance-none cursor-pointer accent-[#F57F17]"
                                />
                                <div className="flex justify-between text-xs text-[#F9A825]/70 font-bold mt-1 px-1">
                                    <span>模糊 (小)</span>
                                    <span>清晰 (大)</span>
                                </div>
                            </div>

                            {/* 對比視窗 */}
                            <div className="grid grid-cols-2 gap-2 md:gap-4 h-48 md:h-64">
                                <div className="relative rounded-[20px] overflow-hidden border-[3px] border-[#E0E4CC] group">
                                    <div className="absolute top-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded font-bold backdrop-blur-sm z-10">原始</div>
                                    <img src={previewUrl} className="w-full h-full object-contain bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0iI2VlZSI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiAvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiAvPjwvc3ZnPg==')] bg-white" />
                                </div>
                                <div className="relative rounded-[20px] overflow-hidden border-[3px] border-[#88C9A1] group shadow-md">
                                    <div className="absolute top-2 left-2 bg-[#88C9A1] text-white text-xs px-2 py-1 rounded font-bold backdrop-blur-sm z-10">壓縮後</div>
                                    {isProcessing && <div className="absolute inset-0 bg-white/50 flex items-center justify-center z-20"><Loader2 className="animate-spin text-[#88C9A1]" /></div>}
                                    <img src={compressedUrl} className="w-full h-full object-contain bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0iI2VlZSI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiAvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiAvPjwvc3ZnPg==')] bg-white" />
                                </div>
                            </div>

                            <Button
                                onClick={handleDownload}
                                disabled={isProcessing}
                                variant="primary"
                                className="w-full text-lg"
                                icon={Download}
                            >
                                下載壓縮圖片
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        // --- ★ 新增功能：PDF/圖片 OCR 文字辨識工具 (V2.0 高精度/大視窗版) ★ ---
        const PdfOcrTool = () => {
            const [file, setFile] = useState(null);
            const [resultText, setResultText] = useState("");
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState("idle");
            const [statusMsg, setStatusMsg] = useState("");
            const [lang, setLang] = useState("chi_tra+eng"); // For Tesseract

            // ★ Cloud AI State
            const [useCloud, setUseCloud] = useState(false);
            const [apiKey, setApiKey] = useState("");
            const [showKeyInput, setShowKeyInput] = useState(false);

            // Load API Key on Mount
            useEffect(() => {
                const storedKey = localStorage.getItem("gemini_api_key");
                if (storedKey) setApiKey(storedKey);
            }, []);

            const saveApiKey = () => {
                localStorage.setItem("gemini_api_key", apiKey);
                setShowKeyInput(false);
                alert("API Key 已儲存 (僅存於本地端)");
            };

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    setFile(e.target.files[0]);
                    setResultText("");
                    setProgress(0);
                    setStatus("idle");
                }
            };

            const processOCR = async () => {
                if (!file) return;
                setStatus("processing");
                setResultText("");

                try {
                    let images = [];
                    setStatusMsg(useCloud ? "正在準備 Cloud AI 請求..." : "正在啟動高精度影像預處理引擎...");

                    // 1. Convert PDF/Image to Canvas Images (Shared Step)
                    if (file.type === "application/pdf") {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        const numPages = pdf.numPages;

                        for (let i = 1; i <= numPages; i++) {
                            setStatusMsg(`正在進行 PDF 光學採樣 (300 DPI) - 第 ${i}/${numPages} 頁...`);
                            const page = await pdf.getPage(i);
                            // Cloud Mode doesn't need as much pre-processing, but consistent quality helps
                            const scale = useCloud ? 2.0 : 3.0; // Cloud is smarter, can handle slightly lower res to save token/bandwidth
                            const viewport = page.getViewport({ scale: scale });

                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            if (!useCloud) {
                                // Tesseract needs help
                                context.filter = 'grayscale(100%) contrast(170%) brightness(105%)';
                            }

                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            images.push(canvas.toDataURL('image/jpeg', 0.8));
                        }
                    } else if (file.type.startsWith("image/")) {
                        setStatusMsg("正在優化圖片...");
                        const imgBitmap = await createImageBitmap(file);
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        const scale = 1.5;
                        canvas.width = imgBitmap.width * scale;
                        canvas.height = imgBitmap.height * scale;

                        if (!useCloud) {
                            context.filter = 'grayscale(100%) contrast(150%)';
                        }
                        context.drawImage(imgBitmap, 0, 0, canvas.width, canvas.height);
                        images.push(canvas.toDataURL('image/jpeg', 0.8));
                    } else {
                        throw new Error("不支援的檔案格式");
                    }

                    // 2. Recognition Strategy
                    let fullText = "";

                    if (useCloud) {
                        if (!apiKey) throw new Error("請先輸入 Google API Key");

                        for (let i = 0; i < images.length; i++) {
                            setStatusMsg(`Cloud AI 正在智慧解析... 第 ${i + 1}/${images.length} 頁`);

                            const base64Image = images[i].split(',')[1];

                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: "OCR this image. Extract all text exactly as it appears. If there are tables, output them as standard Markdown tables. Ignore visual noise. Output ONLY the extracted text." },
                                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                                        ]
                                    }]
                                })
                            });

                            const data = await response.json();
                            if (data.error) throw new Error(data.error.message);

                            const pageText = data.candidates?.[0]?.content?.parts?.[0]?.text || "(No Text Found)";
                            fullText += `--- Page ${i + 1} (Gemini AI) ---\n${pageText}\n\n`;
                            setProgress(Math.round(((i + 1) / images.length) * 100));
                        }

                    } else {
                        // Local Tesseract
                        const worker = await Tesseract.createWorker(lang);
                        await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.AUTO });

                        for (let i = 0; i < images.length; i++) {
                            setStatusMsg(`本機 AI 正在進行特徵提取與解碼... 第 ${i + 1}/${images.length} 頁`);
                            const { data: { text } } = await worker.recognize(images[i]);
                            fullText += `--- Page ${i + 1} ---\n${text}\n\n`;
                            setProgress(Math.round(((i + 1) / images.length) * 100));
                        }
                        await worker.terminate();
                    }

                    setResultText(fullText);
                    setStatus("success");
                    setStatusMsg(useCloud ? "Cloud AI 解析完成！" : "高精度辨識完成！");

                } catch (err) {
                    console.error(err);
                    setStatus("error");
                    setStatusMsg("系統錯誤：" + err.message);
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(resultText);
                alert("文字已複製到剪貼簿！");
            };

            return (
                <div className="h-full flex flex-col gap-4 p-2">
                    <div className="bg-white p-4 rounded-2xl border-2 border-[#E0E4CC] shadow-sm space-y-4">

                        {/* Cloud Mode Toggle Header */}
                        <div className="flex items-center justify-between mb-2 pb-2 border-b border-[#F2F4E6]">
                            <div className="flex items-center gap-2">
                                <ScanText className={`w-5 h-5 ${useCloud ? "text-[#7A5C3E]" : "text-[#88C9A1]"}`} />
                                <h3 className="font-bold text-[#5D4037]">OCR 引擎設定</h3>
                            </div>
                            <div className="flex items-center gap-2 md:gap-4 bg-[#F8F9F0] px-3 py-1.5 rounded-full border border-[#E0E4CC]">
                                <span className={`text-xs font-bold ${!useCloud ? "text-[#2E7D32]" : "text-[#9CA38F]"}`}>本機 (隱私)</span>
                                <button
                                    onClick={() => setUseCloud(!useCloud)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none ${useCloud ? 'bg-[#FFAB91]' : 'bg-[#88C9A1]'}`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${useCloud ? 'translate-x-6' : 'translate-x-1'}`} />
                                </button>
                                <span className={`text-xs font-bold ${useCloud ? "text-[#D84315]" : "text-[#9CA38F]"}`}>Cloud AI (高精準)</span>
                            </div>
                        </div>

                        {/* Cloud Mode API Key Input */}
                        {useCloud && (
                            <div className="bg-[#FFF3E0] border border-[#FFE0B2] p-3 rounded-lg animate-in fade-in slide-in-from-top-2">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="text-sm font-bold text-[#D84315] flex items-center gap-1"><Key className="w-4 h-4" /> Google Gemini API Key</h4>
                                    <button onClick={() => setShowKeyInput(!showKeyInput)} className="text-xs text-[#E64A19] underline hover:text-[#D84315]">{showKeyInput ? "隱藏" : (apiKey ? "更換 Key" : "設定 Key")}</button>
                                </div>
                                {(showKeyInput || !apiKey) && (
                                    <div className="flex gap-2">
                                        <input
                                            type="password"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            placeholder="請輸入您的 Gemini API Key (AI Studio)"
                                            className="flex-1 bg-white border border-[#FFCCBC] rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-[#FFAB91]"
                                        />
                                        <button onClick={saveApiKey} className="bg-[#FFAB91] text-white px-3 py-1 rounded text-sm font-bold hover:bg-[#FF8A65]">儲存</button>
                                    </div>
                                )}
                                <p className="text-[10px] text-[#E64A19] mt-1 opacity-80">* API Key 僅儲存於您的瀏覽器 localStorage，絕不傳送至第三方伺服器。</p>
                            </div>
                        )}

                        {/* Local Mode Warning */}
                        {!useCloud && (
                            <div className="bg-[#E8F5E9] border border-[#C8E6C9] rounded-lg p-3 flex items-start gap-3">
                                <div className="bg-[#A5D6A7] text-[#1B5E20] p-1.5 rounded-full mt-0.5 shrink-0">
                                    <ShieldCheck className="w-4 h-4" />
                                </div>
                                <div>
                                    <h4 className="text-sm font-black text-[#2E7D32] mb-0.5">離線模式 (隱私優先)</h4>
                                    <p className="text-xs text-[#1B5E20] leading-relaxed">
                                        文件只會在瀏覽器內運算。若遇到複雜排版或手寫字，建議切換至 Cloud AI 模式獲得更佳效果。
                                    </p>
                                </div>
                            </div>
                        )}


                        <div className="flex flex-wrap gap-4 items-center pt-2">
                            <div className="flex-1 min-w-[200px]">
                                <label className="block text-sm font-bold text-[#5D4037] mb-1">1. 選擇檔案 (PDF 或 圖片)</label>
                                <input type="file" accept="application/pdf, image/*" onChange={handleFileChange} className={`block w-full text-sm text-[#5D4037] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:text-white cursor-pointer ${useCloud ? 'file:bg-[#FFAB91] hover:file:bg-[#FF8A65]' : 'file:bg-[#88C9A1] hover:file:bg-[#68B085]'}`} />
                            </div>

                            {!useCloud && (
                                <div className="min-w-[150px]">
                                    <label className="block text-sm font-bold text-[#5D4037] mb-1">2. 辨識模型</label>
                                    <select value={lang} onChange={(e) => setLang(e.target.value)} className="w-full p-2 bg-[#F2F4E6] rounded-lg text-[#5D4037] font-bold border border-[#E0E4CC] outline-none focus:ring-2 focus:ring-[#88C9A1]">
                                        <option value="chi_tra+eng">繁體中文 + 英文</option>
                                        <option value="eng">僅英文</option>
                                        <option value="chi_tra">僅繁體中文</option>
                                        <option value="jpn">日文</option>
                                    </select>
                                </div>
                            )}

                            <div className="flex items-end">
                                <button onClick={processOCR} disabled={!file || status === 'processing'} className={`px-6 py-2 rounded-xl font-bold text-white shadow-md transition-all active:scale-95 ${!file || status === 'processing' ? 'bg-gray-300 cursor-not-allowed' : (useCloud ? 'bg-[#FFAB91] hover:bg-[#FF8A65]' : 'bg-[#88C9A1] hover:bg-[#68B085]')}`}>
                                    {status === 'processing' ? '運算中...' : (useCloud ? 'Cloud AI 解析' : '開始辨識')}
                                </button>
                            </div>
                        </div>

                        {status === 'processing' && (
                            <div className="w-full bg-[#E0E4CC] rounded-full h-2.5 overflow-hidden">
                                <div className={`h-2.5 rounded-full transition-all duration-300 ${useCloud ? 'bg-[#FFAB91]' : 'bg-[#88C9A1]'}`} style={{ width: `${progress}%` }}></div>
                            </div>
                        )}
                        {statusMsg && <p className="text-xs font-bold text-[#8D6E63] text-center animate-pulse">{statusMsg}</p>}
                    </div>

                    <div className="flex-1 bg-white p-4 rounded-2xl border-2 border-[#E0E4CC] shadow-sm flex flex-col relative">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-[#5D4037]">
                                辨識結果輸出
                                {useCloud && resultText && <span className="ml-2 text-[10px] bg-[#FFAB91] text-white px-2 py-0.5 rounded-full">Gemini Powered</span>}
                            </h3>
                            <button onClick={copyToClipboard} disabled={!resultText} className="text-xs bg-[#F2F4E6] text-[#5D4037] px-3 py-1 rounded-lg hover:bg-[#E0E4CC] font-bold disabled:opacity-50">複製文字</button>
                        </div>

                        <textarea
                            value={resultText}
                            readOnly
                            placeholder={useCloud ? "Cloud AI 將自動分析圖片內容並提取文字、表格..." : "系統將透過高精度 OCR 引擎提取文字..."}
                            className={`w-full min-h-[600px] p-4 bg-[#FAFAFA] border border-[#E0E4CC] rounded-xl text-base leading-relaxed text-[#3E2723] resize-y focus:outline-none focus:ring-2 ${useCloud ? 'focus:ring-[#FFAB91]' : 'focus:ring-[#88C9A1]'}`}
                        />

                        {status === 'idle' && !resultText && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center opacity-30 pointer-events-none">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#8D6E63" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="mb-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>
                                <p className="text-base font-bold text-[#8D6E63]">請上傳文件以開始解析</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // 12. 安全工具層 (Security Tools)
        // ==========================================

        // --- 安全密碼產生器_v1.0 (PasswordGeneratorTool) ---
        /**
         * @function PasswordGeneratorTool
         * @description 生成高強度隨機密碼，支援安全計時銷毀與剪貼簿複製。
         * 使用 window.crypto.getRandomValues 確保密碼的隨機性與安全性。
         * 包含應用標籤功能，方便使用者記錄密碼用途 (僅顯示用，不儲存)。
         * 具備 60 秒安全計時器，時間到自動清除顯示的密碼。
         */
        const PasswordGeneratorTool = () => {
            const [password, setPassword] = useState("");
            const [length, setLength] = useState(12);
            const [options, setOptions] = useState({
                upper: true,
                lower: true,
                numbers: true,
                symbols: true,
                excludeAmbiguous: false
            });
            const [strength, setStrength] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [copyFeedback, setCopyFeedback] = useState("");
            const timerRef = useRef(null);

            // 字符集定義
            const CHAR_SETS = {
                upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
                lower: "abcdefghijklmnopqrstuvwxyz",
                numbers: "0123456789",
                symbols: "!@#$%^&*()_+~`|}{[]:;?><,./-=",
                ambiguous: "1lI0O"
            };

            // 計算密碼強度
            useEffect(() => {
                if (!password) {
                    setStrength(0);
                    return;
                }
                let score = 0;
                if (password.length > 8) score += 1;
                if (password.length > 12) score += 1;
                if (/[A-Z]/.test(password)) score += 1;
                if (/[a-z]/.test(password)) score += 1;
                if (/[0-9]/.test(password)) score += 1;
                if (/[^A-Za-z0-9]/.test(password)) score += 1;
                setStrength(Math.min(score, 6)); // Max score 6
            }, [password]);

            const generatePassword = () => {
                let charset = "";
                let newPassword = "";

                if (options.upper) charset += CHAR_SETS.upper;
                if (options.lower) charset += CHAR_SETS.lower;
                if (options.numbers) charset += CHAR_SETS.numbers;
                if (options.symbols) charset += CHAR_SETS.symbols;

                if (options.excludeAmbiguous) {
                    // Remove ambiguous chars manually
                    for (let char of CHAR_SETS.ambiguous) {
                        charset = charset.split(char).join('');
                    }
                }

                if (charset === "") {
                    alert("請至少選擇一種字元類型！");
                    return;
                }

                const array = new Uint32Array(length);
                window.crypto.getRandomValues(array);
                for (let i = 0; i < length; i++) {
                    newPassword += charset[array[i] % charset.length];
                }

                setPassword(newPassword);
                setCopyFeedback("");
                resetTimer();
            };

            const resetTimer = () => {
                if (timerRef.current) clearInterval(timerRef.current);
                setTimeLeft(60);
                timerRef.current = setInterval(() => {
                    setTimeLeft((prev) => {
                        if (prev <= 1) {
                            clearInterval(timerRef.current);
                            setPassword("");
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            useEffect(() => {
                return () => {
                    if (timerRef.current) clearInterval(timerRef.current);
                };
            }, []);

            const handleCopy = async () => {
                if (!password) return;
                try {
                    await navigator.clipboard.writeText(password);
                    setCopyFeedback("已複製!");
                    setTimeout(() => setCopyFeedback(""), 2000);
                } catch (err) {
                    setCopyFeedback("複製失敗");
                }
            };

            const handleClear = () => {
                setPassword("");
                setTimeLeft(0);
                if (timerRef.current) clearInterval(timerRef.current);
            };

            const toggleOption = (key) => {
                setOptions(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const getStrengthColor = () => {
                if (strength <= 2) return "bg-[#FF9A8B]"; // Soft Red
                if (strength <= 4) return "bg-[#F4E798]"; // Soft Yellow
                return "bg-[#88C9A1]"; // Soft Green
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-2xl mx-auto">
                    {/* Main Container - Islander Style */}
                    <div className="bg-white p-6 md:p-8 rounded-[30px] border-[4px] border-[#E0E4CC] shadow-sm relative overflow-hidden">

                        {/* Header */}
                        <div className="flex items-center gap-3 mb-6 border-b-[3px] border-[#F2F4E6] pb-4">
                            <div className="p-2 bg-[#F2F4E6] rounded-xl text-[#88C9A1]">
                                <Key className="stroke-[2.5]" size={24} />
                            </div>
                            <div>
                                <h3 className="text-xl font-extrabold text-[#797365]">安全密碼產生器</h3>
                                <p className="text-xs font-bold text-[#9CA38F]">Secure Password Generator</p>
                            </div>
                            <div className="ml-auto flex items-center gap-2">
                                {timeLeft > 0 && (
                                    <span className="text-xs font-bold text-[#FF9A8B] bg-[#FFF5F5] px-2 py-1 rounded-full animate-pulse border border-[#FF9A8B]/30">
                                        {timeLeft}秒後自動清除
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* Password Display Field */}
                        <div className="relative mb-6">
                            <div className="bg-[#F8F9F0] p-6 rounded-[20px] min-h-[80px] flex items-center justify-center text-center break-all relative border-[3px] border-[#E0E4CC] transition-colors group hover:border-[#88C9A1]">
                                <span className={`text-2xl md:text-3xl font-black tracking-widest ${!password ? 'text-[#9CA38F]/50' : 'text-[#574E44]'} font-mono`}>
                                    {password || "點擊按鈕產生密碼"}
                                </span>
                                {password && (
                                    <button
                                        onClick={handleCopy}
                                        className="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-white hover:bg-[#F2F4E6] rounded-xl text-[#797365] transition-all opacity-0 group-hover:opacity-100 shadow-sm border-2 border-[#E0E4CC] hover:border-[#88C9A1]"
                                        title="複製密碼"
                                    >
                                        <Copy size={20} />
                                    </button>
                                )}
                            </div>

                            {/* Strength Meter Bar */}
                            {password && (
                                <div className="mt-3 flex items-center gap-2">
                                    <span className="text-xs font-bold text-[#9CA38F]">強度:</span>
                                    <div className="flex-1 h-2 bg-[#F2F4E6] rounded-full overflow-hidden flex gap-1">
                                        <div className={`h-full flex-1 transition-all duration-500 rounded-full ${strength >= 1 ? getStrengthColor() : 'opacity-0'}`}></div>
                                        <div className={`h-full flex-1 transition-all duration-500 rounded-full ${strength >= 3 ? getStrengthColor() : 'opacity-0'}`}></div>
                                        <div className={`h-full flex-1 transition-all duration-500 rounded-full ${strength >= 5 ? getStrengthColor() : 'opacity-0'}`}></div>
                                        <div className={`h-full flex-1 transition-all duration-500 rounded-full ${strength >= 6 ? getStrengthColor() : 'opacity-0'}`}></div>
                                    </div>
                                </div>
                            )}

                            {copyFeedback && (
                                <span className="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#88C9A1] text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm animate-bounce">
                                    {copyFeedback}
                                </span>
                            )}
                        </div>

                        {/* Controls Section */}
                        <div className="bg-[#F9FAFB] p-5 rounded-[24px] border-[2px] border-[#F2F4E6] space-y-6">
                            {/* Length Slider */}
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-extrabold text-[#797365] flex items-center gap-2">
                                        <Hash size={16} /> 密碼長度
                                    </span>
                                    <span className="text-sm font-black text-[#574E44] bg-white px-3 py-1 rounded-lg border-2 border-[#E0E4CC] shadow-sm min-w-[3rem] text-center">
                                        {length}
                                    </span>
                                </div>
                                <input
                                    type="range"
                                    min="4"
                                    max="50"
                                    value={length}
                                    onChange={(e) => setLength(parseInt(e.target.value))}
                                    className="w-full h-2 bg-[#E0E4CC] rounded-lg appearance-none cursor-pointer accent-[#88C9A1]"
                                />
                                <div className="flex justify-between text-[10px] font-bold text-[#9CA38F] px-1">
                                    <span>4</span>
                                    <span>16</span>
                                    <span>32</span>
                                    <span>50</span>
                                </div>
                            </div>

                            {/* Options Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                {[
                                    { id: 'upper', label: 'ABC 大寫' },
                                    { id: 'lower', label: 'abc 小寫' },
                                    { id: 'numbers', label: '123 數字' },
                                    { id: 'symbols', label: '!@# 符號' },
                                    { id: 'excludeAmbiguous', label: '排除易混淆' }
                                ].map(opt => (
                                    <label key={opt.id} className="flex items-center space-x-2 cursor-pointer select-none group bg-white p-2 rounded-xl border-2 border-transparent hover:border-[#E0E4CC] transition-all">
                                        <div className={`w-5 h-5 rounded-[6px] border-[2.5px] flex items-center justify-center transition-all ${options[opt.id] ? 'bg-[#88C9A1] border-[#88C9A1]' : 'border-[#D1D5DB] bg-[#F3F4F6]'}`}>
                                            {options[opt.id] && <Check size={14} className="text-white stroke-[4]" />}
                                        </div>
                                        <input
                                            type="checkbox"
                                            checked={options[opt.id]}
                                            onChange={() => toggleOption(opt.id)}
                                            className="hidden"
                                        />
                                        <span className={`text-xs md:text-sm font-bold ${options[opt.id] ? 'text-[#574E44]' : 'text-[#9CA38F]'}`}>{opt.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="mt-6 flex gap-3">
                            <button
                                onClick={generatePassword}
                                className="flex-1 bg-[#88C9A1] hover:bg-[#76B492] text-white font-black py-4 rounded-[20px] shadow-[0_4px_0_#68A382] hover:shadow-[0_6px_0_#68A382] hover:translate-y-[-2px] active:translate-y-0 active:shadow-none transition-all flex items-center justify-center gap-2 text-lg"
                            >
                                <RefreshCw className={password ? "animate-spin-slow" : ""} strokeWidth={3} />
                                產生密碼
                            </button>
                            <button
                                onClick={handleClear}
                                className="px-5 py-4 bg-[#FFF5F5] hover:bg-[#FFE5E5] text-[#FF9A8B] hover:text-[#FF8A75] rounded-[20px] border-[3px] border-[#FF9A8B]/30 hover:border-[#FF9A8B] transition-all flex items-center justify-center shadow-sm"
                                title="清除重置"
                            >
                                <Trash2 size={24} />
                            </button>
                        </div>
                    </div>

                    <p className="text-center text-[10px] text-[#9CA38F] font-bold opacity-60">
                        * 安全提示：採用瀏覽器原生 crypto API 生成，確保最高隨機性。
                    </p>
                </div>
            );
        };

        // ==========================================
        // 13. 日常/生產力工具層 (Daily & Productivity Tools)
        // ==========================================

        // --- DAL 數位快遞 (DALDeliveryTool) ---
        /**
         * @function DALDeliveryTool
         * @description 整合 QR Code 生成與 TinyURL 縮網址服務，風格化為動森機場快遞。
         * 使用 qrcode.js 進行離線 QR Code 生成，並使用 TinyURL API 進行網址縮短。
         * 介面模仿 DAL 航空的品牌風格。
         */
        const DALDeliveryTool = () => {
            const [url, setUrl] = useState("");
            const [shortUrl, setShortUrl] = useState("");
            const [loading, setLoading] = useState(false);
            const qrRef = useRef(null);

            // 當網址改變時，重新繪製 QR Code (離線執行)
            useEffect(() => {
                if (qrRef.current) {
                    qrRef.current.innerHTML = ""; // 清空舊的
                    if (url) {
                        try {
                            new QRCode(qrRef.current, {
                                text: url,
                                width: 180,
                                height: 180,
                                colorDark: "#574E44", // 動森深褐色
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        } catch (e) {
                            console.error("QR Code 生成失敗，請確認已載入 qrcode.js", e);
                            qrRef.current.innerHTML = "<div class='text-xs text-red-400 font-bold'>核心未載入</div>";
                        }
                    }
                }
            }, [url]);

            // 執行縮網址 (使用 TinyURL API，需聯網)
            const handleShorten = async () => {
                if (!url) return;
                setLoading(true);
                try {
                    // 使用 TinyURL 免費 API
                    const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(url)}`);
                    if (res.ok) {
                        const result = await res.text();
                        setShortUrl(result);
                        setUrl(result); // 自動將輸入框更新為短網址
                    } else {
                        throw new Error("API Error");
                    }
                } catch (err) {
                    alert("⚠️ 縮網址失敗！\n\n請確認您的電腦已連接網際網路，此功能無法離線使用。");
                } finally {
                    setLoading(false);
                }
            };

            const handleCopy = (text) => {
                navigator.clipboard.writeText(text);
                alert("已複製到剪貼簿！");
            };

            const downloadQR = () => {
                const img = qrRef.current.querySelector("img");
                const canvas = qrRef.current.querySelector("canvas");
                const src = img ? img.src : (canvas ? canvas.toDataURL() : null);

                if (src) {
                    const a = document.createElement("a");
                    a.href = src;
                    a.download = "dal_qrcode.png";
                    a.click();
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* DAL 品牌頭部 */}
                    <div className="bg-[#40A4D8] p-4 rounded-t-[30px] border-b-4 border-[#F3D35B] flex items-center justify-between text-white shadow-sm relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-20"><Plane size={100} className="rotate-12" /></div>
                        <div className="flex items-center gap-3 relative z-10">
                            <div className="bg-[#F3D35B] p-2 rounded-full text-[#40A4D8]"><Plane size={24} className="stroke-[3]" /></div>
                            <div>
                                <h3 className="font-black text-xl tracking-wider italic">QR Airlines</h3>
                                <p className="text-[10px] font-bold opacity-80">數位快遞服務 • DAL Digital Express</p>
                            </div>
                        </div>
                        <div className="text-right hidden md:block relative z-10">
                            <div className="text-xs font-bold opacity-80">GATE</div>
                            <div className="text-2xl font-black leading-none">01</div>
                        </div>
                    </div>

                    {/* 操作區 */}
                    <div className="bg-white p-6 rounded-b-[30px] border-[4px] border-t-0 border-[#E0E4CC] shadow-sm space-y-6">

                        {/* 網址輸入 */}
                        <div className="space-y-2">
                            <label className="text-sm font-bold text-[#797365] ml-1">輸入網址 (URL)</label>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    placeholder="https://..."
                                    className="flex-1 bg-[#F8F9F0] border-[3px] border-[#E0E4CC] rounded-xl px-4 py-3 text-[#797365] font-bold focus:outline-none focus:border-[#40A4D8] transition-colors"
                                />
                                <button
                                    onClick={() => { setUrl(''); setShortUrl(''); }}
                                    className="bg-[#FF9A8B] text-white px-4 rounded-xl font-bold hover:bg-[#ff806b] transition-colors"
                                >
                                    <X size={20} />
                                </button>
                            </div>
                        </div>

                        {/* 功能按鈕區 */}
                        <div className="flex flex-wrap gap-3 items-center border-b-[2px] border-[#F2F4E6] pb-6">
                            {/* 縮網址按鈕 (帶有警示) */}
                            <Button
                                onClick={handleShorten}
                                disabled={loading || !url}
                                variant="blue"
                                icon={loading ? Loader2 : LinkIcon}
                                className="flex-1 md:flex-none bg-[#40A4D8] hover:bg-[#3590C0] relative overflow-hidden group"
                            >
                                <span className="mr-1">{loading ? "連線中..." : "縮短網址"}</span>
                                {/* 警示標籤 */}
                                <div className="inline-flex items-center bg-black/20 px-1.5 py-0.5 rounded text-[10px] text-white/90 font-bold ml-1 group-hover:bg-black/30 transition-colors">
                                    <Wifi size={10} className="mr-1" /> 需聯網
                                </div>
                            </Button>

                            {shortUrl && (
                                <Button onClick={() => handleCopy(shortUrl)} variant="secondary" icon={Copy} className="bg-[#F3D35B] text-[#7A5C3E]">
                                    複製
                                </Button>
                            )}
                        </div>

                        {/* QR Code 顯示區 (登機證風格) */}
                        {url && (
                            <div className="mt-2 border-[3px] border-dashed border-[#E0E4CC] rounded-[24px] p-6 bg-[#F8F9F0] flex flex-col md:flex-row items-center gap-6 relative overflow-hidden animate-in zoom-in-95 duration-300">

                                <div className="bg-white p-4 rounded-2xl border-[3px] border-[#40A4D8] shadow-sm shrink-0">
                                    <div ref={qrRef} className="w-[180px] h-[180px] flex items-center justify-center bg-white"></div>
                                </div>

                                <div className="flex-1 text-center md:text-left z-10 w-full overflow-hidden flex flex-col justify-center h-full">
                                    <div className="text-xs font-bold text-[#9CA38F] mb-1 tracking-widest">DESTINATION</div>
                                    <div className="text-lg font-bold text-[#574E44] break-all leading-tight mb-4 line-clamp-3 font-mono">
                                        {url}
                                    </div>
                                    <div className="flex gap-2 justify-center md:justify-start">
                                        <Button onClick={downloadQR} variant="outline" className="text-sm py-2 bg-white" icon={Download}>
                                            下載 QR 圖檔
                                        </Button>
                                    </div>
                                    <div className="mt-3 text-[10px] text-[#88C9A1] font-bold flex items-center justify-center md:justify-start gap-1">
                                        <Check size={10} /> 此 QR Code 為本機離線運算，安全無虞
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 幸運大轉盤 (LuckyWheelTool) ---
        /**
         * @function LuckyWheelTool
         * @description 使用 HTML5 Canvas 繪製的互動式轉盤，支援物理模擬轉動效果 (速度與摩擦力)。
         * 使用 requestAnimationFrame 實現平滑動畫。
         * 支援自定義選項名單。
         */
        const LuckyWheelTool = () => {
            const [namesStr, setNamesStr] = useState(() => localStorage.getItem('ac-wheel-names') || "牛頓\n愛因斯坦\n費曼\n馬克斯威\n波耳");

            // Auto-save names
            useEffect(() => {
                localStorage.setItem('ac-wheel-names', namesStr);
            }, [namesStr]);
            const [winner, setWinner] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const canvasRef = useRef(null);

            // 物理參數狀態
            const stateRef = useRef({
                rotation: 0,        // 當前角度 (弧度)
                velocity: 0,        // 角速度
                friction: 0.985,    // 摩擦係數 (模擬空氣阻力與軸承摩擦)
                isAnimating: false,
                names: []
            });

            // 動森配色盤
            const colors = ['#F2D879', '#7FD1B9', '#FF9A8B', '#A7C5EB', '#C4A9E8', '#88C9A1', '#F4E798', '#FFC8DD'];

            const parseNames = () => namesStr.split('\n').filter(n => n.trim());

            // 繪製轉盤的核心函數
            const drawWheel = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const { rotation, names } = stateRef.current;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = centerX - 20; // 留邊距
                const step = (2 * Math.PI) / names.length;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. 繪製扇形
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(rotation); // 套用當前旋轉角度

                names.forEach((name, i) => {
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, radius, i * step, (i + 1) * step);
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fill();
                    ctx.stroke();

                    // 繪製文字
                    ctx.save();
                    ctx.rotate((i * step) + (step / 2));
                    ctx.textAlign = "right";
                    ctx.fillStyle = "#574E44";
                    ctx.font = "bold 16px sans-serif";
                    ctx.fillText(name, radius - 20, 6);
                    ctx.restore();
                });
                ctx.restore();

                // 2. 繪製中心裝飾 (動森葉子 Logo 風格)
                ctx.beginPath();
                ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
                ctx.fillStyle = "white";
                ctx.fill();
                ctx.strokeStyle = "#E0E4CC";
                ctx.lineWidth = 4;
                ctx.stroke();

                // 3. 繪製指針 (固定在右側)
                ctx.beginPath();
                ctx.moveTo(canvas.width - 10, centerY);
                ctx.lineTo(canvas.width + 10, centerY - 15);
                ctx.lineTo(canvas.width + 10, centerY + 15);
                ctx.fillStyle = "#FF5252";
                ctx.fill();
            };

            // 動畫迴圈 (Physics Loop)
            const animate = () => {
                if (!stateRef.current.isAnimating) return;

                // 物理減速：速度 * 摩擦係數
                stateRef.current.velocity *= stateRef.current.friction;
                stateRef.current.rotation += stateRef.current.velocity;

                // 停止條件：速度極小
                if (stateRef.current.velocity < 0.002) {
                    stateRef.current.isAnimating = false;
                    setIsSpinning(false);
                    calculateWinner();
                } else {
                    drawWheel();
                    requestAnimationFrame(animate);
                }
            };

            const calculateWinner = () => {
                const { rotation, names } = stateRef.current;
                const step = (2 * Math.PI) / names.length;
                // 計算最終角度對應的索引 (指針在右側 0 度，因 Canvas 座標系特性，需反向計算)
                // 正規化角度到 0 ~ 2PI
                let normalizedRotation = rotation % (2 * Math.PI);
                if (normalizedRotation < 0) normalizedRotation += 2 * Math.PI;

                // 指針位置在 0 (右)，輪盤逆時針轉，所以角度越大，指到的索引越後面
                // 這裡的數學邏輯是：總角度 - 當前角度 = 倒退回指針處
                let index = Math.floor(((2 * Math.PI) - normalizedRotation) / step) % names.length;

                setWinner(names[index]);
                drawWheel(); // 重繪最後一幀確保清晰
            };

            const handleSpin = () => {
                const names = parseNames();
                if (names.length < 2) {
                    alert("請至少輸入兩個選項！");
                    return;
                }

                setWinner(null);
                setIsSpinning(true);

                // 設定初始物理狀態
                stateRef.current.names = names;
                stateRef.current.isAnimating = true;
                // 初始速度：隨機給一個較大的角速度 (0.3 ~ 0.8 rad/frame)
                stateRef.current.velocity = 0.4 + Math.random() * 0.4;
                // 隨機摩擦力：讓每次停下來的時間不同 (0.985 ~ 0.990)
                stateRef.current.friction = 0.985 + Math.random() * 0.005;

                requestAnimationFrame(animate);
            };

            // 初始化與名單變更時重繪
            useEffect(() => {
                stateRef.current.names = parseNames();
                drawWheel();
            }, [namesStr]);

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* 左側：設定區 */}
                        <div className="md:col-span-1 space-y-4">
                            <div className="bg-[#F8F9F0] p-4 rounded-[24px] border-[3px] border-white h-full flex flex-col">
                                <label className="text-sm font-bold text-[#797365] mb-2 flex items-center gap-2">
                                    <ClipboardList size={16} /> 選項名單
                                </label>
                                <textarea
                                    value={namesStr}
                                    onChange={(e) => setNamesStr(e.target.value)}
                                    className="flex-1 w-full p-3 rounded-xl border-none text-[#797365] font-bold bg-white focus:ring-4 focus:ring-[#88C9A1]/30 resize-none text-sm leading-relaxed"
                                    placeholder="每行一個選項..."
                                    disabled={isSpinning}
                                />
                                <div className="mt-2 text-xs text-[#9CA38F] font-bold text-center">
                                    共 {parseNames().length} 個項目
                                </div>
                            </div>
                        </div>

                        {/* 右側：轉盤顯示區 */}
                        <div className="md:col-span-2 flex flex-col items-center justify-center bg-[#FFF8E1] rounded-[30px] border-[4px] border-[#FFE082] p-6 relative shadow-inner">
                            {/* Canvas */}
                            <canvas
                                ref={canvasRef}
                                width={320}
                                height={320}
                                className="max-w-full h-auto drop-shadow-xl"
                            />

                            {/* 勝利顯示層 */}
                            {winner && (
                                <div className="absolute inset-0 bg-black/20 backdrop-blur-[2px] rounded-[26px] flex items-center justify-center z-10 animate-in zoom-in duration-300">
                                    <div className="bg-white p-6 rounded-[30px] border-[6px] border-[#F2D879] text-center shadow-2xl transform rotate-[-2deg]">
                                        <div className="text-xs font-bold text-[#9CA38F] tracking-widest uppercase mb-1">WINNER</div>
                                        <div className="text-4xl font-black text-[#7A5C3E] px-4">{winner}</div>
                                        <button
                                            onClick={() => setWinner(null)}
                                            className="mt-4 bg-[#88C9A1] text-white px-4 py-1 rounded-full text-xs font-bold hover:scale-105 transition-transform"
                                        >
                                            OK!
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <Button
                        onClick={handleSpin}
                        disabled={isSpinning || parseNames().length < 2}
                        variant="primary"
                        className="w-full text-xl py-4 shadow-[0_6px_0_#68C0A6] active:shadow-none active:translate-y-[6px]"
                        icon={isSpinning ? Loader2 : RefreshCw}
                    >
                        {isSpinning ? "轉動中..." : "開始轉動 !"}
                    </Button>
                </div>
            );
        };

        // --- 隨機抽籤工具 (RandomPickerTool) ---
        /**
         * @function RandomPickerTool
         * @description 簡單的文字清單隨機抽選工具。
         * 輸入名單後，系統隨機選出一位幸運兒。
         */
        const RandomPickerTool = () => {
            const [input, setInput] = useState("");
            const [result, setResult] = useState("");

            const handleDraw = () => {
                const lines = input.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return;
                const random = Math.floor(Math.random() * lines.length);
                setResult(lines[random]);
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                        <label className="text-sm md:text-base font-bold text-[#797365] mb-2 block">
                            輸入名單 (每行一個)
                        </label>
                        <textarea
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            className="w-full h-32 p-3 md:p-4 rounded-xl md:rounded-2xl border-none text-[#797365] font-bold bg-white focus:ring-4 focus:ring-[#88C9A1]/30 resize-none"
                            placeholder="例如:&#10;西施惠&#10;豆狸&#10;粒狸"
                        />
                    </div>

                    <Button
                        onClick={handleDraw}
                        disabled={!input.trim()}
                        variant="secondary"
                        className="w-full text-base md:text-lg"
                        icon={Dice5}
                    >
                        開始抽籤
                    </Button>

                    {result && (
                        <div className="bg-[#FFF9C4] p-6 md:p-8 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-[#FFF176] text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-3 bg-[#FFF176]/30"></div>
                            <p className="text-xs md:text-sm font-bold text-[#FBC02D] mb-2 uppercase tracking-wider">
                                Winner
                            </p>
                            <p className="text-3xl md:text-4xl font-extrabold text-[#F57F17] tracking-wide break-words">
                                {result}
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // --- 倒數計時器 (CountdownTool) ---
        /**
         * @function CountdownTool
         * @description 簡單好用的倒數計時器。
         * 支援預設時間 (1/3/5/10/30 分鐘) 快速設定與自定義時間。
         * 時間到時會播放提示音 (playAlarm) 並顯示視覺提醒。
         * 包含進度條圓環視覺效果。
         */
        const CountdownTool = () => {
            const [timeLeft, setTimeLeft] = useState(0);
            const [isActive, setIsActive] = useState(false);
            const [duration, setDuration] = useState(0);
            const [customMin, setCustomMin] = useState("");
            const [customSec, setCustomSec] = useState("");

            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft(t => t - 1);
                    }, 1000);
                } else if (timeLeft === 0 && isActive) {
                    setIsActive(false);
                    playAlarm();
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);

            const startTimer = (seconds) => {
                setDuration(seconds);
                setTimeLeft(seconds);
                setIsActive(true);
            };

            const toggleTimer = () => setIsActive(!isActive);
            const resetTimer = () => {
                setIsActive(false);
                setTimeLeft(0);
                setDuration(0);
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const progress = duration > 0 ? ((duration - timeLeft) / duration) * 100 : 0;

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="flex flex-col items-center justify-center py-6 relative">
                        {/* 進度圓環背景 */}
                        <div className="w-56 h-56 rounded-full border-[6px] border-[#F2F4E6] flex items-center justify-center relative bg-white shadow-inner">
                            {duration > 0 && (
                                <svg className="absolute top-0 left-0 w-full h-full transform -rotate-90 pointer-events-none">
                                    <circle
                                        cx="112" cy="112" r="109"
                                        stroke="#88C9A1" strokeWidth="6" fill="none"
                                        strokeDasharray={2 * Math.PI * 109}
                                        strokeDashoffset={2 * Math.PI * 109 * (1 - progress / 100)}
                                        strokeLinecap="round"
                                        className="transition-all duration-1000 ease-linear"
                                    />
                                </svg>
                            )}

                            <div className={`text-6xl font-black font-mono tabular-nums tracking-tighter ${timeLeft < 10 && isActive ? 'text-[#FF9A8B] animate-pulse' : 'text-[#797365]'}`}>
                                {formatTime(timeLeft)}
                            </div>
                            <div className="absolute -bottom-3 bg-[#F8F9F0] px-3 py-1 rounded-full text-xs font-bold text-[#9CA38F] border border-[#E0E4CC]">
                                {isActive ? '計時中' : '準備就緒'}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                        {[1, 3, 5, 10, 30].map(m => (
                            <button
                                key={m}
                                onClick={() => startTimer(m * 60)}
                                className="bg-[#F8F9F0] hover:bg-[#E0E4CC] text-[#797365] font-bold py-3 rounded-xl border border-[#D7DCC1] transition-colors"
                            >
                                {m} 分鐘
                            </button>
                        ))}
                    </div>

                    <div className="bg-[#F8F9F0] p-3 rounded-xl flex items-center gap-2 border border-[#E0E4CC]">
                        <input
                            type="number" value={customMin} onChange={e => setCustomMin(e.target.value)}
                            placeholder="分" className="w-full bg-white p-2 rounded-lg text-center font-bold text-[#797365]"
                        />
                        <span className="font-black text-[#9CA38F]">:</span>
                        <input
                            type="number" value={customSec} onChange={e => setCustomSec(e.target.value)}
                            placeholder="秒" className="w-full bg-white p-2 rounded-lg text-center font-bold text-[#797365]"
                        />
                        <button
                            onClick={() => {
                                const m = parseInt(customMin) || 0;
                                const s = parseInt(customSec) || 0;
                                if (m + s > 0) startTimer(m * 60 + s);
                            }}
                            className="bg-[#A7C5EB] text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap hover:bg-[#96B4DA]"
                        >
                            設定
                        </button>
                    </div>

                    <div className="flex gap-3">
                        <Button
                            onClick={toggleTimer}
                            disabled={timeLeft === 0}
                            variant={isActive ? "danger" : "primary"}
                            className="flex-1 text-lg"
                            icon={isActive ? Pause : Play}
                        >
                            {isActive ? "暫停" : "開始"}
                        </Button>
                        <Button
                            onClick={resetTimer}
                            variant="secondary"
                            icon={RotateCcw}
                            className="px-6"
                        />
                    </div>
                </div>
            );
        };

        // --- 番茄鐘專注工具 (PomodoroTool) ---
        /**
         * @function PomodoroTool
         * @description 經典的番茄工作法計時器。
         * 提供 25 分鐘專注模式與 5 分鐘休息模式。
         * 介面風格模仿動森露營，營造放鬆專注的氛圍。
         */
        const PomodoroTool = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus'); // focus, break

            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft(t => t - 1);
                    }, 1000);
                } else if (timeLeft === 0 && isActive) {
                    setIsActive(false);
                    playAlarm();
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);

            const switchMode = (m) => {
                setIsActive(false);
                setMode(m);
                setTimeLeft(m === 'focus' ? 25 * 60 : 5 * 60);
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* 露營風格卡片 */}
                    <div className={`${mode === 'focus' ? 'bg-[#FF9A8B]' : 'bg-[#7FD1B9]'} p-6 rounded-[30px] border-[5px] border-white text-white shadow-lg transition-colors duration-500 relative overflow-hidden`}>
                        <div className="absolute top-2 right-2 opacity-20"><Tent size={80} /></div>
                        <div className="text-center relative z-10">
                            <h3 className="text-xl font-black mb-1 opacity-90 uppercase tracking-widest">{mode === 'focus' ? 'Focus Time' : 'Take a Break'}</h3>
                            <div className="text-7xl font-black font-mono my-4 drop-shadow-md">
                                {formatTime(timeLeft)}
                            </div>
                            <div className="flex justify-center gap-4">
                                <button onClick={() => switchMode('focus')} className={`px-4 py-1 rounded-full text-xs font-bold border-2 ${mode === 'focus' ? 'bg-white text-[#FF9A8B] border-white' : 'border-white/50 text-white/50 hover:bg-white/10'}`}>25m 專注</button>
                                <button onClick={() => switchMode('break')} className={`px-4 py-1 rounded-full text-xs font-bold border-2 ${mode === 'break' ? 'bg-white text-[#7FD1B9] border-white' : 'border-white/50 text-white/50 hover:bg-white/10'}`}>5m 休息</button>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3">
                        <Button
                            onClick={() => setIsActive(!isActive)}
                            className={`flex-1 text-xl py-4 shadow-[0_6px_0_rgba(0,0,0,0.1)] active:shadow-none active:translate-y-[6px] ${mode === 'focus' ? 'bg-[#FF9A8B] hover:bg-[#FF8A65]' : 'bg-[#7FD1B9] hover:bg-[#68C0A6]'}`}
                            icon={isActive ? Pause : Play}
                            variant="primary" // Override with className
                        >
                            {isActive ? "暫停計時" : "開始計時"}
                        </Button>
                        <Button
                            onClick={() => switchMode(mode)}
                            variant="secondary"
                            className="px-6"
                            icon={RotateCcw}
                        />
                    </div>
                </div>
            );
        };

        // --- 隨手便利貼 (NotepadTool) ---
        /**
         * @function NotepadTool
         * @description 簡單的文字記事功能，支援 LocalStorage 自動儲存。
         */
        const NotepadTool = () => {
            const [text, setText] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem('ac-memo');
                if (saved) setText(saved);
            }, []);

            useEffect(() => {
                localStorage.setItem('ac-memo', text);
            }, [text]);

            return (
                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-[#FFF9C4] p-1 rounded-[24px] border-[4px] border-[#FBC02D] shadow-md relative">
                        <div className="absolute -top-3 -left-3 bg-[#FF9A8B] w-8 h-8 rounded-full border-4 border-white shadow-sm z-20 flex items-center justify-center">
                            <StickyNote size={14} className="text-white" />
                        </div>
                        <textarea
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            className="w-full h-64 bg-[#FFFDE7] p-6 rounded-[20px] text-[#5D4037] text-lg leading-relaxed placeholder:text-[#F9A825]/30 focus:outline-none resize-none font-medium"
                            placeholder="在這裡記下島務筆記..."
                        />
                        <div className="absolute bottom-4 right-4 text-xs font-bold text-[#F9A825]/60 flex items-center gap-1">
                            {text ? <Save size={12} /> : null} {text ? '已自動儲存' : '自動儲存中'}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 待辦事項清單 (TodoListTool) ---
        /**
         * @function TodoListTool
         * @description 簡易待辦事項清單，支援新增、完成、刪除功能，並透過 LocalStorage 儲存。
         */
        const TodoListTool = () => {
            const [todos, setTodos] = useState([]);
            const [input, setInput] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem('ac-todos');
                if (saved) setTodos(JSON.parse(saved));
            }, []);

            useEffect(() => {
                localStorage.setItem('ac-todos', JSON.stringify(todos));
            }, [todos]);

            const add = () => {
                if (!input.trim()) return;
                setTodos([...todos, { id: Date.now(), text: input, done: false }]);
                setInput("");
            };

            const toggle = (id) => {
                setTodos(todos.map(t => t.id === id ? { ...t, done: !t.done } : t));
            };

            const remove = (id) => {
                setTodos(todos.filter(t => t.id !== id));
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="flex gap-2">
                        <input
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && add()}
                            className="flex-1 p-3 rounded-xl border-none font-bold bg-[#F8F9F0] text-[#797365] focus:ring-4 focus:ring-[#88C9A1]/30 placeholder:text-[#9CA38F]"
                            placeholder="新增待辦事項..."
                        />
                        <Button onClick={add} variant="primary" icon={Plus} className="px-6">新增</Button>
                    </div>

                    <div className="space-y-2">
                        {todos.length === 0 && (
                            <div className="text-center py-8 text-[#9CA38F] font-bold opacity-50">
                                目前沒有待辦事項
                            </div>
                        )}
                        {todos.map(t => (
                            <div key={t.id} className={`flex items-center gap-3 p-3 rounded-xl transition-all ${t.done ? 'bg-[#F0F2F5] opacity-60' : 'bg-white shadow-sm border border-[#E0E4CC]'}`}>
                                <button
                                    onClick={() => toggle(t.id)} // Fixed: toggle defined within scope of functional component is fine but onClick expects function reference
                                    className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-colors ${t.done ? 'bg-[#88C9A1] border-[#88C9A1]' : 'border-[#9CA38F] hover:border-[#88C9A1]'}`}
                                >
                                    {t.done && <Check size={14} className="text-white" />}
                                </button>
                                <span className={`flex-1 font-bold ${t.done ? 'text-[#9CA38F] line-through' : 'text-[#797365]'}`}>{t.text}</span>
                                <button onClick={() => remove(t.id)} className="text-[#FF9A8B] hover:bg-[#FFF0F0] p-1.5 rounded-lg transition-colors">
                                    <Trash2 size={16} />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // 14. 休閒娛樂工具層 (Entertainment Tools)
        // ==========================================

        // --- 島民笑話集 (JokeTool) ---
        /**
         * @function JokeTool
         * @description 隨機顯示一則與動森島民生活相關的趣味笑話。
         * 包含西施惠、呂游、傅達等角色的經典梗。
         * 介面設計為對話框形式。
         */
        const JokeTool = () => {
            const [jokeData, setJokeData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [history, setHistory] = useState([]);

            const hardcodedJokes = [
                { text: "要成功要做到五個字「特別能吃苦」，而我想我快成功了", sub: "因為我已經做到五分之四...「特別能吃」" },
                { text: "炎柱會吃便當，那龍柱會？", sub: "回頭......浪子回頭" },
                { text: "有隻麋鹿在森林裡迷路了，於是他打電話給長頸鹿：「ㄟㄟ！我迷路啦！」", sub: "長頸鹿：「喔～拎北長頸鹿啦！」" },
                { text: "一般的狗都汪汪叫，那山上的狗怎麼叫？", sub: "汪汪的啦" },
                { text: "人在什麼時候會感到害怕？", sub: "亥時。亥時（還是）會害怕..." },
                { text: "哪個藝人不吃午餐？", sub: "中島美嘉" },
                { text: "什麼果汁名字最長？", sub: "屬牛虎兔龍蛇馬羊猴雞 狗豬" },
                { text: "小鹿斑比的哥哥是？", sub: "大鹿尋奇" },
                { text: "學海無涯", sub: "回頭是岸" },
                { text: "葡萄點名 . . . . .", sub: "葡萄柚" },
                { text: "小馬的哥哥叫什麼？", sub: "歐巴馬" },
                { text: "請問要怎麼變成一個暖男？", sub: "火化" },
                { text: "牆壁去爬山，走到腳痠了，誰會揹他？", sub: "源之助。因為卑鄙源之助（背壁源之助）" },
                { text: "在哪裡跌倒", sub: "就在那裡哭" },
                { text: "空中大學的學生，上完課後要幹嘛？", sub: "進行空中作業" },
                { text: "出門前我對桌上的隱形眼鏡說", sub: "我根本沒把妳放在眼裡！" },
                { text: "紅豆、綠豆、黃豆，哪一種豆子最貴？", sub: "紅豆。紅豆粉粿（悔過）" },
                { text: "很熱的島是什麼島？", sub: "正中午（台語：透中晝）" },
                { text: "為什麼超人要穿緊身衣？", sub: "因為救人要緊" },
                { text: "開封的優格可以保存幾天？", sub: "開封優格保七天（包青天）" },
                { text: "我：醫生，我手術後要多久才能拉小提琴？醫生：一個月。", sub: "我：謝謝你，我本來不會拉的！" },
                { text: "為什麼會有起床氣？", sub: "因為我賴床，床不回，我就生氣了" },
                { text: "皮卡丘要去跟傑尼龜借錢。皮卡丘：「皮卡皮卡皮卡（傑尼龜借我一些錢）」", sub: "傑尼龜：「不要（傑尼傑尼）」" },
                { text: "一歲的蜜蜂到了一百歲變成甚麼？", sub: "高齡蜂" },
                { text: "哪位總統最愛吃零食？", sub: "袁世凱。因為他是臨時（零食）大總統" },
                { text: "老王姓什麼？", sub: "法。法老王" },
                { text: "阿杏摔個四腳朝天，變什麼？", sub: "阿呆" },
                { text: "一個成功的男人背後都有什麼？", sub: "一根脊椎" },
                { text: "為什麼母雞要一直抖？", sub: "其實我也母雞抖（粵語：不知道）" },
                { text: "有天小明打電話給電話客服。客服：「很高興能為您服務。」小明：「你高興的太早了。」", sub: "於是小明就把電話掛掉了。" },
                { text: "小明為什麼每次跑步比賽都輸？", sub: "因為他穿慢跑鞋" },
                { text: "曹操字孟德，劉備字玄德，那伍佰呢？", sub: "五百字心得" },
                { text: "冰塊最想做什麼事？", sub: "退伍，因為他當冰（兵）當很久了" },
                { text: "熊剪了指甲變成？", sub: "能" },
                { text: "高麗菜死掉會變成什麼？", sub: "高利貸...高麗Die" },
                { text: "為什麼螃蟹要橫著走？", sub: "因為有鉗就是任性" },
                { text: "什麼刀最長？", sub: "屠龍刀，Too Long…." },
                { text: "壞事一定要在中午做，為什麼？", sub: "因為～早晚會有報應" },
                { text: "鯊魚吃下綠豆變成？", sub: "綠豆沙" },
                { text: "達文西密碼的上面是什麼？", sub: "達文西帳號" },
                { text: "恐怖分子樓下住誰？", sub: "恐怖分母" },
                { text: "為什麼皇帝害怕去醫院?", sub: "因為對症下藥（對朕下藥）" },
                { text: "什麼皇帝最漂亮?", sub: "秦始皇，因為他暴政（爆正）" },
                { text: "狗的英文叫 dog，那臘腸狗的英文怎麼拚？", sub: "doooooooog" },
                { text: "為什麼看不到李白寫的詩?", sub: "字太白" },
                { text: "小白＋小白=?", sub: "小白兔（two）" },
                { text: "誰家沒有電話?", sub: "天衣，因為天衣無縫（phone）" },
                { text: "誰最不孝順?", sub: "面速力，因為面速力達（打）母" },
                { text: "要把杯子變大，要念什麼咒語?", sub: "大悲（杯）咒" },
                { text: "為什麼飛機飛這麼高都不會撞到星星呢?", sub: "因為星星會〝閃〞" },
                { text: "我跟你說一件事實……", sub: "兩件80" },
                { text: "高速公路北上給汽車走，南下給誰走?", sub: "給騎老虎的走（騎虎南下）" },
                { text: "為什麼哈利波特不吃冰?", sub: "因為魔法少年賈修（呷燒）（台語）" },
                { text: "豹的女朋友是誰?", sub: "龜，因為抱（豹）得美人歸（龜）" },
                { text: "馬英九的家猜一首歌?", sub: "小酒窩（九窩）" },
                { text: "哪一種花最沒力?", sub: "茉莉花，因為好一朵美麗（沒力）的茉莉花～～" },
                { text: "誰的老婆身體最不好?", sub: "酷酷哥，因為老婆叫酷酷嫂（臺語：咳嗽）" },
                { text: "為什麼老人不在晚上的時候出去?", sub: "因為月下（嚇）老人" },
                { text: "有誰知道天使姓什麼嗎?", sub: "馬。因為馬英九（馬angel）" },
                { text: "當兵時所吃的鹽是細鹽還是粗鹽?", sub: "粗鹽。因為軍無細鹽（君無戲言）" },
                { text: "有個潮男走在路上，路人看着他，稱讚道：「哇！你超會搭！」", sub: "潮男就燒焦了。（搭=焦）" },
                { text: "通常多少人我們會稱他為一個團體呢?", sub: "20個人。因為團體=twenty" },
                { text: "請問三國時代為什麼最後魏國會勝利?", sub: "因為天下第一味（魏）" },
                { text: "皮卡丘站起來？", sub: "皮卡兵" },
                { text: "皮卡丘爬山？", sub: "皮卡岳" },
                { text: "皮卡丘左右跳呢？", sub: "皮卡乒乓乒乓" },
                { text: "為什麼很少看到蜜蜂的便便?", sub: "因為牠便蜜" },
                { text: "五月花和百合花哪個沒生過小孩?", sub: "五月花。因為五月花衛生紙（未生子）" },
                { text: "一對連體嬰的姐妹，一個叫瑪麗，另一個叫什麼?", sub: "夢露。因為瑪麗蓮（連）夢露" },
                { text: "什麼情況下人會有四隻眼睛?", sub: "兩個人的時候" },
                { text: "為什麼美人魚最專情?", sub: "因為她不會劈腿" },
                { text: "青春痘長在哪裡最不用擔心?", sub: "別人臉上" },
                { text: "哪個人跑得最快?", sub: "曹操，因為說曹操曹操就到" },
                { text: "什麼樣的人不能到加油站上班?", sub: "油腔滑調的人" },
                { text: "氧氣和二氧化碳，哪一個比較美?", sub: "氧氣。因為氧氣會助燃，助燃（自然）就是美" },
                { text: "一隻公雞加一隻母雞，猜三個字?", sub: "兩隻雞" },
                { text: "什麼事是林先生和林太太每天睡覺都要做的事?", sub: "閉上眼睛" },
                { text: "哪個村不會下雨?", sub: "地球村美語" },
                { text: "川普跌倒了變什麼?", sub: "三普" },
                { text: "木魚掉到水裡變什麼?", sub: "虱目魚（濕木魚）" },
                { text: "白襯衫容易發黃，一般的洗衣精很難洗乾淨，不少人為此感到頭痛，其實，不妨在洗的時候…", sub: "吃顆頭痛藥，頭就不會那麼痛了" },
                { text: "有一對情侶吵架，女生很生氣的奪門而出，男生馬上快速的追出去…", sub: "把門奪回來…." },
                { text: "怎樣使麻雀安靜下來?", sub: "壓它一下。因為，壓（鴉）雀無聲" },
                { text: "迪士尼卡通的辛巴姓什麼?", sub: "姓王。因為 獅子 王辛巴" },
                { text: "請問書跟筆誰是壞人?", sub: "書。因為害人之心book有" },
                { text: "哪種職業最不容易受傷?", sub: "零售商（零受傷）" },
                { text: "哪一種食物最常被拿來做攻擊的武器呢?", sub: "人蔘。因為〝人身攻擊〞" },
                { text: "有一天Y跟X走在路上，突然看到U哭得很傷心，Y就走過去問U說：", sub: "uniqlo U你哭囉?" },
                { text: "問：你有《時間簡史》嗎?", sub: "神經病，我有時間也不撿屎！" },
                { text: "你從醫院回來了啊，沒什麼事吧？醫生怎麼說?", sub: "Doctor" },
                { text: "一塊三分熟的牛排和一塊五分熟的牛排在大街上遇到了，為什麼他們沒打招呼呢?", sub: "因為……他們都不熟…" },
                { text: "醫生問小明：如果把你一邊耳朵割掉你會怎麼樣？小明：我會聽不見。醫生又問：那再割掉另一個耳朵呢？", sub: "小明：我會看不見（因為我有戴眼鏡）" },
                { text: "有位女孩跳河後因為羽絨服太厚，漂在了河上被獲救。這難道就是傳說中的：", sub: "大難不死必有厚服！！！！！" },
                { text: "某公司老板去旅行，經過一座山時，導遊介紹到：「這山下有個泉，屈原泉。」老板問：「什麼泉？」導遊答：「屈－原－泉！」", sub: "老板怒道：「就你會拼音，我問你什麼泉！」" },
                { text: "有一天紅豆餅出車禍了，他臨死前說的最後一句話是：", sub: "「啊！原來我是包奶油的！」" },
                { text: "劉備和張飛一起騎馬，眼看著張飛要沖出懸崖了。劉備：張飛！你快勒馬！", sub: "張飛回頭：我很快樂！然後他就掉下去了。" },
                { text: "千萬不要和風打架，就算你武功高，風沒傷到你", sub: "你傷風了，也會感冒。" },
                { text: "有一對玉米相愛了，決定結婚。那天一個玉米找不到另一個，問身旁的爆米花：「你看到我們家玉米了嗎？」", sub: "爆米花說：「親愛的，人家穿婚紗了嘛~」" },
                { text: "小鵝問媽媽：「為什麼我要叫爸爸〝阿瑪〞？」", sub: "「因為我是你的鵝娘呀！」" },
                { text: "小蛇很慌張地問大蛇哥哥：「哥哥，我們有沒有毒？」大蛇說：「你問這幹嘛？」", sub: "小蛇說：「我剛才不小心把自己舌頭咬到了。」" },
                { text: "少女：請問禪師，現在社會動亂，我一個弱女子應當如何保護自己？禪師二話不說，倒了一杯水，立即潑到少女臉上。", sub: "少女：難道是要我保持冷靜？禪師：妳素顏就可以了。" },
                { text: "有一天，0 跟 8 在街上遇見，0 不屑地對 8 說：胖就胖，還繫什麼腰帶！", sub: "" },
                { text: "綠豆哪裡人？", sub: "嘉義人（加薏仁）。" },
                { text: "小明：爸爸，我想要一隻狗。爸爸：好啊，我們去寵物店買。", sub: "小明：可是我想要一隻熱狗。" },
                { text: "有一天，皮卡丘走路跌倒了，變成了什麼？", sub: "皮卡兵（乒）。" },
                { text: "猴子最討厭什麼線？", sub: "平行線，因為沒有相交（香蕉）。" },
                { text: "為什麼小鳥飛到南方就不飛了？", sub: "因為牠的一隻翅膀抽筋了（很冷）。" },
                { text: "有一天，紅豆餅出車禍了，他吐出了什麼？", sub: "紅豆餡（血）。" },
                { text: "愚公移山的時候唱什麼歌？", sub: "移山移山亮晶晶。" },
                { text: "為什麼哈利波特不吃冰？", sub: "因為他怕魔法變沒了（魔髮變沒了）。" },
                { text: "有一個人叫小蔡，然後他就被端走了。", sub: "" },
                { text: "巫婆死掉變什麼？", sub: "Switch" },
                { text: "卓別林死掉變什麼？", sub: "Strawberry" },
                { text: "企鵝死掉變什麼？", sub: "鵝（他沒氣ㄌ）" },
                { text: "圓形、長方形、正方形、三角形相約出去誰遲到最久？", sub: "三角形（全等三角形）" },
                { text: "狗會汪貓會喵雞呢？", sub: "雞會留給準備好的人" },
                { text: "哪個殺手只會講英文？", sub: "銀翼殺手" },
                { text: "有天貝殼回老家，跟他媽講什麼？", sub: "I'm back" },
                { text: "胡迪死了要唱什麼？", sub: "盛夏光年" },
                { text: "楊過最愛吃什麼？", sub: "小籠包" },
                { text: "達文西密碼上面是什麼？", sub: "達文西帳號" },
                { text: "為什麼非洲沒有藥局？", sub: "因為空腹不能吃藥" },
                { text: "誰殺了便當？", sub: "值日生（抬便當）" },
                { text: "張雨生家的木頭哪來的？", sub: "雨生鋸來的" },
                { text: "有一天幹部們一起出去玩", sub: "幹部揪" },
                { text: "為什麼邊緣人不剪頭髮？", sub: "因為沒人要理他" },
                { text: "船長負責開船，水手呢？", sub: "水手關燈" },
                { text: "什麼飲料最好玩？", sub: "喝剩的飲料" },
                { text: "媽媽跟小陳說不要指月亮，結果小東回什麼？", sub: "蛤（因為小陳耳朵被割掉變小東）" },
                { text: "在樹上饒舌", sub: "桑（又又又）" },
                { text: "最浪漫的鳥是？", sub: "候鳥，因為他會壁咚" },
                { text: "哪個牌子車最沒種？", sub: "你上（Nissan）" },
                { text: "這次考試很簡單，但小明怎麼還是覺得很硬？", sub: "隔壁小美裸考" },
                { text: "小鹿叫班比，大鹿呢？", sub: "尋奇（大陸尋奇）" },
                { text: "警察爆氣變什麼？", sub: "警報器" },
                { text: "胃最多能塞幾道菜？", sub: "九道，因為胃十道逆流" },
                { text: "翁山蘇姬他哥是誰？", sub: "蘇姬大哥啦（司機大哥）" },
                { text: "剪刀有什麼就能打贏石頭？", sub: "聯絡簿（聯絡布）" },
                { text: "鐵達尼號傑克應該跟螺絲說什麼？", sub: "全都怪我，不該沉沒時沉沒" },
                { text: "一個中子走進酒吧並說來一瓶海尼根多少錢？", sub: "酒保: For you? No charge. (免費/無電荷)" },
                { text: "農夫養的雞都不生蛋，物理學家計算後說：我想到辦法了！", sub: "不過這辦法只適用在真空中的球體母雞。" },
                { text: "海森堡開車被警察攔下來問「你知道你開多快嗎？」", sub: "海森堡：不知道，但我知道我在哪裡。（測不準原理）" },
                { text: "Why is Heisenberg in the joke above?", sub: "We're not certain." },
                { text: "一個物理學家看到有人要跳樓大叫說：Dont jump!", sub: "You have so much potential! (潛力/位能)" },
                { text: "什麼時候會不遵守虎克定律？", sub: "When spring break. (春假/彈簧斷掉)" },
                { text: "Jump off the roof,", sub: "that'll teach you about gravity!" },
                { text: "Don't be a a'(t). (變加速度 jerk)", sub: "別當個混蛋 (Don't be a jerk)" },
                { text: "床與螺線管有什麼共通點？", sub: "都符合冷次定律（想要離開時會產生反抗的力）" },
                { text: "籃球為什麼會往下掉？", sub: "因為有籃球場（Field/場）" },
                { text: "What did Donald Duck say in his quantum physics class?", sub: "Quark! Quark! Quark! (夸克)" },
                { text: "工程師、物理學家和數學家在愛爾蘭看到一隻黑羊。", sub: "工程師：愛爾蘭羊是黑的。物理學家：有些羊是黑的。數學家：至少有一隻羊的一側是黑的。" },
                { text: "光照射金屬打出光電子，那跳出的電子誰捕捉著？。", sub: "彩虹/紅橙黃綠藍靛紫" },
            ];

            const handleJoke = () => {
                setLoading(true);
                setTimeout(() => {
                    let random;
                    let attempts = 0;
                    do {
                        random = Math.floor(Math.random() * hardcodedJokes.length);
                        attempts++;
                    } while (history.includes(random) && attempts < 50);

                    setHistory(prev => {
                        const newHistory = [...prev, random];
                        if (newHistory.length > 10) newHistory.shift();
                        return newHistory;
                    });

                    setJokeData(hardcodedJokes[random]);
                    setLoading(false);
                }, 600);
            };

            return (
                <div className="text-center animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-white p-6 md:p-10 rounded-[35px] border-[5px] border-[#F2F4E6] shadow-[0_8px_0_#E0E4CC] relative overflow-hidden group">
                        <div className="absolute top-0 left-0 w-full h-2 bg-[#F2F4E6]/50"></div>

                        {jokeData ? (
                            <div className="space-y-4 animate-in zoom-in-95 duration-300">
                                <h3 className="text-xl md:text-2xl font-black text-[#797365] leading-relaxed">
                                    {jokeData.text}
                                </h3>
                                <div className="h-0.5 w-16 bg-[#E0E4CC] mx-auto rounded-full"></div>
                                <p className="text-base md:text-lg font-bold text-[#FF9A8B]">
                                    {jokeData.sub}
                                </p>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-6 md:py-10 opacity-40">
                                <Smile size={64} className="mb-4 text-[#9CA38F]" />
                                <p className="font-bold text-[#9CA38F]">點擊下方按鈕，來點冷氣...</p>
                            </div>
                        )}
                    </div>

                    <Button
                        onClick={handleJoke}
                        disabled={loading}
                        className="mt-6 md:mt-8 w-full md:w-auto px-12 py-4 text-lg rounded-full shadow-[0_6px_0_#6FB5A1] active:shadow-none active:translate-y-1.5"
                        variant="primary"
                    >
                        {loading ? "冷氣輸送中..." : (jokeData ? "再來一個！" : "講個笑話")}
                    </Button>
                </div>
            );
        };

        // --- 島民適性測驗 (MBTI) - V1.1 (修復計分版) ---
        const IslandMBTITool = () => {
            const [step, setStep] = useState('intro');
            const [currentQ, setCurrentQ] = useState(0);
            const [scores, setScores] = useState({ E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 });
            const [resultType, setResultType] = useState(null);

            const questions = [
                { q: "當你在島上看到一位新搬來的鄰居，你會...", options: [{ val: 'E', text: "馬上跑過去打招呼，送他見面禮！" }, { val: 'I', text: "先遠遠觀察，等時機成熟再說。" }] },
                { q: "經過一整天的抓蟲釣魚後，你覺得...", options: [{ val: 'E', text: "好想找朋友來島上開派對慶祝！" }, { val: 'I', text: "終於可以一個人靜靜地整理圖鑑了。" }] },
                { q: "在廣場聽到 K.K. 在唱歌，你會...", options: [{ val: 'E', text: "衝到第一排跟著節奏跳舞！" }, { val: 'I', text: "坐在後面的長椅上安靜欣賞。" }] },
                { q: "當你規劃島嶼建設時，你傾向...", options: [{ val: 'S', text: "參考現有的漂亮照片，一步步模仿。" }, { val: 'N', text: "腦中充滿天馬行空的想像，隨性發揮。" }] },
                { q: "狸克在說明貸款方案時，你...", options: [{ val: 'S', text: "仔細聽具體的金額和還款期限。" }, { val: 'N', text: "已經在幻想擴建後房子要怎麼佈置了。" }] },
                { q: "你在沙灘上撿到一個漂流瓶，你猜裡面是...", options: [{ val: 'S', text: "一定是重複的 DIY 方程式。" }, { val: 'N', text: "說不定是來自未來的神祕訊息！" }] },
                { q: "鄰居送了你一件很醜的衣服，你會...", options: [{ val: 'T', text: "雖然收下，但誠實告訴他這不是我的風格。" }, { val: 'F', text: "開心地收下並馬上穿給他看，不想讓他難過。" }] },
                { q: "如果不小心把島上的稀有花踩爛了，你會...", options: [{ val: 'T', text: "冷靜思考如何重新配種長回來。" }, { val: 'F', text: "感到非常自責，甚至想哭出來。" }] },
                { q: "在決定要趕走哪位島民時，你的考量是...", options: [{ val: 'T', text: "他的房子外觀跟我的島嶼風格不搭。" }, { val: 'F', text: "雖然他不搭，但我捨不得這段感情..." }] },
                { q: "對於每天的大頭菜價格，你...", options: [{ val: 'J', text: "每天早晚準時紀錄，分析波型。" }, { val: 'P', text: "想起來才去看一下，隨緣買賣。" }] },
                { q: "明天有朋友要來島上玩，你會...", options: [{ val: 'J', text: "提前把雜草拔光，規劃好參觀路線。" }, { val: 'P', text: "沒關係啦，保持自然的樣子就好。" }] },
                { q: "你的包包通常...", options: [{ val: 'J', text: "工具、素材分類整齊，隨時保持空格。" }, { val: 'P', text: "塞滿了各種雜物，要用時才發現滿了。" }] },
            ];

            const personalities = {
                "ISTJ": { role: "博物館館長", icon: "🦉", desc: "你是一絲不苟的知識守護者。如同貓頭鷹館長，你重視傳統、細節與秩序。島上的每一塊化石、每一隻昆蟲都逃不過你的紀錄。", tags: ["可靠", "安靜", "有條理"] },
                "ISFJ": { role: "咖啡店老闆", icon: "☕", desc: "你是溫暖而低調的守護者。像在博物館地下安靜沖泡咖啡的老闆，你總是默默關心著大家，提供最貼心的服務。", tags: ["體貼", "忠誠", "耐心"] },
                "INFJ": { role: "觀星的妹妹", icon: "✨", desc: "你是神秘的夢想家。如同仰望星空的貓頭鷹妹妹，你擁有獨特的直覺與洞察力，總是能看見他人看不見的深層意義。", tags: ["深邃", "理想", "神祕"] },
                "INTJ": { role: "孤高的造景師", icon: "📐", desc: "你是追求完美的策劃者。你的島嶼規劃充滿了邏輯與美學的精算，雖然不常與人社交，但你的作品總讓人驚嘆。", tags: ["獨立", "遠見", "完美"] },
                "ISTP": { role: "昆蟲藝術家", icon: "🦎", desc: "你是冷靜的觀察者與創作者。像那位熱愛昆蟲的藝術家，你話不多，但對於自己熱愛的事物有著極高的專注與技術。", tags: ["務實", "隨性", "技術"] },
                "ISFP": { role: "釣魚大師", icon: "🎣", desc: "你是隨和的冒險家。如同在河邊等待大魚的釣客，你享受當下的感官體驗，不喜歡被規則束縛，追求自由自在的生活。", tags: ["溫柔", "藝術", "自由"] },
                "INFP": { role: "幽靈補蟲網", icon: "👻", desc: "你是敏感的治癒者。就像半夜出現的膽小幽靈，你內心柔軟豐富，雖然容易受驚嚇（受傷），但總是懷抱著善意。", tags: ["浪漫", "同理", "創意"] },
                "INTP": { role: "飛機駕駛員", icon: "✈️", desc: "你是充滿好奇的探索者。你的腦袋裡裝滿了各種奇奇怪怪的知識，喜歡探索未知的無人島，尋求新的邏輯與可能性。", tags: ["分析", "好奇", "客觀"] },
                "ESTP": { role: "買賣大頭菜的山豬", icon: "🐗", desc: "你是大膽的行動派。如同週日來賣大頭菜的商人，你充滿活力，敢於冒險下注，總是在尋找下一個有趣的機會。", tags: ["活力", "直率", "冒險"] },
                "ESFP": { role: "偶像歌手", icon: "🎤", desc: "你是天生的表演者。就像廣場上的狗狗偶像，只要有你在的地方就有歡笑與音樂，你是島上的氣氛製造機。", tags: ["熱情", "友善", "焦點"] },
                "ENFP": { role: "島民代表助理", icon: "🔔", desc: "你是熱情的激勵者。如同在服務處廣播的小狗助理，你充滿了創意與感染力，真心希望島上的每個人都過得開心。", tags: ["熱忱", "想像", "社交"] },
                "ENTP": { role: "狡猾的狐狸商人", icon: "🦊", desc: "你是機智的辯論家。就像那艘神祕小船上的狐狸，你聰明、反應快，喜歡挑戰常規，有時候會耍點無傷大雅的小聰明。", tags: ["機智", "挑戰", "創新"] },
                "ESTJ": { role: "移居計畫總裁", icon: "💰", desc: "你是天生的領導者。如同穿著夏威夷衫的狸貓總裁，你講求效率、組織與成果，能將荒島變成繁華的都市。", tags: ["果斷", "效率", "領導"] },
                "ESFJ": { role: "服裝店刺蝟姊姊", icon: "🦔", desc: "你是熱心的供給者。就像在裁縫店忙進忙出的姊姊，你非常重視人際和諧，總是樂於助人，照顧大家的日常需求。", tags: ["合作", "友善", "盡責"] },
                "ENFJ": { role: "節日活動主持人", icon: "🦚", desc: "你是充滿魅力的引導者。就像嘉年華時熱舞的孔雀，你擅長凝聚人心，帶領大家一起為了共同的目標（或舞步）努力。", tags: ["魅力", "同理", "領導"] },
                "ENTJ": { role: "機場櫃檯專員", icon: "🛫", desc: "你是果斷的指揮官。如同守在登機口的度度鳥，你嚴格執行規則，掌控全場，確保所有計畫都按照你的預期順利起飛。", tags: ["戰略", "自信", "決斷"] }
            };

            const handleAnswer = (val) => {
                const newScores = { ...scores, [val]: scores[val] + 1 };
                setScores(newScores);
                if (currentQ < questions.length - 1) {
                    setCurrentQ(prev => prev + 1);
                } else {
                    calculateResult(newScores);
                }
            };

            const calculateResult = (finalScores) => {
                setStep('calculating');
                setTimeout(() => {
                    const type =
                        (finalScores.E > finalScores.I ? 'E' : 'I') +
                        (finalScores.S > finalScores.N ? 'S' : 'N') +
                        (finalScores.T > finalScores.F ? 'T' : 'F') +
                        (finalScores.J > finalScores.P ? 'J' : 'P');
                    setResultType(type);
                    setStep('result');
                }, 1500);
            };

            const restart = () => {
                setScores({ E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 });
                setCurrentQ(0);
                setStep('intro');
                setResultType(null);
            };

            return (
                <div className="w-full max-w-2xl mx-auto h-[550px] relative bg-[#F9F5E3] rounded-[30px] border-[8px] border-white shadow-xl overflow-hidden flex flex-col">
                    <div className="absolute top-0 left-0 w-full h-4 bg-[#88C9A1] opacity-50"></div>

                    {step === 'intro' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-500">
                            <div className="w-24 h-24 bg-[#E0E4CC] rounded-full flex items-center justify-center text-5xl mb-6 shadow-inner">🌴</div>
                            <h2 className="text-3xl font-black text-[#574E44] mb-4 tracking-wider">登島適性測驗</h2>
                            <p className="text-[#797365] font-bold mb-8 leading-relaxed max-w-md">歡迎來到無人島移居計畫櫃台！<br />在為您安排帳篷位置之前，<br />我們想了解一下您的生活風格...</p>
                            <button onClick={() => setStep('quiz')} className="bg-[#88C9A1] text-white text-xl font-bold py-3 px-10 rounded-full hover:bg-[#76B08B] hover:scale-105 transition-all shadow-[0_4px_0_#558B6E] active:shadow-none active:translate-y-[4px]">開始測驗</button>
                        </div>
                    )}

                    {step === 'quiz' && (
                        <div className="flex-1 flex flex-col p-6 md:p-10 animate-in slide-in-from-right duration-300">
                            <div className="flex justify-between items-center mb-6">
                                <span className="bg-[#E0E4CC] text-[#797365] px-3 py-1 rounded-full text-sm font-bold">Question {currentQ + 1} / {questions.length}</span>
                                <div className="text-[#88C9A1] text-2xl">✈️</div>
                            </div>
                            <div className="flex-1 flex items-center justify-center mb-8">
                                <h3 className="text-xl md:text-2xl font-bold text-[#574E44] text-center leading-relaxed">{questions[currentQ].q}</h3>
                            </div>
                            <div className="grid grid-cols-1 gap-4">
                                {questions[currentQ].options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(opt.val)} className="bg-white border-2 border-[#E0E4CC] text-[#797365] font-bold py-4 px-6 rounded-2xl hover:bg-[#F2F4E6] hover:border-[#88C9A1] hover:text-[#574E44] transition-all text-left shadow-sm active:scale-[0.98]">{opt.text}</button>
                                ))}
                            </div>
                        </div>
                    )}

                    {step === 'calculating' && (
                        <div className="flex-1 flex flex-col items-center justify-center animate-in fade-in">
                            <div className="animate-spin text-5xl mb-4">🦝</div>
                            <p className="text-[#797365] font-bold text-lg animate-pulse">正在分析您的移居資料...</p>
                        </div>
                    )}

                    {step === 'result' && resultType && (
                        <div className="flex-1 overflow-y-auto p-6 md:p-8 animate-in zoom-in-95 duration-500 bg-[#EFEBE9]">
                            <div className="bg-white rounded-[24px] p-6 shadow-lg border-4 border-[#E0E4CC] h-full flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-[#9CA38F] tracking-[0.2em] mb-2">ISLAND RESIDENT ID</div>
                                <div className="w-24 h-24 bg-[#F9F5E3] rounded-full flex items-center justify-center text-5xl mb-4 border-4 border-white shadow-sm">{personalities[resultType].icon}</div>
                                <h2 className="text-3xl font-black text-[#574E44] mb-1">{personalities[resultType].role}</h2>
                                <div className="text-[#88C9A1] font-bold text-lg mb-4 font-mono tracking-widest">{resultType}</div>
                                <div className="flex gap-2 mb-6">{personalities[resultType].tags.map(tag => (<span key={tag} className="px-3 py-1 bg-[#F2F4E6] text-[#797365] text-xs font-bold rounded-full">#{tag}</span>))}</div>
                                <p className="text-[#797365] font-bold text-sm md:text-base leading-relaxed mb-6 bg-[#F9F5E3] p-4 rounded-xl w-full">{personalities[resultType].desc}</p>
                                <div className="mt-auto pt-4 border-t-2 border-dashed border-[#E0E4CC] w-full flex justify-center gap-4">
                                    <button onClick={restart} className="text-[#9CA38F] font-bold text-sm hover:text-[#88C9A1] transition-colors flex items-center gap-1"><span>↺</span> 再測一次</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 星座運勢 (HoroscopeTool) ---
        /**
         * @function HoroscopeTool
        /**
         * @function HoroscopeTool
         * @description 島民每日星座運勢。
         * 基於「日期 + 星座」產生固定的每日運勢 (Daily Fortune)。
         * 包含幸運色、幸運物與傅達妹妹風格的建言。
         */
        const HoroscopeTool = () => {
            const [sign, setSign] = useState("aries");
            const [result, setResult] = useState(null);

            const signs = [
                { id: "aries", label: "牡羊座" },
                { id: "taurus", label: "金牛座" },
                { id: "gemini", label: "雙子座" },
                { id: "cancer", label: "巨蟹座" },
                { id: "leo", label: "獅子座" },
                { id: "virgo", label: "處女座" },
                { id: "libra", label: "天秤座" },
                { id: "scorpio", label: "天蠍座" },
                { id: "sagittarius", label: "射手座" },
                { id: "capricorn", label: "摩羯座" },
                { id: "aquarius", label: "水瓶座" },
                { id: "pisces", label: "雙魚座" }
            ];

            const luckyItems = ["金礦石", "大頭菜", "旅行券", "星星碎片", "鈴錢袋", "化石", "KK唱片", "特產水果", "家具樹葉", "漂流瓶", "梯子", "撐庫跳桿"];
            const luckyColors = ["紅色", "天藍色", "金色", "草綠色", "紫色", "亮橘色", "粉色", "米白色", "曜石黑", "檸檬黃"];
            const templates = [
                "今天的財運亨通,敲石頭記得要連續敲滿8下喔!",
                "人際運勢上升,去和島民們送禮物吧,可能會收到回禮。",
                "工作效率極高,非常適合進行大規模的島嶼改造工程。",
                "去海邊散散步吧,撿到的{item}可能會帶來好運。",
                "穿上{color}的衣服去找刺蝟姊妹,也許會有特別的對話。",
                "隨身帶著{item},它是你今天的幸運護身符。",
                "小心搖樹!雖然可能會掉下{item},但也可能有黃蜂。",
                "今天的大頭菜價格走勢成謎,建議多問問豆狸。",
                "適合出島旅行,穿著{color}的鞋子說不定會遇到稀有島民。",
                "晚上的夜空很清澈,看見流星記得放下手中的{item}許願。"
            ];

            const getDailyFortune = (signId) => {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
                const seedString = dateStr + signId;

                let hash = 0;
                for (let i = 0; i < seedString.length; i++) {
                    const char = seedString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const seed = Math.abs(hash);

                const itemIndex = seed % luckyItems.length;
                const colorIndex = (seed >> 1) % luckyColors.length;
                const templateIndex = (seed >> 2) % templates.length;
                const stars = (seed % 5) + 1;

                let message = templates[templateIndex];
                message = message.replace("{item}", luckyItems[itemIndex]);
                message = message.replace("{color}", luckyColors[colorIndex]);

                return {
                    stars: stars,
                    item: luckyItems[itemIndex],
                    color: luckyColors[colorIndex],
                    message: message
                };
            };

            const handlePredict = () => {
                const fortune = getDailyFortune(sign);
                setResult(fortune);
            };

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-[#F8F9F0] p-4 md:p-6 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-white">
                        <label className="text-sm md:text-base font-bold text-[#797365] mb-2 block">
                            選擇星座
                        </label>
                        <select
                            value={sign}
                            onChange={(e) => setSign(e.target.value)}
                            className="w-full p-3 md:p-4 rounded-xl md:rounded-2xl border-none text-[#797365] font-bold bg-white focus:ring-4 focus:ring-[#88C9A1]/30 appearance-none"
                        >
                            {signs.map(s => (
                                <option key={s.id} value={s.id}>
                                    {s.label}
                                </option>
                            ))}
                        </select>
                    </div>

                    <Button
                        onClick={handlePredict}
                        variant="primary"
                        className="w-full text-base md:text-lg"
                        icon={Sun}
                    >
                        占卜今日運勢
                    </Button>

                    {result && (
                        <div className="bg-[#E0F7FA] p-6 md:p-8 rounded-[24px] md:rounded-[30px] border-[3px] md:border-[4px] border-[#4DD0E1] text-center relative overflow-hidden animate-pulse">
                            <div className="absolute top-0 left-0 w-full h-3 bg-[#4DD0E1]/30"></div>
                            <p className="text-xs md:text-sm font-bold text-[#0097A7] mb-2 uppercase tracking-wider">
                                Katrina's Prediction
                            </p>
                            <div className="flex justify-center gap-1 mb-4">
                                {[...Array(5)].map((_, i) => (
                                    <span
                                        key={i}
                                        className={`text-2xl ${i < result.stars ? 'text-[#FFD700]' : 'text-gray-300'}`}
                                    >
                                        ★
                                    </span>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4 text-sm font-bold text-[#00838F]">
                                <div className="bg-white/50 p-2 rounded-xl">
                                    <span className="block text-[10px] opacity-70 uppercase">Lucky Item</span>
                                    {result.item}
                                </div>
                                <div className="bg-white/50 p-2 rounded-xl">
                                    <span className="block text-[10px] opacity-70 uppercase">Lucky Color</span>
                                    {result.color}
                                </div>
                            </div>
                            <p className="text-lg md:text-xl font-extrabold text-[#006064] tracking-wide leading-relaxed">
                                {result.message}
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // --- 狸端機 2048 (Game2048Tool) ---
        // 定義獎盃圖示 (Trophy)，若全域未定義則使用此處定義
        const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.45.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></Icon>;

        /**
         * @function Game2048Tool
         * @description 狸端機風格的 2048 益智遊戲。
         * 玩家透過方向鍵控制數字方塊合併，目標是合成 2048 (Nook Inc. 標誌)。
         * 支援鍵盤操作與觸控滑動 (尚未實作觸控，目前僅鍵盤)。
         * 包含分數統計與最高分紀錄 (LocalStorage)。
         */
        const Game2048Tool = () => {
            const containerRef = useRef(null);
            const tileContainerRef = useRef(null);
            const scoreRef = useRef(null);
            const bestScoreRef = useRef(null);
            const gameOverOverlayRef = useRef(null);
            const houseNameRef = useRef(null);
            const houseNextRef = useRef(null);
            const houseProgressRef = useRef(null);
            const houseDisplayRef = useRef(null);

            // Using refs for game state to avoid re-render loops with DOM manipulation
            const gameState = useRef({
                board: [],
                score: 0,
                bestScore: localStorage.getItem('nook2048_best') || 0,
                won: false,
                currentHouseLevel: -1
            });

            const SIZE = 4;

            const HOUSE_LEVELS = [
                { score: 0, name: '流浪帳篷', emoji: '⛺', img: 'https://dodo.ac/np/images/thumb/5/52/Tent_(white)_NH_Icon.png/150px-Tent_(white)_NH_Icon.png' },
                { score: 500, name: '簡樸平房', emoji: '🏠', img: 'https://dodo.ac/np/images/thumb/e/e6/House_Icon_NH.png/150px-House_Icon_NH.png' },
                { score: 1500, name: '擴建木屋', emoji: '🏡', img: 'https://dodo.ac/np/images/thumb/5/57/Tom_Nook_NH.png/150px-Tom_Nook_NH.png' },
                { score: 3000, name: '便利商店', emoji: '🏪', img: 'https://dodo.ac/np/images/thumb/6/66/Nook%27s_Cranny_NH_Icon.png/150px-Nook%27s_Cranny_NH_Icon.png' },
                { score: 5000, name: '服飾旗艦', emoji: '👗', img: 'https://dodo.ac/np/images/thumb/b/b8/Able_Sisters_NH_Icon.png/150px-Able_Sisters_NH_Icon.png' },
                { score: 10000, name: '國立博物館', emoji: '🏛️', img: 'https://dodo.ac/np/images/thumb/5/5e/Museum_NH_Icon.png/150px-Museum_NH_Icon.png' },
                { score: 20000, name: '市政廳大樓', emoji: '🏫', img: 'https://dodo.ac/np/images/thumb/4/4c/Resident_Services_NH_Icon.png/150px-Resident_Services_NH_Icon.png' },
                { score: 50000, name: '狸克摩天樓', emoji: '🏙️', img: 'https://dodo.ac/np/images/thumb/2/23/Nook_Miles_Ticket_NH_Icon.png/150px-Nook_Miles_Ticket_NH_Icon.png' }
            ];

            const ITEM_MAP = {
                2: { emoji: '🪵', name: '樹枝', img: 'https://dodo.ac/np/images/thumb/7/73/Tree_Branch_NH_Icon.png/150px-Tree_Branch_NH_Icon.png' },
                4: { emoji: '🪨', name: '石頭', img: 'https://dodo.ac/np/images/thumb/d/d4/Stone_NH_Icon.png/150px-Stone_NH_Icon.png' },
                8: { emoji: '⛏️', name: '鐵礦', img: 'https://dodo.ac/np/images/thumb/8/8b/Iron_Nugget_NH_Icon.png/150px-Iron_Nugget_NH_Icon.png' },
                16: { emoji: '🟡', name: '金礦', img: 'https://dodo.ac/np/images/thumb/a/af/Gold_Nugget_NH_Icon.png/150px-Gold_Nugget_NH_Icon.png' },
                32: { emoji: '🌿', name: '家具', img: 'https://dodo.ac/np/images/e/e6/Leaf_NH_Icon.png' },
                64: { emoji: '🦴', name: '化石', img: 'https://dodo.ac/np/images/9/91/Fossil_NH_Icon.png' },
                128: { emoji: '💰', name: '零錢', img: 'https://dodo.ac/np/images/7/7c/Bell_Bag_NH_Icon.png' },
                256: { emoji: '✈️', name: '機票', img: 'https://dodo.ac/np/images/2/23/Nook_Miles_Ticket_NH_Icon.png' },
                512: { emoji: '⛺', name: '帳篷', img: 'https://dodo.ac/np/images/thumb/5/52/Tent_(white)_NH_Icon.png/150px-Tent_(white)_NH_Icon.png' },
                1024: { emoji: '🦝', name: '狸克', img: 'https://dodo.ac/np/images/thumb/5/57/Tom_Nook_NH.png/150px-Tom_Nook_NH.png' },
                2048: { emoji: '🏝️', name: '島嶼', img: 'https://dodo.ac/np/images/thumb/e/ef/Map_NH_Icon.png/150px-Map_NH_Icon.png' },
                4096: { emoji: '👑', name: '傳說', img: '' }
            };

            const getTilePosition = (r, c) => {
                if (!containerRef.current) return { x: 0, y: 0, size: 0 };
                const totalW = containerRef.current.clientWidth;
                const padding = 10;
                const gap = 10;
                const cellSize = (totalW - (padding * 2) - (gap * (SIZE - 1))) / SIZE;
                const x = padding + c * (cellSize + gap);
                const y = padding + r * (cellSize + gap);
                return { x, y, size: cellSize };
            };

            const createTileElement = (r, c, value, isNew = false, isMerged = false) => {
                const tile = document.createElement('div');
                const pos = getTilePosition(r, c);
                const item = ITEM_MAP[value] || { emoji: '❓', name: value, img: '' };

                tile.classList.add('game-2048-tile');
                tile.classList.add(`tile-${value <= 2048 ? value : 'super'}`);
                if (isNew) tile.classList.add('game-2048-tile-new');
                if (isMerged) tile.classList.add('game-2048-tile-merged');

                tile.style.width = `${pos.size}px`;
                tile.style.height = `${pos.size}px`;
                tile.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
                tile.style.left = '0px'; tile.style.top = '0px';

                const imgHtml = item.img ?
                    `<img src="${item.img}" onerror="this.parentElement.innerHTML='<span>${item.emoji}</span>'" draggable="false" style="width: 80%; height: 80%; object-fit: contain;">` :
                    `<span style="font-size: 32px;">${item.emoji}</span>`;

                tile.innerHTML = `<div class="tile-icon" style="width: 100%; height: 80%; display: flex; justify-content: center; align-items: center;">${imgHtml}</div><div class="tile-text" style="font-size: 10px; font-weight: 900; margin-top: -5px; color: #584C3F;">${item.name}</div>`;
                return tile;
            };

            const renderBoard = () => {
                if (!tileContainerRef.current) return;
                tileContainerRef.current.innerHTML = '';
                const { board } = gameState.current;
                for (let r = 0; r < SIZE; r++) {
                    for (let c = 0; c < SIZE; c++) {
                        if (board[r][c] !== 0) {
                            tileContainerRef.current.appendChild(createTileElement(r, c, board[r][c]));
                        }
                    }
                }
            };

            const updateHouse = (currentScore) => {
                let levelIndex = HOUSE_LEVELS.length - 1;
                for (let i = 0; i < HOUSE_LEVELS.length; i++) {
                    if (currentScore < HOUSE_LEVELS[i].score) {
                        levelIndex = i - 1;
                        break;
                    }
                }
                if (levelIndex < 0) levelIndex = 0;

                const levelData = HOUSE_LEVELS[levelIndex];
                const nextLevelData = HOUSE_LEVELS[levelIndex + 1];

                if (levelIndex !== gameState.current.currentHouseLevel) {
                    gameState.current.currentHouseLevel = levelIndex;
                    if (houseNameRef.current) houseNameRef.current.innerText = levelData.name;

                    if (houseDisplayRef.current) {
                        const imgHtml = levelData.img ?
                            `<img src="${levelData.img}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" style="width:100%; height:100%; object-fit:contain;">
                            <div class="house-display-box" style="display:none; width:100%; height:100%; align-items:center; justify-content:center;"><span class="house-emoji-large">${levelData.emoji}</span></div>`
                            :
                            `<div class="house-display-box" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"><span class="house-emoji-large">${levelData.emoji}</span></div>`;

                        houseDisplayRef.current.innerHTML = imgHtml;
                        houseDisplayRef.current.classList.remove('level-up-anim');
                        void houseDisplayRef.current.offsetWidth;
                        houseDisplayRef.current.classList.add('level-up-anim');
                    }
                }

                if (houseProgressRef.current && houseNextRef.current) {
                    if (nextLevelData) {
                        const range = nextLevelData.score - levelData.score;
                        const progress = currentScore - levelData.score;
                        const percent = Math.min(100, Math.max(0, (progress / range) * 100));

                        houseProgressRef.current.style.width = `${percent}%`;
                        houseNextRef.current.innerText = `距離升級還需 ${nextLevelData.score - currentScore} 分`;
                    } else {
                        houseProgressRef.current.style.width = '100%';
                        houseNextRef.current.innerText = '已達到最高等級！';
                    }
                }
            };

            const updateScore = (add) => {
                gameState.current.score += add;
                if (scoreRef.current) scoreRef.current.innerText = gameState.current.score;

                if (gameState.current.score > gameState.current.bestScore) {
                    gameState.current.bestScore = gameState.current.score;
                    if (bestScoreRef.current) bestScoreRef.current.innerText = gameState.current.bestScore;
                    localStorage.setItem('nook2048_best', gameState.current.bestScore);
                }
                updateHouse(gameState.current.score);
            };

            const addRandomTile = () => {
                let available = [];
                for (let r = 0; r < SIZE; r++) {
                    for (let c = 0; c < SIZE; c++) {
                        if (gameState.current.board[r][c] === 0) available.push({ r, c });
                    }
                }
                if (available.length > 0) {
                    let spot = available[Math.floor(Math.random() * available.length)];
                    gameState.current.board[spot.r][spot.c] = Math.random() < 0.9 ? 2 : 4;
                }
            };

            const checkGameOver = () => {
                const { board } = gameState.current;
                for (let r = 0; r < SIZE; r++) for (let c = 0; c < SIZE; c++) if (board[r][c] === 0) return;
                for (let r = 0; r < SIZE; r++) {
                    for (let c = 0; c < SIZE; c++) {
                        let val = board[r][c];
                        if (c < SIZE - 1 && board[r][c + 1] === val) return;
                        if (r < SIZE - 1 && board[r + 1][c] === val) return;
                    }
                }
                if (gameOverOverlayRef.current) gameOverOverlayRef.current.style.display = 'flex';
            };

            const rotateLeft = (matrix) => {
                let result = Array(SIZE).fill().map(() => Array(SIZE).fill(0));
                for (let r = 0; r < SIZE; r++) {
                    for (let c = 0; c < SIZE; c++) {
                        result[SIZE - 1 - c][r] = matrix[r][c];
                    }
                }
                return result;
            };

            const move = (direction) => {
                if (gameOverOverlayRef.current && gameOverOverlayRef.current.style.display === 'flex') return;

                let board = gameState.current.board;
                let tempBoard = JSON.parse(JSON.stringify(board));
                let originalBoardStr = JSON.stringify(board);

                if (direction === 1) tempBoard = rotateLeft(tempBoard);
                if (direction === 2) tempBoard = rotateLeft(rotateLeft(tempBoard));
                if (direction === 3) tempBoard = rotateLeft(rotateLeft(rotateLeft(tempBoard)));

                let scoreAdd = 0;
                for (let i = 0; i < SIZE; i++) {
                    let row = tempBoard[i];
                    let newRow = row.filter(val => val !== 0);
                    for (let j = 0; j < newRow.length - 1; j++) {
                        if (newRow[j] === newRow[j + 1]) {
                            newRow[j] *= 2;
                            scoreAdd += newRow[j];
                            newRow[j + 1] = 0;
                            if (newRow[j] === 2048 && !gameState.current.won) {
                                gameState.current.won = true;
                                alert("恭喜！你已經開發出了無人島！(可以繼續遊玩)");
                            }
                        }
                    }
                    newRow = newRow.filter(val => val !== 0);
                    while (newRow.length < SIZE) newRow.push(0);
                    tempBoard[i] = newRow;
                }

                if (direction === 1) tempBoard = rotateLeft(rotateLeft(rotateLeft(tempBoard)));
                if (direction === 2) tempBoard = rotateLeft(rotateLeft(tempBoard));
                if (direction === 3) tempBoard = rotateLeft(tempBoard);

                gameState.current.board = tempBoard;

                if (JSON.stringify(gameState.current.board) !== originalBoardStr) {
                    updateScore(scoreAdd);
                    addRandomTile();
                    renderBoard();
                    checkGameOver();
                }
            };

            const restartGame = () => {
                gameState.current.board = Array(SIZE).fill().map(() => Array(SIZE).fill(0));
                gameState.current.score = 0;
                gameState.current.won = false;
                gameState.current.currentHouseLevel = -1;

                if (scoreRef.current) scoreRef.current.innerText = 0;
                if (gameOverOverlayRef.current) gameOverOverlayRef.current.style.display = 'none';

                updateScore(0);
                addRandomTile();
                addRandomTile();
                renderBoard();
            };

            useEffect(() => {
                if (bestScoreRef.current) bestScoreRef.current.innerText = gameState.current.bestScore;
                restartGame();

                const handleKeyDown = (e) => {
                    if ([37, 38, 39, 40].includes(e.keyCode)) e.preventDefault();
                    switch (e.keyCode) {
                        case 37: move(0); break; // Left
                        case 38: move(1); break; // Up
                        case 39: move(2); break; // Right
                        case 40: move(3); break; // Down
                    }
                };

                // Touch handling
                let touchStartX = 0;
                let touchStartY = 0;
                const handleTouchStart = (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                };
                const handleTouchEnd = (e) => {
                    if (!touchStartX || !touchStartY) return;
                    let touchEndX = e.changedTouches[0].clientX;
                    let touchEndY = e.changedTouches[0].clientY;
                    let dx = touchEndX - touchStartX;
                    let dy = touchEndY - touchStartY;
                    if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) {
                        if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 2 : 0);
                        else move(dy > 0 ? 3 : 1);
                    }
                };

                document.addEventListener('keydown', handleKeyDown);
                // Attach touch listeners to the container if available, else window
                const target = containerRef.current || window;
                target.addEventListener('touchstart', handleTouchStart, { passive: false });
                target.addEventListener('touchend', handleTouchEnd, { passive: false });

                const handleResize = () => renderBoard();
                window.addEventListener('resize', handleResize);

                return () => {
                    document.removeEventListener('keydown', handleKeyDown);
                    target.removeEventListener('touchstart', handleTouchStart);
                    target.removeEventListener('touchend', handleTouchEnd);
                    window.removeEventListener('resize', handleResize);
                };
            }, []);

            return (
                <div className="flex flex-col items-center w-full">
                    <div className="w-full max-w-[340px] flex justify-between items-center mb-5">
                        <div>
                            <h1 className="text-3xl font-black text-[#584C3F] drop-shadow-sm m-0">Nook 2048</h1>
                            <p className="text-xs text-gray-400 font-bold m-0">無人島開發計畫</p>
                        </div>
                        <div className="flex gap-2">
                            <div className="bg-white px-3 py-1 rounded-xl text-center min-w-[60px] shadow-[0_4px_0_#E0DBC5] border-2 border-[#584C3F]">
                                <div className="text-[9px] text-gray-400 font-bold uppercase">SCORE</div>
                                <div className="text-base font-black text-[#584C3F]" ref={scoreRef}>0</div>
                            </div>
                            <div className="bg-white px-3 py-1 rounded-xl text-center min-w-[60px] shadow-[0_4px_0_#E0DBC5] border-2 border-[#584C3F]">
                                <div className="text-[9px] text-gray-400 font-bold uppercase">BEST</div>
                                <div className="text-base font-black text-[#584C3F]" ref={bestScoreRef}>0</div>
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-wrap justify-center gap-5 w-full">
                        {/* Game Board */}
                        <div className="flex flex-col items-center">
                            <div className="game-2048-container" ref={containerRef}>
                                <div className="game-2048-grid">
                                    {[...Array(16)].map((_, i) => <div key={i} className="game-2048-cell"></div>)}
                                </div>
                                <div className="tile-container" ref={tileContainerRef}></div>
                                <div className="game-over-overlay" ref={gameOverOverlayRef} style={{ display: 'none' }}>
                                    <h2 className="text-2xl text-[#584C3F] font-bold mb-2">Game Over!</h2>
                                    <p className="text-sm text-gray-500 mb-4 text-center font-bold">島嶼開發資金不足...</p>
                                    <button className="btn btn-restart bg-[#FF8A80] text-white px-6 py-2 rounded-full font-bold shadow-[0_4px_0_#D16B63] active:shadow-none active:translate-y-1 transition-all" onClick={restartGame}>重新貸款</button>
                                </div>
                            </div>
                            <div className="mt-5 flex gap-5">
                                <button className="btn btn-restart bg-[#8DD6BF] text-white px-6 py-2 rounded-full font-bold shadow-[0_4px_0_#6FB5A1] active:shadow-none active:translate-y-1 transition-all" onClick={restartGame}>重新開始</button>
                            </div>
                            <div className="mt-4 text-xs text-gray-400 text-center font-bold">
                                使用方向鍵或滑動螢幕來合併物品<br />目標：建設繁榮的都會區
                            </div>
                        </div>

                        {/* House Panel */}
                        <div className="house-panel">
                            <div className="house-title">資產評估中心</div>
                            <div className="house-display" ref={houseDisplayRef}>
                                <span className="house-emoji-large">⛺</span>
                            </div>
                            <div className="house-level-name" ref={houseNameRef}>流浪帳篷</div>

                            <div className="progress-container">
                                <div className="progress-bar" ref={houseProgressRef}></div>
                            </div>
                            <div className="house-next-info" ref={houseNextRef}>下個等級：500 分</div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * 物理實驗沙盒 (Physics Sandbox) V1.2
         * 使用 Matter.js 物理引擎模擬拋體運動
         * 可調整初速度、仰角、高度、重力、摩擦力等參數
         * 即時顯示運動軌跡與能量轉換數據
         */
        const PhysicsSandboxTool = () => {
            const sceneRef = React.useRef(null);
            const engineRef = React.useRef(null);
            const renderRef = React.useRef(null);
            const runnerRef = React.useRef(null);
            const statsRef = React.useRef(null);

            // --- 實驗參數設定 (Initial Conditions) ---
            const [params, setParams] = React.useState({
                v0: 20,     // 初速度 (m/s)
                angle: 45,  // 仰角 (degree)
                height: 2,  // 初始高度 (m)
                gravity: 1, // 重力倍率 (1 = 地球重力)
                friction: 0 // 摩擦係數 (0 = 理想光滑)
            });

            // --- 物理常數定義 (First Principles) ---
            const SCALE = 50; // 比例尺定義：50 pixels = 1 meter
            const FPS = 60;   // 模擬幀率

            // 初始化物理引擎
            React.useEffect(() => {
                if (!sceneRef.current) return;

                // 引入 Matter.js 模組
                const Engine = Matter.Engine,
                    Render = Matter.Render,
                    Runner = Matter.Runner,
                    World = Matter.World,
                    Bodies = Matter.Bodies,
                    Events = Matter.Events,
                    Composite = Matter.Composite;

                // 1. 建立引擎與世界
                const engine = Engine.create();
                engineRef.current = engine;
                engine.world.gravity.y = params.gravity; // 設定重力

                const width = sceneRef.current.clientWidth;
                const height = sceneRef.current.clientHeight;

                // 2. 建立渲染器 (Renderer)
                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width,
                        height,
                        background: 'transparent', // 透明背景以顯示網格
                        wireframes: false,
                        pixelRatio: window.devicePixelRatio || 1
                    }
                });
                renderRef.current = render;

                // 3. 建立邊界 (Boundary Conditions)
                const groundY = height - 20;
                const ground = Bodies.rectangle(width / 2, groundY + 30, width, 60, {
                    isStatic: true,
                    label: 'Ground',
                    render: { fillStyle: '#795548' },
                    friction: params.friction
                });
                const leftWall = Bodies.rectangle(-30, height / 2, 60, height, { isStatic: true });
                const rightWall = Bodies.rectangle(width + 30, height / 2, 60, height, { isStatic: true });

                World.add(engine.world, [ground, leftWall, rightWall]);

                // 4. 數據監測迴圈 (Data Loop) - 每一幀計算物理量
                let timeStart = 0;

                Events.on(engine, 'afterUpdate', () => {
                    if (!statsRef.current) return;

                    const projectile = engine.world.bodies.find(b => b.label === 'Projectile');

                    if (projectile) {
                        // 時間 t
                        const now = engine.timing.timestamp;
                        if (timeStart === 0) timeStart = now;
                        const t = ((now - timeStart) / 1000).toFixed(2);

                        // 位移 (Coordinate Transformation)
                        // 原點設為左下角 (x=50, y=地面)
                        const posX = (projectile.position.x - 50) / SCALE;
                        const posY = (groundY - projectile.position.y - projectile.circleRadius) / SCALE;

                        // 速度 (Kinematics)
                        // Matter.js 速度單位為 px/tick，需轉換為 m/s
                        const vx = projectile.velocity.x * FPS / SCALE;
                        const vy = -projectile.velocity.y * FPS / SCALE; // y軸修正為向上為正
                        const v = Math.sqrt(vx * vx + vy * vy);

                        // 能量 (Energy)
                        const m = projectile.mass;
                        const g = 9.8 * params.gravity;
                        const Ek = 0.5 * m * v * v;
                        const Ug = m * g * Math.max(0, posY);

                        // 直接操作 DOM 以優化效能，避免 React 重繪
                        statsRef.current.innerHTML = `
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs font-mono">
                                <div class="text-gray-500">時間 (t)</div><div class="font-bold text-[#5D4037]">${t} s</div>
                                <div class="text-gray-500">水平位移 (x)</div><div class="font-bold text-[#1565C0]">${posX.toFixed(2)} m</div>
                                <div class="text-gray-500">垂直高度 (y)</div><div class="font-bold text-[#2E7D32]">${posY.toFixed(2)} m</div>
                                <div class="text-gray-500">水平速度 (Vx)</div><div class="font-bold text-[#1565C0]">${vx.toFixed(2)} m/s</div>
                                <div class="text-gray-500">垂直速度 (Vy)</div><div class="font-bold text-[#2E7D32]">${vy.toFixed(2)} m/s</div>
                                <div class="text-gray-500">合速度 (V)</div><div class="font-bold text-[#5D4037]">${v.toFixed(2)} m/s</div>
                                <div class="col-span-2 border-t border-gray-200 my-1"></div>
                                <div class="text-gray-500">動能 (Ek)</div><div class="font-bold text-[#E65100]">${Ek.toFixed(1)} J</div>
                                <div class="text-gray-500">位能 (Ug)</div><div class="font-bold text-[#7B1FA2]">${Ug.toFixed(1)} J</div>
                                <div class="text-gray-500">力學能 (E)</div><div class="font-bold text-[#455A64]">${(Ek + Ug).toFixed(1)} J</div>
                            </div>
                        `;
                    } else {
                        timeStart = 0;
                        statsRef.current.innerHTML = `<div class="text-center text-gray-400 text-xs py-8">等待發射...</div>`;
                    }
                });

                // 5. 軌跡繪製系統 (Trajectory System)
                const trailCanvas = document.createElement('canvas');
                trailCanvas.width = width;
                trailCanvas.height = height;
                trailCanvas.style.position = 'absolute';
                trailCanvas.style.top = '0';
                trailCanvas.style.left = '0';
                trailCanvas.style.pointerEvents = 'none'; // 讓滑鼠穿透
                sceneRef.current.appendChild(trailCanvas);
                const trailCtx = trailCanvas.getContext('2d');
                let frameCount = 0;

                Events.on(render, 'afterRender', () => {
                    frameCount++;
                    // 每 3 幀畫一個點 (頻閃攝影效果)
                    if (frameCount % 3 === 0) {
                        const projectile = engine.world.bodies.find(b => b.label === 'Projectile');
                        if (projectile) {
                            trailCtx.beginPath();
                            trailCtx.arc(projectile.position.x, projectile.position.y, 2, 0, 2 * Math.PI);
                            trailCtx.fillStyle = 'rgba(255, 82, 82, 0.5)';
                            trailCtx.fill();
                        }
                    }
                });

                // 掛載清除軌跡的方法
                engine.clearTrails = () => trailCtx.clearRect(0, 0, width, height);

                // 啟動引擎
                Render.run(render);
                const runner = Runner.create();
                runnerRef.current = runner;
                Runner.run(runner, engine);

                // 清理函數 (Cleanup)
                return () => {
                    Render.stop(render);
                    Runner.stop(runner);
                    if (engine) World.clear(engine.world);
                    if (render.canvas) render.canvas.remove();
                    if (trailCanvas) trailCanvas.remove();
                };
            }, [params.gravity]); // 當重力改變時重新初始化引擎

            // 監聽並即時更新物理參數 (不重啟引擎)
            React.useEffect(() => {
                if (engineRef.current) {
                    engineRef.current.world.gravity.y = params.gravity;
                    const ground = engineRef.current.world.bodies.find(b => b.label === 'Ground');
                    if (ground) ground.friction = params.friction;
                }
            }, [params.gravity, params.friction]);

            // --- 核心功能：發射器 (Launcher Logic) ---
            const fireProjectile = () => {
                if (!engineRef.current || !renderRef.current) return;
                const { World, Bodies, Body } = Matter;

                // 清除舊物體與軌跡
                const oldProjectile = engineRef.current.world.bodies.find(b => b.label === 'Projectile');
                if (oldProjectile) World.remove(engineRef.current.world, oldProjectile);
                if (engineRef.current.clearTrails) engineRef.current.clearTrails();

                // 計算向量
                const rad = params.angle * (Math.PI / 180);
                const vTotalPxTick = (params.v0 * SCALE) / FPS; // 單位轉換
                const vx = vTotalPxTick * Math.cos(rad);
                const vy = -vTotalPxTick * Math.sin(rad);

                // 初始位置
                const startX = 50;
                const groundY = renderRef.current.options.height - 20;
                const radius = 15;
                const startY = groundY - (params.height * SCALE) - radius;

                // 生成剛體
                const projectile = Bodies.circle(startX, startY, radius, {
                    label: 'Projectile',
                    mass: 5,          // 設定固定質量
                    friction: 0,      // 理想化：無摩擦
                    frictionAir: 0,   // 理想化：無空阻
                    restitution: 0.8, // 彈性碰撞
                    render: { fillStyle: '#FF5252', strokeStyle: 'white', lineWidth: 2 }
                });

                Body.setVelocity(projectile, { x: vx, y: vy });
                World.add(engineRef.current.world, projectile);
            };

            const clearScene = () => {
                if (!engineRef.current) return;
                const projectile = engineRef.current.world.bodies.find(b => b.label === 'Projectile');
                if (projectile) Matter.World.remove(engineRef.current.world, projectile);
                if (engineRef.current.clearTrails) engineRef.current.clearTrails();
                if (statsRef.current) statsRef.current.innerHTML = `<div class="text-center text-gray-400 text-xs py-8">等待發射...</div>`;
            };

            // --- UI 渲染 (JSX) ---
            return (
                <div className="flex flex-col lg:flex-row gap-6 h-[600px] w-full">
                    {/* 左側：控制面板 */}
                    <div className="w-full lg:w-[30%] flex flex-col bg-[#EFEBE9] p-5 rounded-[24px] border-[3px] border-[#D7CCC8] shadow-sm h-full overflow-y-auto custom-scrollbar">
                        <div className="mb-4">
                            <h3 className="text-lg font-black text-[#5D4037] flex items-center gap-2 mb-1">
                                <Settings size={20} /> 實驗控制台
                            </h3>
                            <p className="text-xs text-[#9CA38F] font-bold">設定參數進行精確物理拋射</p>
                        </div>

                        {/* 輸入參數區 */}
                        <div className="bg-white p-4 rounded-xl border border-[#E0E4CC] mb-4 shadow-sm space-y-4">
                            <h4 className="text-xs font-black text-[#8D6E63] uppercase tracking-wider border-b border-[#F2F4E6] pb-1 mb-2">Initial Conditions</h4>

                            <div>
                                <label className="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                                    初速度 v0 <span className="text-[#1565C0]">{params.v0} m/s</span>
                                </label>
                                <input type="range" min="1" max="30" step="1" value={params.v0} onChange={e => setParams({ ...params, v0: Number(e.target.value) })} className="w-full h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#1565C0]" />
                            </div>

                            <div>
                                <label className="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                                    發射仰角 θ <span className="text-[#E65100]">{params.angle}°</span>
                                </label>
                                <input type="range" min="0" max="90" step="5" value={params.angle} onChange={e => setParams({ ...params, angle: Number(e.target.value) })} className="w-full h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#E65100]" />
                            </div>

                            <div>
                                <label className="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                                    初始高度 h <span className="text-[#2E7D32]">{params.height} m</span>
                                </label>
                                <input type="range" min="0" max="8" step="0.5" value={params.height} onChange={e => setParams({ ...params, height: Number(e.target.value) })} className="w-full h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#2E7D32]" />
                            </div>
                        </div>

                        {/* 環境變數區 */}
                        <div className="bg-[#F8F9F0] p-4 rounded-xl border border-[#E0E4CC] mb-4 shadow-inner space-y-4">
                            <h4 className="text-xs font-black text-[#8D6E63] uppercase tracking-wider border-b border-[#E0E4CC] pb-1 mb-2">Environment</h4>

                            <div>
                                <label className="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                                    重力倍率 (g) <span className="text-[#5D4037]">{params.gravity}</span>
                                </label>
                                <input type="range" min="0" max="3" step="0.1" value={params.gravity} onChange={e => setParams({ ...params, gravity: Number(e.target.value) })} className="w-full h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#5D4037]" />
                            </div>

                            <div>
                                <label className="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                                    地面摩擦力 μ <span className="text-[#5D4037]">{params.friction}</span>
                                </label>
                                <input type="range" min="0" max="1" step="0.1" value={params.friction} onChange={e => setParams({ ...params, friction: Number(e.target.value) })} className="w-full h-2 bg-[#E0E4CC] rounded-full appearance-none accent-[#5D4037]" />
                            </div>
                        </div>

                        {/* 按鈕區 */}
                        <div className="mt-auto grid grid-cols-2 gap-2">
                            <button onClick={fireProjectile} className="col-span-1 py-3 bg-[#FF5252] hover:bg-[#FF1744] text-white rounded-xl font-black shadow-[0_4px_0_#D32F2F] active:shadow-none active:translate-y-[4px] transition-all flex items-center justify-center gap-2">
                                <Play size={18} fill="currentColor" /> 發射
                            </button>
                            <button onClick={clearScene} className="col-span-1 py-3 bg-white hover:bg-[#F2F4E6] text-[#797365] border-2 border-[#E0E4CC] rounded-xl font-bold shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2">
                                <Trash2 size={18} /> 清除
                            </button>
                        </div>
                    </div>

                    {/* 右側：實驗觀察區 */}
                    <div className="flex-1 bg-[#263238] rounded-[24px] border-[4px] border-[#455A64] relative overflow-hidden shadow-inner flex flex-col group">

                        {/* 網格背景 (Grid) */}
                        <div className="absolute inset-0 opacity-20 pointer-events-none"
                            style={{ backgroundImage: 'linear-gradient(#546E7A 1px, transparent 1px), linear-gradient(90deg, #546E7A 1px, transparent 1px)', backgroundSize: '50px 50px' }}>
                        </div>

                        {/* 刻度標示 */}
                        <div className="absolute bottom-5 left-12 right-0 h-px bg-[#546E7A] flex justify-between px-2 text-[10px] text-[#90A4AE] pointer-events-none">
                            <span>0m</span><span>5m</span><span>10m</span><span>15m</span><span>20m</span>
                        </div>
                        <div className="absolute top-0 bottom-5 left-12 w-px bg-[#546E7A] flex flex-col justify-between py-2 text-[10px] text-[#90A4AE] pointer-events-none">
                            <span>10m</span><span>0m</span>
                        </div>

                        {/* 數據儀表板 (Overlay Dashboard) */}
                        <div className="absolute top-4 right-4 z-20 w-64 bg-white/95 backdrop-blur rounded-xl shadow-lg border-2 border-[#CFD8DC] p-3 transition-opacity opacity-90 hover:opacity-100">
                            <h4 className="text-xs font-black text-[#455A64] uppercase tracking-wider mb-2 flex items-center gap-2">
                                <Activity size={14} /> Real-time Data
                            </h4>
                            <div ref={statsRef} className="min-h-[120px]">
                                <div className="text-center text-gray-400 text-xs py-8">等待發射...</div>
                            </div>
                        </div>

                        {/* 物理渲染區 */}
                        <div ref={sceneRef} className="w-full h-full cursor-crosshair touch-none z-10"></div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 16. 主應用程式邏輯 (Core Logic)
        // ==========================================

        // --- 懸浮氣球元件 V2.4 (位置修正版) ---
        // 漂浮在畫面右側的互動氣球，點擊可獲得隨機獎勵
        const FloatingBalloon = () => {
            const [isVisible, setIsVisible] = useState(false);
            const [balloons, setBalloons] = useState([true, true, true]);
            const [isGiftDropped, setIsGiftDropped] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [giftContent, setGiftContent] = useState(null);

            const audioCtxRef = useRef(null);

            useEffect(() => {
                const scheduleNext = () => {
                    const delay = 1000;
                    setTimeout(() => {
                        setBalloons([true, true, true]);
                        setIsGiftDropped(false);
                        setIsVisible(true);
                        const gifts = [
                            { label: '9,999 零錢', icon: '💰' }, { label: '星星', icon: '✨' },
                            { label: '咖啡廳制服', icon: '👔' }, { label: '機票一張', icon: '✈️' },
                            { label: '青江菜', icon: '🥬' }, { label: '狗骨頭', icon: '🦴' }
                        ];
                        setGiftContent(gifts[Math.floor(Math.random() * gifts.length)]);
                    }, delay);
                };

                if (!isVisible && !showModal) {
                    scheduleNext();
                }
            }, [isVisible, showModal]);

            const playSound = (type) => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                    const ctx = audioCtxRef.current;
                    if (ctx.state === 'suspended') ctx.resume().catch(() => { });

                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    if (type === 'pop') {
                        osc.frequency.setValueAtTime(400, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        osc.start(); osc.stop(ctx.currentTime + 0.1);
                    } else if (type === 'drop') {
                        osc.frequency.setValueAtTime(800, ctx.currentTime);
                        osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.6);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.6);
                        osc.start(); osc.stop(ctx.currentTime + 0.6);
                    } else if (type === 'win') {
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                        osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
                        osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
                        osc.start(); osc.stop(ctx.currentTime + 0.5);
                    }
                    osc.connect(gain); gain.connect(ctx.destination);
                } catch (e) { console.error("Audio error:", e); }
            };

            const popBalloon = (index) => {
                if (!balloons[index]) return;
                const newBalloons = [...balloons];
                newBalloons[index] = false;
                setBalloons(newBalloons);
                playSound('pop');
                if (newBalloons.every(b => b === false)) {
                    requestAnimationFrame(() => {
                        setIsGiftDropped(true);
                        playSound('drop');
                    });
                }
            };

            const openGift = () => {
                if (!isGiftDropped) return;
                setShowModal(true);
                setIsVisible(false);
                playSound('win');
            };

            if (!isVisible && !showModal) return null;

            return (
                <>
                    {isVisible && (
                        // ★ 位置修改：top-32 (避開Header), right-4 (靠右邊緣)
                        <div
                            className={`fixed z-[999] top-32 right-12 select-none
                                ${isGiftDropped
                                    ? 'transition-transform duration-[800ms] ease-in translate-y-[80vh] rotate-12 cursor-pointer'
                                    : 'animate-[balloon-float_6s_ease-in-out_infinite]'
                                }
                            `}
                            style={isGiftDropped ? { transitionTimingFunction: 'cubic-bezier(0.5, 0, 1, 0.5)' } : {}}
                        >
                            <div className="relative pointer-events-auto">
                                <svg width="100" height="120" className="absolute -top-20 -left-10 pointer-events-none overflow-visible">
                                    {balloons[0] && <line x1="20" y1="20" x2="50" y2="90" stroke="#FFF" strokeWidth="2" />}
                                    {balloons[1] && <line x1="50" y1="10" x2="50" y2="90" stroke="#FFF" strokeWidth="2" />}
                                    {balloons[2] && <line x1="80" y1="20" x2="50" y2="90" stroke="#FFF" strokeWidth="2" />}
                                </svg>
                                {balloons[0] && (
                                    <div onClick={(e) => { e.stopPropagation(); popBalloon(0); }} className="absolute z-20 -top-[100px] -left-[30px] w-14 h-16 rounded-full bg-red-400 shadow-[inset_-5px_-5px_10px_rgba(0,0,0,0.1)] cursor-crosshair active:scale-90 transition-transform flex items-center justify-center opacity-90 hover:opacity-100 hover:scale-105">
                                        <div className="absolute top-3 left-3 w-3 h-3 bg-white rounded-full opacity-30"></div>
                                        <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-red-400"></div>
                                    </div>
                                )}
                                {balloons[1] && (
                                    <div onClick={(e) => { e.stopPropagation(); popBalloon(1); }} className="absolute z-30 -top-[115px] left-[0px] w-14 h-16 rounded-full bg-yellow-400 shadow-[inset_-5px_-5px_10px_rgba(0,0,0,0.1)] cursor-crosshair active:scale-90 transition-transform flex items-center justify-center opacity-90 hover:opacity-100 hover:scale-105">
                                        <div className="absolute top-3 left-3 w-3 h-3 bg-white rounded-full opacity-30"></div>
                                        <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-yellow-400"></div>
                                    </div>
                                )}
                                {balloons[2] && (
                                    <div onClick={(e) => { e.stopPropagation(); popBalloon(2); }} className="absolute z-20 -top-[100px] left-[30px] w-14 h-16 rounded-full bg-blue-400 shadow-[inset_-5px_-5px_10px_rgba(0,0,0,0.1)] cursor-crosshair active:scale-90 transition-transform flex items-center justify-center opacity-90 hover:opacity-100 hover:scale-105">
                                        <div className="absolute top-3 left-3 w-3 h-3 bg-white rounded-full opacity-30"></div>
                                        <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-blue-400"></div>
                                    </div>
                                )}
                                <div onClick={(e) => { e.stopPropagation(); openGift(); }} className={`relative z-10 w-12 h-12 bg-white border-4 border-red-500 rounded-lg shadow-lg flex items-center justify-center ${isGiftDropped ? 'animate-bounce cursor-pointer' : 'cursor-default'}`}>
                                    <div className="absolute inset-0 border-4 border-red-500 rounded-lg"></div>
                                    <div className="absolute top-0 bottom-0 left-1/2 -translate-x-1/2 w-3 bg-red-500"></div>
                                    <div className="absolute left-0 right-0 top-1/2 -translate-y-1/2 h-3 bg-red-500"></div>
                                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 text-red-500 filter drop-shadow-sm"><Gift size={20} /></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showModal && giftContent && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-[#FFF8E1] p-8 rounded-[32px] border-8 border-white shadow-2xl text-center max-w-sm transform scale-100 animate-in zoom-in-95 duration-300 relative overflow-hidden">
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-yellow-300 rounded-full blur-3xl opacity-50 -z-10 animate-pulse"></div>
                                <div className="text-6xl mb-4 animate-bounce">{giftContent.icon}</div>
                                <h3 className="text-xl font-black text-[#5D4037] mb-2">撿到了氣球禮物！</h3>
                                <p className="text-[#8D6E63] font-bold mb-6">裡面好像是... <span className="text-[#E65100] text-lg">{giftContent.label}</span> ！</p>
                                <button onClick={() => setShowModal(false)} className="px-8 py-3 bg-[#88C9A1] hover:bg-[#68B085] text-white font-black rounded-full shadow-lg hover:scale-105 active:scale-95 transition-all text-lg">收下</button>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- 島嶼氛圍特效組件 V2.0 (導演版：互斥播放) ---
        const IslandAtmosphere = () => {
            // currentEvent: 目前正在上演的劇本 ('none' | 'bird' | 'maple' | 'snow')
            const [currentEvent, setCurrentEvent] = useState('none');

            // 狀態物件 (用來渲染畫面)
            const [bird, setBird] = useState(null);
            const [particles, setParticles] = useState([]);
            // ★ 隱藏功能：按 'W' 鍵強制切換動畫
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'w' || e.key === 'W') {
                        // 強制清空當前畫面，避免殘留
                        setBird(null);
                        setParticles([]);

                        // 切換模式：鳥 -> 楓葉 -> 雪 -> 停止 -> (循環)
                        setCurrentEvent(prev => {
                            if (prev === 'none') return 'bird';
                            if (prev === 'bird') return 'maple';
                            if (prev === 'maple') return 'snow';
                            return 'none';
                        });
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, []);
            // --- 導演排程系統 ---
            useEffect(() => {
                let timer;

                if (currentEvent === 'none') {
                    // 如果現在沒事發生，休息 3~8 秒後決定下一個節目
                    const breakTime = 3000 + Math.random() * 5000;

                    timer = setTimeout(() => {
                        const rand = Math.random();
                        if (rand < 0.35) {
                            // 35% 機率出現：鳥
                            setCurrentEvent('bird');
                        } else {
                            // 65% 機率出現：天氣 (隨機楓葉或雪)
                            setCurrentEvent(Math.random() < 0.5 ? 'maple' : 'snow');
                        }
                    }, breakTime);
                } else if (currentEvent === 'bird') {
                    // --- 劇本：鳥 ---
                    // 設定鳥的參數
                    const duration = 15 + Math.random() * 5; // 飛 15-20 秒
                    setBird({
                        id: Date.now(),
                        top: 10 + Math.random() * 40, // 高度 10%-50%
                        size: 35 + Math.random() * 15,
                        duration: duration
                    });

                    // 演出結束後，清場並回到休息狀態
                    timer = setTimeout(() => {
                        setBird(null);
                        setCurrentEvent('none');
                    }, duration * 1000);

                } else if (currentEvent === 'maple' || currentEvent === 'snow') {
                    // --- 劇本：天氣 (落葉/雪) ---
                    // 設定天氣持續時間 (約 12 秒)
                    const weatherDuration = 12000;
                    const spawnRate = currentEvent === 'snow' ? 300 : 800; // 雪比較密

                    const interval = setInterval(() => {
                        const id = Date.now();
                        const pDuration = currentEvent === 'snow' ? (5 + Math.random() * 5) : (10 + Math.random() * 10);

                        setParticles(prev => {
                            const newState = [...prev, {
                                id,
                                left: Math.random() * 100,
                                duration: pDuration,
                                size: currentEvent === 'snow' ? (4 + Math.random() * 6) : (20 + Math.random() * 10),
                                color: currentEvent === 'maple' ? ['#FF9A8B', '#FFB74D', '#FF8A65'][Math.floor(Math.random() * 3)] : '#FFFFFF'
                            }];
                            // 限制數量避免效能問題
                            if (newState.length > 25) newState.shift();
                            return newState;
                        });

                        // 粒子自毀
                        setTimeout(() => {
                            setParticles(prev => prev.filter(p => p.id !== id));
                        }, pDuration * 1000);

                    }, spawnRate);

                    // 時間到，停止生成，等待最後一批掉落後清場
                    timer = setTimeout(() => {
                        clearInterval(interval);
                        // 多給 10 秒讓畫面上的飄完
                        setTimeout(() => {
                            setParticles([]);
                            setCurrentEvent('none');
                        }, 10000);
                    }, weatherDuration);
                }

                return () => clearTimeout(timer);
            }, [currentEvent]);

            return (
                <div className="atmosphere-layer">
                    {/* 鳥層：只有在 currentEvent 為 bird 且 bird 存在時顯示 */}
                    {currentEvent === 'bird' && bird && (
                        <div key={bird.id} className="ac-bird"
                            style={{
                                top: `${bird.top}%`,
                                width: bird.size,
                                height: bird.size,
                                // 使用您指定的修正後飛行路徑
                                animation: `fly-across ${bird.duration}s linear forwards`
                            }}>
                            {/* 黃色小鳥 + 深色邊框 */}
                            <svg viewBox="0 0 40 40" width="100%" height="100%" fill="#F2D879" stroke="#5D4037" strokeWidth="2">
                                <path d="M5 20 Q15 10 35 20 Q15 30 5 20 Z" />
                                <path d="M15 15 Q20 5 25 15" fill="#F2D879" stroke="#5D4037" strokeWidth="2">
                                    <animate attributeName="d" dur="0.4s" repeatCount="indefinite" values="M15 15 Q20 2 25 15; M15 15 Q20 28 25 15; M15 15 Q20 2 25 15" />
                                </path>
                            </svg>
                        </div>
                    )}

                    {/* 粒子層：只有在天氣模式下顯示 */}
                    {(currentEvent === 'maple' || currentEvent === 'snow') && particles.map(p => (
                        <div key={p.id} className="particle"
                            style={{
                                left: `${p.left}%`,
                                width: p.size,
                                height: p.size,
                                color: p.color,
                                animation: `fall-down ${p.duration}s linear forwards, sway-left-right 3s ease-in-out infinite alternate`
                            }}>
                            {currentEvent === 'maple' ? (
                                <svg viewBox="0 0 24 24" fill={p.color} width="100%" height="100%">
                                    <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-11 10z" />
                                    <path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" stroke={p.color} strokeWidth="2" />
                                </svg>
                            ) : (
                                <div style={{ width: '100%', height: '100%', borderRadius: '50%', background: 'white', boxShadow: '0 0 5px white' }}></div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };



        // --- ★ Nook Inc. 功能型錄組件 (ACNH Style Feature Catalog) ★ ---
        const FeatureCatalog = () => {
            const catalogData = [
                {
                    title: "班級助手",
                    icon: "🏫",
                    color: "bg-[#26A69A]",
                    textColor: "text-[#E0F2F1]",
                    desc: "管理島嶼秩序的必備工具",
                    apps: [
                        { name: "森林咖啡廳", sub: "分組計時與引導" },
                        { name: "座位大師", sub: "智慧排位系統" },
                        { name: "成績分析", sub: "圖表分析統計" },
                        { name: "獎狀產生器", sub: "頒發榮譽證書" },
                        { name: "分組小幫手", sub: "隨機公平分組" }
                    ]
                },
                {
                    title: "實驗助手研究室",
                    icon: "🦉",
                    color: "bg-[#5C6BC0]",
                    textColor: "text-[#E8EAF6]",
                    desc: "傅達館長推薦的學術工具",
                    apps: [
                        { name: "實驗繪圖板", sub: "科學數據回歸" },
                        { name: "島民靈感板", sub: "心智圖筆記" }
                    ]
                },
                {
                    title: "PDF 加工部",
                    icon: "🛠️",
                    color: "bg-[#88C9A1]",
                    textColor: "text-[#E8F5E9]",
                    desc: "敲敲打打改造文件",
                    apps: [
                        { name: "合併/拆分 PDF", sub: "檔案整理術" },
                        { name: "移除頁面", sub: "去蕪存菁" },
                        { name: "PDF 旋轉", sub: "修正方向" },
                        { name: "PDF 加密", sub: "資安上鎖" },
                        { name: "添加頁碼", sub: "索引標記" }
                    ]
                },
                {
                    title: "轉換服務",
                    icon: "🎨",
                    color: "bg-[#7ACBD5]",
                    textColor: "text-[#E0F7FA]",
                    desc: "把素材變成你要的樣子",
                    apps: [
                        { name: "文字辨識機", sub: "OCR 圖片轉文字" },
                        { name: "圖片壓縮機", sub: "節省儲存空間" },
                        { name: "JPG ↔ PDF", sub: "雙向格式轉換" },
                        { name: "數字轉大寫", sub: "支票金額轉換" }
                    ]
                },
                {
                    title: "日常應用",
                    icon: "📱",
                    color: "bg-[#FFC8DD]",
                    textColor: "text-[#FFF0F5]",
                    desc: "讓島嶼生活更便利",
                    apps: [
                        { name: "DAL 數位快遞", sub: "QR Code & 短網址" },
                        { name: "隨身筆記", sub: "自動存檔便條" },
                        { name: "待辦清單", sub: "任務管理" },
                        { name: "計時與蕃茄鐘", sub: "專注工作" },
                        { name: "幸運轉盤", sub: "隨機決策" }
                    ]
                },
                {
                    title: "島嶼娛樂",
                    icon: "🎈",
                    color: "bg-[#B39DDB]",
                    textColor: "text-[#EDE7F6]",
                    desc: "工作累了休息一下",
                    apps: [
                        { name: "冷爛笑話", sub: "降溫專用" },
                        { name: "星座運勢", sub: "每日幸運物" },
                        { name: "島民適性測驗", sub: "MBTI 分析" },
                        { name: "Nook 2048", sub: "益智小遊戲" }
                    ]
                }
            ];

            return (
                <div className="w-full max-w-5xl mx-auto p-4 md:p-8 animate-in fade-in slide-in-from-bottom-8 duration-700 pb-24"> {/* pb-24 是為了不被頁尾擋住 */}
                    {/* 標題區 */}
                    <div className="text-center mb-10 relative">
                        <div className="inline-block bg-[#F4E798] px-8 py-3 rounded-full border-[6px] border-white shadow-md transform rotate-[-2deg] z-10 relative">
                            <h1 className="text-3xl md:text-4xl font-black text-[#7A5C3E] flex items-center justify-center gap-3">
                                <span className="text-4xl">🍃</span>
                                Nook Inc. 服務總覽
                                <span className="text-4xl">🍃</span>
                            </h1>
                        </div>
                        <div className="mt-4 text-[#797365] font-bold bg-white/60 inline-block px-6 py-2 rounded-2xl backdrop-blur-sm border-2 border-[#E0E4CC]">
                            Client-side Edge Computing • 零雲端 • 全本地 • 絕對安心
                        </div>
                    </div>

                    {/* 卡片網格 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                        {catalogData.map((category, idx) => (
                            <div key={idx} className="group relative bg-white rounded-[35px] border-[5px] border-[#F2F4E6] shadow-[0_8px_0_#E0E4CC] hover:shadow-[0_12px_0_#D7CCC8] hover:translate-y-[-4px] transition-all duration-300 overflow-hidden flex flex-col h-full">

                                {/* 頂部裝飾條 */}
                                <div className={`h-24 ${category.color} relative overflow-hidden flex items-center justify-center`}>
                                    {/* 波浪紋理 */}
                                    <div className="absolute inset-0 opacity-20"
                                        style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.5) 10px, rgba(255,255,255,0.5) 20px)' }}>
                                    </div>

                                    <div className="relative z-10 flex flex-col items-center text-white drop-shadow-md">
                                        <span className="text-4xl mb-1 filter drop-shadow-lg transform group-hover:scale-110 transition-transform duration-300">{category.icon}</span>
                                        <h3 className="text-xl font-black tracking-widest">{category.title}</h3>
                                    </div>
                                </div>

                                {/* 內容清單 */}
                                <div className="p-5 flex-1 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMiIgZmlsbD0iIzU3NEU0NCIvPjwvc3ZnPg==')]">
                                    <p className="text-center text-xs font-bold text-[#9CA38F] mb-4 bg-[#F8F9F0] py-1 rounded-full border border-[#E0E4CC]">
                                        {category.desc}
                                    </p>

                                    <div className="space-y-2">
                                        {category.apps.map((app, appIdx) => (
                                            <div key={appIdx} className="flex items-center p-2 rounded-xl hover:bg-[#F2F4E6] transition-colors border border-transparent hover:border-[#E0E4CC]">
                                                <div className={`w-2 h-2 rounded-full mr-3 ${category.color}`}></div>
                                                <div className="flex-1">
                                                    <div className="font-bold text-[#574E44] text-sm leading-tight">{app.name}</div>
                                                    <div className="text-[10px] text-[#9CA38F] font-bold">{app.sub}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 底部裝飾 */}
                                <div className="h-3 bg-[#F8F9F0] border-t border-[#E0E4CC]"></div>
                            </div>
                        ))}
                    </div>

                    {/* 狸克提醒 */}
                    <div className="mt-12 flex justify-center">
                        <div className="bg-[#574E44] text-[#F2D879] p-6 rounded-[30px] max-w-2xl border-[6px] border-[#7A5C3E] shadow-lg flex items-start gap-4 transform rotate-1 hover:rotate-0 transition-transform">
                            <div className="text-4xl">💰</div>
                            <div>
                                <h4 className="font-black text-lg mb-1">麥斯社長提醒：</h4>
                                <p className="text-sm font-bold opacity-90 leading-relaxed text-white">
                                    本島行政中心提供的所有服務皆為<span className="text-[#F4E798] underline">免費</span>提供！<br />
                                    無需支付零錢，也無需償還房貸。請島民代表盡情使用，打造完美的島嶼（班級）生活！Yes, yes!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 17. 應用程式入口 (Entry Point)
        // ==========================================

        // --- 主應用程式組件 ---
        // 負責管理路由、顯示模式、天氣組件與核心佈局
        function AdminDocHub() {
            // 在 AdminDocHub 內部
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('ac-settings-darkmode') === 'true');

            // Persist Dark Mode
            useEffect(() => {
                localStorage.setItem('ac-settings-darkmode', isDarkMode);
                if (isDarkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }, [isDarkMode]);

            // --- 🕵️‍♂️ 詹老師專用：隱藏後門 ---
            const [showPhysics, setShowPhysics] = useState(false);
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // 按下 Alt + Shift + P 切換顯示/隱藏
                    if (e.altKey && e.shiftKey && (e.key === 'p' || e.key === 'P')) {
                        setShowPhysics(prev => {
                            if (prev) alert("🔒 物理沙盒已隱藏"); // 提示老師狀態
                            else alert("🔓 物理沙盒已解鎖");
                            return !prev;
                        });
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            // 切換按鈕組件 (建議放在 Header 區域)
            const DarkModeToggle = () => (
                <button
                    onClick={() => setIsDarkMode(!isDarkMode)}
                    className={`p-2 rounded-full border-2 transition-all duration-300 ${isDarkMode ? 'bg-[#0f3460] border-[#F4E798] text-[#F4E798]' : 'bg-white border-[#E0E4CC] text-[#FBC02D]'}`}
                    title={isDarkMode ? "切換回日間模式" : "切換至夜間模式"}
                >
                    {isDarkMode ? <Sun size={24} /> : <Icon size={24}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></Icon>}
                </button>
            );
            // 天氣組件邏輯
            const [weather, setWeather] = useState(null);
            const [weatherLoading, setWeatherLoading] = useState(true);

            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        const locationRes = await fetch('https://ipapi.co/json/');
                        const locationData = await locationRes.json();

                        const weatherRes = await fetch(
                            `https://api.open-meteo.com/v1/forecast?latitude=${locationData.latitude}&longitude=${locationData.longitude}&current=temperature_2m,weathercode,windspeed_10m&timezone=auto`
                        );
                        const weatherData = await weatherRes.json();

                        const weatherMap = {
                            0: { name: '晴天', emoji: '☀️', acIcon: '☀️', color: '#FFD54F' },
                            1: { name: '晴朗', emoji: '🌤️', acIcon: '🌤️', color: '#FFF59D' },
                            2: { name: '多雲', emoji: '⛅', acIcon: '☁️', color: '#B0BEC5' },
                            3: { name: '陰天', emoji: '☁️', acIcon: '☁️', color: '#90A4AE' },
                            45: { name: '起霧', emoji: '🌫️', acIcon: '🌫️', color: '#CFD8DC' },
                            48: { name: '起霧', emoji: '🌫️', acIcon: '🌫️', color: '#CFD8DC' },
                            51: { name: '小雨', emoji: '🌦️', acIcon: '🌧️', color: '#81D4FA' },
                            53: { name: '雨天', emoji: '🌧️', acIcon: '🌧️', color: '#4FC3F7' },
                            61: { name: '雨天', emoji: '🌧️', acIcon: '🌧️', color: '#4FC3F7' },
                            63: { name: '大雨', emoji: '⛈️', acIcon: '⛈️', color: '#29B6F6' },
                            71: { name: '下雪', emoji: '🌨️', acIcon: '❄️', color: '#B3E5FC' },
                            95: { name: '雷雨', emoji: '⛈️', acIcon: '⚡', color: '#7B1FA2' }
                        };

                        const code = weatherData.current.weathercode;
                        const weatherInfo = weatherMap[code] || weatherMap[0];

                        setWeather({
                            temp: Math.round(weatherData.current.temperature_2m),
                            condition: weatherInfo.name,
                            emoji: weatherInfo.emoji,
                            icon: weatherInfo.acIcon,
                            color: weatherInfo.color,
                            windSpeed: Math.round(weatherData.current.windspeed_10m),
                            city: locationData.city || locationData.region
                        });
                    } catch (error) {
                        console.error('Weather fetch failed:', error);
                        setWeather({
                            temp: '--',
                            condition: '無法取得',
                            emoji: '🌍',
                            icon: '🌍',
                            color: '#9CA38F',
                            city: '無人島'
                        });
                    } finally {
                        setWeatherLoading(false);
                    }
                };

                fetchWeather();
            }, []);

            // 天氣顯示組件 (動森風格 V2 - 寬版)
            const WeatherWidget = () => {
                const [currentTime, setCurrentTime] = useState(new Date());

                useEffect(() => {
                    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                    return () => clearInterval(timer);
                }, []);

                const formatDate = (date) => {
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const weekDay = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                    return `${month}月${day}日 (${weekDay})`;
                };

                const formatTime = (date) => {
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                };

                if (weatherLoading) {
                    return (
                        <div className="bg-white/60 backdrop-blur-md px-6 py-3 rounded-full border-[3px] border-white shadow-sm animate-pulse flex gap-4 w-full md:w-auto justify-end">
                            <div className="h-6 w-24 bg-gray-200 rounded-full"></div>
                            <div className="h-6 w-32 bg-gray-200 rounded-full"></div>
                        </div>
                    );
                }

                if (!weather) return null;

                return (
                    <div className="flex flex-col md:flex-row items-end md:items-center gap-3 animate-in fade-in slide-in-from-right-4 duration-700">
                        <div className="bg-white/80 backdrop-blur-md rounded-[30px] border-[4px] border-white shadow-sm flex items-center p-1.5 pr-6 relative overflow-hidden group hover:shadow-md transition-all duration-300">
                            <div className="absolute inset-0 opacity-10 pointer-events-none"
                                style={{ backgroundImage: 'repeating-linear-gradient(45deg, #7FD1B9 0, #7FD1B9 2px, transparent 2px, transparent 6px)' }}>
                            </div>
                            <div className="relative z-10 w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center border-[3px] border-white shadow-sm mr-3 shrink-0 transition-transform group-hover:rotate-12"
                                style={{ backgroundColor: weather.color }}>
                                <span className="text-2xl md:text-3xl filter drop-shadow-sm">{weather.icon}</span>
                            </div>
                            <div className="flex flex-col relative z-10 mr-4 md:mr-6 border-r-2 border-[#E0E4CC] pr-4 md:pr-6">
                                <div className="flex items-baseline gap-1">
                                    <span className="text-2xl md:text-3xl font-black text-[#574E44] leading-none">{weather.temp}°</span>
                                    <span className="text-xs font-bold text-[#9CA38F]">{weather.condition}</span>
                                </div>
                                <div className="flex items-center gap-1 text-[10px] md:text-xs font-bold text-[#797365] opacity-70">
                                    <span>📍 {weather.city}</span>
                                    {weather.windSpeed && <span>• 💨 {weather.windSpeed} km/h</span>}
                                </div>
                            </div>
                            <div className="flex flex-col items-end relative z-10">
                                <div className="text-sm md:text-base font-black text-[#7FD1B9] tracking-widest uppercase" style={{ fontFamily: '"Varela Round", sans-serif' }}>
                                    {formatTime(currentTime)}
                                </div>
                                <div className="text-xs md:text-sm font-bold text-[#9CA38F] bg-[#F2F4E6] px-2 rounded-full">
                                    {formatDate(currentTime)}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            // --- 新增：動森風格日曆組件 ---
            const CalendarWidget = () => {
                const [date, setDate] = useState(new Date());

                useEffect(() => {
                    const timer = setInterval(() => setDate(new Date()), 60000); // 每分鐘更新
                    return () => clearInterval(timer);
                }, []);

                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = days[date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const textColor = isWeekend ? 'text-[#FF9A8B]' : 'text-[#7FD1B9]'; // 週末顯示粉紅色，平日顯示綠色

                return (
                    <div className="hidden md:block bg-white p-6 rounded-[35px] border-[6px] border-white text-center shadow-sm mt-4 relative overflow-hidden group hover:rotate-1 transition-transform origin-top cursor-default">
                        {/* 裝飾：頂部掛孔 */}
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 flex gap-6">
                            <div className="w-3 h-3 bg-[#F0F5F1] rounded-full shadow-[inset_0_2px_4px_rgba(0,0,0,0.1)]"></div>
                            <div className="w-3 h-3 bg-[#F0F5F1] rounded-full shadow-[inset_0_2px_4px_rgba(0,0,0,0.1)]"></div>
                        </div>

                        <div className="mt-2">
                            {/* 月份 */}
                            <div className="text-xl font-black text-[#9CA38F] tracking-widest uppercase mb-[-5px]">
                                {date.getMonth() + 1}月
                            </div>

                            {/* 日期大字 */}
                            <div className={`text-7xl font-black ${textColor} leading-none tracking-tighter drop-shadow-sm`}>
                                {date.getDate()}
                            </div>

                            {/* 星期幾 */}
                            <div className="mt-3">
                                <span className="text-xs font-bold text-[#797365] bg-[#F8F9F0] px-3 py-1 rounded-full border border-[#E0E4CC]">
                                    {dayName}
                                </span>
                            </div>
                        </div>

                        {/* 裝飾：右下角小樹圖案 */}
                        <Tree className="absolute -bottom-2 -right-2 w-12 h-12 text-[#E0E4CC]/40 rotate-12 pointer-events-none" />
                    </div>
                );
            };
            const [activeCategory, setActiveCategory] = useState('INTRO');
            const [activeTool, setActiveTool] = useState(null);
            const { loaded, error } = useExternalScripts();

            const categories = [
                // ★ 新增這行：獨立的介紹分頁
                { id: 'INTRO', label: '功能佈告欄', sub: 'Catalog', color: 'bg-[#8D6E63]', icon: Info, desc: "Nook Inc. 服務總覽" },
                { id: 'ORGANIZE', label: 'PDF萬能工具箱', sub: 'PDF Tools', color: 'bg-[#88C9A1]', icon: Layers, desc: "合併、拆分、OCR與轉檔" },
                { id: 'CONVERT', label: '圖片轉換', sub: 'Convert', color: 'bg-[#7ACBD5]', icon: RotateCw, desc: "圖片壓縮與小工具" },
                { id: 'EDIT', label: '圖片加工', sub: 'Edit', color: 'bg-[#F4E798]', icon: FileCog, desc: "圖片浮水印" },
                { id: 'CLASS', label: '班級助手', sub: 'Class', color: 'bg-[#26A69A]', icon: School, desc: "座位表與成績分析" },
                { id: 'LAB', label: '實驗助手', sub: 'Lab', color: 'bg-[#5C6BC0]', icon: Activity, desc: "數據分析與繪圖" },
                { id: 'DAILY', label: '日常工具', sub: 'Daily', color: 'bg-[#FFC8DD]', icon: CalendarDays, desc: "真的很日常" },
                { id: 'FUN', label: '放鬆一下', sub: 'Fun', color: 'bg-[#B39DDB]', icon: Laugh, desc: "放鬆一下" },
            ];

            const tools = {
                'INTRO': [],
                'ORGANIZE': [
                    { id: 'merge', label: '合併 PDF', icon: Layers, component: PDFMerger, scripts: ['pdflib', 'jszip'] },
                    { id: 'split', label: '拆分 PDF', icon: Scissors, component: PDFSplitter, scripts: ['pdflib', 'jszip'] },
                    { id: 'remove', label: '移除頁面', icon: Trash2, component: PDFPageRemover, scripts: ['pdflib'] },
                    { id: 'rotate', label: '旋轉 PDF', icon: RotateCw, component: PDFRotator, scripts: ['pdflib'] },
                    { id: 'ocr', label: 'PDF 文字辨識', icon: ScanText, component: PdfOcrTool, scripts: ['pdf', 'tesseract'] },
                    { id: 'img2pdf', label: 'JPG 轉 PDF', icon: ImageIcon, component: ImageToPDF, scripts: ['pdflib'] },
                    { id: 'pdf2jpg', label: 'PDF 轉 JPG', icon: FileOutput, component: PDFToImage, style: 'danger', scripts: ['pdf', 'pdflib', 'jszip'] },
                    { id: 'pagenum', label: 'PDF 添加頁碼', icon: Hash, component: PDFPageNumber, scripts: ['pdflib'] },
                    { id: 'encrypt', label: 'PDF 加密', icon: Lock, component: PDFEncrypt, scripts: ['pdflib'] }
                ],
                'CONVERT': [
                    { id: 'compress', label: '圖片壓縮機', icon: Settings, component: ImageCompressorTool },
                    { id: 'num2chi', label: '數字轉大寫', icon: Type, component: NumToChiTool }
                ],
                'EDIT': [
                    { id: 'watermark', label: '圖片浮水印', icon: Stamp, component: WatermarkTool, scripts: ['html2canvas'] }
                ],
                'CLASS': [{ id: 'presentation', label: '上台順序抽籤', icon: Shuffle, component: RandomPresentationTool, scripts: ['xlsx'] },

                { id: 'worldcafe', label: '世界咖啡館', icon: Users, component: WorldCafeTool },
                { id: 'seating', label: '座位大師', icon: Users, component: SeatingChartTool, scripts: ['html2canvas', 'xlsx', 'pdflib'] },
                { id: 'grouping', label: '分組小幫手', icon: Grid, component: GroupMakerTool, scripts: ['xlsx', 'html2canvas', 'pdflib'] },
                { id: 'grade', label: '成績分析', icon: BarChart, component: GradeAnalysisTool, scripts: ['chart', 'xlsx', 'html2canvas', 'pdflib'] },
                { id: 'cert', label: '獎狀產生器', icon: Medal, component: CertificateTool, scripts: ['html2canvas', 'pdflib'] },
                ],
                'LAB': [
                    { id: 'lab', label: '實驗繪圖板', icon: Activity, component: LabPlotterTool, scripts: ['chart', 'xlsx'] },
                    // 加入判斷：如果 showPhysics 為 true 才顯示物理沙盒
                    ...(showPhysics ? [{ id: 'physics', label: '物理沙盒', icon: Dice5, component: PhysicsSandboxTool, scripts: ['matter'] }] : []),
                    { id: 'mindmap', label: '島民靈感板', icon: GitBranch, component: MindMapTool }
                ],
                'DAILY': [
                    { id: 'passgen', label: '密碼產生器', icon: Key, component: PasswordGeneratorTool },
                    { id: 'wheel', label: '幸運大轉盤', icon: PieChart, component: LuckyWheelTool, scripts: ['chart'] },
                    { id: 'dal', label: 'QR code & 縮網址', icon: Plane, component: DALDeliveryTool, scripts: ['qrcode'] },
                    { id: 'random', label: '亂數抽籤', icon: Dice5, component: RandomPickerTool },
                    { id: 'timer', label: '倒數計時', icon: Timer, component: CountdownTool },
                    { id: 'pomodoro', label: '蕃茄鬧鐘', icon: AlarmClock, component: PomodoroTool },
                    { id: 'notepad', label: '隨身筆記', icon: StickyNote, component: NotepadTool },
                    { id: 'todo', label: '待辦清單', icon: ClipboardList, component: TodoListTool },
                ],
                'FUN': [
                    { id: 'joke', label: '冷爛笑話', icon: Smile, component: JokeTool },
                    { id: 'mbti', label: '島民適性測驗', icon: ClipboardList, component: IslandMBTITool, scripts: ['html2canvas'] },
                    { id: '2048', label: 'Nook 2048', icon: Grid, component: Game2048Tool },
                    { id: 'horoscope', label: '星座運勢', icon: Sun, component: HoroscopeTool }
                ],
            };

            const currentCategoryColor = categories.find(c => c.id === activeCategory)?.color || 'bg-[#88C9A1]';

            return (
                <div className="min-h-full font-sans p-3 md:p-8 flex justify-center items-start overflow-x-hidden selection:bg-[#88C9A1] selection:text-white">
                    <LeafPattern />
                    <IslandAtmosphere />
                    <FloatingBalloon />

                    <div className="max-w-6xl w-full space-y-4 md:space-y-8 relative z-10">
                        {/* Header Section - Revised Layout */}
                        <header className="flex flex-col lg:flex-row lg:items-end justify-between pb-4 md:pb-6 gap-4 w-full">
                            <div className="flex items-center gap-3 md:gap-4 shrink-0">
                                <div className="bg-white p-3 md:p-4 rounded-[20px] md:rounded-[25px] shadow-sm transform hover:rotate-6 transition-transform duration-300 border-[3px] md:border-[4px] border-[#F2F4E6]">
                                    <Leaf className="w-8 h-8 md:w-12 md:h-12 text-[#7FD1B9] stroke-[2.5]" />
                                </div>
                                <div>
                                    <div className="flex items-center gap-2">
                                        <h1 className="text-2xl md:text-4xl font-extrabold text-[#574E44] tracking-tight">島民行政中心</h1>
                                        <span className="bg-[#F4E798] text-[#797365] text-[10px] md:text-xs font-bold px-2 py-0.5 md:px-3 md:py-1 rounded-full border-2 border-white shadow-sm">v8.3 乾淨版</span>
                                    </div>
                                    <div className="relative mt-1 md:mt-2 inline-block">
                                        <div className="bg-white px-3 py-1 md:px-4 md:py-2 rounded-2xl rounded-tl-none border-[2px] md:border-[3px] border-[#E0E4CC] shadow-sm">
                                            <p className="text-[#9CA38F] font-bold text-xs md:text-sm flex items-center gap-2">
                                                <MessageCircle className="w-3 h-3 md:w-4 md:h-4" />
                                                今天想處理什麼文件呢?
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 flex justify-end w-full lg:w-auto items-center gap-3">
                                {
                                    /* Focus Mode Toggle */
                                }
                                {/* ★★★ 在這裡加入夜間模式切換按鈕 ★★★ */}
                                <DarkModeToggle />
                                <WeatherWidget />
                            </div>
                        </header>


                        {error && (
                            <div className="bg-[#FF9A8B] text-white p-4 rounded-3xl flex items-center shadow-sm font-bold animate-pulse text-sm md:text-base">
                                <AlertCircle className="w-5 h-5 md:w-6 md:h-6 mr-3" />
                                <span>核心庫載入失敗，請檢查網路連線。</span>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 relative">
                            <nav className="md:col-span-4 lg:col-span-3 space-y-4 md:sticky md:top-8 md:h-fit">
                                {/* 選單按鈕區塊 */}
                                <div className="bg-white/80 backdrop-blur-md p-3 md:p-4 rounded-[24px] md:rounded-[40px] border-[4px] md:border-[6px] border-white shadow-sm">
                                    <div className="grid grid-cols-2 md:grid-cols-1 gap-2 md:gap-3">
                                        {categories.map((cat) => (
                                            <button key={cat.id} onClick={() => { setActiveCategory(cat.id); setActiveTool(null); }} className={`group relative w-full flex flex-col items-center md:items-start p-3 md:p-4 rounded-[20px] md:rounded-[30px] transition-all duration-300 border-[3px] ${activeCategory === cat.id ? `bg-white border-[#797365]/10 shadow-[0_4px_0_0_rgba(0,0,0,0.05)] translate-y-[-2px]` : 'bg-transparent border-transparent hover:bg-white/50 text-[#9CA38F]'}`}>
                                                <div className={`flex items-center gap-2 md:gap-4 w-full justify-center md:justify-start ${activeCategory === cat.id ? 'opacity-100' : 'opacity-60 group-hover:opacity-80'}`}>
                                                    <div className={`p-2 md:p-3 rounded-[16px] md:rounded-[20px] ${cat.color} text-white shadow-sm shrink-0`}><cat.icon className="w-5 h-5 md:w-6 md:h-6 stroke-[3]" /></div>
                                                    <div className="text-left hidden md:block"><span className="block font-extrabold text-[#797365] text-lg">{cat.label}</span><span className="block font-bold text-xs opacity-50 uppercase tracking-wider">{cat.sub}</span></div>
                                                    <span className="md:hidden font-bold text-[#797365] text-sm">{cat.label}</span>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 小提示區塊 */}
                                <div className="hidden md:block bg-[#F4E798] p-6 rounded-[35px] border-[6px] border-white text-[#797365] relative overflow-hidden shadow-sm">
                                    <Sparkles className="absolute top-2 right-2 w-12 h-12 text-white/40 rotate-12" />
                                    <div className="absolute bottom-[-10px] right-[-10px] opacity-20"><Gem size={60} /></div>
                                    <h3 className="font-extrabold text-lg mb-1 relative z-10">小提示</h3>
                                    <p className="text-sm font-bold opacity-80 leading-relaxed relative z-10">所有運算都在您的電腦上完成，無需上傳，絕對安全！</p>
                                </div>

                                {/* ★ 新增：這裡放入日曆組件 ★ */}
                                <CalendarWidget />
                            </nav>
                            <main className="md:col-span-8 lg:col-span-9">
                                <Card className="p-5 md:p-8 min-h-[400px] md:min-h-[600px] relative transition-all duration-500">
                                    <div className="hidden md:block absolute top-8 right-8 p-6 opacity-[0.08] pointer-events-none transition-all duration-500">
                                        {activeCategory === 'SECURITY' ? <Shield className="w-64 h-64 text-[#FF9A8B] rotate-12" /> : activeCategory === 'DAILY' ? <Sun className="w-64 h-64 text-[#FFC8DD] rotate-12" /> : activeCategory === 'CLASS' ? <School className="w-64 h-64 text-[#26A69A] rotate-12" /> : activeCategory === 'FUN' ? <Laugh className="w-64 h-64 text-[#B39DDB] rotate-12" /> : <Tree className="w-64 h-64 text-[#88C9A1] rotate-6" />}
                                    </div>

                                    {!activeTool ? (
                                        <div className="relative z-10 animate-in fade-in slide-in-from-bottom-2 duration-300">

                                            {/* 標題區 */}
                                            <div className="flex items-center mb-6 md:mb-8">
                                                <span className={`w-3 h-8 md:w-4 md:h-10 rounded-full mr-3 md:mr-4 block ${currentCategoryColor} shadow-sm`}></span>
                                                <div>
                                                    <h2 className="text-xl md:text-3xl font-extrabold text-[#797365] tracking-tight">{categories.find(c => c.id === activeCategory).label}</h2>
                                                    <p className="text-[#9CA38F] font-bold text-xs md:text-sm mt-1">{categories.find(c => c.id === activeCategory).desc}</p>
                                                </div>
                                            </div>

                                            {/* ★★★ 核心修改邏輯 ★★★ */}
                                            {activeCategory === 'INTRO' ? (
                                                // 1. 如果是「系統介紹」分類，顯示功能型錄
                                                <FeatureCatalog />
                                            ) : (
                                                // 2. 如果是其他分類，顯示原本的工具按鈕網格
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
                                                    {tools[activeCategory].map(tool => (
                                                        <button key={tool.id} onClick={() => setActiveTool(tool)} className={`group p-5 md:p-6 rounded-[24px] md:rounded-[35px] border-[3px] md:border-[4px] text-left transition-all duration-300 relative overflow-hidden hover:shadow-[0_8px_0_0_rgba(0,0,0,0.05)] hover:translate-y-[-4px] active:translate-y-0 active:shadow-none bg-white border-[#E0E4CC] hover:border-[#88C9A1] ${tool.style === 'danger' ? 'hover:border-[#FF9A8B]' : ''}`}>
                                                            <div className={`w-12 h-12 md:w-14 md:h-14 rounded-[16px] md:rounded-[20px] mb-3 md:mb-4 flex items-center justify-center transition-colors ${tool.style === 'danger' ? 'bg-[#FFF5F5] text-[#FF9A8B] group-hover:bg-[#FF9A8B] group-hover:text-white' : 'bg-[#F2F4E6] text-[#88C9A1] group-hover:bg-[#88C9A1] group-hover:text-white'}`}>{tool.icon && <tool.icon className="w-6 h-6 md:w-7 md:h-7 stroke-[2.5]" />}</div>
                                                            <span className="font-extrabold text-lg md:text-xl text-[#797365] block mb-1 group-hover:text-[#555]">{tool.label}</span>
                                                            <span className="text-[10px] md:text-xs font-bold text-[#9CA38F] bg-[#F8F9F0] px-2 py-1 md:px-3 rounded-full inline-block">Local Only</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}

                                        </div>
                                    ) : (
                                        // 這是進入工具後的畫面 (不用動)
                                        <div className="relative z-10 animate-in zoom-in-95 duration-300">
                                            <button onClick={() => setActiveTool(null)} className="mb-6 md:mb-8 flex items-center text-[#9CA38F] hover:text-[#797365] font-extrabold bg-[#F8F9F0] px-4 py-2 md:px-5 md:py-3 rounded-full w-fit hover:bg-[#F2F4E6] transition-colors text-sm md:text-base"><Home className="w-4 h-4 md:w-5 md:h-5 mr-2 stroke-[2.5]" />返回選單</button>
                                            <div className="mb-6 md:mb-8 pb-4 md:pb-6 border-b-[3px] border-[#F2F4E6] flex items-center gap-3 md:gap-4"><div className={`p-2 md:p-3 rounded-2xl ${currentCategoryColor} text-white shadow-sm`}>{activeTool.icon && <activeTool.icon className="w-6 h-6 md:w-8 md:h-8 stroke-[2.5]" />}</div><h2 className="text-2xl md:text-3xl font-extrabold text-[#797365]">{activeTool.label}</h2></div>
                                            <div className="max-w-3xl mx-auto">
                                                <ToolWrapper component={activeTool.component} scripts={activeTool.scripts || []} />
                                            </div>
                                        </div>
                                    )}
                                </Card>
                            </main>
                        </div>



                        {/* 底部風景區：低飽和度動森風格 (完全靜止版 / Static) */}
                        <div className="w-full flex justify-center items-end pointer-events-none mt-16 px-4 gap-4 md:gap-12 relative select-none" style={{ opacity: 0.9 }}>

                            {/* 1. 柔和灌木 (Sage Green) */}
                            <svg viewBox="0 0 100 100" className="w-16 h-16 md:w-20 md:h-20 hidden md:block transform translate-y-3 drop-shadow-sm">
                                <circle cx="50" cy="60" r="35" fill="#9FB7A6" />
                                <circle cx="30" cy="50" r="25" fill="#8CA593" />
                                <circle cx="70" cy="50" r="25" fill="#8CA593" />
                                <circle cx="50" cy="40" r="30" fill="#B3C7B9" />
                                <circle cx="35" cy="40" r="5" fill="#E6BEAE" />
                                <circle cx="65" cy="45" r="5" fill="#E6BEAE" />
                                <circle cx="50" cy="25" r="6" fill="#DDB0A0" />
                            </svg>

                            {/* 2. 針葉樹 (Muted Pine) - 移除動畫 */}
                            <svg viewBox="0 0 100 120" className="w-24 h-24 md:w-32 md:h-32 drop-shadow-md">
                                <rect x="44" y="85" width="12" height="25" fill="#8D7B6F" rx="2" />
                                <path d="M15 90 L50 35 L85 90 Z" fill="#6B8E76" />
                                <path d="M20 70 L50 25 L80 70 Z" fill="#7FA189" />
                                <path d="M25 50 L50 10 L75 50 Z" fill="#94B59D" />
                            </svg>

                            {/* 3. 庭院石 (Stone Grey) */}
                            <div className="relative z-10 mx-[-10px]">
                                <svg viewBox="0 0 100 80" className="w-20 h-16 md:w-28 md:h-24 drop-shadow-md transform translate-y-2">
                                    <path d="M10 65 Q25 15 50 25 Q75 15 90 55 Q95 75 50 75 Q5 75 10 65" fill="#B0BEC5" stroke="#90A4AE" strokeWidth="2" />
                                    <path d="M25 55 Q35 35 45 40" fill="none" stroke="#ECEFF1" strokeWidth="2" strokeLinecap="round" opacity="0.5" />
                                    <circle cx="82" cy="70" r="6" fill="#78909C" />
                                </svg>
                            </div>

                            {/* 4. 白色波斯菊 (White Cosmos) */}
                            <svg viewBox="0 0 100 100" className="w-12 h-12 md:w-16 md:h-16 hidden md:block transform translate-y-2 drop-shadow-sm">
                                <path d="M50 55 L50 95" stroke="#8CA593" strokeWidth="3" />
                                <path d="M50 95 Q35 85 35 75" stroke="#8CA593" strokeWidth="3" fill="none" />
                                <circle cx="50" cy="50" r="12" fill="#F5F5F5" />
                                <circle cx="50" cy="38" r="10" fill="#E0E0E0" />
                                <circle cx="62" cy="50" r="10" fill="#E0E0E0" />
                                <circle cx="50" cy="62" r="10" fill="#E0E0E0" />
                                <circle cx="38" cy="50" r="10" fill="#E0E0E0" />
                                <circle cx="50" cy="50" r="6" fill="#FFD54F" />
                            </svg>

                            {/* 5. 闊葉樹 (Muted Hardwood) - 移除動畫 */}
                            <svg viewBox="0 0 100 120" className="w-24 h-24 md:w-32 md:h-32 drop-shadow-md">
                                <rect x="44" y="75" width="12" height="35" fill="#8D7B6F" rx="2" />
                                <circle cx="30" cy="55" r="22" fill="#819E8B" />
                                <circle cx="70" cy="55" r="22" fill="#819E8B" />
                                <circle cx="50" cy="40" r="28" fill="#9FB7A6" />
                                <circle cx="35" cy="45" r="4" fill="#FFCCBC" />
                                <circle cx="70" cy="60" r="4" fill="#FFCCBC" />
                            </svg>

                            {/* 6. 台北 101 (低飽和度版) */}
                            <div className="absolute right-0 md:right-10 bottom-0 z-0 opacity-90">
                                <Taipei101 className="w-32 h-auto md:w-48 text-[#8FA998]" />
                            </div>
                        </div>
                        {/* ★ 新版頁尾：加入動森漂浮圖騰 ★ */}
                        <footer className="text-center py-8 flex flex-col items-center justify-center gap-4 relative z-10 mt-12">

                            {/* 漂浮圖騰列 (滑鼠移過去會變清楚) */}
                            <div className="flex items-center justify-center gap-6 md:gap-10 opacity-50 hover:opacity-100 transition-opacity duration-500 select-none">
                                <Tent className="w-8 h-8 md:w-10 md:h-10 text-[#FFAB91] animate-[balloon-float_4s_ease-in-out_infinite]" />
                                <Tree className="w-8 h-8 md:w-10 md:h-10 text-[#88C9A1] animate-[balloon-float_5s_ease-in-out_infinite]" style={{ animationDelay: '0.5s' }} />
                                <Gift className="w-8 h-8 md:w-10 md:h-10 text-[#FF5252] animate-[balloon-float_4.5s_ease-in-out_infinite]" style={{ animationDelay: '1s' }} />
                                <Star className="w-8 h-8 md:w-10 md:h-10 text-[#F4E798] animate-[balloon-float_5.5s_ease-in-out_infinite]" style={{ animationDelay: '1.5s' }} />
                                <Gem className="w-8 h-8 md:w-10 md:h-10 text-[#F2D879] animate-[balloon-float_6s_ease-in-out_infinite]" style={{ animationDelay: '2s' }} />
                            </div>

                            {/* 版權宣告 */}
                            <div className="text-xs text-[#9CA38F] font-bold opacity-60 flex flex-col items-center gap-1">
                                <p>Nook Inc. Administrative Tools © 2025</p>
                                <p className="text-[10px]"> Designed by MAXCHAN</p>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <AdminDocHub />
            </ErrorBoundary>
        );
    </script>
</body>

</html>