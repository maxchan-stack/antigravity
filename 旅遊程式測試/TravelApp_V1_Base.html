<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的旅遊計畫</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC (System-like) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- Phosphor Icons: Apple-like symbols -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#F2F2F7',       // iOS System Grouped Background
                            card: '#FFFFFF',     // iOS Card Background
                            separator: '#C6C6C8',
                            blue: '#007AFF',
                            red: '#FF3B30',
                            gray: '#8E8E93',
                            gray2: '#AEAEB2',
                            gray6: '#F2F2F7',
                        },
                        muji: {
                            red: '#7F0019',      // MUJI Brand Red (Accent)
                            text: '#1D1D1F',     // Apple Text Black
                            sub: '#86868B',      // Apple Subtitle Gray
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    boxShadow: {
                        'ios': '0 1px 2px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Transitions */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* iOS Toggle Switch */
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: #7F0019;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* GPS Pulse */
        .gps-pulse {
            width: 16px;
            height: 16px;
            border: 3px solid #fff;
            border-radius: 50%;
            background-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.3);
        }
    </style>
</head>

<body class="text-muji-text h-[100dvh] flex flex-col overflow-hidden bg-ios-bg">

    <div id="app"
        class="flex flex-col h-full w-full max-w-md mx-auto bg-ios-bg relative sm:border-x sm:border-ios-separator/30">

        <!-- Top Navigation Bar (Dynamic based on View) -->
        <header class="bg-ios-bg/90 backdrop-blur-xl sticky top-0 z-30 pt-safe-top transition-all duration-200"
            :class="{'border-b border-ios-separator/50': !isScrolledTop}">

            <div class="px-5 pt-2 pb-2 flex justify-between items-center h-11">
                <!-- Left Action -->
                <button @click="showTripMenu = true" class="text-muji-red flex items-center gap-1 text-[17px]">
                    <i class="ph-bold ph-list text-xl"></i>
                </button>

                <!-- Center Title (If simplified mode) -->
                <div v-if="isScrolledTop === false" class="text-[17px] font-bold absolute left-1/2 -translate-x-1/2">
                    {{ getPageTitle() }}
                </div>

                <!-- Right Action -->
                <button v-if="viewMode === 'plan'" @click="addDay"
                    class="text-muji-red text-[17px] flex items-center gap-1">
                    <i class="ph-bold ph-plus"></i> <span class="font-normal">新增</span>
                </button>
                <button v-else-if="viewMode === 'map'" @click="centerOnUser" class="text-muji-red">
                    <i class="ph-fill ph-navigation-arrow text-xl"></i>
                </button>
            </div>

            <!-- Large Title Area (Collapsible) -->
            <div class="px-5 pb-2 transition-all duration-300 origin-top overflow-hidden"
                :class="{'h-0 opacity-0': !isScrolledTop, 'h-auto opacity-100': isScrolledTop}">
                <h1 class="text-[34px] font-bold leading-tight tracking-tight text-black">{{ getPageTitle() }}</h1>
                <div v-if="viewMode === 'plan'" class="text-sm text-muji-sub mt-1 font-medium">{{ setup.destination ||
                    '目的地' }} • {{ days[currentDayIdx]?.shortDate || '選擇日期' }}</div>
            </div>

            <!-- Day Selector (Only in Plan Mode) -->
            <div v-if="viewMode === 'plan'" class="flex overflow-x-auto hide-scroll px-4 pb-3 space-x-2 snap-x mt-2">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index"
                    class="snap-center shrink-0 flex flex-col items-center justify-center w-[4.5rem] h-14 rounded-xl cursor-pointer transition-all border"
                    :class="currentDayIdx === index ? 'bg-muji-red text-white border-muji-red shadow-md' : 'bg-white text-muji-text border-transparent shadow-sm'">
                    <span class="text-[10px] uppercase font-bold opacity-80 mb-0.5">{{ day.shortDate }}</span>
                    <span class="text-sm font-bold">D{{ index + 1 }}</span>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto bg-ios-bg relative hide-scroll" @scroll="handleScroll" ref="mainScroll">

            <!-- PLAN VIEW -->
            <transition name="fade">
                <div v-if="viewMode === 'plan'" class="p-4 pb-32 space-y-6">

                    <!-- Date & Weather Card (Apple Style Group) -->
                    <div class="bg-white rounded-xl overflow-hidden shadow-ios">
                        <div class="p-4 flex justify-between items-center border-b border-ios-bg">
                            <div>
                                <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)"
                                    class="absolute opacity-0 w-8 h-8">
                                <h3 class="text-lg font-bold text-muji-text flex items-center gap-2">
                                    {{ currentDay.date.split(' ')[0] }} <span
                                        class="text-muji-sub font-normal text-base">{{ currentDay.date.split(' ')[1]
                                        }}</span>
                                    <i class="ph-bold ph-caret-down text-xs text-muji-sub/50"></i>
                                </h3>
                                <div class="mt-1">
                                    <input v-model="currentDay.title"
                                        class="w-full text-[15px] bg-transparent placeholder-muji-sub/40 text-muji-text focus:outline-none"
                                        placeholder="輸入當日主題...">
                                </div>
                            </div>
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="text-2xl font-light text-muji-text tracking-tighter">{{ weatherDisplay.temp
                                    }}</div>
                                <div class="text-xs text-muji-sub flex items-center justify-end gap-1"><i
                                        :class="['ph-fill', weatherDisplay.icon]"></i> {{ weatherDisplay.label }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Flight Card -->
                    <div class="bg-white rounded-xl shadow-ios overflow-hidden relative">
                        <div
                            class="bg-muji-red/5 px-4 py-2 border-b border-muji-red/10 flex justify-between items-center">
                            <span class="text-[11px] font-bold text-muji-red uppercase tracking-wider">航班資訊</span>
                            <button @click="toggleFlightCard" class="text-muji-red"><i class="ph-bold"
                                    :class="currentDay.flight ? 'ph-minus-circle' : 'ph-plus-circle'"></i></button>
                        </div>

                        <div v-if="currentDay.flight" class="p-5">
                            <div class="flex justify-between items-center">
                                <div class="text-center w-1/3">
                                    <input v-model="currentDay.flight.startTime" type="time"
                                        class="text-[28px] font-light text-muji-text w-full text-center bg-transparent focus:outline-none p-0">
                                    <input v-model="currentDay.flight.startAirport"
                                        class="text-[13px] font-bold text-muji-sub uppercase w-full text-center bg-transparent focus:outline-none p-0 tracking-wider">
                                </div>
                                <div class="w-1/3 flex flex-col items-center justify-center px-1">
                                    <div class="text-[10px] font-bold text-muji-sub/50 mb-1">飛行時間</div>
                                    <div class="w-full h-[2px] bg-muji-sub/20 relative rounded-full">
                                        <i
                                            class="ph-fill ph-airplane absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-1 text-muji-sub/50 text-xs"></i>
                                    </div>
                                    <input v-model="currentDay.flight.number"
                                        class="text-[11px] font-medium text-muji-sub mt-1 w-full text-center bg-transparent uppercase p-0 focus:outline-none">
                                </div>
                                <div class="text-center w-1/3 relative">
                                    <input v-model="currentDay.flight.endTime" type="time"
                                        class="text-[28px] font-light text-muji-text w-full text-center bg-transparent focus:outline-none p-0">
                                    <input v-model="currentDay.flight.endAirport"
                                        class="text-[13px] font-bold text-muji-sub uppercase w-full text-center bg-transparent focus:outline-none p-0 tracking-wider">
                                    <select v-model="currentDay.flight.arrivalOffset"
                                        class="absolute inset-0 opacity-0">
                                        <option value="0">同日</option>
                                        <option value="1">+1天</option>
                                        <option value="-1">-1天</option>
                                    </select>
                                    <div v-if="currentDay.flight.arrivalOffset != 0"
                                        class="absolute -top-2 right-0 bg-muji-red text-white text-[9px] px-1 rounded-sm font-bold shadow-sm">
                                        {{ currentDay.flight.arrivalOffset > 0 ? '+1' : '-1' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="p-8 text-center" @click="toggleFlightCard">
                            <div class="text-muji-sub/40 text-sm">點擊新增航班</div>
                        </div>
                    </div>

                    <!-- Itinerary List (Inset Grouped) -->
                    <div class="space-y-4">
                        <div v-for="(item, idx) in currentDay.items" :key="idx" class="flex gap-4 group">
                            <!-- Time Column -->
                            <div class="w-12 pt-1 flex flex-col items-center shrink-0">
                                <input v-model="item.time" type="time"
                                    class="text-[13px] font-semibold text-muji-text bg-transparent text-center w-full focus:outline-none font-mono">
                                <div
                                    class="h-full w-[2px] bg-ios-separator/30 my-1 rounded-full group-last:bg-transparent relative">
                                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-ios-bg rounded-full flex items-center justify-center cursor-pointer border border-ios-separator/50"
                                        @click="cycleType(item)">
                                        <i class="ph-fill text-[10px] text-muji-sub" :class="getIcon(item.type)"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card -->
                            <div class="flex-1 bg-white rounded-xl p-4 shadow-ios relative">
                                <div class="flex justify-between items-start mb-2">
                                    <input v-model="item.activity"
                                        class="text-[17px] font-semibold text-muji-text bg-transparent w-full focus:outline-none"
                                        placeholder="行程名稱">
                                    <button @click="removeItem(idx)"
                                        class="text-muji-sub/30 hover:text-muji-red ml-2"><i
                                            class="ph-bold ph-minus-circle"></i></button>
                                </div>
                                <div class="flex items-center gap-2 mb-2 pb-2 border-b border-ios-bg">
                                    <i class="ph-fill ph-map-pin text-muji-red/70 text-sm"></i>
                                    <input v-model="item.location"
                                        class="text-[15px] text-muji-sub flex-1 bg-transparent focus:outline-none"
                                        placeholder="新增地點...">
                                    <a v-if="item.location" :href="getGoogleMapLink(item.location)" target="_blank"
                                        class="text-ios-blue text-xs font-medium">地圖</a>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="ph-fill ph-text-align-left text-muji-sub/40 text-sm mt-1"></i>
                                    <textarea v-model="item.note" rows="1"
                                        class="text-[13px] text-muji-sub w-full bg-transparent focus:outline-none resize-none"
                                        placeholder="備註、訂位資訊..."></textarea>
                                </div>

                                <!-- Recommendation Section -->
                                <div v-if="item.type === 'food'" class="mt-3 bg-ios-bg/50 rounded-lg p-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-[11px] font-bold text-muji-sub uppercase">附近美食推薦</span>
                                        <button @click="searchNearby(item, idx)"
                                            class="text-[11px] text-muji-red font-bold" :disabled="!item.location">
                                            <span
                                                v-if="isSearchingRecs && searchTargetIndex === `${currentDayIdx}-${idx}`">搜尋中...</span>
                                            <span v-else>搜尋</span>
                                        </button>
                                    </div>
                                    <div v-if="recommendationsMap[`${currentDayIdx}-${idx}`]"
                                        class="flex flex-wrap gap-2">
                                        <button v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]"
                                            :key="rec.name" @click="applyRecommendation(item, rec)"
                                            class="text-[11px] px-2 py-1 bg-white border border-ios-separator/30 rounded text-muji-text shadow-sm truncate max-w-full">
                                            {{ rec.name }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="addItem"
                            class="w-full py-4 rounded-xl border-2 border-dashed border-ios-separator/50 text-muji-sub font-medium hover:border-muji-red hover:text-muji-red transition flex items-center justify-center gap-2">
                            <i class="ph-bold ph-plus"></i> 加入行程
                        </button>
                    </div>
                </div>
            </transition>

            <!-- MAP VIEW -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative w-full">
                <div id="map" class="flex-1 w-full bg-ios-bg/20 z-0"></div>
                <div v-if="isMapLoading"
                    class="absolute inset-0 bg-white/80 backdrop-blur z-10 flex items-center justify-center text-muji-sub font-bold text-sm">
                    地圖載入中...</div>

                <!-- Map Overlay Card -->
                <div
                    class="absolute bottom-6 left-5 right-5 bg-white/90 backdrop-blur-xl rounded-2xl p-4 shadow-xl z-20 border border-white/20">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-xs text-muji-sub font-bold uppercase tracking-wide">今日地點</div>
                            <div class="text-xl font-bold text-muji-text">{{
                                currentDay.items.filter(i=>i.location).length }} <span
                                    class="text-sm font-normal text-muji-sub">個</span></div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="initMap"
                                class="w-10 h-10 bg-ios-bg rounded-full text-muji-text flex items-center justify-center"><i
                                    class="ph-bold ph-arrows-clockwise"></i></button>
                            <button @click="centerOnUser"
                                class="w-10 h-10 bg-muji-red text-white rounded-full shadow-lg flex items-center justify-center"><i
                                    class="ph-bold ph-crosshair"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MONEY VIEW -->
            <transition name="fade">
                <div v-if="viewMode === 'money'" class="p-4 pb-32 space-y-4">
                    <div class="bg-white rounded-xl p-5 shadow-ios text-center">
                        <div class="text-[11px] text-muji-sub font-bold uppercase tracking-wide mb-1">總支出預估</div>
                        <div class="text-[34px] font-bold text-muji-text tabular-nums tracking-tight">{{ currencySymbol
                            }} {{ totalExpense.toLocaleString() }}</div>
                        <div class="text-sm text-muji-sub font-medium">≈ NT$ {{ Math.round(totalExpense *
                            exchangeRate).toLocaleString() }}</div>
                        <div class="mt-4 pt-3 border-t border-ios-bg flex justify-center gap-3">
                            <div class="bg-ios-bg rounded-lg px-3 py-1 text-xs text-muji-sub font-medium">匯率設定</div>
                            <input v-model.number="exchangeRate" type="number" step="0.001"
                                class="w-16 bg-transparent text-center border-b border-muji-sub/30 focus:border-muji-red text-sm font-bold tabular-nums">
                        </div>
                    </div>

                    <!-- Input section -->
                    <div class="bg-white rounded-xl p-4 shadow-ios">
                        <div class="flex items-center gap-3 mb-3">
                            <input v-model="newExpense.item" placeholder="消費項目"
                                class="flex-1 text-[17px] bg-transparent border-b border-ios-bg py-2 focus:border-muji-red focus:outline-none">
                            <select v-model="newExpense.payer"
                                class="bg-ios-bg text-sm rounded-lg px-2 py-1.5 font-bold text-muji-text border-none focus:ring-0">
                                <option v-for="p in participants" :value="p">{{ p }} 先付</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold text-muji-sub">{{ currencySymbol }}</span>
                            <input v-model.number="newExpense.amount" type="number" placeholder="金額"
                                class="flex-1 text-2xl font-bold bg-transparent py-1 focus:outline-none">
                            <button @click="addExpense"
                                class="bg-muji-red text-white flex items-center gap-1 px-4 py-2 rounded-full font-bold shadow-lg active:scale-95 transition-transform">
                                <i class="ph-bold ph-plus"></i> 加入
                            </button>
                        </div>
                    </div>

                    <!-- Expense List -->
                    <div class="bg-white rounded-xl shadow-ios overflow-hidden">
                        <div
                            class="px-4 py-2 bg-ios-bg/50 border-b border-ios-bg text-[11px] text-muji-sub font-bold uppercase">
                            支出明細</div>
                        <div v-for="(exp, idx) in expenses" :key="idx"
                            class="flex justify-between items-center p-4 border-b border-ios-bg last:border-0">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-muji-red/10 text-muji-red flex items-center justify-center font-bold text-xs">
                                    {{ exp.payer.charAt(0) }}</div>
                                <div class="text-[17px] text-muji-text">{{ exp.item }}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[17px] font-bold text-muji-text tabular-nums">{{ currencySymbol }}{{
                                    exp.amount.toLocaleString() }}</span>
                                <button @click="removeExpense(idx)" class="text-muji-sub/40 hover:text-red-500"><i
                                        class="ph-fill ph-minus-circle text-xl"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Settlement - Apple Style List -->
                    <div v-if="settlementPlan.length > 0" class="bg-white rounded-xl shadow-ios overflow-hidden">
                        <div
                            class="px-4 py-2 bg-ios-bg/50 border-b border-ios-bg text-[11px] text-muji-sub font-bold uppercase">
                            結帳建議</div>
                        <div v-for="(plan, idx) in settlementPlan" :key="idx"
                            class="flex justify-between items-center p-4 border-b border-ios-bg last:border-0">
                            <div class="flex items-center gap-2 text-[15px]">
                                <span class="font-bold text-muji-text">{{ plan.from }}</span>
                                <i class="ph-bold ph-arrow-right text-muji-sub/50 text-xs"></i>
                                <span class="font-bold text-muji-text">{{ plan.to }}</span>
                            </div>
                            <div class="text-[15px] font-bold text-muji-red tabular-nums">{{ currencySymbol }}{{
                                plan.amount.toLocaleString() }}</div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- TRANSLATE VIEW -->
            <transition name="fade">
                <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32">
                    <div class="w-full max-w-sm space-y-4">
                        <a href="https://translate.google.com/?op=images" target="_blank"
                            class="block group active:scale-95 transition-transform">
                            <div
                                class="bg-white rounded-2xl p-6 shadow-ios flex items-center justify-between border border-transparent group-hover:border-muji-red/20">
                                <div>
                                    <div class="text-xs font-bold text-muji-sub uppercase mb-1">相機翻譯</div>
                                    <div class="text-xl font-bold text-muji-text">菜單 / 招牌</div>
                                </div>
                                <div
                                    class="w-12 h-12 bg-muji-red/10 rounded-full flex items-center justify-center text-muji-red">
                                    <i class="ph-fill ph-camera text-2xl"></i></div>
                            </div>
                        </a>
                        <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`"
                            target="_blank" class="block group active:scale-95 transition-transform">
                            <div
                                class="bg-white rounded-2xl p-6 shadow-ios flex items-center justify-between border border-transparent group-hover:border-muji-red/20">
                                <div>
                                    <div class="text-xs font-bold text-muji-sub uppercase mb-1">對話翻譯</div>
                                    <div class="text-xl font-bold text-muji-text">中文 <i
                                            class="ph-bold ph-arrow-right text-sm mx-1"></i> {{ setup.langName }}</div>
                                </div>
                                <div
                                    class="w-12 h-12 bg-ios-blue/10 rounded-full flex items-center justify-center text-ios-blue">
                                    <i class="ph-fill ph-chat-text text-2xl"></i></div>
                            </div>
                        </a>
                    </div>
                </div>
            </transition>

        </main>

        <!-- Bottom Tab Bar (iOS Style) -->
        <nav class="shrink-0 bg-white/90 backdrop-blur-xl border-t border-ios-separator/50 pb-safe-bottom z-40">
            <div class="flex justify-around items-center h-[55px]">
                <button @click="viewMode = 'plan'"
                    class="flex-1 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform"
                    :class="viewMode === 'plan' ? 'text-muji-red' : 'text-muji-sub/60'">
                    <i :class="viewMode === 'plan' ? 'ph-fill ph-calendar-check' : 'ph ph-calendar-check'"
                        class="text-2xl"></i>
                    <span class="text-[10px] font-medium">行程</span>
                </button>
                <button @click="viewMode = 'map'"
                    class="flex-1 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform"
                    :class="viewMode === 'map' ? 'text-muji-red' : 'text-muji-sub/60'">
                    <i :class="viewMode === 'map' ? 'ph-fill ph-map-trifold' : 'ph ph-map-trifold'"
                        class="text-2xl"></i>
                    <span class="text-[10px] font-medium">地圖</span>
                </button>
                <button @click="viewMode = 'money'"
                    class="flex-1 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform"
                    :class="viewMode === 'money' ? 'text-muji-red' : 'text-muji-sub/60'">
                    <i :class="viewMode === 'money' ? 'ph-fill ph-currency-dollar' : 'ph ph-currency-dollar'"
                        class="text-2xl"></i>
                    <span class="text-[10px] font-medium">分帳</span>
                </button>
                <button @click="viewMode = 'translate'"
                    class="flex-1 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform"
                    :class="viewMode === 'translate' ? 'text-muji-red' : 'text-muji-sub/60'">
                    <i :class="viewMode === 'translate' ? 'ph-fill ph-translate' : 'ph ph-translate'"
                        class="text-2xl"></i>
                    <span class="text-[10px] font-medium">翻譯</span>
                </button>
            </div>
        </nav>

        <!-- Sidebar Menu (Trip Switcher) -->
        <transition name="fade">
            <div v-if="showTripMenu"
                class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm">
                <div
                    class="bg-ios-bg w-full max-w-sm sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[80vh] flex flex-col">
                    <div class="p-4 bg-white border-b border-ios-separator/50 flex justify-between items-center">
                        <h2 class="text-[17px] font-bold text-muji-text">我的旅程</h2>
                        <button @click="showTripMenu = false"
                            class="w-8 h-8 bg-ios-bg rounded-full flex items-center justify-center text-muji-sub"><i
                                class="ph-bold ph-x"></i></button>
                    </div>
                    <div class="p-4 overflow-y-auto">
                        <button @click="createNewTrip"
                            class="w-full py-3 mb-4 bg-muji-red text-white font-bold rounded-xl shadow-ios flex items-center justify-center gap-2 active:scale-95 transition-transform">
                            <i class="ph-bold ph-plus"></i> 建立新旅程
                        </button>
                        <div class="space-y-3">
                            <div v-for="trip in tripList" :key="trip.id" @click="switchTrip(trip.id)"
                                class="p-4 rounded-xl border transition cursor-pointer relative group flex justify-between items-center"
                                :class="currentTripId === trip.id ? 'bg-white border-muji-red ring-1 ring-muji-red' : 'bg-white border-transparent'">
                                <div>
                                    <div class="font-bold text-[17px]">{{ trip.destination || '未命名行程' }}</div>
                                    <div class="text-xs text-muji-sub mt-1">{{ trip.startDate }} • {{ trip.daysCount }}
                                        天</div>
                                </div>
                                <i v-if="currentTripId === trip.id"
                                    class="ph-fill ph-check-circle text-muji-red text-xl"></i>
                                <button v-if="tripList.length > 1" @click.stop="deleteTrip(trip.id)"
                                    class="text-muji-sub/30 hover:text-red-500 p-2"><i
                                        class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Setup Modal -->
        <div v-if="showSetupModal"
            class="absolute inset-0 bg-ios-bg z-50 flex items-center justify-center p-6 animate-fade-in text-muji-text">
            <div class="w-full max-w-sm">
                <div class="text-center mb-10">
                    <div
                        class="w-24 h-24 bg-white shadow-ios rounded-3xl flex items-center justify-center mx-auto mb-6">
                        <i class="ph-duotone ph-airplane-tilt text-5xl text-muji-red"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">開始規劃您的旅程</h2>
                    <p class="text-muji-sub text-[15px]">簡單設定，即刻出發</p>
                </div>

                <div class="bg-white rounded-xl shadow-ios overflow-hidden mb-6">
                    <div class="flex items-center px-4 py-3 border-b border-ios-bg">
                        <label class="w-20 text-[15px] font-bold text-muji-text">目的地</label>
                        <input v-model="setup.destination"
                            class="flex-1 text-[15px] bg-transparent focus:outline-none text-right placeholder-muji-sub/40"
                            placeholder="例如: 京都" @blur="detectRate">
                    </div>
                    <div class="flex items-center px-4 py-3 border-b border-ios-bg">
                        <label class="w-20 text-[15px] font-bold text-muji-text">日期</label>
                        <input v-model="setup.startDate" type="date"
                            class="flex-1 text-[15px] bg-transparent focus:outline-none text-right font-mono">
                    </div>
                    <div class="flex items-center px-4 py-3 border-b border-ios-bg">
                        <label class="w-20 text-[15px] font-bold text-muji-text">天數</label>
                        <input v-model.number="setup.days" type="number" min="1" max="30"
                            class="flex-1 text-[15px] bg-transparent focus:outline-none text-right font-mono">
                    </div>
                    <div class="flex items-center px-4 py-3">
                        <label class="w-24 text-[15px] font-bold text-muji-text">匯率 ({{setup.currency||'外幣'}})</label>
                        <input v-model.number="setup.rate" type="number" step="0.001"
                            class="flex-1 text-[15px] bg-transparent focus:outline-none text-right font-mono">
                        <span v-if="isRateLoading" class="ml-2 text-xs text-muji-sub animate-pulse">...</span>
                    </div>
                </div>

                <button @click="initTrip"
                    class="w-full bg-muji-red text-white h-12 rounded-xl text-[17px] font-bold shadow-lg active:scale-95 transition-transform">建立行程</button>
                <button v-if="tripList.length>0" @click="showSetupModal = false"
                    class="w-full mt-4 text-muji-sub text-sm font-bold">取消返回</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isScrolledTop = ref(true);
                const mainScroll = ref(null);

                let mapInstance, userMarker;
                let geoWatchId = null;

                // Trip Data
                const showTripMenu = ref(false);
                const tripList = ref([]);
                const currentTripId = ref(null);
                const showSetupModal = ref(false);

                // Core Data
                const days = ref([]);
                const expenses = ref([]);
                const participants = ref(['我', '旅伴']);
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: '我' });

                // Temp
                const isRateLoading = ref(false);
                const isMapLoading = ref(false);
                const userLocation = ref(null);
                const weather = ref({ temp: null, icon: 'ph-sun', code: 0, location: '', daily: [] });
                const setup = ref({ destination: 'Kyoto', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja', langName: '日文' });

                // Recommendations
                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');

                // --- Computed ---
                const currentDay = computed(() => days.value[currentDayIdx.value] || { items: [], flight: null, date: '', title: '' });
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => { if (map[e.payer] === undefined) map[e.payer] = 0; map[e.payer] += e.amount; });
                    return map;
                });
                const settlementPlan = computed(() => {
                    const average = totalExpense.value / participants.value.length;
                    if (!totalExpense.value) return [];
                    let balances = participants.value.map(p => ({ name: p, val: (paidByPerson.value[p] || 0) - average }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(Math.abs(debtors[i].val), creditors[j].val);
                        if (amount > 0) result.push({ from: debtors[i].name, to: creditors[j].name, amount: Math.round(amount) });
                        debtors[i].val += amount; creditors[j].val -= amount;
                        if (Math.abs(debtors[i].val) < 1) i++;
                        if (creditors[j].val < 1) j++;
                    }
                    return result;
                });
                const currencySymbol = computed(() => {
                    const map = { 'JPY': '¥', 'CNY': '¥', 'USD': '$', 'EUR': '€', 'KRW': '₩', 'GBP': '£', 'TWD': 'NT$', 'HKD': 'HK$', 'THB': '฿', 'VND': '₫' };
                    return map[setup.value.currency] || '$';
                });
                const weatherDisplay = computed(() => {
                    if (!currentDay.value || !currentDay.value.fullDate || weather.value.daily.length === 0) {
                        return { temp: weather.value.temp !== null ? `${weather.value.temp}°` : '--', icon: weather.value.icon || 'ph-sun', label: `目前`, isForecast: false };
                    }
                    const idx = weather.value.daily.time.indexOf(currentDay.value.fullDate);
                    if (idx !== -1) {
                        const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                        const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                        return { temp: `${min}°/${max}°`, icon: getWeatherIcon(weather.value.daily.weathercode[idx]), label: `預報`, isForecast: true };
                    }
                    return { temp: weather.value.temp !== null ? `${weather.value.temp}°` : '--', icon: weather.value.icon || 'ph-sun', label: `目前`, isForecast: false };
                });

                // --- Helpers ---
                const getPageTitle = () => {
                    if (viewMode.value === 'plan') return '行程規劃';
                    if (viewMode.value === 'map') return '地圖模式';
                    if (viewMode.value === 'money') return '分帳助手';
                    if (viewMode.value === 'translate') return '翻譯工具';
                    return '旅遊計畫';
                };
                const handleScroll = (e) => { isScrolledTop.value = e.target.scrollTop < 20; };
                const generateId = () => 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const getWeatherIcon = (c) => { if (c === 0) return 'ph-sun'; if (c < 4) return 'ph-cloud-sun'; if (c < 50) return 'ph-cloud-fog'; if (c < 70) return 'ph-cloud-rain'; return 'ph-cloud'; };
                const toggleFlightCard = () => {
                    if (currentDay.value.flight) { if (confirm('確定移除航班資訊？')) currentDay.value.flight = null; }
                    else { currentDay.value.flight = { type: 'arrival', startTime: '10:00', startAirport: 'TPE', number: 'BR198', endTime: '14:00', endAirport: 'KIX', arrivalOffset: 0 }; }
                };
                const getIcon = (t) => t === 'food' ? 'ph-fork-knife' : t === 'shop' ? 'ph-shopping-bag' : t === 'flight' ? 'ph-airplane' : 'ph-map-pin';
                const cycleType = (item) => {
                    const types = ['spot', 'food', 'shop', 'transport'];
                    item.type = types[(types.indexOf(item.type) + 1) % types.length];
                };
                const updateDate = (e, day) => {
                    const val = e.target.value; if (!val) return;
                    day.fullDate = val; const d = new Date(val);
                    if (isNaN(d.getTime())) return;
                    const w = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'][d.getDay()];
                    day.date = `${d.getMonth() + 1}/${d.getDate()} ${w}`;
                    day.shortDate = `${d.getMonth() + 1}/${d.getDate()}`;
                };

                // --- Core ---
                const addItem = () => currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' });
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => days.value.push({ date: `Day ${days.value.length + 1}`, title: '', items: [] });
                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const addExpense = () => { if (newExpense.value.item) { expenses.value.unshift({ ...newExpense.value }); newExpense.value.item = ''; newExpense.value.amount = ''; } };
                const removeExpense = (idx) => expenses.value.splice(idx, 1);

                // --- LBS ---
                const searchNearby = async (item, idx) => {
                    if (!item.location) return;
                    const key = `${currentDayIdx.value}-${idx}`; searchTargetIndex.value = key; isSearchingRecs.value = true; recommendationsMap[key] = [];
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData?.[0]) {
                            const searchRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent('restaurant near ' + item.location)}&limit=4`);
                            const searchData = await searchRes.json();
                            recommendationsMap[key] = searchData.map(place => ({ name: place.name || place.display_name.split(',')[0], location: place.name }));
                            if (recommendationsMap[key].length === 0) recommendationsMap[key] = [{ name: '無推薦結果', location: item.location }];
                        }
                    } catch (e) { } finally { isSearchingRecs.value = false; searchTargetIndex.value = ''; }
                };
                const applyRecommendation = (item, rec) => { item.activity = rec.name; item.location = rec.name; };

                // --- Auto Detect ---
                const countryInfoMap = { 'jp': { c: 'JPY', l: 'ja', n: '日文' }, 'kr': { c: 'KRW', l: 'ko', n: '韓文' }, 'us': { c: 'USD', l: 'en', n: '英文' }, 'cn': { c: 'CNY', l: 'zh-CN', n: '簡中' }, 'th': { c: 'THB', l: 'th', n: '泰文' } };
                const detectRate = async () => {
                    if (!setup.value.destination) return; isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`);
                        const geoData = await geoRes.json();
                        if (geoData?.[0]?.address?.country_code) {
                            const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || { c: 'USD', l: 'en', n: '英文' };
                            setup.value.currency = info.c; setup.value.langCode = info.l; setup.value.langName = info.n;
                            if (info.c === 'TWD') setup.value.rate = 1;
                            else { const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`); const rData = await rRes.json(); if (rData?.rates?.TWD) setup.value.rate = rData.rates.TWD; }
                        }
                    } catch (e) { } finally { isRateLoading.value = false; }
                };

                // --- Weather ---
                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData?.[0]) {
                            const { lat, lon } = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if (wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch (e) { weather.value.temp = '--'; }
                };

                // --- Trip Management ---
                const loadTripList = () => { const list = localStorage.getItem('travel_app_index'); tripList.value = list ? JSON.parse(list) : []; };
                const saveTripList = () => { localStorage.setItem('travel_app_index', JSON.stringify(tripList.value)); };
                const createNewTrip = () => { setup.value = { destination: '', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja', langName: '日文' }; showSetupModal.value = true; showTripMenu.value = false; };
                const initTrip = () => {
                    if (!setup.value.destination) { alert('請輸入目的地'); return; }
                    const newId = generateId();
                    const newTripMeta = { id: newId, destination: setup.value.destination, startDate: setup.value.startDate, daysCount: setup.value.days };
                    const newDays = []; const start = new Date(setup.value.startDate); const dNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                    for (let i = 0; i < setup.value.days; i++) {
                        const curr = new Date(start); curr.setDate(start.getDate() + i);
                        const mm = curr.getMonth() + 1; const dd = curr.getDate();
                        const fullDate = `${curr.getFullYear()}-${mm < 10 ? '0' + mm : mm}-${dd < 10 ? '0' + dd : dd}`;
                        newDays.push({ date: `${mm}/${dd} ${dNames[curr.getDay()]}`, shortDate: `${mm}/${dd}`, fullDate: fullDate, title: '', items: [], flight: null });
                    }
                    localStorage.setItem(`${newId}_days`, JSON.stringify(newDays));
                    localStorage.setItem(`${newId}_exp`, '[]');
                    localStorage.setItem(`${newId}_users`, '我, 旅伴');
                    localStorage.setItem(`${newId}_rate`, setup.value.rate.toString());
                    localStorage.setItem(`${newId}_config`, JSON.stringify(setup.value));
                    tripList.value.unshift(newTripMeta); saveTripList(); switchTrip(newId); showSetupModal.value = false;
                };
                const deleteTrip = (id) => { if (!confirm('確定刪除此行程？')) return; tripList.value = tripList.value.filter(t => t.id !== id); saveTripList(); if (currentTripId.value === id) { if (tripList.value.length > 0) switchTrip(tripList.value[0].id); else { days.value = []; currentTripId.value = null; showSetupModal.value = true; } } };
                const switchTrip = (id) => {
                    currentTripId.value = id; showTripMenu.value = false;
                    const d = localStorage.getItem(`${id}_days`); if (d) days.value = JSON.parse(d);
                    const e = localStorage.getItem(`${id}_exp`); if (e) expenses.value = JSON.parse(e);
                    const r = localStorage.getItem(`${id}_rate`); if (r) exchangeRate.value = parseFloat(r);
                    const c = localStorage.getItem(`${id}_config`); if (c) { const conf = JSON.parse(c); setup.value = conf; fetchWeather(conf.destination); }
                };

                onMounted(() => {
                    loadTripList(); if (tripList.value.length > 0) switchTrip(tripList.value[0].id); else showSetupModal.value = true;
                    watch([days, expenses, exchangeRate], () => { if (!currentTripId.value) return; localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(days.value)); localStorage.setItem(`${currentTripId.value}_exp`, JSON.stringify(expenses.value)); localStorage.setItem(`${currentTripId.value}_rate`, exchangeRate.value.toString()); }, { deep: true });
                });

                const initMap = async () => {
                    isMapLoading.value = true; await nextTick(); if (!document.getElementById('map')) return;
                    if (mapInstance) { mapInstance.remove(); mapInstance = null; }
                    mapInstance = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' }).addTo(mapInstance);
                    if ("geolocation" in navigator) {
                        if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                        geoWatchId = navigator.geolocation.watchPosition(pos => {
                            userLocation.value = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            const icon = L.divIcon({ className: 'custom-div-icon', html: "<div class='gps-pulse'></div>", iconSize: [16, 16] });
                            if (userMarker) userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                            else userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], { icon: icon }).addTo(mapInstance);
                        }, err => { }, { enableHighAccuracy: true });
                    }
                    const locs = currentDay.value.items.filter(i => i.location);
                    const bounds = L.latLngBounds();
                    for (const item of locs) {
                        try { await new Promise(r => setTimeout(r, 200)); const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`); const d = await res.json(); if (d && d.length > 0) { const lat = parseFloat(d[0].lat); const lon = parseFloat(d[0].lon); L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${item.activity}</b><br>${item.location}`); bounds.extend([lat, lon]); } } catch (e) { }
                    }
                    isMapLoading.value = false; if (locs.length > 0) mapInstance.fitBounds(bounds, { padding: [50, 50] });
                };
                const centerOnUser = () => { if (userLocation.value && mapInstance) mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15); };
                watch(viewMode, (v) => { if (v === 'map') initMap(); });
                watch(currentDayIdx, () => { if (viewMode.value === 'map') initMap(); });

                return {
                    viewMode, currentDayIdx, days, currentDay, participants, exchangeRate,
                    getPageTitle, isScrolledTop, handleScroll, mainScroll,
                    addItem, removeItem, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense, settlementPlan,
                    weather, weatherDisplay,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    updateDate, showSetupModal, setup, initTrip, detectRate, isRateLoading, currencySymbol, toggleFlightCard,
                    showTripMenu, tripList, createNewTrip, switchTrip, deleteTrip, currentTripId,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    getIcon, cycleType, getGoogleMapLink
                };
            }
        }).mount('#app')
    </script>
</body>

</html>